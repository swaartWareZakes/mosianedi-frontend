\n--- ./types/project.ts ---\n
// ./types/project.ts
export type NewProject = {
    project_name: string;
    description: string;
    start_year: number;
    forecast_duration: number;
    discount_rate: number;
    // user_id will be derived from the session on the backend
  };\n--- ./app/(app)/settings/components/AppearanceTab.tsx ---\n
"use client";

import React, { useState } from "react";
import { Moon, Sun, Monitor } from "lucide-react";

export default function AppearanceTab() {
  const [theme, setTheme] = useState("system");
  const [accent, setAccent] = useState("indigo");

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
      
      {/* Header */}
      <div>
        <h2 className="text-lg font-bold text-slate-900 dark:text-white">Interface Theme</h2>
        <p className="text-sm text-slate-500">Customize how Mosianedi looks on your device.</p>
      </div>

      {/* Mode Selection */}
      <div className="grid grid-cols-3 gap-4">
        {['light', 'dark', 'system'].map((mode) => (
            <button
                key={mode}
                onClick={() => setTheme(mode)}
                className={`group relative p-4 rounded-xl border-2 text-left transition-all ${theme === mode ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/10' : 'border-slate-200 dark:border-slate-700 hover:border-slate-300'}`}
            >
                <div className="mb-3">
                    {mode === 'light' && <Sun className={`w-6 h-6 ${theme === mode ? 'text-indigo-600' : 'text-slate-400'}`} />}
                    {mode === 'dark' && <Moon className={`w-6 h-6 ${theme === mode ? 'text-indigo-600' : 'text-slate-400'}`} />}
                    {mode === 'system' && <Monitor className={`w-6 h-6 ${theme === mode ? 'text-indigo-600' : 'text-slate-400'}`} />}
                </div>
                <div className="font-medium text-sm capitalize text-slate-900 dark:text-white">{mode} Mode</div>
            </button>
        ))}
      </div>

      <hr className="border-slate-100 dark:border-slate-800" />

      {/* Brand Color */}
      <div>
        <h2 className="text-lg font-bold text-slate-900 dark:text-white mb-4">Brand Accent</h2>
        <div className="flex gap-4">
            {['indigo', 'violet', 'emerald', 'rose', 'amber'].map((color) => {
                const bgClass = {
                    indigo: 'bg-indigo-500',
                    violet: 'bg-violet-500',
                    emerald: 'bg-emerald-500',
                    rose: 'bg-rose-500',
                    amber: 'bg-amber-500'
                }[color];

                return (
                    <button
                        key={color}
                        onClick={() => setAccent(color)}
                        className={`w-10 h-10 rounded-full ${bgClass} flex items-center justify-center transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-${color}-500 ${accent === color ? 'ring-2 ring-offset-2 ring-slate-400' : ''}`}
                    >
                        {accent === color && <div className="w-2 h-2 bg-white rounded-full" />}
                    </button>
                )
            })}
        </div>
      </div>

      {/* Preview Box */}
      <div className="p-6 bg-slate-50 dark:bg-slate-950 rounded-xl border border-slate-200 dark:border-slate-800 mt-8">
          <div className="flex items-center gap-4 mb-4">
              <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-white bg-${accent}-500 shadow-lg shadow-${accent}-500/30`}>
                  <Sun className="w-5 h-5" />
              </div>
              <div>
                  <div className="font-bold text-sm">Active Project</div>
                  <div className="text-xs text-slate-500">This is how your components will look.</div>
              </div>
              <button className={`ml-auto px-4 py-2 rounded-lg text-xs font-bold text-white bg-${accent}-600`}>
                  Primary Action
              </button>
          </div>
      </div>

    </div>
  );
}\n--- ./app/(app)/settings/components/SecurityTab.tsx ---\n
"use client";

import React, { useState } from "react";
// ðŸ‘‡ Added 'Monitor' to the imports
import { ShieldCheck, Smartphone, QrCode, CheckCircle2, Lock, Monitor } from "lucide-react";

export default function SecurityTab() {
  const [twoFactorEnabled, setTwoFactorEnabled] = useState(false);
  const [showSetup, setShowSetup] = useState(false);

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
      
      {/* Header */}
      <div>
        <h2 className="text-lg font-bold text-slate-900 dark:text-white">Security & Authentication</h2>
        <p className="text-sm text-slate-500">Manage two-factor authentication and active sessions.</p>
      </div>

      {/* 2FA Card */}
      <div className={`p-6 rounded-2xl border transition-all ${twoFactorEnabled ? 'bg-emerald-50/50 border-emerald-200 dark:border-emerald-900/30' : 'bg-white border-slate-200 dark:border-slate-800'}`}>
        <div className="flex justify-between items-start">
            <div className="flex gap-4">
                <div className={`p-3 rounded-xl ${twoFactorEnabled ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}`}>
                    <Smartphone className="w-6 h-6" />
                </div>
                <div>
                    <h3 className="font-bold text-slate-900 dark:text-white">Two-Factor Authentication (2FA)</h3>
                    <p className="text-sm text-slate-500 mt-1 max-w-sm">
                        Secure your account by requiring an authentication code from your mobile app when logging in.
                    </p>
                </div>
            </div>
            
            {!showSetup && !twoFactorEnabled && (
                <button 
                    onClick={() => setShowSetup(true)}
                    className="px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold rounded-lg"
                >
                    Enable 2FA
                </button>
            )}

            {twoFactorEnabled && (
                <button 
                    onClick={() => setTwoFactorEnabled(false)}
                    className="px-4 py-2 border border-rose-200 text-rose-600 hover:bg-rose-50 text-sm font-bold rounded-lg"
                >
                    Disable
                </button>
            )}
        </div>

        {/* Setup Flow (Mock) */}
        {showSetup && !twoFactorEnabled && (
            <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-800 animate-in slide-in-from-top-2">
                <div className="flex gap-8">
                    <div className="w-32 h-32 bg-white p-2 rounded-lg border border-slate-200 shadow-sm flex items-center justify-center">
                        <QrCode className="w-24 h-24 text-slate-900" />
                    </div>
                    <div className="flex-1 space-y-4">
                        <ol className="list-decimal list-inside text-sm text-slate-600 space-y-2">
                            <li>Open Google Authenticator or Authy on your phone.</li>
                            <li>Scan the QR code displayed on the left.</li>
                            <li>Enter the 6-digit code generated by the app below.</li>
                        </ol>
                        <div className="flex gap-3">
                            <input type="text" placeholder="000 000" className="w-32 text-center text-lg tracking-widest font-mono p-2 rounded border border-slate-300 focus:ring-2 focus:ring-indigo-500 outline-none" />
                            <button 
                                onClick={() => { setTwoFactorEnabled(true); setShowSetup(false); }}
                                className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg text-sm"
                            >
                                Verify & Activate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        )}
      </div>

      <hr className="border-slate-100 dark:border-slate-800" />

      {/* Device History */}
      <div>
          <h3 className="font-bold text-slate-900 dark:text-white mb-4">Device History</h3>
          <div className="space-y-3">
              <DeviceRow 
                icon={<Monitor className="w-4 h-4"/>} 
                name="Chrome on macOS" 
                location="Pretoria, ZA" 
                active 
              />
              <DeviceRow 
                icon={<Smartphone className="w-4 h-4"/>} 
                name="Safari on iPhone 14" 
                location="Johannesburg, ZA" 
                lastActive="2 days ago" 
              />
          </div>
      </div>

    </div>
  );
}

function DeviceRow({ icon, name, location, active, lastActive }: any) {
    return (
        <div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl border border-slate-200 dark:border-slate-800">
            <div className="flex items-center gap-3">
                <div className="text-slate-400">{icon}</div>
                <div>
                    <div className="text-sm font-bold text-slate-700 dark:text-slate-200">{name}</div>
                    <div className="text-xs text-slate-500">{location}</div>
                </div>
            </div>
            <div className="text-xs">
                {active ? (
                    <span className="flex items-center gap-1.5 text-emerald-600 font-medium px-2 py-1 bg-emerald-50 rounded-full">
                        <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" /> Active now
                    </span>
                ) : (
                    <span className="text-slate-400">{lastActive}</span>
                )}
            </div>
        </div>
    )
}\n--- ./app/(app)/settings/components/NotificationsTab.tsx ---\n
"use client";

import React, { useState } from "react";
import { Mail, Bell, AlertCircle } from "lucide-react";

export default function NotificationsTab() {
  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-right-4 duration-300">
      
      <div>
        <h2 className="text-lg font-bold text-slate-900 dark:text-white">Notification Preferences</h2>
        <p className="text-sm text-slate-500">Control when and how we communicate with you.</p>
      </div>

      <div className="space-y-6">
          <Section title="Project Activity" icon={<Bell className="w-4 h-4"/>}>
              <ToggleRow label="Simulation Completed" desc="Receive an alert when a heavy calculation finishes." defaultChecked />
              <ToggleRow label="Report Generated" desc="Notify when a PDF export is ready for download." defaultChecked />
              <ToggleRow label="New Team Comment" desc="When a colleague comments on a project." />
          </Section>

          <Section title="Email Alerts" icon={<Mail className="w-4 h-4"/>}>
              <ToggleRow label="Weekly Digest" desc="A summary of network condition changes." />
              <ToggleRow label="Critical Infrastructure Warnings" desc="Immediate email when VCI drops below threshold." defaultChecked />
              <ToggleRow label="Product Updates" desc="News about Mosianedi features." />
          </Section>
      </div>

      <div className="p-4 bg-amber-50 border border-amber-200 rounded-xl flex gap-3 items-start">
          <AlertCircle className="w-5 h-5 text-amber-600 mt-0.5" />
          <div>
              <h4 className="text-sm font-bold text-amber-800">System Wide Alerts</h4>
              <p className="text-xs text-amber-700 mt-1">
                  You cannot disable security alerts or password reset notifications. These will always be sent to your primary email.
              </p>
          </div>
      </div>

    </div>
  );
}

function Section({ title, icon, children }: any) {
    return (
        <div>
            <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3 flex items-center gap-2">
                {icon} {title}
            </h3>
            <div className="divide-y divide-slate-100 dark:divide-slate-800 border-t border-b border-slate-100 dark:border-slate-800">
                {children}
            </div>
        </div>
    )
}

function ToggleRow({ label, desc, defaultChecked }: any) {
    const [checked, setChecked] = useState(defaultChecked || false);
    return (
        <div className="py-4 flex items-center justify-between">
            <div>
                <div className="text-sm font-medium text-slate-900 dark:text-white">{label}</div>
                <div className="text-xs text-slate-500">{desc}</div>
            </div>
            <button 
                onClick={() => setChecked(!checked)}
                className={`w-11 h-6 rounded-full transition-colors relative ${checked ? 'bg-indigo-600' : 'bg-slate-200 dark:bg-slate-700'}`}
            >
                <div className={`w-4 h-4 bg-white rounded-full shadow-sm absolute top-1 transition-transform ${checked ? 'left-6' : 'left-1'}`} />
            </button>
        </div>
    )
}\n--- ./app/(app)/settings/page.tsx ---\n
"use client";

import React, { useState } from "react";
import { 
  Palette, 
  Shield, 
  Bell, 
  Monitor, 
  Smartphone, 
  LogOut,
  ChevronRight
} from "lucide-react";
import { cn } from "@/lib/utils";
import AppearanceTab from "./components/AppearanceTab";
import SecurityTab from "./components/SecurityTab";
import NotificationsTab from "./components/NotificationsTab";

export default function SettingsPage() {
  const [activeTab, setActiveTab] = useState("appearance");

  const menu = [
    { id: "appearance", label: "Appearance", icon: <Palette className="w-4 h-4" /> },
    { id: "security", label: "Security & 2FA", icon: <Shield className="w-4 h-4" /> },
    { id: "notifications", label: "Notifications", icon: <Bell className="w-4 h-4" /> },
  ];

  return (
    <div className="min-h-screen bg-[var(--background)] p-8">
      <div className="max-w-6xl mx-auto">
        
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-2xl font-bold text-slate-900 dark:text-white">Settings</h1>
          <p className="text-slate-500 dark:text-slate-400">Configure your workspace preferences and security.</p>
        </div>

        <div className="flex flex-col lg:flex-row gap-8">
          
          {/* LEFT SIDEBAR: NAVIGATION */}
          <aside className="lg:w-64 flex-shrink-0 space-y-8">
            <nav className="space-y-1">
              {menu.map((item) => (
                <button
                  key={item.id}
                  onClick={() => setActiveTab(item.id)}
                  className={cn(
                    "w-full flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all",
                    activeTab === item.id 
                      ? "bg-slate-900 dark:bg-white text-white dark:text-slate-900 shadow-md" 
                      : "text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800"
                  )}
                >
                  {item.icon}
                  {item.label}
                  {activeTab === item.id && <ChevronRight className="w-3 h-3 ml-auto opacity-50" />}
                </button>
              ))}
            </nav>

            {/* Session Info Box */}
            <div className="bg-slate-50 dark:bg-slate-900/50 p-4 rounded-xl border border-slate-200 dark:border-slate-800">
                <h3 className="text-xs font-bold uppercase text-slate-400 mb-3 tracking-wider">Current Session</h3>
                <div className="flex items-center gap-3 mb-2">
                    <Monitor className="w-4 h-4 text-emerald-500" />
                    <div className="text-xs">
                        <div className="font-medium text-slate-700 dark:text-slate-300">Chrome on macOS</div>
                        <div className="text-slate-400">Pretoria, ZA â€¢ Just now</div>
                    </div>
                </div>
            </div>
          </aside>

          {/* RIGHT CONTENT: TABS */}
          <main className="flex-1 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-8 shadow-sm min-h-[500px]">
            {activeTab === "appearance" && <AppearanceTab />}
            {activeTab === "security" && <SecurityTab />}
            {activeTab === "notifications" && <NotificationsTab />}
          </main>

        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/advisor/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Sparkles, ArrowRight, Loader2 } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function GlobalAdvisorPage() {
  const router = useRouter();
  const [projects, setProjects] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedId, setSelectedId] = useState("");

  useEffect(() => {
    async function fetchProjects() {
      try {
        const { data } = await supabase
          .from("projects")
          .select("id, project_name, province")
          .order("updated_at", { ascending: false });
        
        if (data) setProjects(data);
      } catch (err) {
        console.error("Error fetching projects:", err);
      } finally {
        setLoading(false);
      }
    }
    fetchProjects();
  }, []);

  const handleGo = () => {
    if (selectedId) {
      router.push(`/projects/${selectedId}/advisor`);
    }
  };

  return (
    <div className="h-[calc(100vh-64px)] flex flex-col items-center justify-center bg-[var(--background)] p-6">
      
      <div className="max-w-md w-full text-center space-y-8">
        
        {/* Hero Icon */}
        <div className="relative mx-auto w-24 h-24">
            <div className="absolute inset-0 bg-indigo-500 rounded-full blur-2xl opacity-20 animate-pulse" />
            <div className="relative w-full h-full bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center border border-slate-200 dark:border-slate-700 shadow-xl">
                <Sparkles className="w-10 h-10 text-indigo-500" />
            </div>
        </div>

        <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white">AI Strategic Advisor</h1>
            <p className="text-slate-500 mt-2">
                Select a project to analyze simulation results and generate a Treasury-ready strategy.
            </p>
        </div>

        {/* Selector Card */}
        <div className="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg text-left">
            <label className="text-xs font-bold uppercase text-slate-400 tracking-wider mb-2 block">
                Select Project Scope
            </label>
            
            {loading ? (
                <div className="flex items-center justify-center py-4">
                    <Loader2 className="w-5 h-5 animate-spin text-indigo-500" />
                </div>
            ) : (
                <div className="space-y-4">
                    <select
                        value={selectedId}
                        onChange={(e) => setSelectedId(e.target.value)}
                        className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-950 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                    >
                        <option value="" disabled>-- Choose a Project --</option>
                        {projects.map((p) => (
                            <option key={p.id} value={p.id}>
                                {p.project_name} ({p.province})
                            </option>
                        ))}
                    </select>

                    <button
                        onClick={handleGo}
                        disabled={!selectedId}
                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                    >
                        Launch Advisor <ArrowRight className="w-4 h-4" />
                    </button>
                </div>
            )}
        </div>

      </div>
    </div>
  );
}\n--- ./app/(app)/presentationmode/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";
import { 
  Presentation, 
  Calendar, 
  ChevronRight, 
  Briefcase,
  Map,
  Clock,
  ArrowUpRight,
  AlertCircle,
  CheckCircle2
} from "lucide-react";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

// ðŸ‘‡ Updated Interface to handle variations in DB column naming
interface Project {
  id: string;
  project_name: string;
  description: string;
  created_at: string;
  
  // These might vary depending on your exact DB schema, so we make them optional
  // and handle the logic inside the component.
  start_year?: number; 
  start_financial_year?: number; 
  
  duration?: number;
  forecast_duration?: number;
  
  status?: string;
}

export default function PresentationHub() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchProjects() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const res = await fetch(`${API_BASE}/api/v1/projects`, {
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        if (res.ok) {
          const data = await res.json();
          // Sort by newest first
          setProjects(data.sort((a: Project, b: Project) => 
            new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
          ));
        }
      } catch (error) {
        console.error("Failed to load projects", error);
      } finally {
        setLoading(false);
      }
    }
    fetchProjects();
  }, []);

  return (
    <div className="relative min-h-screen w-full">
      
      {/* Background */}
      <div className="absolute inset-0 -z-10 h-full w-full bg-[var(--background)] bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px] dark:bg-[radial-gradient(#1e293b_1px,transparent_1px)]">
        <div className="absolute inset-0 bg-gradient-to-b from-[var(--background)] via-transparent to-transparent opacity-80" />
      </div>

      <div className="max-w-5xl mx-auto py-12 px-6">
        
        {/* Header */}
        <div className="mb-12 space-y-4">
          <div className="inline-flex items-center gap-2 rounded-full bg-purple-50 dark:bg-purple-900/20 px-3 py-1 text-xs font-medium text-purple-600 dark:text-purple-300 ring-1 ring-inset ring-purple-500/20">
            <Presentation className="h-3 w-3" /> Executive Suite
          </div>
          <h1 className="text-4xl font-bold tracking-tight text-[var(--foreground)]">
            Presentation Hub
          </h1>
          <p className="text-lg text-slate-500 dark:text-slate-400 max-w-2xl leading-relaxed">
            Select a strategic initiative below to configure the presentation environment. 
            Prepare your narrative, maps, and financial forecasts for the boardroom.
          </p>
        </div>

        {/* Project List */}
        <div className="relative border-l-2 border-slate-200 dark:border-slate-800 ml-4 space-y-10 pb-20">
          
          {loading && (
              <div className="pl-12 flex items-center gap-3 text-slate-500">
                  <div className="h-2 w-2 rounded-full bg-slate-300 animate-pulse"/>
                  <span className="text-sm font-medium">Loading portfolio...</span>
              </div>
          )}

          {!loading && projects.length === 0 && (
              <div className="pl-12 text-slate-500">
                  <div className="p-6 border border-dashed border-slate-300 rounded-xl bg-slate-50/50">
                    No projects found. Go to Projects to create one first.
                  </div>
              </div>
          )}

          {projects.map((project) => {
            // ðŸ‘‡ LOGIC: Normalize Fields
            // Use current year + 1 as fallback if DB field is missing
            const startYear = project.start_year || project.start_financial_year || (new Date().getFullYear() + 1);
            
            // If duration is 0 or null, it implies the project hasn't been configured/simulated yet
            const duration = project.forecast_duration || project.duration || 0;
            const endYear = startYear + duration;
            
            const isReady = duration > 0; // "Ready" if we have a duration

            return (
              <div key={project.id} className="relative pl-10 group">
                
                {/* Node Dot */}
                <div className={`absolute -left-[9px] top-8 h-4 w-4 rounded-full border-4 border-[var(--background)] transition-all duration-300 shadow-sm z-10 ${isReady ? 'bg-purple-500 group-hover:scale-110' : 'bg-slate-300 dark:bg-slate-600'}`} />

                {/* Card */}
                <Link 
                    href={`/projects/${project.id}/presentation/setup`} 
                    className="block group-hover:-translate-y-1 transition-transform duration-300"
                >
                    <div className="bg-[var(--surface-bg)]/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-200/60 dark:border-slate-800 shadow-sm group-hover:shadow-xl group-hover:border-purple-500/20 transition-all">
                        
                        {/* Title Row */}
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg group-hover:bg-purple-100 dark:group-hover:bg-purple-900/30 transition-colors">
                                  <Briefcase className="h-5 w-5 text-slate-500 group-hover:text-purple-600 dark:group-hover:text-purple-400" />
                                </div>
                                <div>
                                  <h2 className="text-lg font-bold text-[var(--foreground)] group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
                                      {project.project_name}
                                  </h2>
                                  <div className="flex items-center gap-2 text-xs text-slate-400 mt-0.5">
                                    <Clock className="h-3 w-3" />
                                    <span>Last modified {new Date(project.created_at).toLocaleDateString()}</span>
                                  </div>
                                </div>
                            </div>
                            
                            <div className="h-8 w-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-all">
                                <ArrowUpRight className="h-4 w-4" />
                            </div>
                        </div>

                        {/* Description */}
                        <p className="text-sm text-slate-500 dark:text-slate-400 leading-relaxed pl-[52px] mb-6 line-clamp-2">
                            {project.description || "No strategic description provided for this scenario."}
                        </p>

                        {/* Metadata Grid */}
                        <div className="pl-[52px] grid grid-cols-2 md:grid-cols-4 gap-4">
                            
                            {/* 1. Horizon */}
                            <div className="flex flex-col">
                              <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Horizon</span>
                              {isReady ? (
                                <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1 flex items-center gap-1">
                                  <Calendar className="h-3 w-3" />
                                  {startYear} - {endYear}
                                </span>
                              ) : (
                                <span className="text-xs text-slate-400 mt-1 italic">Pending Config</span>
                              )}
                            </div>

                            {/* 2. Duration */}
                            <div className="flex flex-col">
                              <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Duration</span>
                              <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1">
                                {isReady ? `${duration} Years` : "-"}
                              </span>
                            </div>

                            {/* 3. Network */}
                            <div className="flex flex-col">
                              <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Network</span>
                              <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1 flex items-center gap-1">
                                <Map className="h-3 w-3" />
                                Ready
                              </span>
                            </div>

                            {/* 4. Status */}
                            <div className="flex flex-col">
                              <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Status</span>
                              {isReady ? (
                                <span className="inline-flex w-fit items-center gap-1 rounded-md bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700 ring-1 ring-inset ring-emerald-600/20 dark:bg-emerald-900/20 dark:text-emerald-400">
                                  <CheckCircle2 className="h-3 w-3" /> Ready
                                </span>
                              ) : (
                                <span className="inline-flex w-fit items-center gap-1 rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-600/20 dark:bg-amber-900/20 dark:text-amber-400">
                                  <AlertCircle className="h-3 w-3" /> Draft
                                </span>
                              )}
                            </div>
                        </div>
                    </div>
                </Link>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/ProjectCreateForm.tsx ---\n
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import { X, Loader2, FolderPlus } from "lucide-react";

interface ProjectCreateFormProps {
  onClose: (success?: boolean, newProjectId?: string) => void;
}

const PROVINCES = [
  "Eastern Cape",
  "Free State",
  "Gauteng",
  "KwaZulu-Natal",
  "Limpopo",
  "Mpumalanga",
  "Northern Cape",
  "North West",
  "Western Cape",
];

export function ProjectCreateForm({ onClose }: ProjectCreateFormProps) {
  const router = useRouter();

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [projectName, setProjectName] = useState("");
  const [province, setProvince] = useState(PROVINCES[0]);
  const [startYear, setStartYear] = useState(new Date().getFullYear() + 1);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      const token = session?.access_token;
      if (!token) throw new Error("Not authenticated. Please log in again.");

      const payload = {
        project_name: projectName,
        province,
        start_year: startYear,
      };

      const res = await fetch(`${API_BASE_URL}/api/v1/projects/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Failed to create project (${res.status})`);
      }

      // Expecting FastAPI to return created project row or at least { id: ... }
      const created = await res.json().catch(() => null);
      const newProjectId =
        created?.id || created?.project_id || created?.data?.id || undefined;

      onClose(true, newProjectId);
      router.refresh();
    } catch (err: any) {
      setError(err?.message ?? "Unknown error");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="w-full">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800">
        <h2 className="text-lg font-semibold flex items-center gap-2">
          <FolderPlus className="w-5 h-5 text-indigo-500" />
          New Provincial Proposal
        </h2>
        <button
          onClick={() => onClose(false)}
          className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"
          aria-label="Close"
        >
          <X className="w-5 h-5" />
        </button>
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit} className="p-6 space-y-4">
        {error && (
          <div className="p-3 text-sm text-rose-600 bg-rose-50 border border-rose-200 rounded-lg whitespace-pre-wrap">
            {error}
          </div>
        )}

        <div className="space-y-2">
          <label className="text-sm font-medium text-slate-700 dark:text-slate-300">
            Proposal Title
          </label>
          <input
            type="text"
            required
            placeholder="e.g. Eastern Cape 2026 Budget Proposal"
            className="w-full px-3 py-2 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
            value={projectName}
            onChange={(e) => setProjectName(e.target.value)}
          />
        </div>

        <div className="grid grid-cols-2 gap-3">
          <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">
              Province
            </label>
            <select
              className="w-full px-3 py-2 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              value={province}
              onChange={(e) => setProvince(e.target.value)}
            >
              {PROVINCES.map((p) => (
                <option key={p} value={p}>
                  {p}
                </option>
              ))}
            </select>
          </div>

          <div className="space-y-2">
            <label className="text-sm font-medium text-slate-700 dark:text-slate-300">
              Year
            </label>
            <select
              className="w-full px-3 py-2 bg-white dark:bg-slate-900 border border-slate-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
              value={startYear}
              onChange={(e) => setStartYear(Number(e.target.value))}
            >
              {[2024, 2025, 2026, 2027, 2028].map((y) => (
                <option key={y} value={y}>
                  {y}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div className="flex justify-end gap-3 pt-2">
          <button
            type="button"
            onClick={() => onClose(false)}
            className="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200"
          >
            Cancel
          </button>

          <button
            type="submit"
            disabled={loading}
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg disabled:opacity-50"
          >
            {loading && <Loader2 className="w-4 h-4 animate-spin" />}
            Create Proposal
          </button>
        </div>
      </form>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/advisor/components/InsightDisplay.tsx ---\n
"use client";

import React from "react";
import { 
  TrendingUp, 
  AlertTriangle, 
  CheckCircle2, 
  Briefcase, 
  Landmark, 
  ArrowRight 
} from "lucide-react";
import type { AiInsight } from "../hooks/useAdvisor";

export function InsightDisplay({ insight }: { insight: AiInsight }) {
  const { content, simulation_summary } = insight;

  return (
    <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden animate-in fade-in duration-500">
      
      {/* HEADER BANNER */}
      <div className="bg-indigo-600 p-8 text-white">
        <div className="flex items-center gap-2 text-indigo-200 text-xs font-bold uppercase tracking-widest mb-3">
            <SparklesIcon /> AI Strategic Assessment
        </div>
        <h1 className="text-3xl font-bold leading-tight max-w-2xl">
            {content.headline || "Strategic Infrastructure Review"}
        </h1>
        {simulation_summary && (
             <div className="mt-6 inline-flex items-center gap-4 bg-indigo-500/30 border border-indigo-400/30 rounded-lg px-4 py-2 text-sm">
                <span className="font-medium text-indigo-100">Analysis Base:</span>
                <span className="font-bold">{simulation_summary.run_name}</span>
                <span className="opacity-50">|</span>
                <span className="font-bold">{simulation_summary.total_cost}</span>
             </div>
        )}
      </div>

      <div className="p-8 space-y-10">
        
        {/* EXECUTIVE SUMMARY */}
        <section>
            <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <Briefcase className="w-4 h-4" /> Executive Summary
            </h3>
            <p className="text-lg text-slate-800 dark:text-slate-200 leading-relaxed font-medium">
                {content.executive_summary}
            </p>
        </section>

        <div className="grid md:grid-cols-2 gap-8">
            {/* FISCAL IMPLICATIONS (RISK) */}
            <div className="bg-rose-50 dark:bg-rose-900/10 p-6 rounded-2xl border border-rose-100 dark:border-rose-800/30">
                <h3 className="text-rose-700 dark:text-rose-400 font-bold flex items-center gap-2 mb-4">
                    <AlertTriangle className="w-5 h-5" /> Fiscal Liabilities
                </h3>
                <div className="space-y-4">
                    <div>
                        <div className="text-xs text-rose-600/70 uppercase font-bold mb-1">Backlog Growth</div>
                        <p className="text-sm text-slate-700 dark:text-slate-300">{content.fiscal_implications?.liability_growth}</p>
                    </div>
                    <div>
                        <div className="text-xs text-rose-600/70 uppercase font-bold mb-1">Economic Risk</div>
                        <p className="text-sm text-slate-700 dark:text-slate-300">{content.fiscal_implications?.economic_risk}</p>
                    </div>
                </div>
            </div>

            {/* ENGINEERING REALITY */}
            <div className="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
                <h3 className="text-slate-700 dark:text-slate-200 font-bold flex items-center gap-2 mb-4">
                    <TrendingUp className="w-5 h-5 text-indigo-500" /> Engineering Reality
                </h3>
                <p className="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
                    {content.engineering_reality}
                </p>
            </div>
        </div>

        {/* RECOMMENDATION */}
        <section className="border-t border-slate-100 dark:border-slate-800 pt-8">
             <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                <Landmark className="w-4 h-4" /> Strategic Recommendation
            </h3>
            <div className="flex items-start gap-4">
                <div className="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-full text-emerald-600 shrink-0 mt-1">
                    <CheckCircle2 className="w-5 h-5" />
                </div>
                <p className="text-base text-slate-700 dark:text-slate-300 leading-relaxed">
                    {content.recommendation}
                </p>
            </div>
        </section>

      </div>
    </div>
  );
}

function SparklesIcon() {
    return (
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 3.214L13 21l-2.286-6.857L5 12l5.714-3.214z" />
        </svg>
    )
}\n--- ./app/(app)/projects/[projectId]/advisor/hooks/useAdvisor.ts ---\n
"use client";

import { useState, useEffect, useCallback } from "react";
import { supabase } from "@/lib/supabaseClient";

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export type AiInsight = {
  id: string;
  created_at: string;
  status: string;
  content: {
    headline: string;
    executive_summary: string;
    fiscal_implications: {
      liability_growth: string;
      economic_risk: string;
    };
    engineering_reality: string;
    recommendation: string;
  };
  simulation_summary?: {
    run_name: string;
    total_cost: string;
    end_vci: number;
  };
};

export function useAdvisor(projectId: string) {
  const [history, setHistory] = useState<AiInsight[]>([]);
  const [activeInsight, setActiveInsight] = useState<AiInsight | null>(null);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Fetch History
  const fetchHistory = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}/advisor/history`, {
        headers: { Authorization: `Bearer ${session.access_token}` }
      });

      if (res.ok) {
        const data = await res.json();
        setHistory(data);
        // Default to latest if nothing selected
        if (!activeInsight && data.length > 0) {
            setActiveInsight(data[0]);
        }
      }
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  }, [projectId, activeInsight]);

  useEffect(() => {
    fetchHistory();
  }, [fetchHistory]);

  // Generate New
  const generateInsight = async () => {
    setGenerating(true);
    setError(null);
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not logged in");

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}/advisor/generate`, {
        method: "POST",
        headers: { Authorization: `Bearer ${session.access_token}` }
      });

      if (!res.ok) {
        const body = await res.json();
        throw new Error(body.detail || "Generation failed");
      }

      const newInsight = await res.json();
      
      // Update state immediately
      setHistory(prev => [newInsight, ...prev]);
      setActiveInsight(newInsight);

    } catch (err: any) {
      setError(err.message);
    } finally {
      setGenerating(false);
    }
  };

  return {
    history,
    activeInsight,
    setActiveInsight,
    loading,
    generating,
    error,
    generateInsight
  };
}\n--- ./app/(app)/projects/[projectId]/advisor/page.tsx ---\n
"use client";

import React from "react";
import { useParams } from "next/navigation";
import { 
  Sparkles, 
  Plus, 
  Loader2, 
  Clock, 
  AlertTriangle
} from "lucide-react";

// Ensure these imports point to the files you created
import { useAdvisor } from "./hooks/useAdvisor";
import { InsightDisplay } from "./components/InsightDisplay";

// Fix: Corrected path to point to the sibling 'components' folder inside [projectId]
import { ProjectNavBar } from "../components/ProjectNavBar";

export default function AIAdvisorPage() {
  const params = useParams();
  // Safe extraction of projectId from URL
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;

  // 1. Hook Call
  const { 
    history, 
    activeInsight, 
    setActiveInsight, 
    generateInsight, 
    loading, 
    generating,
    error 
  } = useAdvisor(projectId || "");

  // 2. Safety Check
  if (!projectId) return <div className="p-8">Error: Project ID missing</div>;

  // 3. Render
  return (
    <div className="h-full w-full bg-[var(--background)] flex flex-col">
       
       <div className="sticky top-0 z-10 bg-[var(--background)]">
          <ProjectNavBar projectId={projectId} />
       </div>

       <div className="flex-1 overflow-hidden flex">
          
          {/* LEFT SIDEBAR: HISTORY */}
          <aside className="w-80 border-r border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] flex flex-col shrink-0">
             <div className="p-5 border-b border-slate-200 dark:border-slate-800">
                <button 
                    onClick={generateInsight}
                    disabled={generating}
                    className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2 transition-all disabled:opacity-70"
                >
                    {generating ? <Loader2 className="w-4 h-4 animate-spin"/> : <Plus className="w-4 h-4"/>}
                    {generating ? "Thinking..." : "New Analysis"}
                </button>
             </div>

             <div className="flex-1 overflow-y-auto p-3 space-y-2">
                {loading && <div className="text-center p-4 text-xs text-slate-400">Loading history...</div>}
                
                {!loading && history.length === 0 && (
                    <div className="text-center p-8 text-slate-400 border border-dashed border-slate-200 dark:border-slate-800 rounded-xl m-2">
                        <Sparkles className="w-8 h-8 mx-auto mb-2 opacity-50" />
                        <p className="text-xs">No insights generated yet.</p>
                    </div>
                )}

                {history.map((item) => (
                    <button
                        key={item.id}
                        onClick={() => setActiveInsight(item)}
                        className={`w-full text-left p-3 rounded-xl border transition-all group ${
                            activeInsight?.id === item.id 
                                ? "bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800" 
                                : "bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-800 hover:border-indigo-300"
                        }`}
                    >
                        <div className="flex justify-between items-start mb-1">
                            <span className="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-1">
                                <Clock className="w-3 h-3" />
                                {new Date(item.created_at).toLocaleDateString()}
                            </span>
                            {activeInsight?.id === item.id && <div className="w-1.5 h-1.5 rounded-full bg-indigo-500" />}
                        </div>
                        <div className="font-bold text-sm text-slate-800 dark:text-slate-100 line-clamp-2 mb-1">
                            {item.content.headline || "Strategic Review"}
                        </div>
                        {item.simulation_summary && (
                            <div className="text-[10px] text-slate-500 font-mono bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded inline-block">
                                {item.simulation_summary.run_name}
                            </div>
                        )}
                    </button>
                ))}
             </div>
          </aside>

          {/* RIGHT MAIN: CONTENT */}
          <main className="flex-1 overflow-y-auto p-8 bg-slate-50 dark:bg-slate-950">
             <div className="max-w-4xl mx-auto">
                {error && (
                    <div className="mb-6 p-4 bg-rose-50 border border-rose-200 text-rose-600 rounded-xl text-sm flex items-center gap-2">
                        <AlertTriangle className="w-4 h-4" /> {error}
                    </div>
                )}

                {activeInsight ? (
                    <InsightDisplay insight={activeInsight} />
                ) : (
                    <div className="flex flex-col items-center justify-center h-[60vh] text-slate-400">
                        <div className="w-20 h-20 bg-slate-200 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6">
                            <Sparkles className="w-10 h-10 text-slate-400" />
                        </div>
                        <h2 className="text-xl font-bold text-slate-600 dark:text-slate-300">AI Strategic Advisor</h2>
                        <p className="text-sm max-w-md text-center mt-2">
                            Select a past analysis from the sidebar, or generate a new one based on your active simulation data.
                        </p>
                    </div>
                )}
             </div>
          </main>

       </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/types.ts ---\n
// app/(app)/projects/[projectId]/config/types.ts

// --- Upload / Master Data Types (Legacy/Support) ---

export type UploadStatus = "success" | "processing" | "failed" | "none";

export interface LastUpload {
  id?: string;
  project_id: string;
  file_name: string | null;
  status: UploadStatus;
  row_count?: number | null;
  uploaded_at: string | null;
  validation_errors?: Record<string, any> | null;
  original_filename?: string | null;
}

export interface PreviewResponse {
  preview_data: Record<string, any>[];
  total_rows: number;
  columns: string[];
}

// --- NEW: Forecast & Strategy Types ---

export interface ForecastParameters {
  id: string;
  project_id: string;

  // Section A: Economic Reality
  cpi_percentage: number;       // Default 6.0
  discount_rate: number;        // Default 8.0
  previous_allocation: number;  // Default 0

  // Section B: Engineering Reality
  paved_deterioration_rate: "Slow" | "Medium" | "Fast";
  gravel_loss_rate: number;     // mm per year (Default 20)
  climate_stress_factor: "Low" | "Medium" | "High";

  // Section C: Time
  analysis_duration: number;    // Years (3 to 20)

  updated_at: string;
}

// Helper for partial updates (PATCH)
export type ForecastPatch = Partial<ForecastParameters>;

// --- Simulation Results ---

export interface YearlyResult {
  year: number;
  avg_condition_index: number;
  pct_good: number;
  pct_fair: number;
  pct_poor: number;
  total_maintenance_cost: number;
  asset_value: number;
}

export interface SimulationOutput {
  project_id: string;
  year_count: number;
  
  // Time Series Data (for charts)
  yearly_data: YearlyResult[];
  
  // Aggregates (for summary cards)
  total_cost_npv: number;
  final_network_condition: number;
  
  generated_at?: string;
}

// --- Proposal Inputs (Green Blocks) ---

export type ProposalData = {
  id: string;
  project_id: string;
  user_id: string;
  data_source: string;

  // Paved Climate Zones
  paved_arid: number;
  paved_semi_arid: number;
  paved_dry_sub_humid: number;
  paved_moist_sub_humid: number;
  paved_humid: number;

  // Gravel Climate Zones
  gravel_arid: number;
  gravel_semi_arid: number;
  gravel_dry_sub_humid: number;
  gravel_moist_sub_humid: number;
  gravel_humid: number;

  // Indicators
  avg_vci_used: number;
  vehicle_km: number;
  pct_vehicle_km_used: number;
  fuel_sales: number;
  pct_fuel_sales_used: number;
  fuel_option_selected: number;
  target_vci: number;

  extra_inputs: Record<string, any>;

  created_at: string;
  updated_at: string;
};

export type ProposalDataPatch = Partial<
  Pick<
    ProposalData,
    | "paved_arid"
    | "paved_semi_arid"
    | "paved_dry_sub_humid"
    | "paved_moist_sub_humid"
    | "paved_humid"
    | "gravel_arid"
    | "gravel_semi_arid"
    | "gravel_dry_sub_humid"
    | "gravel_moist_sub_humid"
    | "gravel_humid"
    | "avg_vci_used"
    | "vehicle_km"
    | "pct_vehicle_km_used"
    | "fuel_sales"
    | "pct_fuel_sales_used"
    | "fuel_option_selected"
    | "target_vci"
    | "extra_inputs"
  >
>;\n--- ./app/(app)/projects/[projectId]/config/components/ProvincialStatsCard.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { Upload, Save, FileSpreadsheet, AlertCircle, CheckCircle2 } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

interface ProvincialStat {
  province_name: string;
  km_arid: number;
  km_semi_arid: number;
  km_dry_sub_humid: number;
  km_moist_sub_humid: number;
  km_humid: number;
  avg_vci: number;
  vehicle_km: number;
  fuel_sales: number;
}

const PROVINCES = [
  "Eastern Cape", "Free State", "Gauteng", "Kwazulu Natal", 
  "Limpopo", "Mpumalanga", "North West", "Northern Cape", "Western Cape"
];

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export function ProvincialStatsCard({ projectId }: { projectId: string }) {
  const [activeTab, setActiveTab] = useState<"manual" | "upload">("manual");
  const [stats, setStats] = useState<ProvincialStat[]>([]);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [message, setMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);

  // --- 1. Fetch Data on Load ---
  useEffect(() => {
    fetchStats();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  async function fetchStats() {
    try {
      setLoading(true);
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;

      const res = await fetch(`${API_BASE}/api/v1/provincial-stats/${projectId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (res.ok) {
        const data = await res.json();
        // Sort specifically to match the user's expected order
        const sorted = data.sort((a: any, b: any) => a.province_name.localeCompare(b.province_name));
        setStats(sorted);
      }
    } catch (err) {
      console.error("Failed to load stats", err);
    } finally {
      setLoading(false);
    }
  }

  // --- 2. Handle Manual Grid Updates ---
  const handleInputChange = (index: number, field: keyof ProvincialStat, value: string) => {
    const newStats = [...stats];
    newStats[index] = { ...newStats[index], [field]: Number(value) || 0 };
    setStats(newStats);
  };

  async function saveManualChanges() {
    setSaving(true);
    setMessage(null);
    try {
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;

      const res = await fetch(`${API_BASE}/api/v1/provincial-stats/${projectId}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}` 
        },
        body: JSON.stringify(stats),
      });

      if (!res.ok) throw new Error("Failed to save");
      
      setMessage({ type: "success", text: "Updates saved successfully." });
      setTimeout(() => setMessage(null), 3000);
    } catch (err) {
      setMessage({ type: "error", text: "Could not save changes." });
    } finally {
      setSaving(false);
    }
  }

  // --- 3. Handle CSV Upload ---
  async function handleFileUpload(e: React.ChangeEvent<HTMLInputElement>) {
    if (!e.target.files || e.target.files.length === 0) return;
    
    const file = e.target.files[0];
    const formData = new FormData();
    formData.append("file", file);

    setSaving(true);
    setMessage(null);

    try {
      const { data: sessionData } = await supabase.auth.getSession();
      const token = sessionData.session?.access_token;

      const res = await fetch(`${API_BASE}/api/v1/provincial-stats/${projectId}/upload`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: formData,
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || "Upload failed");
      }

      setMessage({ type: "success", text: "Spreadsheet imported! Grid updated." });
      fetchStats(); // Refresh grid with new data
      setActiveTab("manual"); // Switch user back to grid to see results
    } catch (err: any) {
      setMessage({ type: "error", text: err.message });
    } finally {
      setSaving(false);
      // Reset input
      e.target.value = ""; 
    }
  }

  return (
    <div className="bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-xl shadow-sm overflow-hidden">
      {/* Header */}
      <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h3 className="font-semibold text-lg flex items-center gap-2">
            <FileSpreadsheet className="w-5 h-5 text-indigo-500" />
            Provincial Data Inputs
          </h3>
          <p className="text-sm text-slate-500">
            Define the base parameters (Climate, Condition, Traffic) for the 9 provinces.
          </p>
        </div>
        
        {/* Tabs */}
        <div className="flex bg-slate-100 dark:bg-slate-900 p-1 rounded-lg">
          <button
            onClick={() => setActiveTab("manual")}
            className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${
              activeTab === "manual" 
                ? "bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 shadow-sm" 
                : "text-slate-500 hover:text-slate-700"
            }`}
          >
            Grid Input
          </button>
          <button
            onClick={() => setActiveTab("upload")}
            className={`px-3 py-1.5 text-xs font-medium rounded-md transition-all ${
              activeTab === "upload" 
                ? "bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 shadow-sm" 
                : "text-slate-500 hover:text-slate-700"
            }`}
          >
            Upload CSV
          </button>
        </div>
      </div>

      {/* Content */}
      <div className="p-4">
        {message && (
          <div className={`mb-4 p-3 rounded-md text-sm flex items-center gap-2 ${
            message.type === "success" 
              ? "bg-emerald-50 text-emerald-700 border border-emerald-200" 
              : "bg-rose-50 text-rose-700 border border-rose-200"
          }`}>
            {message.type === "success" ? <CheckCircle2 className="w-4 h-4"/> : <AlertCircle className="w-4 h-4"/>}
            {message.text}
          </div>
        )}

        {activeTab === "manual" ? (
          <div className="space-y-4">
             {loading ? (
               <div className="h-40 flex items-center justify-center text-slate-400">Loading data...</div>
             ) : (
              <div className="overflow-x-auto border border-slate-200 dark:border-slate-700 rounded-lg">
                <table className="w-full text-xs text-left">
                  <thead className="bg-slate-50 dark:bg-slate-900/50 text-slate-500 uppercase font-medium">
                    <tr>
                      <th className="px-3 py-2 border-r border-slate-200 dark:border-slate-800 sticky left-0 bg-slate-50 dark:bg-slate-900 z-10">Province</th>
                      <th className="px-2 py-2 text-center" colSpan={5}>Climate Zone (km)</th>
                      <th className="px-2 py-2 border-l border-slate-200 dark:border-slate-800">Avg VCI</th>
                      <th className="px-2 py-2">Veh Km</th>
                      <th className="px-2 py-2">Fuel Sales</th>
                    </tr>
                    <tr className="border-b border-slate-200 dark:border-slate-800">
                      <th className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800"></th>
                      <th className="px-2 py-1 font-normal text-[10px] text-slate-400">Arid</th>
                      <th className="px-2 py-1 font-normal text-[10px] text-slate-400">Semi</th>
                      <th className="px-2 py-1 font-normal text-[10px] text-slate-400">DrySub</th>
                      <th className="px-2 py-1 font-normal text-[10px] text-slate-400">MoistSub</th>
                      <th className="px-2 py-1 font-normal text-[10px] text-slate-400">Humid</th>
                      <th className="border-l border-slate-200 dark:border-slate-800"></th>
                      <th></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100 dark:divide-slate-800/50">
                    {stats.map((row, idx) => (
                      <tr key={row.province_name} className="hover:bg-slate-50/50 dark:hover:bg-slate-800/30">
                        <td className="px-3 py-2 font-medium sticky left-0 bg-[var(--surface-bg)] border-r border-slate-200 dark:border-slate-800 z-10">
                          {row.province_name}
                        </td>
                        {/* Climate Inputs */}
                        {(['km_arid', 'km_semi_arid', 'km_dry_sub_humid', 'km_moist_sub_humid', 'km_humid'] as const).map(field => (
                          <td key={field} className="p-1">
                            <input 
                              type="number" 
                              value={row[field]}
                              onChange={(e) => handleInputChange(idx, field, e.target.value)}
                              className="w-16 bg-transparent border border-transparent hover:border-slate-200 focus:border-indigo-500 rounded px-1 py-0.5 text-right outline-none transition-all"
                            />
                          </td>
                        ))}
                        {/* Other Inputs */}
                        <td className="p-1 border-l border-slate-200 dark:border-slate-800">
                           <input type="number" value={row.avg_vci} onChange={(e) => handleInputChange(idx, 'avg_vci', e.target.value)} className="w-14 bg-transparent border border-transparent hover:border-slate-200 focus:border-indigo-500 rounded px-1 py-0.5 text-right outline-none" />
                        </td>
                        <td className="p-1">
                           <input type="number" value={row.vehicle_km} onChange={(e) => handleInputChange(idx, 'vehicle_km', e.target.value)} className="w-20 bg-transparent border border-transparent hover:border-slate-200 focus:border-indigo-500 rounded px-1 py-0.5 text-right outline-none" />
                        </td>
                        <td className="p-1">
                           <input type="number" value={row.fuel_sales} onChange={(e) => handleInputChange(idx, 'fuel_sales', e.target.value)} className="w-24 bg-transparent border border-transparent hover:border-slate-200 focus:border-indigo-500 rounded px-1 py-0.5 text-right outline-none" />
                        </td>
                      </tr>
                    ))}
                    {stats.length === 0 && (
                      <tr>
                        <td colSpan={9} className="text-center py-8 text-slate-400">
                          No provincial data found. (Did the automatic seed run?)
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
             )}

             <div className="flex justify-end pt-2">
               <button 
                 onClick={saveManualChanges}
                 disabled={saving || loading}
                 className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50"
               >
                 {saving ? <span className="animate-spin">â³</span> : <Save className="w-4 h-4" />}
                 Save Changes
               </button>
             </div>
          </div>
        ) : (
          /* Upload Tab */
          <div className="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl p-10 bg-slate-50/50 dark:bg-slate-900/20">
            <div className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded-full mb-4">
              <Upload className="w-8 h-8 text-indigo-500" />
            </div>
            <h4 className="font-medium text-slate-900 dark:text-slate-100 mb-1">Upload Provincial Spreadsheet</h4>
            <p className="text-sm text-slate-500 mb-6 text-center max-w-sm">
              Upload the CSV or Excel file containing the "Green Blocks" (Climate, Condition, Traffic, Fuel).
            </p>
            
            <label className="cursor-pointer bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-medium py-2 px-6 rounded-lg shadow-sm transition-all">
              <span>Select File</span>
              <input type="file" className="hidden" accept=".csv, .xlsx" onChange={handleFileUpload} />
            </label>
            
            <p className="mt-4 text-xs text-slate-400">Supported: .csv, .xlsx</p>
          </div>
        )}
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/components/RunSimulationCard.tsx ---\n
"use client";

import React, { useState } from "react";
import { Play, Loader2, TrendingUp, ArrowRight, CheckCircle2, Calendar, Layers } from "lucide-react";
import { useRouter } from "next/navigation";
import { useSimulationRun } from "../hooks/useSimulationRun";
import { useProjectMeta } from "../hooks/useProjectMeta";

// --- FIX: Robust formatting function ---
function fmtCurrency(val: any) {
  const v = Number(val);
  if (!Number.isFinite(v)) return "R 0"; // Safety check for null/undefined/NaN

  if (v >= 1_000_000_000) return `R ${(v / 1_000_000_000).toFixed(1)} bn`;
  if (v >= 1_000_000) return `R ${(v / 1_000_000).toFixed(1)} m`;
  return `R ${v.toLocaleString()}`;
}

export function RunSimulationCard({ projectId }: { projectId: string }) {
  const router = useRouter();
  const { runSimulation, isRunning, result, error } = useSimulationRun(projectId);
  const { data: meta } = useProjectMeta(projectId);

  // --- STATE: Pre-Flight Controls ---
  const [startYear, setStartYear] = useState<number | null>(null);
  const [includePaved, setIncludePaved] = useState(true);
  const [includeGravel, setIncludeGravel] = useState(true);

  // Default start year to project year if not manually set
  const currentYear = new Date().getFullYear();
  const baseYear = meta?.start_year || currentYear + 1;
  const activeStartYear = startYear || baseYear;

  // Pass state to the hook
  const handleRun = async () => {
    await runSimulation({
        startYearOverride: activeStartYear,
        includePaved,
        includeGravel
    });
  };

  const handleGoToDashboard = () => {
    router.push(`/projects/${projectId}/dashboard`);
  };

  return (
    <div className="bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-800/50 overflow-hidden relative">
      
      {/* Decorative gradient top */}
      <div className="h-1.5 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500" />

      <div className="p-6">
        
        {/* Header */}
        <div className="mb-6">
            <h2 className="text-base font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
              <Play className="w-4 h-4 text-indigo-500 fill-indigo-500" />
              Simulation Control
            </h2>
            <p className="text-xs text-slate-500 mt-1">
              Configure parameters before generating the proposal.
            </p>
        </div>

        {!result ? (
          /* --- PRE-FLIGHT CONTROLS --- */
          <div className="space-y-5 animate-in fade-in slide-in-from-left-2 duration-300">
             
             {/* 1. Year Selection (Calendar) */}
             <div className="space-y-2">
                <label className="text-[10px] uppercase font-bold text-slate-400 tracking-wider flex items-center gap-1.5">
                    <Calendar className="w-3 h-3" />
                    Start Financial Year
                </label>
                <div className="relative">
                    <select 
                        value={activeStartYear}
                        onChange={(e) => setStartYear(Number(e.target.value))}
                        className="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm px-3 py-2.5 text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none appearance-none cursor-pointer"
                    >
                        {/* Generate next 5 years dynamically */}
                        {Array.from({ length: 5 }).map((_, i) => {
                            const year = baseYear + i;
                            return <option key={year} value={year}>FY {year} / {year + 1}</option>;
                        })}
                    </select>
                    {/* Custom Arrow */}
                    <div className="absolute right-3 top-3 pointer-events-none text-slate-400">
                        <Calendar className="w-4 h-4" />
                    </div>
                </div>
             </div>

             {/* 2. Scope Toggles */}
             <div className="space-y-2">
                <label className="text-[10px] uppercase font-bold text-slate-400 tracking-wider flex items-center gap-1.5">
                    <Layers className="w-3 h-3" />
                    Network Scope
                </label>
                <div className="flex gap-3">
                    <label className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg border text-xs font-medium cursor-pointer transition-all select-none ${includePaved ? 'bg-indigo-50 dark:bg-indigo-900/20 border-indigo-200 dark:border-indigo-800 text-indigo-700 dark:text-indigo-300 shadow-sm' : 'bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500 opacity-60'}`}>
                        <input 
                            type="checkbox" 
                            checked={includePaved} 
                            onChange={(e) => setIncludePaved(e.target.checked)}
                            className="hidden"
                        />
                        {includePaved && <CheckCircle2 className="w-3 h-3" />}
                        <span>Paved</span>
                    </label>
                    <label className={`flex-1 flex items-center justify-center gap-2 px-3 py-2 rounded-lg border text-xs font-medium cursor-pointer transition-all select-none ${includeGravel ? 'bg-amber-50 dark:bg-amber-900/20 border-amber-200 dark:border-amber-800 text-amber-700 dark:text-amber-300 shadow-sm' : 'bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-500 opacity-60'}`}>
                        <input 
                            type="checkbox" 
                            checked={includeGravel} 
                            onChange={(e) => setIncludeGravel(e.target.checked)}
                            className="hidden"
                        />
                        {includeGravel && <CheckCircle2 className="w-3 h-3" />}
                        <span>Gravel</span>
                    </label>
                </div>
             </div>

             {error && (
                <div className="p-3 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-200 text-xs rounded-lg border border-rose-100 dark:border-rose-800 flex items-center gap-2">
                    <div className="w-1.5 h-1.5 rounded-full bg-rose-500" />
                    {error}
                </div>
             )}

             <button
                onClick={handleRun}
                disabled={isRunning || (!includePaved && !includeGravel)}
                className="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 active:scale-[0.98] text-white rounded-xl font-semibold text-sm shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2 transition-all disabled:opacity-70 disabled:cursor-not-allowed disabled:shadow-none"
             >
                {isRunning ? (
                  <>
                    <Loader2 className="w-4 h-4 animate-spin" />
                    Running Simulation...
                  </>
                ) : (
                  <>
                    Run Analysis
                    <ArrowRight className="w-4 h-4" />
                  </>
                )}
             </button>
          </div>
        ) : (
          /* --- RESULT SUMMARY --- */
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div className="p-4 bg-emerald-50/50 dark:bg-emerald-900/10 rounded-xl border border-emerald-100 dark:border-emerald-800/30">
              <div className="flex items-center gap-2 mb-4 text-emerald-700 dark:text-emerald-400 font-bold text-xs uppercase tracking-wide">
                <CheckCircle2 className="w-4 h-4" />
                <span>Proposal Ready (FY{activeStartYear})</span>
              </div>
              
              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Total Ask</div>
                  <div className="text-xl font-black text-slate-900 dark:text-slate-100 tracking-tight">
                    {/* FIX: Add fallback and use safe formatter */}
                    {fmtCurrency(result.total_cost_npv || 0)}
                  </div>
                </div>
                <div>
                  <div className="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Target VCI</div>
                  <div className="text-xl font-black text-slate-900 dark:text-slate-100 flex items-center gap-1 tracking-tight">
                    {(result.final_network_condition || 0).toFixed(1)}
                    <TrendingUp className={`w-4 h-4 ${result.final_network_condition < 50 ? 'text-rose-500' : 'text-emerald-500'}`} />
                  </div>
                </div>
              </div>

               <div className="text-xs text-slate-600 dark:text-slate-400 bg-white dark:bg-slate-900/80 p-3 rounded-lg border border-slate-100 dark:border-slate-800 leading-relaxed">
                  <strong className="text-indigo-600 dark:text-indigo-400">Insight:</strong> Based on the {activeStartYear} start date, this budget prevents a 12% degradation in network quality.
               </div>
            </div>

            <div className="flex gap-2">
                <button
                    onClick={handleRun} // Quick re-run
                    disabled={isRunning}
                    className="flex-1 py-2.5 text-xs font-bold text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                >
                    Recalculate
                </button>
                <button
                    onClick={handleGoToDashboard}
                    className="flex-[2] py-2.5 text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md shadow-indigo-500/20 flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                >
                    View Full Dashboard
                    <ArrowRight className="w-3 h-3" />
                </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/components/ProposalDataSummaryCard.tsx ---\n
"use client";

import React, { useMemo } from "react";
import { Activity, Droplets, Map, Truck } from "lucide-react";
import type { ProposalData } from "../types";

function n(v: any) {
  const x = Number(v);
  return Number.isFinite(x) ? x : 0;
}

function fmt2(v: any) {
  return n(v).toLocaleString("en-ZA", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

function fuelLabel(v: any) {
  const x = Number(v);
  if (x === 1) return "Option 1";
  if (x === 2) return "Option 2";
  if (x === 3) return "Option 3";
  return `Option ${Number.isFinite(x) ? x : 1}`;
}

export function ProposalDataSummaryCard({
  proposal,
}: {
  proposal: ProposalData | null;
}) {
  if (!proposal) return null;

  const totals = useMemo(() => {
    const paved =
      n(proposal.paved_arid) +
      n(proposal.paved_semi_arid) +
      n(proposal.paved_dry_sub_humid) +
      n(proposal.paved_moist_sub_humid) +
      n(proposal.paved_humid);

    const gravel =
      n(proposal.gravel_arid) +
      n(proposal.gravel_semi_arid) +
      n(proposal.gravel_dry_sub_humid) +
      n(proposal.gravel_moist_sub_humid) +
      n(proposal.gravel_humid);

    return { paved, gravel, total: paved + gravel };
  }, [proposal]);

  return (
    <div className="flex flex-col gap-4">
        {/* 1. Hero Stat Card: Network Total */}
        <div className="rounded-2xl bg-gradient-to-br from-indigo-600 to-indigo-700 p-6 text-white shadow-lg">
            <div className="flex items-center gap-3 opacity-80 mb-2">
                <Map className="w-5 h-5" />
                <span className="text-xs font-semibold uppercase tracking-wider">Network Total</span>
            </div>
            <div className="text-4xl font-bold tracking-tight">
                {fmt2(totals.total)} <span className="text-lg font-medium opacity-60">km</span>
            </div>
            <div className="mt-4 flex gap-4 text-xs font-medium opacity-80">
                <div className="flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded">
                    <span className="w-2 h-2 rounded-full bg-emerald-400" />
                    Paved: {fmt2(totals.paved)}
                </div>
                <div className="flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded">
                    <span className="w-2 h-2 rounded-full bg-amber-400" />
                    Gravel: {fmt2(totals.gravel)}
                </div>
            </div>
        </div>

        {/* 2. Details Card */}
        <div className="rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
            <div className="px-5 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
                <h3 className="text-sm font-semibold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                    <Activity className="w-4 h-4 text-indigo-500" />
                    Latest Snapshot
                </h3>
                <div className="text-[10px] text-slate-400 uppercase tracking-wide font-medium">
                    {proposal.updated_at ? new Date(proposal.updated_at).toLocaleDateString() : "New"}
                </div>
            </div>

            <div className="p-2">
                <SummaryRow 
                    icon={<Truck className="w-3.5 h-3.5" />} 
                    label="Vehicle Km" 
                    value={fmt2(proposal.vehicle_km)} 
                />
                <SummaryRow 
                    icon={<span className="text-[10px] font-bold">%</span>} 
                    label="Veh/km Used" 
                    value={`${fmt2(proposal.pct_vehicle_km_used)}%`} 
                />
                <div className="h-px bg-slate-100 dark:bg-slate-800 my-1 mx-4" />
                <SummaryRow 
                    icon={<Droplets className="w-3.5 h-3.5" />} 
                    label="Fuel Sales" 
                    value={fmt2(proposal.fuel_sales)} 
                />
                <SummaryRow 
                    icon={<span className="text-[10px] font-bold">%</span>} 
                    label="Fuel Used" 
                    value={`${fmt2(proposal.pct_fuel_sales_used)}%`} 
                />
                 <div className="h-px bg-slate-100 dark:bg-slate-800 my-1 mx-4" />
                <SummaryRow 
                    label="Avg VCI" 
                    value={fmt2(proposal.avg_vci_used)} 
                    highlight 
                />
                 <SummaryRow 
                    label="Target VCI" 
                    value={fmt2(proposal.target_vci)} 
                    highlight 
                />
            </div>
        </div>
    </div>
  );
}

function SummaryRow({ label, value, icon, highlight }: { label: string; value: string; icon?: React.ReactNode, highlight?: boolean }) {
    return (
        <div className={`flex items-center justify-between px-4 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${highlight ? 'text-indigo-600 dark:text-indigo-400' : 'text-slate-600 dark:text-slate-400'}`}>
            <div className="flex items-center gap-3">
                {icon && <span className="text-slate-400 dark:text-slate-600">{icon}</span>}
                <span className="text-xs font-medium">{label}</span>
            </div>
            <span className={`text-sm font-mono ${highlight ? 'font-bold' : 'font-medium text-slate-900 dark:text-slate-200'}`}>
                {value}
            </span>
        </div>
    );
}\n--- ./app/(app)/projects/[projectId]/config/components/UploadStatusCard.tsx ---\n
// app/(app)/projects/[projectId]/config/components/UploadStatusCard.tsx
"use client";

import React from "react";
import { CheckCircle, AlertTriangle, Clock, Table } from "lucide-react";
import { cn } from "@/lib/utils";
import type { LastUpload, UploadStatus } from "../types";

interface UploadStatusCardProps {
  // current / selected upload
  lastUpload: LastUpload | null;

  // loading + error for the "last upload" / status fetch
  statusLoading: boolean;
  statusError: string | null;

  // optional: full history of uploads for dropdown
  uploadsHistory?: LastUpload[];
  historyLoading?: boolean;
  historyError?: string | null;

  // which upload ID is selected in the dropdown
  selectedUploadId?: string | null;

  // preview state
  previewLoading: boolean;

  // handlers
  onPreview: (uploadId?: string) => void;
  onSelectUpload?: (uploadId: string) => void;
}

function statusColorFromStatus(status: UploadStatus | undefined): string {
  if (status === "success") return "bg-green-500";
  if (status === "processing") return "bg-amber-400";
  if (status === "failed") return "bg-red-500";
  return "bg-slate-300";
}

function statusLabelFromStatus(
  status: UploadStatus | undefined,
  statusLoading: boolean
): string {
  if (status === "success") return "Last upload OK";
  if (status === "processing") return "Upload processing";
  if (status === "failed") return "Last upload failed";
  if (statusLoading) return "Checking statusâ€¦";
  return "No data uploaded yet";
}

function statusIconFromStatus(status: UploadStatus | undefined) {
  if (status === "success") return CheckCircle;
  if (status === "processing") return Clock;
  if (status === "failed") return AlertTriangle;
  return Clock;
}

function formatTimestamp(iso?: string | null): string {
  if (!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("en-ZA", {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

export const UploadStatusCard: React.FC<UploadStatusCardProps> = ({
  lastUpload,
  statusLoading,
  statusError,
  uploadsHistory,
  historyLoading,
  historyError,
  selectedUploadId,
  previewLoading,
  onPreview,
  onSelectUpload,
}) => {
  const status = lastUpload?.status;
  const StatusIcon = statusIconFromStatus(status);
  const statusColor = statusColorFromStatus(status);
  const statusLabel = statusLabelFromStatus(status, statusLoading);

  const hasHistoryDropdown =
    uploadsHistory && uploadsHistory.length > 1 && !!onSelectUpload;

  const effectiveSelectedId =
    selectedUploadId || lastUpload?.id || (uploadsHistory?.[0]?.id ?? "");

  const canPreview =
    !!lastUpload && lastUpload.status === "success" && !previewLoading;

  const handlePreviewClick = () => {
    if (!lastUpload?.id) return;
    onPreview(lastUpload.id);
  };

  const handleSelectChange = (
    e: React.ChangeEvent<HTMLSelectElement>
  ): void => {
    const newId = e.target.value;
    if (onSelectUpload && newId) {
      onSelectUpload(newId);
    }
  };

  return (
    <div className="min-w-[260px]">
      <div className="rounded-xl border border-slate-200/40 dark:border-slate-800/60 px-3 py-2 text-xs bg-white/60 dark:bg-slate-900/40 shadow-sm">
        {/* Top row: status dot + label */}
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span
              className={cn(
                "h-2.5 w-2.5 rounded-full shadow-sm",
                statusColor
              )}
            />
            <span className="font-semibold text-slate-800 dark:text-slate-100">
              {statusLabel}
            </span>
          </div>
          <StatusIcon className="h-3.5 w-3.5 text-slate-400" />
        </div>

        {/* History dropdown (optional) */}
        {hasHistoryDropdown && (
          <div className="mt-2">
            <label className="block text-[10px] mb-1 text-slate-500 dark:text-slate-400">
              Upload history
            </label>
            <select
              className={cn(
                "w-full rounded-lg border border-slate-300 dark:border-slate-700",
                "bg-white/80 dark:bg-slate-900/60",
                "px-2 py-1 text-[10px] focus:outline-none focus:ring-1 focus:ring-slate-400"
              )}
              value={effectiveSelectedId}
              onChange={handleSelectChange}
              disabled={!!historyLoading}
            >
              {uploadsHistory!.map((u) => (
                <option key={u.id} value={u.id ?? ""}>
                  {u.file_name || u.original_filename || "Untitled file"} â€¢{" "}
                  {formatTimestamp(u.uploaded_at)} â€¢{" "}
                  {typeof u.row_count === "number"
                    ? `${u.row_count} rows`
                    : "rows ?"}
                </option>
              ))}
            </select>
          </div>
        )}

        <div className="mt-1 space-y-0.5 text-[10px] text-slate-500 dark:text-slate-400">
          {/* Error messages */}
          {statusError && (
            <div className="text-red-500 text-[10px]">{statusError}</div>
          )}
          {historyError && (
            <div className="text-red-500 text-[10px]">{historyError}</div>
          )}

          {/* Last upload details */}
          {lastUpload ? (
            <>
              <div className="truncate">
                File:{" "}
                <span className="font-medium">
                  {lastUpload.file_name ||
                    lastUpload.original_filename ||
                    "â€”"}
                </span>
              </div>
              <div>
                When:{" "}
                <span className="font-medium">
                  {formatTimestamp(lastUpload.uploaded_at)}
                </span>
              </div>
              {typeof lastUpload.row_count === "number" && (
                <div>Rows: {lastUpload.row_count}</div>
              )}

              {/* Validation errors summary (if failed) */}
              {lastUpload.status === "failed" &&
                lastUpload.validation_errors && (
                  <div className="mt-1 text-[10px] text-red-500">
                    Validation errors detected. Check missing columns or file
                    format.
                  </div>
                )}
            </>
          ) : !statusError && !statusLoading ? (
            <div>No uploads yet for this project.</div>
          ) : null}
        </div>

        {/* View data button */}
        <div className="mt-2 flex justify-end">
          <button
            type="button"
            disabled={!canPreview}
            onClick={handlePreviewClick}
            className={cn(
              "inline-flex items-center gap-1 rounded-lg px-2.5 py-1 text-[10px] font-medium border",
              "border-slate-300 dark:border-slate-700",
              "text-slate-700 dark:text-slate-200",
              "disabled:opacity-50 disabled:cursor-not-allowed"
            )}
          >
            <Table className="h-3 w-3" />
            {previewLoading ? "Loadingâ€¦" : "View data"}
          </button>
        </div>
      </div>
    </div>
  );
};\n--- ./app/(app)/projects/[projectId]/config/components/DataPreviewTable.tsx ---\n
// app/(app)/projects/[projectId]/config/components/DataPreviewTable.tsx
"use client";

import React from "react";
import { Table as TableIcon } from "lucide-react";
import type { PreviewResponse } from "../types";

type DataPreviewTableProps = {
  preview: PreviewResponse;
};

export const DataPreviewTable: React.FC<DataPreviewTableProps> = ({
  preview,
}) => {
  const { preview_data, total_rows, columns } = preview;
  const shownCount = preview_data.length;

  return (
    <div className="mt-6 text-xs">
      {/* Header row */}
      <div className="mb-2 flex items-center justify-between">
        <div className="font-semibold flex items-center gap-2">
          <TableIcon className="h-3.5 w-3.5" />
          <span>Master data preview</span>
        </div>
        <div className="text-[10px] text-slate-500 dark:text-slate-400">
          Showing{" "}
          <span className="font-medium">
            {shownCount.toLocaleString("en-ZA")}
          </span>{" "}
          of{" "}
          <span className="font-medium">
            {total_rows.toLocaleString("en-ZA")}
          </span>{" "}
          rows
        </div>
      </div>

      {/* Table */}
      <div className="overflow-auto max-h-64 border border-slate-200 dark:border-slate-700 rounded-lg">
        <table className="min-w-full text-[11px]">
          <thead className="bg-slate-50 dark:bg-slate-800">
            <tr>
              {columns.map((col) => (
                <th
                  key={col}
                  className="px-2 py-1 text-left font-semibold whitespace-nowrap"
                >
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {preview_data.map((row, i) => (
              <tr
                key={i}
                className={
                  i % 2 === 0
                    ? ""
                    : "bg-slate-50/60 dark:bg-slate-900/30"
                }
              >
                {columns.map((col) => {
                  const value = (row as Record<string, any>)[col];
                  const display =
                    value === null || value === undefined || value === ""
                      ? "â€”"
                      : String(value);

                  return (
                    <td
                      key={col}
                      className="px-2 py-1 whitespace-nowrap max-w-[160px] truncate"
                      title={display === "â€”" ? "" : display}
                    >
                      {display}
                    </td>
                  );
                })}
              </tr>
            ))}

            {preview_data.length === 0 && (
              <tr>
                <td
                  colSpan={columns.length || 1}
                  className="px-2 py-3 text-center text-[11px] text-slate-500"
                >
                  No rows available in preview.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};\n--- ./app/(app)/projects/[projectId]/config/components/ScenarioAssumptionsCard.tsx ---\n
"use client";

import React from "react";
import { useForecast } from "../hooks/useForecast";
import { TrendingUp, Clock, AlertTriangle, Droplets, Gauge } from "lucide-react";

export function ScenarioAssumptionsCard({ projectId }: { projectId: string }) {
  const { data, loading, saving, updateField } = useForecast(projectId);

  if (loading) {
    return <div className="h-48 bg-slate-100 dark:bg-slate-900 animate-pulse rounded-xl" />;
  }

  if (!data) return null;

  return (
    <div className="bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-xl shadow-sm overflow-hidden">
      {/* Header */}
      <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
        <div>
          <h3 className="font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <TrendingUp className="w-4 h-4 text-indigo-500" />
            Forecast Strategy
          </h3>
          <p className="text-xs text-slate-500">Define the variables for the 2027/28 projection.</p>
        </div>
        {saving && <span className="text-[10px] text-indigo-500 animate-pulse font-medium">Saving...</span>}
      </div>

      <div className="p-6 grid gap-8 md:grid-cols-3">
        
        {/* COL 1: ECONOMICS */}
        <div className="space-y-4">
          <h4 className="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Economic Reality</h4>
          
          <div className="space-y-1">
            <label className="text-xs font-medium text-slate-600 dark:text-slate-300">CPI Inflation</label>
            <div className="flex items-center gap-2">
              <input 
                type="number" 
                value={data.cpi_percentage}
                onChange={(e) => updateField("cpi_percentage", Number(e.target.value))}
                className="w-20 p-1.5 text-sm border rounded bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700"
              />
              <span className="text-sm text-slate-500">%</span>
            </div>
          </div>

          <div className="space-y-1">
            <label className="text-xs font-medium text-slate-600 dark:text-slate-300">Prev. Allocation</label>
            <div className="flex items-center gap-2">
              <span className="text-sm text-slate-500">R</span>
              <input 
                type="number"
                value={data.previous_allocation}
                onChange={(e) => updateField("previous_allocation", Number(e.target.value))} 
                className="w-full p-1.5 text-sm border rounded bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700"
              />
            </div>
            <p className="text-[10px] text-slate-400">Used to calculate real budget growth/decline.</p>
          </div>
        </div>

        {/* COL 2: ENGINEERING */}
        <div className="space-y-4">
          <h4 className="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Engineering & Decay</h4>
          
          <div className="space-y-1">
             <label className="text-xs font-medium text-slate-600 dark:text-slate-300 flex items-center gap-1">
                <AlertTriangle className="w-3 h-3 text-amber-500"/> Paved Deterioration
             </label>
             <div className="flex bg-slate-100 dark:bg-slate-800 rounded-lg p-1">
                {(["Slow", "Medium", "Fast"] as const).map((opt) => (
                    <button
                        key={opt}
                        onClick={() => updateField("paved_deterioration_rate", opt)}
                        className={`flex-1 text-xs py-1 rounded-md transition-all ${data.paved_deterioration_rate === opt ? 'bg-white dark:bg-slate-700 shadow text-indigo-600 dark:text-indigo-400 font-medium' : 'text-slate-500 hover:text-slate-700'}`}
                    >
                        {opt}
                    </button>
                ))}
             </div>
          </div>

           <div className="space-y-1">
            <label className="text-xs font-medium text-slate-600 dark:text-slate-300 flex items-center gap-1">
                <Droplets className="w-3 h-3 text-blue-500"/> Gravel Loss Rate
            </label>
            <div className="flex items-center gap-2">
              <input 
                type="number"
                value={data.gravel_loss_rate}
                onChange={(e) => updateField("gravel_loss_rate", Number(e.target.value))}
                className="w-20 p-1.5 text-sm border rounded bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700"
              />
              <span className="text-xs text-slate-500">mm / year</span>
            </div>
          </div>
        </div>

        {/* COL 3: TIME */}
        <div className="space-y-4">
           <h4 className="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Time Horizon</h4>
           
           <div className="bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-4 text-center border border-indigo-100 dark:border-indigo-800/30">
              <Clock className="w-6 h-6 text-indigo-500 mx-auto mb-2" />
              <div className="text-2xl font-bold text-slate-900 dark:text-slate-100">
                {data.analysis_duration} <span className="text-sm font-medium text-slate-500">Years</span>
              </div>
              <input 
                type="range" 
                min="3" 
                max="20" 
                value={data.analysis_duration}
                onChange={(e) => updateField("analysis_duration", Number(e.target.value))}
                className="w-full mt-3 accent-indigo-600"
              />
              <p className="text-[10px] text-indigo-600/70 dark:text-indigo-400/70 mt-1">
                 Projection until {new Date().getFullYear() + 1 + data.analysis_duration}
              </p>
           </div>
        </div>

      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/components/ProposalInputsCard.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { Loader2, Save, AlertCircle, CheckCircle2 } from "lucide-react";
import type { ProposalData, ProposalDataPatch } from "../types";

type Props = {
  proposal: ProposalData | null;
  saving: boolean;
  onSave: (patch: ProposalDataPatch) => Promise<void> | void;
};

function n(v: any) {
  const x = Number(v);
  return Number.isFinite(x) ? x : 0;
}

// Cleaner Input Style with transition
const INPUT_BASE =
  "w-full rounded-md border text-right px-3 py-2 text-sm font-mono transition-all duration-200 " +
  "bg-white text-slate-900 border-slate-200 " +
  "placeholder:text-slate-300 " +
  "focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 " +
  "dark:bg-slate-950/50 dark:text-slate-100 dark:border-slate-800 " +
  "dark:placeholder:text-slate-600";

export function ProposalInputsCard({ proposal, saving, onSave }: Props) {
  const [dirty, setDirty] = useState(false);

  // Local form state
  const [form, setForm] = useState<ProposalDataPatch>({
    paved_arid: 0, paved_semi_arid: 0, paved_dry_sub_humid: 0, paved_moist_sub_humid: 0, paved_humid: 0,
    gravel_arid: 0, gravel_semi_arid: 0, gravel_dry_sub_humid: 0, gravel_moist_sub_humid: 0, gravel_humid: 0,
    avg_vci_used: 0, vehicle_km: 0, pct_vehicle_km_used: 0, fuel_sales: 0, pct_fuel_sales_used: 0, fuel_option_selected: 1, target_vci: 45,
  });

  useEffect(() => {
    if (!proposal) return;
    setForm({
      paved_arid: proposal.paved_arid, paved_semi_arid: proposal.paved_semi_arid, paved_dry_sub_humid: proposal.paved_dry_sub_humid, paved_moist_sub_humid: proposal.paved_moist_sub_humid, paved_humid: proposal.paved_humid,
      gravel_arid: proposal.gravel_arid, gravel_semi_arid: proposal.gravel_semi_arid, gravel_dry_sub_humid: proposal.gravel_dry_sub_humid, gravel_moist_sub_humid: proposal.gravel_moist_sub_humid, gravel_humid: proposal.gravel_humid,
      avg_vci_used: proposal.avg_vci_used, vehicle_km: proposal.vehicle_km, pct_vehicle_km_used: proposal.pct_vehicle_km_used, fuel_sales: proposal.fuel_sales, pct_fuel_sales_used: proposal.pct_fuel_sales_used, fuel_option_selected: proposal.fuel_option_selected, target_vci: proposal.target_vci,
    });
    setDirty(false);
  }, [proposal]);

  const totals = useMemo(() => {
    const paved = n(form.paved_arid) + n(form.paved_semi_arid) + n(form.paved_dry_sub_humid) + n(form.paved_moist_sub_humid) + n(form.paved_humid);
    const gravel = n(form.gravel_arid) + n(form.gravel_semi_arid) + n(form.gravel_dry_sub_humid) + n(form.gravel_moist_sub_humid) + n(form.gravel_humid);
    return { paved, gravel, total: paved + gravel };
  }, [form]);

  const setField = (key: keyof ProposalDataPatch, value: any) => {
    setForm((prev) => ({ ...prev, [key]: value }));
    setDirty(true);
  };

  const handleSave = async () => {
    await onSave({
      ...form,
      // Ensure numbers are sanitized before sending
      paved_arid: n(form.paved_arid), paved_semi_arid: n(form.paved_semi_arid), paved_dry_sub_humid: n(form.paved_dry_sub_humid), paved_moist_sub_humid: n(form.paved_moist_sub_humid), paved_humid: n(form.paved_humid),
      gravel_arid: n(form.gravel_arid), gravel_semi_arid: n(form.gravel_semi_arid), gravel_dry_sub_humid: n(form.gravel_dry_sub_humid), gravel_moist_sub_humid: n(form.gravel_moist_sub_humid), gravel_humid: n(form.gravel_humid),
      avg_vci_used: n(form.avg_vci_used), vehicle_km: n(form.vehicle_km), pct_vehicle_km_used: n(form.pct_vehicle_km_used), fuel_sales: n(form.fuel_sales), pct_fuel_sales_used: n(form.pct_fuel_sales_used), fuel_option_selected: Number(form.fuel_option_selected ?? 1), target_vci: n(form.target_vci),
    });
    setDirty(false);
  };

  return (
    <div className="rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200 dark:border-slate-800 overflow-hidden">
      
      {/* Header Bar */}
      <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100 dark:border-slate-800">
        <div>
          <h2 className="text-base font-semibold text-slate-900 dark:text-slate-100">Proposal Inputs</h2>
          <p className="text-xs text-slate-500 dark:text-slate-400">Enter base values per climate zone.</p>
        </div>
        
        <button
          onClick={handleSave}
          disabled={saving || !dirty}
          className={`
            inline-flex items-center gap-2 px-4 py-2 rounded-lg text-xs font-semibold shadow-sm transition-all
            ${dirty 
                ? 'bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-md hover:scale-105' 
                : 'bg-slate-100 text-slate-400 dark:bg-slate-800 dark:text-slate-600 cursor-not-allowed'
            }
          `}
        >
          {saving ? <Loader2 className="h-3.5 w-3.5 animate-spin" /> : dirty ? <Save className="h-3.5 w-3.5" /> : <CheckCircle2 className="h-3.5 w-3.5"/>}
          {saving ? "Saving..." : dirty ? "Save Changes" : "Saved"}
        </button>
      </div>

      <div className="p-6 space-y-8">
        
        {/* NETWORK SPLIT SECTION */}
        <div className="grid lg:grid-cols-2 gap-6">
            
            {/* PAVED CARD */}
            <div className="bg-slate-50/50 dark:bg-slate-900/30 rounded-xl border border-slate-200/50 dark:border-slate-800/50 p-5">
                <div className="flex items-center justify-between mb-4 pb-2 border-b border-slate-200/50 dark:border-slate-800/50">
                    <div className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-emerald-400"></span>
                        <h3 className="text-sm font-semibold text-slate-700 dark:text-slate-300">Paved</h3>
                    </div>
                    <span className="text-xs font-mono font-medium bg-white dark:bg-slate-950 px-2 py-1 rounded border border-slate-200 dark:border-slate-800">
                        Total: {totals.paved.toFixed(2)} km
                    </span>
                </div>
                <div className="space-y-3">
                    <NumberField label="Arid" value={form.paved_arid} onChange={(v) => setField("paved_arid", v)} unit="km" />
                    <NumberField label="Semi-arid" value={form.paved_semi_arid} onChange={(v) => setField("paved_semi_arid", v)} unit="km" />
                    <NumberField label="Dry sub-humid" value={form.paved_dry_sub_humid} onChange={(v) => setField("paved_dry_sub_humid", v)} unit="km" />
                    <NumberField label="Moist sub-humid" value={form.paved_moist_sub_humid} onChange={(v) => setField("paved_moist_sub_humid", v)} unit="km" />
                    <NumberField label="Humid" value={form.paved_humid} onChange={(v) => setField("paved_humid", v)} unit="km" />
                </div>
            </div>

            {/* GRAVEL CARD */}
            <div className="bg-slate-50/50 dark:bg-slate-900/30 rounded-xl border border-slate-200/50 dark:border-slate-800/50 p-5">
                 <div className="flex items-center justify-between mb-4 pb-2 border-b border-slate-200/50 dark:border-slate-800/50">
                    <div className="flex items-center gap-2">
                        <span className="w-2 h-2 rounded-full bg-amber-400"></span>
                        <h3 className="text-sm font-semibold text-slate-700 dark:text-slate-300">Gravel</h3>
                    </div>
                    <span className="text-xs font-mono font-medium bg-white dark:bg-slate-950 px-2 py-1 rounded border border-slate-200 dark:border-slate-800">
                        Total: {totals.gravel.toFixed(2)} km
                    </span>
                </div>
                <div className="space-y-3">
                    <NumberField label="Arid" value={form.gravel_arid} onChange={(v) => setField("gravel_arid", v)} unit="km" />
                    <NumberField label="Semi-arid" value={form.gravel_semi_arid} onChange={(v) => setField("gravel_semi_arid", v)} unit="km" />
                    <NumberField label="Dry sub-humid" value={form.gravel_dry_sub_humid} onChange={(v) => setField("gravel_dry_sub_humid", v)} unit="km" />
                    <NumberField label="Moist sub-humid" value={form.gravel_moist_sub_humid} onChange={(v) => setField("gravel_moist_sub_humid", v)} unit="km" />
                    <NumberField label="Humid" value={form.gravel_humid} onChange={(v) => setField("gravel_humid", v)} unit="km" />
                </div>
            </div>
        </div>

        {/* INDICATORS SECTION */}
        <div>
            <h3 className="text-xs font-bold uppercase tracking-wider text-slate-400 mb-3 ml-1">Key Indicators</h3>
            <div className="bg-white dark:bg-slate-900/40 rounded-xl border border-slate-200 dark:border-slate-800 p-5 grid gap-x-6 gap-y-4 sm:grid-cols-2 lg:grid-cols-3">
                <NumberField label="Avg VCI used" value={form.avg_vci_used} onChange={(v) => setField("avg_vci_used", v)} />
                <NumberField label="Vehicle-km" value={form.vehicle_km} onChange={(v) => setField("vehicle_km", v)} unit="km" />
                <NumberField label="% vehicle-km used" value={form.pct_vehicle_km_used} onChange={(v) => setField("pct_vehicle_km_used", v)} unit="%" />
                <NumberField label="Fuel sales" value={form.fuel_sales} onChange={(v) => setField("fuel_sales", v)} unit="L" />
                <NumberField label="% fuel sales used" value={form.pct_fuel_sales_used} onChange={(v) => setField("pct_fuel_sales_used", v)} unit="%" />
                
                <SelectField
                label="Fuel option selected"
                value={String(form.fuel_option_selected ?? 1)}
                onChange={(v) => setField("fuel_option_selected", Number(v))}
                options={[
                    { label: "Option 1", value: "1" },
                    { label: "Option 2", value: "2" },
                    { label: "Option 3", value: "3" },
                ]}
                />

                <NumberField label="Target VCI" value={form.target_vci} onChange={(v) => setField("target_vci", v)} />
            </div>
        </div>
      </div>
      
      {/* Footer Status Bar */}
      <div className="bg-slate-50 dark:bg-slate-900/50 px-6 py-2 border-t border-slate-100 dark:border-slate-800 flex justify-end">
          {dirty ? (
             <span className="text-[10px] text-amber-600 dark:text-amber-500 font-medium flex items-center gap-1">
                <AlertCircle className="w-3 h-3"/> Unsaved Changes
             </span>
          ) : (
            <span className="text-[10px] text-slate-400 font-medium flex items-center gap-1">
                All changes saved
             </span>
          )}
      </div>
    </div>
  );
}

function NumberField({ label, value, onChange, unit }: { label: string; value: any; onChange: (v: number) => void; unit?: string }) {
  return (
    <div className="flex items-center justify-between gap-4">
      <label className="text-xs font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap">
        {label}
      </label>
      <div className="relative w-28 sm:w-32">
        <input
          type="number"
          inputMode="decimal"
          className={`${INPUT_BASE} ${unit ? 'pr-8' : ''}`} // Make room for unit
          value={value ?? 0}
          onFocus={(e) => e.target.select()} // Auto-select on click
          onChange={(e) => onChange(Number(e.target.value))}
        />
        {unit && (
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-400 pointer-events-none">
                {unit}
            </span>
        )}
      </div>
    </div>
  );
}

function SelectField({ label, value, onChange, options }: { label: string; value: string; onChange: (v: string) => void; options: { label: string; value: string }[] }) {
  return (
    <div className="flex items-center justify-between gap-4">
      <label className="text-xs font-medium text-slate-500 dark:text-slate-400">
        {label}
      </label>
      <select
        className={`${INPUT_BASE} w-28 sm:w-32 cursor-pointer`}
        value={value}
        onChange={(e) => onChange(e.target.value)}
      >
        {options.map((o) => (
          <option key={o.value} value={o.value}>
            {o.label}
          </option>
        ))}
      </select>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/components/NetworkSnapshotCard.tsx ---\n
"use client";

import React from "react";
import { Activity, Coins, Layers, BarChart3, RefreshCw } from "lucide-react";
import { useNetworkSnapshot } from "../hooks/useNetworkSnapshot";

// --- FIX: Safe formatting functions ---
function fmtCurrency(val: any) {
  const v = Number(val); // Convert to number
  if (!Number.isFinite(v)) return "R 0"; // Safety check

  if (v >= 1_000_000_000) return `R ${(v / 1_000_000_000).toFixed(1)} Billion`;
  if (v >= 1_000_000) return `R ${(v / 1_000_000).toFixed(1)} Million`;
  return `R ${v.toLocaleString()}`;
}

function fmtNum(val: any) {
  const v = Number(val);
  if (!Number.isFinite(v)) return "0";
  return v.toLocaleString("en-ZA", { maximumFractionDigits: 0 });
}

export function NetworkSnapshotCard({ projectId }: { projectId: string }) {
  const { data, loading, error, refetch } = useNetworkSnapshot(projectId);

  // Determine health color based on VCI (Default to 0 if data missing)
  const vci = data?.avgVci || 0;
  let healthColor = "bg-rose-500"; 
  let healthText = "Critical";
  
  if (vci > 85) { healthColor = "bg-emerald-500"; healthText = "Excellent"; }
  else if (vci > 70) { healthColor = "bg-green-500"; healthText = "Good"; }
  else if (vci > 50) { healthColor = "bg-amber-500"; healthText = "Fair"; }
  else if (vci > 30) { healthColor = "bg-orange-500"; healthText = "Poor"; }

  // Safe variables for rendering
  const totalLength = data?.totalLengthKm || 0;
  const pavedLength = data?.pavedLengthKm || 0;
  const gravelLength = data?.gravelLengthKm || 0;
  const assetValue = data?.assetValue || 0;

  return (
    <div className="bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-800/50 overflow-hidden">
      
      {/* Header */}
      <div className="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-900/50">
        <div>
          <h2 className="text-base font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
            <Activity className="w-4 h-4 text-indigo-500" />
            Asset Health Profile
          </h2>
          <p className="text-xs text-slate-500">Current Replacement Cost & Condition</p>
        </div>
        <button 
          onClick={refetch} 
          disabled={loading}
          className="text-slate-400 hover:text-indigo-500 transition-colors"
        >
          <RefreshCw className={`w-4 h-4 ${loading ? "animate-spin" : ""}`} />
        </button>
      </div>

      {loading ? (
        <div className="p-8 flex justify-center">
            <div className="w-8 h-8 border-4 border-indigo-200 border-t-indigo-500 rounded-full animate-spin" />
        </div>
      ) : !data || totalLength === 0 ? (
        <div className="p-8 text-center text-sm text-slate-400">
           No network data defined. 
           <br/>Start by entering inputs on the left.
        </div>
      ) : (
        <div className="divide-y divide-slate-100 dark:divide-slate-800">
            
            {/* 1. HERO: ASSET VALUE (CRC) */}
            <div className="p-6">
                <div className="flex items-center gap-2 mb-1">
                    <Coins className="w-4 h-4 text-slate-400" />
                    <span className="text-xs font-bold uppercase tracking-wider text-slate-500">Net Asset Value (CRC)</span>
                </div>
                <div className="text-3xl font-black text-slate-900 dark:text-white tracking-tight">
                    {fmtCurrency(assetValue)}
                </div>
                <p className="text-xs text-slate-400 mt-1">
                    Estimated replacement cost based on {fmtNum(totalLength)} km network.
                </p>
            </div>

            {/* 2. VCI GAUGE */}
            <div className="p-6">
                <div className="flex justify-between items-end mb-2">
                    <div className="flex items-center gap-2">
                        <BarChart3 className="w-4 h-4 text-slate-400" />
                        <span className="text-xs font-bold uppercase tracking-wider text-slate-500">Network Condition (VCI)</span>
                    </div>
                    <div className="text-right">
                        <span className="text-2xl font-bold text-slate-900 dark:text-white">{vci.toFixed(1)}</span>
                        <span className="text-xs text-slate-400 ml-1">/ 100</span>
                    </div>
                </div>
                
                {/* Progress Bar */}
                <div className="h-3 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden relative">
                    <div 
                        className={`h-full ${healthColor} transition-all duration-1000 ease-out`} 
                        style={{ width: `${Math.min(vci, 100)}%` }} 
                    />
                </div>
                <div className="flex justify-between mt-2 text-xs font-medium">
                    <span className="text-slate-400">Critical</span>
                    <span className={healthColor.replace('bg-', 'text-')}>{healthText} Condition</span>
                    <span className="text-slate-400">Perfect</span>
                </div>
            </div>

            {/* 3. ASSET MIX */}
            <div className="p-6 bg-slate-50/30 dark:bg-slate-900/30">
                <div className="flex items-center gap-2 mb-4">
                    <Layers className="w-4 h-4 text-slate-400" />
                    <span className="text-xs font-bold uppercase tracking-wider text-slate-500">Asset Composition</span>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                    <div className="p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div className="text-xs text-slate-400 mb-1">Paved Network</div>
                        <div className="text-lg font-bold text-slate-900 dark:text-slate-100">
                            {fmtNum(pavedLength)} <span className="text-xs font-normal text-slate-400">km</span>
                        </div>
                        <div className="h-1 w-full bg-slate-100 dark:bg-slate-700 mt-2 rounded-full overflow-hidden">
                             <div className="h-full bg-indigo-500" style={{ width: `${totalLength > 0 ? (pavedLength / totalLength) * 100 : 0}%` }} />
                        </div>
                    </div>

                    <div className="p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm">
                        <div className="text-xs text-slate-400 mb-1">Gravel Network</div>
                        <div className="text-lg font-bold text-slate-900 dark:text-slate-100">
                            {fmtNum(gravelLength)} <span className="text-xs font-normal text-slate-400">km</span>
                        </div>
                        <div className="h-1 w-full bg-slate-100 dark:bg-slate-700 mt-2 rounded-full overflow-hidden">
                             <div className="h-full bg-amber-500" style={{ width: `${totalLength > 0 ? (gravelLength / totalLength) * 100 : 0}%` }} />
                        </div>
                    </div>
                </div>
            </div>

        </div>
      )}
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useForecast.ts ---\n
"use client";

import { useState, useEffect, useRef, useCallback } from "react";
import { supabase } from "@/lib/supabaseClient";
import { ForecastParameters, ForecastPatch } from "../types";

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export function useForecast(projectId: string) {
  const [data, setData] = useState<ForecastParameters | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  
  // Ref for debouncing saves
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  const fetchData = useCallback(async () => {
    if (!projectId) return;
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}/forecast`, {
        headers: { Authorization: `Bearer ${session.access_token}` },
      });

      if (res.ok) {
        setData(await res.json());
      }
    } catch (err) {
      console.error("Failed to load forecast params", err);
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // Optimistic Update + Debounced Save
  const updateField = (key: keyof ForecastParameters, value: any) => {
    if (!data) return;

    // 1. Optimistic Update
    const updated = { ...data, [key]: value };
    setData(updated);
    setSaving(true);

    // 2. Debounce Save
    if (timeoutRef.current) clearTimeout(timeoutRef.current);

    timeoutRef.current = setTimeout(async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const payload: ForecastPatch = { [key]: value };

        await fetch(`${API_BASE}/api/v1/projects/${projectId}/forecast`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(payload),
        });
      } catch (err) {
        console.error("Save failed", err);
      } finally {
        setSaving(false);
      }
    }, 600); // 600ms delay
  };

  return { data, loading, saving, updateField };
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useSimulationRun.ts ---\n
"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config"; 
import { SimulationOutput } from "../types";

export type SimulationOptions = {
  startYearOverride?: number | null;
  includePaved: boolean;
  includeGravel: boolean;
};

export function useSimulationRun(projectId: string) {
  const [result, setResult] = useState<SimulationOutput | null>(null);
  const [isRunning, setIsRunning] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const runSimulation = async (options: SimulationOptions) => {
    setIsRunning(true);
    setError(null);
    setResult(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      // ðŸ‘‡ FIX: Match Backend Pydantic Schema exactly
      const payload = {
        startYearOverride: options.startYearOverride, // Backend expects snake_case alias or this camelCase
        includePaved: options.includePaved,            
        includeGravel: options.includeGravel           
      };

      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/run`,
        {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}` 
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || "Simulation run failed.");
      }

      // ðŸ‘‡ FIX: Unwrap the 'results_payload' from the history wrapper
      const wrapper = await res.json();
      setResult(wrapper.results_payload || null);
      
    } catch (err: any) {
      console.error("Simulation error:", err);
      setError(err.message || "An unexpected error occurred.");
    } finally {
      setIsRunning(false);
    }
  };

  return {
    runSimulation,
    isRunning,
    error,
    result
  };
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useProjectMeta.ts ---\n
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";

// 1. We define the shape of the data here
type ProjectMeta = {
  id: string;
  province: string;
  start_year: number;
  project_name: string; // <--- ADDED THIS
};

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export function useProjectMeta(projectId: string) {
  const [data, setData] = useState<ProjectMeta | null>(null);
  const [loading, setLoading] = useState(true);

  const fetchMeta = useCallback(async () => {
    if (!projectId) return;
    setLoading(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) return;

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (res.ok) {
        const json = await res.json();
        setData(json);
      }
    } catch (err) {
      console.error("Failed to fetch project meta", err);
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchMeta();
  }, [fetchMeta]);

  return { data, loading };
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useMasterDataUpload.ts ---\n
// app/(app)/projects/[projectId]/config/hooks/useMasterDataUpload.ts
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
// ðŸ‘‡ IMPORT THE CENTRAL CONFIG
import { API_BASE_URL } from "@/lib/config";
import type { LastUpload, PreviewResponse, UploadStatus } from "../types";

/**
 * Map whatever the API gives us to our UI status.
 * Handles things like "validated", "ready", "failed", etc.
 */
function mapApiStatusToUiStatus(
  rawStatus: string | null | undefined,
  rowCount?: number | null
): UploadStatus {
  const s = rawStatus?.toLowerCase();

  if (s === "success" || s === "validated" || s === "ready") {
    return "success";
  }

  if (s === "processing" || s === "uploading" || s === "pending") {
    return "processing";
  }

  if (
    s === "failed" ||
    s === "validation_failed" ||
    s === "error" ||
    s === "invalid"
  ) {
    return "failed";
  }

  // Fallback: if we clearly have rows, treat as success
  if (typeof rowCount === "number" && rowCount > 0) {
    return "success";
  }

  return "none";
}

export function useMasterDataUpload(projectId: string) {
  // -------------------------------------------------------------
  // File + upload state
  // -------------------------------------------------------------
  const [file, setFile] = useState<File | null>(null);
  const [status, setStatus] = useState<
    "idle" | "uploading" | "processing" | "ready"
  >("idle");
  const [error, setError] = useState<string | null>(null);

  // -------------------------------------------------------------
  // Last-upload + history
  // -------------------------------------------------------------
  const [lastUpload, setLastUpload] = useState<LastUpload | null>(null);
  const [statusLoading, setStatusLoading] = useState(false);
  const [statusError, setStatusError] = useState<string | null>(null);

  const [uploadsHistory, setUploadsHistory] = useState<LastUpload[]>([]);
  const [historyLoading, setHistoryLoading] = useState(false);
  const [historyError, setHistoryError] = useState<string | null>(null);

  // Which upload is currently selected in the dropdown
  const [selectedUploadId, setSelectedUploadId] = useState<string | null>(null);

  // -------------------------------------------------------------
  // Preview
  // -------------------------------------------------------------
  const [preview, setPreview] = useState<PreviewResponse | null>(null);
  const [previewLoading, setPreviewLoading] = useState(false);
  const [previewError, setPreviewError] = useState<string | null>(null);

  const isUploading = status === "uploading" || status === "processing";
  const isReady = status === "ready";

  // -------------------------------------------------------------
  // Auth helper
  // -------------------------------------------------------------
  const getAuthToken = async () => {
    const {
      data: { session },
    } = await supabase.auth.getSession();
    return session?.access_token;
  };

  // -------------------------------------------------------------
  // Preview fetcher (by upload ID)
  // -------------------------------------------------------------
  const fetchPreview = useCallback(
    async (token: string, uploadId?: string) => {
      setPreviewLoading(true);
      setPreviewError(null);
      setPreview(null);

      try {
        const targetUploadId =
          uploadId ||
          selectedUploadId ||
          (lastUpload && lastUpload.id) ||
          undefined;

        if (!targetUploadId) {
          setPreviewError("No upload selected for preview.");
          return;
        }

        // ðŸ‘‡ USE API_BASE_URL
        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/uploads/${targetUploadId}/preview`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (res.status === 404) {
          setPreviewError(
            "File preview could not be generated (maybe archived or removed)."
          );
          return;
        }

        if (!res.ok) {
          const payload = await res.json().catch(() => ({}));
          throw new Error(payload.detail || `Preview failed: ${res.status}`);
        }

        const data: PreviewResponse = await res.json();
        setPreview(data);
      } catch (err: any) {
        console.error("Preview failed:", err);
        setPreviewError(err.message || "Could not load preview.");
      } finally {
        setPreviewLoading(false);
      }
    },
    [projectId, selectedUploadId, lastUpload]
  );

  // -------------------------------------------------------------
  // Fetch ALL uploads (history)
  // -------------------------------------------------------------
  const fetchUploadsHistory = useCallback(async () => {
    setHistoryLoading(true);
    setHistoryError(null);

    try {
      const token = await getAuthToken();
      if (!token) {
        setHistoryError("Please log in to see upload history.");
        return;
      }

      // ðŸ‘‡ USE API_BASE_URL
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/uploads`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (res.status === 404) {
        // No uploads yet
        setUploadsHistory([]);
        setLastUpload(null);
        setSelectedUploadId(null);
        return;
      }

      if (!res.ok) {
        const errorBody = await res.json().catch(() => ({}));
        throw new Error(errorBody.detail || `History error: ${res.status}`);
      }

      const data = (await res.json()) as any[];

      const mapped: LastUpload[] = data.map((item) => {
        const uiStatus = mapApiStatusToUiStatus(
          item.status,
          item.row_count
        );

        return {
          id: item.id,
          project_id: item.project_id,
          file_name: item.file_name ?? item.original_filename ?? null,
          status: uiStatus,
          row_count:
            typeof item.row_count === "number" ? item.row_count : null,
          uploaded_at: item.uploaded_at ?? item.created_at ?? null,
          validation_errors: item.validation_errors || null,
          original_filename: item.original_filename || null,
        } as LastUpload;
      });

      setUploadsHistory(mapped);

      // Default selection: most recent upload
      if (mapped.length > 0) {
        const mostRecent = mapped[0];
        setLastUpload(mostRecent);
        setSelectedUploadId(mostRecent.id ?? null);
      } else {
        setLastUpload(null);
        setSelectedUploadId(null);
      }
    } catch (err: any) {
      console.error("fetchUploadsHistory failed:", err);
      setHistoryError(err.message || "Could not load upload history.");
      setUploadsHistory([]);
      setLastUpload(null);
      setSelectedUploadId(null);
    } finally {
      setHistoryLoading(false);
    }
  }, [projectId]);

  // -------------------------------------------------------------
  // Initial load
  // -------------------------------------------------------------
  useEffect(() => {
    fetchUploadsHistory();
    setFile(null);
    setPreview(null);
  }, [fetchUploadsHistory]);

  // -------------------------------------------------------------
  // File change + upload
  // -------------------------------------------------------------
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
      setStatus("idle");
      setError(null);
      setPreview(null);
    }
  };

  const handleUpload = async () => {
    if (!file) return;

    setError(null);
    setStatus("uploading");

    try {
      const token = await getAuthToken();
      if (!token) {
        setStatus("idle");
        setError("You need to be logged in to upload data.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      // ðŸ‘‡ USE API_BASE_URL
      const uploadUrl = `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/upload`;

      setStatus("processing");

      const res = await fetch(uploadUrl, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          // DO NOT set Content-Type; browser does it for FormData
        },
        body: formData,
      });

      const payload = await res.json().catch(() => null);

      if (!res.ok) {
        const detail =
          (payload && (payload.detail || payload.message)) ||
          `Upload failed with status ${res.status}`;
        throw new Error(detail);
      }

      if (payload.status === "failed") {
        setStatus("idle");
        throw new Error(
          `Validation Failed: Missing required columns: ${
            payload.validation_errors?.missing_columns?.join(", ") ||
            "See status card."
          }`
        );
      }

      setStatus("ready");
      setFile(null);

      // Refresh history & lastUpload after a successful upload
      await fetchUploadsHistory();
    } catch (e: any) {
      console.error("Upload failed", e);
      setError(
        e instanceof Error ? e.message : "Upload failed. Please try again."
      );
      setStatus("idle");
    }
  };

  // -------------------------------------------------------------
  // Handlers for preview + selecting uploads in dropdown
  // -------------------------------------------------------------
  const handlePreview = async (uploadId?: string) => {
    setPreviewError(null);

    try {
      const token = await getAuthToken();
      if (!token) {
        setPreviewError("You need to be logged in to view data.");
        return;
      }

      await fetchPreview(token, uploadId);
    } catch (e: any) {
      console.error("handlePreview error:", e);
      setPreviewError(
        e instanceof Error ? e.message : "Could not load preview."
      );
    }
  };

  const handleSelectUpload = (uploadId: string) => {
    setSelectedUploadId(uploadId);

    const selected = uploadsHistory.find((u) => u.id === uploadId);
    if (selected) {
      setLastUpload(selected);
    }

    // Optionally, auto-refresh preview when selection changes:
    // getAuthToken().then(token => token && fetchPreview(token, uploadId));
  };

  // -------------------------------------------------------------
  // Public API of the hook
  // -------------------------------------------------------------
  return {
    // file + upload flow
    file,
    status,
    error,
    isUploading,
    isReady,

    // last upload + history
    lastUpload,
    statusLoading,
    statusError,
    uploadsHistory,
    historyLoading,
    historyError,
    selectedUploadId,

    // preview
    preview,
    previewLoading,
    previewError,

    // handlers
    handleFileChange,
    handleUpload,
    handlePreview,
    handleSelectUpload,

    // utilities
    refreshHistory: fetchUploadsHistory,
  };
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useProposalData.ts ---\n
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import type { ProposalData, ProposalDataPatch } from "../types";

// âœ… FIXED: proposal-data lives under /projects/{projectId}/...
const ENDPOINT = (projectId: string) =>
  `${API_BASE_URL}/api/v1/projects/${projectId}/proposal-data`;

export function useProposalData(projectId: string) {
  const [data, setData] = useState<ProposalData | null>(null);
  const [loading, setLoading] = useState<boolean>(true);
  const [saving, setSaving] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);

  const getToken = useCallback(async () => {
    const {
      data: { session },
    } = await supabase.auth.getSession();
    return session?.access_token ?? null;
  }, []);

  const fetchProposalData = useCallback(async () => {
    setLoading(true);
    setError(null);

    const token = await getToken();
    if (!token) {
      setLoading(false);
      setError("Authorization required. Please log in.");
      return;
    }

    try {
      const res = await fetch(ENDPOINT(projectId), {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Failed to load proposal data (${res.status})`);
      }

      const json = (await res.json()) as ProposalData;
      setData(json);
    } catch (e: any) {
      setError(e?.message ?? "Failed to load proposal data");
    } finally {
      setLoading(false);
    }
  }, [projectId, getToken]);

  const patchProposalData = useCallback(
    async (patch: ProposalDataPatch) => {
      setSaving(true);
      setError(null);

      const token = await getToken();
      if (!token) {
        setSaving(false);
        setError("Authorization required. Please log in.");
        return;
      }

      try {
        const res = await fetch(ENDPOINT(projectId), {
          method: "PATCH",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(patch),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `Failed to save proposal data (${res.status})`);
        }

        const updated = (await res.json()) as ProposalData;
        setData(updated);
      } catch (e: any) {
        setError(e?.message ?? "Failed to save proposal data");
        throw e;
      } finally {
        setSaving(false);
      }
    },
    [projectId, getToken]
  );

  useEffect(() => {
    if (!projectId) return;
    fetchProposalData();
  }, [projectId, fetchProposalData]);

  return {
    data,
    loading,
    saving,
    error,
    refetch: fetchProposalData,
    patchProposalData,
  };
}\n--- ./app/(app)/projects/[projectId]/config/hooks/useNetworkSnapshot.ts ---\n
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";

// The clean shape returned by your new backend service
export type NetworkProfile = {
  totalLengthKm: number;
  pavedLengthKm: number;
  gravelLengthKm: number;
  avgVci: number;
  assetValue: number; // CRC
  totalVehicleKm: number;
  fuelSales: number;
};

export function useNetworkSnapshot(projectId: string) {
  const [data, setData] = useState<NetworkProfile | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchSnapshot = useCallback(async () => {
    if (!projectId) return;

    setLoading(true);
    setError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) return;

      // This hits the new endpoint we updated in the backend
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/network/snapshot`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (res.ok) {
        const json = await res.json();
        setData(json);
      } else {
        const err = await res.json().catch(() => ({}));
        // Silent fail 404s (just means no data yet)
        if (res.status !== 404) {
            setError(err.detail || "Failed to load profile");
        }
      }
    } catch (err: any) {
      console.error("Snapshot error:", err);
      setError("Network error");
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchSnapshot();
  }, [fetchSnapshot]);

  return { data, loading, error, refetch: fetchSnapshot };
}\n--- ./app/(app)/projects/[projectId]/config/page.tsx ---\n
"use client";

import React from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { ArrowLeft, Loader2, Calendar, FileText } from "lucide-react";
import { supabase } from "@/lib/supabaseClient"; // Added for logging

// Updated Imports
import { NetworkSnapshotCard } from "./components/NetworkSnapshotCard";
import { ScenarioAssumptionsCard } from "./components/ScenarioAssumptionsCard";
import { RunSimulationCard } from "./components/RunSimulationCard";
import { ProjectNavBar } from "../components/ProjectNavBar"; // Added Nav Bar

// Hooks
import { useProposalData } from "./hooks/useProposalData";
import { useProjectMeta } from "./hooks/useProjectMeta"; 

// Components
import { ProposalInputsCard } from "./components/ProposalInputsCard";

function ProposalInputsLoadingCard() {
  return (
    <div className="rounded-2xl bg-[var(--surface-bg)] shadow-lg p-6 border border-slate-200/50 dark:border-slate-800/50">
      <div className="flex items-center gap-3 text-slate-600 dark:text-slate-300">
        <Loader2 className="h-4 w-4 animate-spin" />
        <div className="text-sm font-medium">Loading proposal inputsâ€¦</div>
      </div>
      <div className="mt-4 space-y-3">
        <div className="h-4 w-1/2 rounded bg-slate-200/60 dark:bg-slate-800/60" />
        <div className="h-4 w-2/3 rounded bg-slate-200/60 dark:bg-slate-800/60" />
        <div className="h-20 w-full rounded bg-slate-200/60 dark:bg-slate-800/60" />
      </div>
    </div>
  );
}

export default function ProjectConfigPage() {
  const params = useParams();
  const projectId = Array.isArray(params?.projectId)
    ? params?.projectId[0]
    : (params?.projectId as string | undefined);

  if (!projectId) {
    return <div className="p-6 text-rose-500">Error: Project ID not found.</div>;
  }

  // 1. Fetch Data
  const { data, loading, saving, error, patchProposalData } = useProposalData(projectId);
  const { data: projectMeta, loading: metaLoading } = useProjectMeta(projectId);

  // 2. Wrapped Save Function with Logging
  const handleSaveWithLog = async (updates: any) => {
      // Perform the actual save
      await patchProposalData(updates);

      // Log the activity
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
          await supabase.from("project_activity_log").insert({
              project_id: projectId,
              user_id: user.id,
              action_type: 'config_update',
              details: { note: "Updated proposal inputs" }
          });
      }
  };

  return (
    <div className="h-full w-full bg-[var(--background)] overflow-y-auto">
      
      {/* Sticky Project Nav */}
      <div className="sticky top-0 z-10 bg-[var(--background)]">
          <ProjectNavBar projectId={projectId} />
      </div>

      <div className="p-8 pb-20">
        {/* --- HEADER --- */}
        <header className="border-b border-slate-200 dark:border-slate-800 pb-6 mb-8">
            <div className="space-y-4">
            
            <Link
                href="/projects"
                className="inline-flex items-center gap-1 text-sm font-medium text-slate-500 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
            >
                <ArrowLeft className="h-4 w-4" />
                Back to projects
            </Link>

            {metaLoading ? (
                <div className="space-y-3 animate-pulse">
                <div className="h-10 w-2/3 bg-slate-200 dark:bg-slate-800 rounded-lg" />
                <div className="h-6 w-1/3 bg-slate-100 dark:bg-slate-800/50 rounded-lg" />
                </div>
            ) : (
                <div className="space-y-2">
                <h1 className="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 dark:text-white">
                    Proposal for{" "}
                    <span className="text-indigo-600 dark:text-indigo-400">
                    {projectMeta?.province || "Unassigned Province"}
                    </span>
                </h1>
                
                <div className="flex flex-wrap items-center gap-x-6 gap-y-2 text-sm md:text-base font-medium text-slate-500 dark:text-slate-400">
                    <div className="flex items-center gap-1.5">
                    <Calendar className="w-4 h-4 text-slate-400 dark:text-slate-500" />
                    <span>{projectMeta?.start_year ? `${projectMeta.start_year} Financial Year` : "Year not set"}</span>
                    </div>
                    
                    <div className="hidden sm:block w-1 h-1 rounded-full bg-slate-300 dark:bg-slate-700" />
                    
                    <div className="flex items-center gap-1.5">
                    <FileText className="w-4 h-4 text-slate-400 dark:text-slate-500" />
                    <span className="text-slate-700 dark:text-slate-300">
                        {projectMeta?.project_name || "Untitled Proposal"}
                    </span>
                    </div>
                </div>
                </div>
            )}
            </div>
        </header>

        {/* --- ERROR --- */}
        {error && (
            <div className="mb-6 rounded-xl border border-rose-200 bg-rose-50 p-4 text-sm font-medium text-rose-700">
            <p>Unable to load proposal data:</p>
            <pre className="mt-1 whitespace-pre-wrap text-xs opacity-80">{error}</pre>
            </div>
        )}

        {/* --- CONTENT --- */}
        <div className="grid gap-8 lg:grid-cols-[1.7fr,1.3fr]">
            
            {/* LEFT COLUMN: Inputs */}
            <div className="space-y-8">
            {loading ? (
                <ProposalInputsLoadingCard />
            ) : (
                <>
                {/* 1. Green Blocks (Inputs) */}
                <ProposalInputsCard
                    proposal={data}
                    saving={saving}
                    onSave={handleSaveWithLog} // Use the new wrapper
                />
                </>
            )}
            
            {/* 2. Forecast Strategy (Inflation/Deterioration) */}
            <ScenarioAssumptionsCard projectId={projectId} />
            </div>

            {/* RIGHT COLUMN: Results & Actions */}
            <div className="space-y-8">
            {/* 3. The Asset Profile (Visual Feedback) */}
            <NetworkSnapshotCard projectId={projectId} />
            
            {/* 4. The Simulation Control Center (Action) */}
            <div className="sticky top-20">
                <RunSimulationCard projectId={projectId} />
            </div>
            </div>
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/config/DataInputCard.tsx ---\n
/* --- app/(app)/projects/[projectId]/config/DataInputCard.tsx --- */
"use client";

import React from "react";
import { Upload, CheckCircle, Database } from "lucide-react";
import { cn } from "@/lib/utils";
import { useMasterDataUpload } from "./hooks/useMasterDataUpload";
import { UploadStatusCard } from "./components/UploadStatusCard";
import { DataPreviewTable } from "./components/DataPreviewTable";

export function DataInputCard({ projectId }: { projectId: string }) {
  const {
    // state
    file,
    status,
    error,
    lastUpload,
    statusLoading,
    statusError,
    uploadsHistory,
    historyLoading,
    historyError,
    selectedUploadId,
    preview,
    previewLoading,
    previewError,
    isUploading,
    isReady,
    // handlers
    handleFileChange,
    handleUpload,
    handlePreview,
    handleSelectUpload,
  } = useMasterDataUpload(projectId);

  // --- Render -----------------------------------------------------
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg">
      <div className="flex items-start justify-between gap-4 mb-3">
        <div>
          <h2 className="text-xl font-semibold mb-1 flex items-center gap-2">
            <Database className="h-5 w-5 text-[var(--accent-color)]" />
            1. Master Data Input
          </h2>
          <p className="text-sm text-slate-500 dark:text-slate-400">
            Upload the road inventory/condition data (Excel/CSV) to set the
            baseline for this project ({projectId}).
          </p>
        </div>

        <UploadStatusCard
          lastUpload={lastUpload}
          statusLoading={statusLoading}
          statusError={statusError}
          uploadsHistory={uploadsHistory}
          historyLoading={historyLoading}
          historyError={historyError}
          selectedUploadId={selectedUploadId}
          previewLoading={previewLoading}
          onPreview={handlePreview}
          onSelectUpload={handleSelectUpload}
        />
      </div>

      {/* Upload area */}
      <div
        className={cn(
          "p-6 border-2 border-dashed rounded-xl transition-colors",
          isReady
            ? "border-green-400 dark:border-green-600"
            : "border-slate-300 dark:border-slate-700"
        )}
      >
        <input
          type="file"
          accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
          onChange={handleFileChange}
          className="hidden"
          id={`file-upload-${projectId}`}
          disabled={isUploading}
        />

        <label
          htmlFor={`file-upload-${projectId}`}
          className={cn(
            "block p-4 text-center rounded-lg cursor-pointer transition-colors",
            isReady
              ? "bg-green-50 dark:bg-green-900/20"
              : "hover:bg-slate-50 dark:hover:bg-slate-800/50"
          )}
        >
          <Upload className="h-6 w-6 mx-auto mb-2 text-slate-500" />
          {file ? (
            <span className="font-medium text-[var(--foreground)]">
              {file.name}
            </span>
          ) : (
            <span className="text-slate-500">
              Click to select file or drag here
            </span>
          )}
        </label>

        {/* General upload error */}
        {error && <p className="text-xs text-red-500 mt-2">{error}</p>}

        <div className="mt-4 flex justify-between items-center gap-3">
          <p className="text-[11px] text-slate-500 dark:text-slate-400">
            Later weâ€™ll add <span className="font-semibold">manual edits</span>{" "}
            on top of this uploaded baseline (hybrid mode).
          </p>

          <button
            onClick={handleUpload}
            disabled={!file || isUploading}
            className={cn(
              "inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-white shadow-sm transition",
              isReady
                ? "bg-green-600 hover:bg-green-700"
                : "bg-[var(--accent-color)] hover:brightness-110",
              "disabled:cursor-not-allowed disabled:opacity-70"
            )}
          >
            {isReady ? (
              <>
                <CheckCircle className="h-4 w-4" /> Data Ready
              </>
            ) : isUploading ? (
              "Processing data..."
            ) : (
              <>
                <Upload className="h-4 w-4" /> Upload &amp; Validate
              </>
            )}
          </button>
        </div>

        {/* Preview error */}
        {previewError && (
          <p className="text-xs text-red-500 mt-3">{previewError}</p>
        )}

        {/* Inline preview */}
        {preview && (
          <div className="mt-6">
            <DataPreviewTable preview={preview} />
          </div>
        )}
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/advisor/page.tsx ---\n
"use client";

import React from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { ArrowLeft, Sparkles, LayoutDashboard } from "lucide-react";

import { useProjectMeta } from "../../config/hooks/useProjectMeta";
import { useNetworkSnapshot } from "../../config/hooks/useNetworkSnapshot";
import { useSimulationResults } from "../hooks/useSimulationResults";

import { useAiAdvisor } from "../hooks/useAiAdvisor";
import { AiStrategyCard } from "../components/AiStrategyCard";
import { DashboardMainPanel } from "../components/DashboardMainPanel";

export default function AdvisorInsightsPage() {
  const params = useParams();
  const projectId = params.projectId as string;

  const { data: project } = useProjectMeta(projectId);
  const { data: snapshot, loading: snapLoading } = useNetworkSnapshot(projectId);
  const { results, loading: simLoading } = useSimulationResults(projectId);

  const { analysis, loading: aiLoading, error: aiError, generateAnalysis } = useAiAdvisor(projectId);

  const loading = snapLoading || simLoading;

  return (
    <div className="space-y-6 pb-20">
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div>
          <Link
            href={`/projects/${projectId}/dashboard`}
            className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
          >
            <ArrowLeft className="w-3 h-3" /> Back to Dashboard
          </Link>

          <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <Sparkles className="w-6 h-6 text-indigo-500" />
            AI Advisor Insights
          </h1>
          <p className="text-sm text-slate-500 mt-1">
            {project?.project_name || "Project"} â€” generate a Treasury-ready executive narrative from your simulation.
          </p>
        </div>
      </header>

      {/* If no simulation exists, show a proper call-to-action */}
      {!loading && !results && (
        <div className="flex flex-col items-center justify-center h-[55vh] text-center space-y-4">
          <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-full">
            <LayoutDashboard className="w-8 h-8 text-slate-400" />
          </div>
          <h2 className="text-xl font-semibold text-slate-900 dark:text-slate-100">
            No Simulation Yet
          </h2>
          <p className="text-slate-500 max-w-md">
            AI insights require a simulation run. Go to Inputs, run your forecast, then return here.
          </p>
          <Link
            href={`/projects/${projectId}/config`}
            className="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            Go to Inputs
          </Link>
        </div>
      )}

      {/* Optional: show context snapshot + charts (same as dashboard) */}
      {loading && (
        <div className="flex h-48 items-center justify-center">
          <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
        </div>
      )}

      {!loading && snapshot && (
        <div className="rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] p-4">
          <p className="text-[10px] uppercase tracking-wider font-bold text-slate-500">
            Context Preview
          </p>
          <p className="text-xs text-slate-500 mt-1">
            This is the same context used in your dashboard (network snapshot + latest simulation).
          </p>

          <div className="mt-4">
            <DashboardMainPanel
              projectId={projectId}
              snapshot={snapshot}
              loading={false}
              error={null}
              adjustedAssetValue={null}
              simulationResults={results}
            />
          </div>
        </div>
      )}

      {/* AI Strategy Card (CTA + Result) */}
      {!loading && results && (
        <AiStrategyCard
          analysis={analysis}
          loading={aiLoading}
          error={aiError}
          onGenerate={generateAnalysis}
        />
      )}
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/types.ts ---\n
// app/(app)/dashboard/types.ts

export type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
};

export type Dashboard = {
  id: string;
  projectId: string;
  userId: string;
  name: string;
  description?: string | null;
  isFavorite: boolean;
  layout?: any | null;
  overrides?: any | null;
  createdAt: string;
  updatedAt: string;
};\n--- ./app/(app)/projects/[projectId]/dashboard/components/ScenarioImpactCard.tsx ---\n
// app/(app)/dashboard/components/ScenarioImpactCard.tsx
"use client";

import React from "react";
import { BarChart3 } from "lucide-react";

type Props = {
  adjustedAssetValue: number | null;
};

export function ScenarioImpactCard({ adjustedAssetValue }: Props) {
  if (adjustedAssetValue == null) return null;

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-2">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <BarChart3 className="h-4 w-4 text-amber-500" />
        Scenario impact (rough illustrative)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        This uses your live scenario controls on the right (analysis horizon +
        budget level) to estimate an indicative{" "}
        <span className="font-medium">lifetime investment envelope</span>. Later
        weâ€™ll plug in full RONET logic.
      </p>
      <p className="text-lg font-semibold mt-1">
        R {(adjustedAssetValue / 1_000_000).toFixed(1)} m
      </p>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/AiInsightChip.tsx ---\n
"use client";

import React from "react";
import { Sparkles } from "lucide-react";

export function AiInsightChip({ text, loading }: { text?: string; loading: boolean }) {
  if (loading) {
    return (
      <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full animate-pulse">
        <div className="w-3 h-3 bg-slate-300 dark:bg-slate-600 rounded-full" />
        <div className="w-32 h-2 bg-slate-300 dark:bg-slate-600 rounded" />
      </div>
    );
  }

  if (!text) return null;

  return (
    <div className="group relative flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-full cursor-help transition-all hover:bg-indigo-100 dark:hover:bg-indigo-900/40">
      <Sparkles className="w-3 h-3 text-indigo-600 dark:text-indigo-400 animate-pulse" />
      <span className="text-[10px] font-semibold text-indigo-700 dark:text-indigo-300 uppercase tracking-wide">
        AI Insight
      </span>
      
      {/* Tooltip Popup */}
      <div className="absolute bottom-full left-0 mb-2 w-64 p-3 bg-slate-900 text-white text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 pointer-events-none">
        <div className="relative z-10 font-medium leading-relaxed">
            "{text}"
        </div>
        {/* Little triangle arrow */}
        <div className="absolute -bottom-1 left-4 w-2 h-2 bg-slate-900 rotate-45" />
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/ProjectDashboardSelector.tsx ---\n
// app/(app)/dashboard/components/ProjectDashboardSelector.tsx
"use client";

import React from "react";
import { AlertTriangle, RefreshCw, Save } from "lucide-react";
import type { Dashboard, Project } from "../types";

type Props = {
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
  dashboards: Dashboard[];
  dashboardsLoading: boolean;
  dashboardsError: string | null;

  selectedProjectId: string;
  onProjectChange: (projectId: string) => void;
  selectedProject: Project | null;

  selectedDashboardId: string;
  onDashboardChange: (dashboardId: string) => void;

  snapshotLoading: boolean;
  onRefreshSnapshot: () => void;

  onSaveNew: () => void;
  onSaveExisting: () => void;
};

export function ProjectDashboardSelector({
  projects,
  projectsLoading,
  projectsError,
  dashboards,
  dashboardsLoading,
  dashboardsError,
  selectedProjectId,
  onProjectChange,
  selectedProject,
  selectedDashboardId,
  onDashboardChange,
  snapshotLoading,
  onRefreshSnapshot,
  onSaveNew,
  onSaveExisting,
}: Props) {
  return (
    <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-4">
      {/* Project row */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Project
          </p>
          <p className="text-sm font-medium">
            {selectedProject ? selectedProject.project_name : "Select a project"}
          </p>
          {selectedProject && (
            <p className="text-[11px] text-slate-500 dark:text-slate-400">
              {selectedProject.description && (
                <>
                  <span className="font-medium">Overview:</span>{" "}
                  {selectedProject.description}{" "}
                </>
              )}
              {(selectedProject.start_year || selectedProject.forecast_duration) && (
                <>
                  |
                  {selectedProject.start_year && (
                    <> Start year: {selectedProject.start_year}</>
                  )}
                  {selectedProject.forecast_duration && (
                    <> â€¢ Horizon: {selectedProject.forecast_duration} years</>
                  )}
                </>
              )}
            </p>
          )}
        </div>

        <div className="flex flex-wrap items-center gap-3">
          <select
            value={selectedProjectId}
            onChange={(e) => onProjectChange(e.target.value)}
            disabled={projectsLoading || projects.length === 0}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="" disabled>
              {projectsLoading
                ? "Loading projectsâ€¦"
                : projects.length === 0
                ? "No projects found"
                : "Select project"}
            </option>
            {projects.map((p) => (
              <option key={p.id} value={p.id}>
                {p.project_name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={onRefreshSnapshot}
            disabled={!selectedProjectId || snapshotLoading}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
          >
            <RefreshCw className="h-3 w-3" />
            {snapshotLoading ? "Refreshing dataâ€¦" : "Refresh data"}
          </button>
        </div>
      </div>

      {/* Dashboard selection row */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div className="flex items-center gap-2">
          <span className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Dashboard
          </span>
          <select
            value={selectedDashboardId}
            onChange={(e) => onDashboardChange(e.target.value)}
            disabled={!selectedProjectId || dashboardsLoading}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">
              {dashboardsLoading
                ? "Loading dashboardsâ€¦"
                : dashboards.length === 0
                ? "Unsaved view"
                : "Unsaved view (current controls)"}
            </option>
            {dashboards.map((d) => (
              <option key={d.id} value={d.id}>
                {d.name}
                {d.isFavorite ? " â˜…" : ""}
              </option>
            ))}
          </select>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={onSaveNew}
            disabled={!selectedProjectId}
            className="inline-flex items-center gap-1.5 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs font-medium text-white px-3 py-1.5 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Save as new dashboard
          </button>
          <button
            type="button"
            onClick={onSaveExisting}
            disabled={!selectedProjectId || !selectedDashboardId}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-200 px-3 py-1.5 hover:bg-slate-800/60 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Update selected
          </button>
        </div>
      </div>

      {(projectsError || dashboardsError) && (
        <p className="text-xs text-red-500 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          {projectsError || dashboardsError}
        </p>
      )}
    </section>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/SimulationCharts.tsx ---\n
"use client";

import React from "react";
import {
  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
import { Activity, DollarSign } from "lucide-react";
import type { SimulationOutput } from "../../config/types";

type Props = {
  results: SimulationOutput | null;
};

export function SimulationCharts({ results }: Props) {
  if (!results) return null;

  return (
    <div className="grid gap-4 lg:grid-cols-2 mt-6">
      
      {/* Chart 1: Condition Over Time */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <Activity className="h-4 w-4 text-blue-500" />
            Predicted Network Condition
          </h2>
          <span className="text-[10px] text-slate-500">Average IRI (Lower is better)</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} domain={[0, 'auto']} />
              <Tooltip 
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
              />
              <Legend wrapperStyle={{ fontSize: "10px" }} />
              <Line 
                type="monotone" 
                dataKey="avg_condition_index" 
                name="Average IRI" 
                stroke="#3b82f6" 
                strokeWidth={3} 
                dot={false} 
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Chart 2: Cost Profile */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
        <h2 className="text-sm font-semibold flex items-center gap-2">
            {/* Replaced DollarSign with a styled 'R' */}
            <span className="h-4 w-4 flex items-center justify-center text-emerald-500 font-bold">
              R
            </span>
            Annual Expenditure
          </h2>
          <span className="text-[10px] text-slate-500">Maintenance Budget Needed</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis 
                stroke="#94a3b8" 
                fontSize={10} 
                tickLine={false} 
                axisLine={false}
                tickFormatter={(val) => `R${val/1000000}M`} 
              />
              <Tooltip 
                cursor={{ fill: 'transparent' }}
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
                formatter={(value: number) => [`R${(value).toLocaleString()}`, 'Cost']}
              />
              <Bar dataKey="total_maintenance_cost" name="Maintenance Cost" fill="#10b981" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/DashboardHeader.tsx ---\n
// app/(app)/dashboard/components/DashboardHeader.tsx
"use client";

import React from "react";
import { LayoutDashboard } from "lucide-react";

export function DashboardHeader() {
  return (
    <header className="space-y-1">
      <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
        <LayoutDashboard className="h-6 w-6 text-sky-500" />
        Dashboards
      </h1>
      <p className="text-sm text-slate-500 dark:text-slate-400">
        Build presentation-ready dashboards for each project. Adjust scenario
        knobs live for board meetings, and optionally save favourite
        configurations as named dashboards.
      </p>
    </header>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/AiStrategyCard.tsx ---\n
"use client";

import React from "react";
import { Sparkles, BrainCircuit, AlertTriangle, CheckCircle2, TrendingUp, Loader2 } from "lucide-react";
// Import Type only
import type { AiAnalysis } from "../hooks/useAiAdvisor";

// ðŸ‘‡ Props now accept the state from the parent
type Props = {
    analysis: AiAnalysis | null;
    loading: boolean;
    error: string | null;
    onGenerate: () => void;
};

export function AiStrategyCard({ analysis, loading, error, onGenerate }: Props) {

  // 1. Initial State (Call to Action)
  if (!analysis && !loading) {
    return (
      <div className="mt-8 p-1 rounded-2xl bg-gradient-to-r from-slate-200 to-slate-300 dark:from-slate-800 dark:to-slate-900 shadow-sm opacity-80 hover:opacity-100 transition-opacity">
        <div className="bg-white dark:bg-slate-950 rounded-xl p-8 text-center space-y-4">
          <div className="inline-flex p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-full mb-2">
             <Sparkles className="w-6 h-6 text-indigo-600 dark:text-indigo-400" />
          </div>
          <h2 className="text-xl font-bold text-slate-900 dark:text-white">
            Unlock Strategic Insights
          </h2>
          <p className="text-sm text-slate-500 max-w-md mx-auto">
            Ready to finalize your strategy? Ask the <strong>Mosianedi AI</strong> to synthesize your simulation results into a formal Treasury motivation.
          </p>
          
          {error && <div className="text-xs text-rose-500">{error}</div>}

          <button
            onClick={onGenerate}
            className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm hover:scale-105 transition-transform flex items-center gap-2 mx-auto shadow-lg shadow-indigo-500/30"
          >
            <BrainCircuit className="w-4 h-4" />
            Generate Final Report
          </button>
        </div>
      </div>
    );
  }

  // 2. Loading State
  if (loading) {
    return (
      <div className="mt-8 p-8 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] flex flex-col items-center justify-center text-center space-y-4 min-h-[300px]">
        <div className="relative">
            <div className="absolute inset-0 bg-indigo-500 blur-xl opacity-20 animate-pulse rounded-full" />
            <Loader2 className="w-10 h-10 text-indigo-600 dark:text-indigo-400 animate-spin relative z-10" />
        </div>
        <div>
            <h3 className="text-lg font-semibold animate-pulse">Synthesizing Strategy...</h3>
            <p className="text-xs text-slate-500 mt-1">Analyzing graphs & financial liabilities</p>
        </div>
      </div>
    );
  }

  // 3. Result State (The Report)
  return (
    <div className="mt-8 rounded-2xl border border-indigo-100 dark:border-indigo-900/50 bg-indigo-50/50 dark:bg-indigo-950/10 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-700">
      
      {/* Header */}
      <div className="bg-indigo-100/80 dark:bg-indigo-900/20 px-6 py-4 border-b border-indigo-200 dark:border-indigo-800 flex items-center justify-between">
         <div className="flex items-center gap-2">
            <Sparkles className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
            <h3 className="font-bold text-indigo-900 dark:text-indigo-200">Strategic Executive Conclusion</h3>
         </div>
         <span className="text-[10px] uppercase font-bold tracking-wider text-indigo-400 bg-white dark:bg-slate-900 px-2 py-1 rounded">
            AI Generated
         </span>
      </div>

      <div className="p-6 grid gap-6 md:grid-cols-2">
         {/* ... (Keep the rest of your display logic from previous step) ... */}
         <div className="space-y-6">
            <div>
                <h4 className="text-xs uppercase font-bold text-slate-500 mb-2">Executive Overview</h4>
                <p className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed font-medium">
                    {analysis?.executive_summary}
                </p>
            </div>
            {/* ... etc ... */}
             <div className="p-4 bg-rose-50 dark:bg-rose-900/10 rounded-xl border border-rose-100 dark:border-rose-800/30">
                <h4 className="text-xs uppercase font-bold text-rose-600 dark:text-rose-400 mb-2 flex items-center gap-1">
                    <AlertTriangle className="w-3 h-3" /> Risk Analysis
                </h4>
                <p className="text-xs text-rose-800 dark:text-rose-200 leading-relaxed">
                    {analysis?.risk_analysis}
                </p>
            </div>
         </div>

         <div className="space-y-6">
            <div>
                <h4 className="text-xs uppercase font-bold text-slate-500 mb-2">Recommended Actions</h4>
                <ul className="space-y-2">
                    {analysis?.recommended_action.map((action, i) => (
                        <li key={i} className="flex items-start gap-2 text-sm text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-900 p-2.5 rounded-lg border border-slate-100 dark:border-slate-800 shadow-sm">
                            <CheckCircle2 className="w-4 h-4 text-emerald-500 shrink-0 mt-0.5" />
                            {action}
                        </li>
                    ))}
                </ul>
            </div>
             <div>
                 <h4 className="text-xs uppercase font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <TrendingUp className="w-3 h-3" /> Economic Context
                 </h4>
                 <p className="text-xs text-slate-500 italic">
                    "{analysis?.economic_impact}"
                 </p>
            </div>
         </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/ScenarioControlsCard.tsx ---\n
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControlsCard({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (presentation only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> modify
        your underlying data. They only drive this dashboardâ€™s story. When
        youâ€™re happy with a configuration, save it as a named dashboard.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET runs use 20 years; adjust to explore shorter or longer
          investment horizons.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used to scale indicative figures on
          the dashboard.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {(
            [
              {
                value: "preventive" as const,
                label: "Preventive heavy",
                desc: "Prioritise good/fair roads.",
              },
              {
                value: "balanced" as const,
                label: "Balanced",
                desc: "Mix of preventive + rehab.",
              },
              {
                value: "reactive" as const,
                label: "Reactive",
                desc: "Worst-first; more backlog risk.",
              },
            ] as const
          ).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/ScenarioControls.tsx ---\n
// app/(app)/dashboard/components/ScenarioControls.tsx
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControls({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (live only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> change the
        underlying data â€“ they only drive this dashboard view. Use them during
        board presentations, and save as a named dashboard when you like the
        story.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET uses 20 years; extend or shorten for presentation
          â€œwhat-ifâ€ runs.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used only for indicative dashboard
          figures.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {([
            {
              value: "preventive" as PolicyBias,
              label: "Preventive heavy",
              desc: "Prioritise good/fair roads.",
            },
            {
              value: "balanced" as PolicyBias,
              label: "Balanced",
              desc: "Mix of preventive + rehab.",
            },
            {
              value: "reactive" as PolicyBias,
              label: "Reactive",
              desc: "Worst-first, more backlog.",
            },
          ] as const).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/components/DashboardMainPanel.tsx ---\n
"use client";

import React, { useMemo } from "react";
import {
  ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, Legend, CartesianGrid,
} from "recharts";
import { TrendingUp, Activity, Coins, Map, BarChart3 } from "lucide-react";

import type { NetworkProfile } from "../../config/hooks/useNetworkSnapshot";
import type { SimulationOutput } from "../../config/types";
import { SimulationCharts } from "./SimulationCharts";

// ðŸ‘‡ 1. Imports for AI Features
import { AiStrategyCard } from "./AiStrategyCard";
import { AiInsightChip } from "./AiInsightChip";
import { useAiAdvisor } from "../hooks/useAiAdvisor";

type Props = {
  // ðŸ‘‡ 2. Add projectId here so TypeScript stops complaining
  projectId: string; 
  snapshot: NetworkProfile | null;
  loading: boolean;
  error: string | null;
  adjustedAssetValue: number | null; 
  simulationResults: SimulationOutput | null;
};

const SURFACE_COLOURS = ["#6366f1", "#f59e0b"]; 

function fmtCurrency(val: number) {
  if (val >= 1_000_000_000) return `R ${(val / 1_000_000_000).toFixed(1)} bn`;
  if (val >= 1_000_000) return `R ${(val / 1_000_000).toFixed(1)} m`;
  return `R ${val.toLocaleString()}`;
}

export function DashboardMainPanel({
  projectId, // ðŸ‘ˆ 3. Destructure it
  snapshot,
  loading,
  error,
  adjustedAssetValue,
  simulationResults,
}: Props) {

  // ðŸ‘‡ 4. Initialize AI Hook here to share data with Chips and Card
  const { analysis, loading: aiLoading, error: aiError, generateAnalysis } = useAiAdvisor(projectId);
  
  // ----- Data Prep ----------------------------------------
  const surfaceMixData = useMemo(() => {
    if (!snapshot) return [];
    return [
      { name: "Paved", value: snapshot.pavedLengthKm },
      { name: "Gravel", value: snapshot.gravelLengthKm },
    ];
  }, [snapshot]);

  const assetMixData = useMemo(() => {
    if (!snapshot) return [];
    const pavedVal = snapshot.pavedLengthKm * 3_500_000;
    const gravelVal = snapshot.gravelLengthKm * 250_000;
    return [
      { name: "Paved Assets", value: pavedVal, fill: "#6366f1" },
      { name: "Gravel Assets", value: gravelVal, fill: "#f59e0b" },
    ];
  }, [snapshot]);

  // ---------------------------------------------------------

  if (loading) return <div className="p-8 text-center text-slate-500">Loading dashboard...</div>;
  if (error) return <div className="p-8 text-center text-rose-500">Error: {error}</div>;
  if (!snapshot) return <div className="p-8 text-center text-slate-500">No network data found.</div>;

  return (
    <div className="space-y-6">
      
      {/* --- ROW 1: KPI CARDS --- */}
      <div className="grid gap-4 md:grid-cols-4">
        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)]">
          <p className="text-[10px] uppercase tracking-wide text-slate-500 flex items-center gap-2">
            <Map className="w-3 h-3" /> Total Length
          </p>
          <div className="mt-2 text-2xl font-bold text-slate-900 dark:text-slate-100">
            {snapshot.totalLengthKm.toLocaleString()} <span className="text-sm font-medium text-slate-500">km</span>
          </div>
          <div className="mt-1 text-xs text-slate-400">Current Network Size</div>
        </div>

        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)]">
          <p className="text-[10px] uppercase tracking-wide text-slate-500 flex items-center gap-2">
            <Activity className="w-3 h-3" /> Network VCI
          </p>
          <div className="mt-2 text-2xl font-bold text-slate-900 dark:text-slate-100 flex items-baseline gap-2">
            {snapshot.avgVci.toFixed(1)}
            <span className={`text-xs px-1.5 py-0.5 rounded font-bold ${snapshot.avgVci < 50 ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}`}>
                {snapshot.avgVci < 50 ? 'POOR' : 'FAIR'}
            </span>
          </div>
          <div className="mt-1 text-xs text-slate-400">Weighted Average Condition</div>
        </div>

        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] col-span-2 bg-gradient-to-br from-slate-900 to-slate-800 text-white">
          <div className="flex justify-between items-start">
             <div>
                <p className="text-[10px] uppercase tracking-wide text-slate-400 flex items-center gap-2">
                    <Coins className="w-3 h-3 text-emerald-400" /> Current Replacement Cost
                </p>
                <div className="mt-2 text-3xl font-bold">{fmtCurrency(snapshot.assetValue)}</div>
                <div className="mt-1 text-xs text-slate-400">Total Estimated Value</div>
             </div>
             {adjustedAssetValue && (
                 <div className="text-right">
                    <p className="text-[10px] text-slate-400">Scenario Adjusted</p>
                    <p className="font-mono text-emerald-400 font-bold">{fmtCurrency(adjustedAssetValue)}</p>
                 </div>
             )}
          </div>
        </div>
      </div>

      {/* --- ROW 2: VISUAL BREAKDOWNS --- */}
      <div className="grid gap-4 lg:grid-cols-2">
        <div className="p-6 rounded-2xl bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800">
          <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2">
             <BarChart3 className="w-4 h-4 text-indigo-500" />
             Network Surface Composition
          </h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={surfaceMixData} dataKey="value" nameKey="name" innerRadius={60} outerRadius={80} paddingAngle={5}>
                  {surfaceMixData.map((_, idx) => <Cell key={`cell-${idx}`} fill={SURFACE_COLOURS[idx]} />)}
                </Pie>
                <Tooltip formatter={(val: number) => `${val.toLocaleString()} km`} />
                <Legend verticalAlign="bottom" height={36}/>
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="p-6 rounded-2xl bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800">
          <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2">
            <TrendingUp className="w-4 h-4 text-emerald-500"/>
            Estimated Value Distribution
          </h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={assetMixData} layout="vertical" margin={{ left: 20 }}>
                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                <XAxis type="number" hide />
                <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                <Tooltip formatter={(val: number) => fmtCurrency(val)} cursor={{fill: 'transparent'}} />
                <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={32} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* --- ROW 3: SIMULATION RESULTS --- */}
      {simulationResults && (
        <div className="mt-8 pt-6 border-t border-slate-200 dark:border-slate-800">
            <div className="mb-6 flex items-center justify-between">
                <div>
                    <h2 className="text-lg font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                        <Activity className="w-5 h-5 text-indigo-500" />
                        Strategic Forecast
                    </h2>
                    <p className="text-sm text-slate-500">
                        Projected performance over the next {simulationResults.year_count} years.
                    </p>
                </div>
                {/* ðŸ‘‡ AI INSIGHT CHIP (Condition) */}
                <AiInsightChip 
                    text={analysis?.chart_insights.condition_forecast} 
                    loading={aiLoading} 
                />
            </div>
            
            <SimulationCharts results={simulationResults} />
            
            <div className="flex justify-end mt-2">
                 {/* ðŸ‘‡ AI INSIGHT CHIP (Budget) */}
                 <AiInsightChip 
                    text={analysis?.chart_insights.budget_impact} 
                    loading={aiLoading} 
                />
            </div>
        </div>
      )}

      {/* ðŸ‘‡ 5. AI STRATEGY CARD (Moved to Bottom) */}
      {/* <AiStrategyCard 
         analysis={analysis} 
         loading={aiLoading} 
         error={aiError} 
         onGenerate={generateAnalysis} 
      /> */}
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/hooks/useAiAdvisor.ts ---\n
"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL;

export type AiAnalysis = {
  // ðŸ‘‡ New Section
  chart_insights: {
    condition_forecast: string;
    budget_impact: string;
  };
  // Existing Section
  executive_summary: string;
  risk_analysis: string;
  economic_impact: string;
  recommended_action: string[];
};

export function useAiAdvisor(projectId: string) {
  const [analysis, setAnalysis] = useState<AiAnalysis | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const generateAnalysis = async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/advisor/generate`,
        {
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (!res.ok) throw new Error("Failed to generate insights.");

      const data = await res.json();
      setAnalysis(data);
      
    } catch (err: any) {
      console.error(err);
      setError("AI Service Unavailable.");
    } finally {
      setLoading(false);
    }
  };

  return { analysis, loading, error, generateAnalysis };
}\n--- ./app/(app)/projects/[projectId]/dashboard/hooks/useSimulationResults.ts ---\n
"use client";

import { useState, useEffect } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import type { SimulationOutput } from "../../config/types";

export function useSimulationResults(projectId: string) {
  const [results, setResults] = useState<SimulationOutput | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let isCancelled = false;

    async function fetchResults() {
      if (!projectId) return;
      
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/latest`,
          {
            headers: { Authorization: `Bearer ${session.access_token}` },
          }
        );

        if (isCancelled) return;

        if (res.status === 404) {
            // No simulation run yet
            setResults(null); 
        } else if (res.ok) {
            const wrapper = await res.json();
            // ðŸ‘‡ CRITICAL FIX: Unwrap the payload from the history wrapper
            // The backend returns { id: "...", results_payload: { ...data... } }
            if (wrapper && wrapper.results_payload) {
                setResults(wrapper.results_payload);
            } else {
                // Fallback in case the structure is flat (legacy) or empty
                setResults(null);
            }
        } else {
            setError("Failed to fetch results");
        }
      } catch (err: any) {
        if (!isCancelled) {
            console.error("Simulation fetch error:", err);
            setError("Network error");
        }
      } finally {
        if (!isCancelled) setLoading(false);
      }
    }

    fetchResults();

    return () => {
      isCancelled = true;
    };
  }, [projectId]);

  return { results, loading, error };
}\n--- ./app/(app)/projects/[projectId]/dashboard/hooks/useProjectDashboards.ts ---\n
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Dashboard } from "../types";

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export function useProjectDashboards(projectId: string | undefined) {
  const [dashboards, setDashboards] = useState<Dashboard[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchDashboards = useCallback(async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (!res.ok) {
        // Handle 404 silently (just empty list)
        if (res.status === 404) {
            setDashboards([]);
            return;
        }
        throw new Error("Failed to load dashboards");
      }

      const data = await res.json();
      // Map snake_case to camelCase
      const mapped: Dashboard[] = data.map((d: any) => ({
        id: d.id,
        projectId: d.project_id,
        userId: d.user_id,
        name: d.name,
        description: d.description,
        isFavorite: d.is_favorite,
        layout: d.layout,
        overrides: d.overrides,
        createdAt: d.created_at,
        updatedAt: d.updated_at,
      }));

      setDashboards(mapped);
    } catch (err: any) {
      console.error("[useProjectDashboards] error:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchDashboards();
  }, [fetchDashboards]);

  // Create Dashboard
  const createDashboard = useCallback(async (payload: {
      name: string;
      description?: string;
      overrides?: any;
      layout?: any;
      isFavorite?: boolean;
    }) => {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) throw new Error("Failed to create dashboard");
      await fetchDashboards();
  }, [projectId, fetchDashboards]);

  // Update Dashboard
  const updateDashboard = useCallback(async (
      dashboardId: string,
      payload: Partial<Dashboard>
    ) => {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards/${dashboardId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) throw new Error("Failed to update dashboard");
      await fetchDashboards();
  }, [projectId, fetchDashboards]);

  return {
    dashboards,
    loading,
    error,
    refetch: fetchDashboards,
    createDashboard,
    updateDashboard,
  };
}\n--- ./app/(app)/projects/[projectId]/dashboard/history/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import { cn } from "@/lib/utils";
import {
  ArrowLeft,
  History,
  RefreshCw,
  Calendar,
  Activity,
  Download,
  AlertTriangle,
  FileText,
} from "lucide-react";

type SimulationRun = {
  id: string;
  created_at: string;
  // simulation_results payload shape may vary; keep it flexible
  results_payload?: any;
};

function fmtDate(dt: string) {
  const d = new Date(dt);
  if (Number.isNaN(d.getTime())) return dt;
  return d.toLocaleString();
}

export default function SimulationHistoryPage() {
  const params = useParams();
  const projectId = params.projectId as string;

  const [runs, setRuns] = useState<SimulationRun[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchRuns = async () => {
    if (!projectId) return;
    setError(null);
    setLoading(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      // âœ… Backend endpoint we assume exists (or will exist):
      // GET /api/v1/projects/{projectId}/simulation/runs
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/runs`,
        { headers: { Authorization: `Bearer ${session.access_token}` } }
      );

      if (res.status === 404) {
        setRuns([]);
        return;
      }

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Failed to load simulation history");
      }

      const data = await res.json();

      // Accept either: [{id, created_at, results_payload}] OR something similar
      const mapped: SimulationRun[] = (Array.isArray(data) ? data : []).map((r: any) => ({
        id: r.id,
        created_at: r.created_at || r.createdAt || new Date().toISOString(),
        results_payload: r.results_payload ?? r.resultsPayload ?? r,
      }));

      setRuns(mapped);
    } catch (e: any) {
      setError(e?.message ?? "Failed to load simulation history");
      setRuns([]);
    } finally {
      setLoading(false);
    }
  };

  const onRefresh = async () => {
    setRefreshing(true);
    await fetchRuns();
    setRefreshing(false);
  };

  useEffect(() => {
    fetchRuns();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  const latest = useMemo(() => runs?.[0] ?? null, [runs]);

  return (
    <div className="space-y-6 pb-20">
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div>
          <Link
            href={`/projects/${projectId}/dashboard`}
            className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
          >
            <ArrowLeft className="w-3 h-3" /> Back to Dashboard
          </Link>

          <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <History className="w-6 h-6 text-indigo-500" />
            Simulation History
          </h1>
          <p className="text-sm text-slate-500 mt-1">
            Review prior simulation runs for this project. Useful for audit trails and Treasury justification.
          </p>
        </div>

        <button
          onClick={onRefresh}
          disabled={refreshing}
          className={cn(
            "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border transition-colors",
            "border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800",
            "hover:bg-slate-50 dark:hover:bg-slate-700",
            "text-slate-700 dark:text-slate-200 disabled:opacity-60"
          )}
        >
          <RefreshCw className={cn("w-4 h-4", refreshing && "animate-spin")} />
          {refreshing ? "Refreshingâ€¦" : "Refresh"}
        </button>
      </header>

      {/* ERROR */}
      {error && (
        <div className="p-4 rounded-xl border border-rose-200 dark:border-rose-900/40 bg-rose-50 dark:bg-rose-950/20 text-rose-700 dark:text-rose-300 flex items-start gap-2">
          <AlertTriangle className="w-4 h-4 mt-0.5" />
          <div className="text-sm whitespace-pre-wrap">{error}</div>
        </div>
      )}

      {/* EMPTY */}
      {!loading && !error && runs.length === 0 && (
        <div className="p-10 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800 text-center">
          <div className="mx-auto w-14 h-14 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
            <Activity className="w-7 h-7 text-slate-400" />
          </div>
          <h3 className="mt-4 text-lg font-bold text-slate-900 dark:text-white">
            No simulation runs yet
          </h3>
          <p className="mt-2 text-sm text-slate-500 max-w-md mx-auto">
            Run a simulation from the Inputs page to generate a forecast. Once generated, each run will appear here.
          </p>
          <Link
            href={`/projects/${projectId}/config`}
            className="inline-flex mt-5 items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            <FileText className="w-4 h-4" />
            Go to Inputs
          </Link>
        </div>
      )}

      {/* LOADING */}
      {loading && (
        <div className="flex h-48 items-center justify-center">
          <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
        </div>
      )}

      {/* LIST */}
      {!loading && runs.length > 0 && (
        <div className="grid gap-4">
          {/* Latest highlight */}
          {latest && (
            <div className="p-5 rounded-2xl bg-gradient-to-br from-indigo-50 to-white dark:from-indigo-950/30 dark:to-slate-950 border border-indigo-100 dark:border-indigo-900/40">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <p className="text-[10px] uppercase tracking-wider font-bold text-indigo-600 dark:text-indigo-300">
                    Latest run
                  </p>
                  <h3 className="mt-1 text-lg font-bold text-slate-900 dark:text-white">
                    {latest.id}
                  </h3>
                  <p className="mt-1 text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-slate-400" />
                    {fmtDate(latest.created_at)}
                  </p>
                </div>

                <button
                  type="button"
                  onClick={() => {
                    // simple export JSON
                    const blob = new Blob([JSON.stringify(latest.results_payload ?? {}, null, 2)], {
                      type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `simulation_${projectId}_${latest.id}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                  }}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200"
                >
                  <Download className="w-4 h-4" />
                  Export JSON
                </button>
              </div>
            </div>
          )}

          {/* Table-like cards */}
          <div className="overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-800">
            <div className="grid grid-cols-12 gap-2 px-4 py-3 bg-slate-50 dark:bg-slate-900/40 text-[10px] uppercase tracking-wider font-bold text-slate-500">
              <div className="col-span-5">Run ID</div>
              <div className="col-span-5">Created</div>
              <div className="col-span-2 text-right">Export</div>
            </div>

            <div className="divide-y divide-slate-100 dark:divide-slate-800">
              {runs.map((r) => (
                <div key={r.id} className="grid grid-cols-12 gap-2 px-4 py-3 bg-white dark:bg-slate-950">
                  <div className="col-span-5">
                    <p className="text-sm font-semibold text-slate-900 dark:text-slate-100 truncate">
                      {r.id}
                    </p>
                  </div>
                  <div className="col-span-5">
                    <p className="text-sm text-slate-600 dark:text-slate-300">
                      {fmtDate(r.created_at)}
                    </p>
                  </div>
                  <div className="col-span-2 flex justify-end">
                    <button
                      type="button"
                      onClick={() => {
                        const blob = new Blob([JSON.stringify(r.results_payload ?? {}, null, 2)], {
                          type: "application/json",
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `simulation_${projectId}_${r.id}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                      }}
                      className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200"
                    >
                      <Download className="w-3.5 h-3.5" />
                      JSON
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <p className="text-xs text-slate-500">
            Note: This page expects a backend endpoint for run history. If you havenâ€™t added it yet, Iâ€™ll give you the FastAPI route + repo SQL next.
          </p>
        </div>
      )}
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/dashboard/page.tsx ---\n
"use client";

import React from "react";
import { useParams } from "next/navigation";
import Link from "next/link";
import { LayoutDashboard, ArrowLeft, FileCheck, Sparkles, History, Presentation } from "lucide-react";

import { useSimulationResults } from "./hooks/useSimulationResults";
import { useProjectMeta } from "../config/hooks/useProjectMeta";
import { DashboardMainPanel } from "./components/DashboardMainPanel";
import { useNetworkSnapshot } from "../config/hooks/useNetworkSnapshot";

export default function ProjectDashboardPage() {
  const params = useParams();
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;

  const { data: project } = useProjectMeta(projectId || "");
  const { results, loading: simLoading } = useSimulationResults(projectId || "");
  const { data: snapshot, loading: snapLoading } = useNetworkSnapshot(projectId || "");

  const isLoading = simLoading || snapLoading;

  if (!projectId) return null;

  if (isLoading) {
    return (
      <div className="flex h-64 items-center justify-center">
        <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // Handle case where no simulation exists
  if (!results) {
    return (
      <div className="flex flex-col items-center justify-center h-[65vh] text-center space-y-4">
        <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-full">
          <LayoutDashboard className="w-8 h-8 text-slate-400" />
        </div>

        <h2 className="text-xl font-semibold text-slate-900 dark:text-slate-100">
          No Strategy Generated
        </h2>

        <p className="text-slate-500 max-w-md">
          You haven&apos;t run a simulation for this project yet. Go to Inputs and generate a forecast first.
        </p>

        <div className="flex flex-col sm:flex-row gap-3">
          <Link
            href={`/projects/${projectId}/config`}
            className="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            Go to Inputs
          </Link>
        </div>
      </div>
    );
  }

  // Safe data access
  const yearlyData = results.yearly_data || [];
  const startYear = yearlyData[0]?.year;
  const endYear = yearlyData[yearlyData.length - 1]?.year;

  return (
    <div className="space-y-6 pb-20 p-6">
      
      {/* HEADER */}
      <header className="flex flex-col gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <Link
              href={`/projects/${projectId}/config`}
              className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
            >
              <ArrowLeft className="w-3 h-3" /> Back to Inputs
            </Link>

            <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100">
              {project?.project_name || "Project"} Strategy
            </h1>

            <p className="text-sm text-slate-500 flex items-center gap-2 mt-1">
              {results.year_count}-Year Forecast {startYear && endYear ? `(${startYear} - ${endYear})` : ""}
            </p>
          </div>

          {/* Primary Action: Compile Report */}
          <Link
            href="/reports" // Direct link to the Report Builder module
            className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors shadow-lg shadow-indigo-500/20"
          >
            <FileCheck className="w-4 h-4" />
            Compile Report
          </Link>
        </div>

        {/* Secondary Actions Row */}
        <div className="flex flex-wrap gap-2">
          {/* AI Advisor Button */}
          <Link
            href={`/projects/${projectId}/advisor`}
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors group"
          >
            <Sparkles className="w-3.5 h-3.5 text-indigo-500 group-hover:text-indigo-600" />
            AI Advisor Insights
          </Link>

          {/* History Button (Opens the local history page/panel) */}
          <Link
            href={`/projects/${projectId}/dashboard/history`}
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors"
          >
            <History className="w-3.5 h-3.5 text-slate-500" />
            Simulation History
          </Link>

          {/* Boardroom View Button */}
          <Link
            href="/presentationmode"
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors"
          >
            <Presentation className="w-3.5 h-3.5 text-emerald-500" />
            Boardroom View
          </Link>
        </div>
      </header>

      {/* MAIN DASHBOARD PANEL */}
      {/* Passing data down - logic inside handles display */}
      <DashboardMainPanel
        projectId={projectId}
        snapshot={snapshot}
        loading={false}
        error={null}
        adjustedAssetValue={null}
        simulationResults={results}
      />
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/components/ProjectNavBar.tsx ---\n
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";
import { 
  LayoutDashboard, 
  ShieldAlert, 
  Map, 
} from "lucide-react";

export function ProjectNavBar({ projectId }: { projectId: string }) {
  const pathname = usePathname();

  const tabs = [
    { name: "Proposal", href: `/projects/${projectId}/dashboard`, icon: <LayoutDashboard className="w-4 h-4"/> },
    // { name: "Network Map", href: `/projects/${projectId}/network`, icon: <Map className="w-4 h-4"/> },
    { name: "Governance & History", href: `/projects/${projectId}/governance`, icon: <ShieldAlert className="w-4 h-4"/> },
    // Removed Treasury View as requested
  ];

  return (
    <div className="border-b border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)]">
      <div className="flex items-center gap-6 px-8 overflow-x-auto no-scrollbar">
        {tabs.map((tab) => {
          const isActive = pathname === tab.href;
          return (
            <Link
              key={tab.name}
              href={tab.href}
              className={cn(
                "flex items-center gap-2 py-4 text-sm font-medium border-b-2 transition-colors whitespace-nowrap",
                isActive
                  ? "border-indigo-500 text-indigo-600 dark:text-indigo-400"
                  : "border-transparent text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 hover:border-slate-300"
              )}
            >
              {tab.icon}
              {tab.name}
            </Link>
          );
        })}
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/[projectId]/governance/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { ProjectNavBar } from "../components/ProjectNavBar"; 
import { 
  CheckCircle2, 
  Circle, 
  ShieldAlert, 
  User, 
  Users, 
  History, 
  Loader2,
  Plus,
  Trash2,
  X
} from "lucide-react";
import { cn } from "@/lib/utils";

// --- TYPES ---
type Profile = {
  user_id: string;
  first_name: string;
  last_name: string;
  email: string;
  department: string;
};

type ProjectDetails = {
  id: string;
  project_name: string;
  status: 'backlog' | 'planning' | 'review' | 'published' | 'archived';
  assignee_id: string | null;
  user_id: string; // Owner ID
  locked: boolean;
};

type Collaborator = {
  id: string; // The row ID in project_collaborators
  user_id: string;
  user: Profile; // Joined profile data
  role: string;
};

type ActivityLog = {
  id: string;
  action_type: string;
  created_at: string;
  profiles: { first_name: string; last_name: string };
};

export default function ProjectGovernancePage() {
  const params = useParams();
  const router = useRouter();
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;

  const [loading, setLoading] = useState(true);
  const [currentUser, setCurrentUser] = useState<string | null>(null);
  
  // Data State
  const [project, setProject] = useState<ProjectDetails | null>(null);
  const [collaborators, setCollaborators] = useState<Collaborator[]>([]);
  const [allUsers, setAllUsers] = useState<Profile[]>([]); 
  const [logs, setLogs] = useState<ActivityLog[]>([]);
  
  // UI State
  const [isAddingCollab, setIsAddingCollab] = useState(false);

  // Status Flow Configuration
  const steps = [
    { id: 'backlog', label: 'Backlog', desc: 'Drafting & Setup' },
    { id: 'planning', label: 'Active Planning', desc: 'Data & Simulation' },
    { id: 'review', label: 'In Review', desc: 'Manager Approval' },
    { id: 'published', label: 'Published', desc: 'Locked & Live' },
  ];

  // --- 1. LOAD DATA ---
  useEffect(() => {
    async function loadData() {
      if (!projectId) return;

      // Get Current User
      const { data: { user } } = await supabase.auth.getUser();
      setCurrentUser(user?.id || null);

      // A. Fetch Project
      const { data: proj } = await supabase
        .from("projects")
        .select("id, project_name, status, assignee_id, user_id, locked")
        .eq("id", projectId)
        .single();
      
      if (proj) setProject(proj as any);

      // B. Fetch Collaborators (New Table)
      // Note: We use the join syntax here because RLS is now open
      const { data: collabData } = await supabase
        .from("project_collaborators")
        .select(`
            id, user_id, role,
            user:profiles!user_id ( user_id, first_name, last_name, email, department )
        `)
        .eq("project_id", projectId);
      
      if (collabData) setCollaborators(collabData as any);

      // C. Fetch All Profiles (for dropdowns)
      const { data: users } = await supabase
        .from("profiles")
        .select("*")
        .order('first_name', { ascending: true });
      
      if (users) setAllUsers(users);

      // D. Fetch Logs
      fetchLogs();

      setLoading(false);
    }
    loadData();
  }, [projectId]);

  const fetchLogs = async () => {
      const { data: activity } = await supabase
        .from("project_activity_log")
        .select(`
            id, action_type, created_at,
            profiles:user_id ( first_name, last_name )
        `)
        .eq("project_id", projectId)
        .order("created_at", { ascending: false })
        .limit(10);
      if (activity) setLogs(activity as any);
  };

  // --- ACTIONS ---

  const updateStatus = async (newStatus: string) => {
    if (!project || !projectId) return;
    setProject({ ...project, status: newStatus as any });

    await supabase
      .from("projects")
      .update({ status: newStatus, locked: newStatus === 'published' })
      .eq("id", projectId);

    await logActivity('status_change', { from: project.status, to: newStatus });
    router.refresh();
  };

  const assignLead = async (userId: string) => {
      if (!project || !projectId) return;
      setProject({ ...project, assignee_id: userId });
      
      await supabase
        .from("projects")
        .update({ assignee_id: userId })
        .eq("id", projectId);
        
      await logActivity('assign_lead', { assignee: userId });
  };

  const addCollaborator = async (userId: string) => {
      if (!projectId || !userId) return;

      // 1. Add to DB
      const { error } = await supabase
          .from("project_collaborators")
          .insert({ project_id: projectId, user_id: userId, role: 'editor' });

      if (!error) {
          // 2. Refresh List Locally
          const userProfile = allUsers.find(u => u.user_id === userId);
          if (userProfile) {
              setCollaborators([...collaborators, { 
                  id: 'temp-' + Date.now(), 
                  user_id: userId, 
                  role: 'editor', 
                  user: userProfile 
              }]);
          }
          await logActivity('add_collaborator', { user: userId });
          setIsAddingCollab(false);
      }
  };

  const removeCollaborator = async (userId: string) => {
      if (!projectId) return;
      
      // Optimistic Remove
      setCollaborators(collaborators.filter(c => c.user_id !== userId));

      await supabase
          .from("project_collaborators")
          .delete()
          .eq("project_id", projectId)
          .eq("user_id", userId);
          
      await logActivity('remove_collaborator', { user: userId });
  };

  const logActivity = async (action: string, details: any) => {
      if (!currentUser) return;
      await supabase.from("project_activity_log").insert({
          project_id: projectId,
          user_id: currentUser,
          action_type: action,
          details: details
      });
      fetchLogs();
  };

  if (loading || !project) return <div className="p-12 flex justify-center text-slate-500"><Loader2 className="animate-spin" /></div>;

  const currentStepIndex = steps.findIndex(s => s.id === project.status);
  
  // Filter available users for "Add Collaborator" (Exclude current lead + existing collabs)
  const availableUsers = allUsers.filter(u => 
      u.user_id !== project.assignee_id && 
      !collaborators.some(c => c.user_id === u.user_id)
  );

  return (
    <div className="h-full w-full bg-[var(--background)] overflow-y-auto">
        
        <div className="sticky top-0 z-10 bg-[var(--background)]">
            {projectId && <ProjectNavBar projectId={projectId} />}
        </div>

        <div className="p-8 max-w-5xl mx-auto space-y-8 pb-20">
            {/* Header */}
            <div>
                <h1 className="text-2xl font-bold text-slate-900 dark:text-white">Governance & Settings</h1>
                <p className="text-slate-500">Manage lifecycle, team permissions, and audit trails for <strong className="text-white">{project.project_name}</strong>.</p>
            </div>

            {/* 1. LIFECYCLE ENGINE */}
            <section className="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-8">
                <div className="flex items-center gap-3 mb-6">
                    <div className="p-2 bg-indigo-500/10 rounded-lg text-indigo-500">
                        <ShieldAlert className="w-5 h-5" />
                    </div>
                    <h2 className="text-lg font-bold text-slate-900 dark:text-white">Project Lifecycle</h2>
                </div>

                <div className="relative flex justify-between items-center mb-8">
                    <div className="absolute top-5 left-0 right-0 h-0.5 bg-slate-200 dark:bg-slate-800 -z-0" />
                    {steps.map((step, idx) => {
                        const isActive = idx === currentStepIndex;
                        const isCompleted = idx < currentStepIndex;
                        return (
                            <button 
                                key={step.id}
                                onClick={() => updateStatus(step.id)}
                                disabled={project.locked && !isActive} 
                                className="relative z-10 flex flex-col items-center group focus:outline-none"
                            >
                                <div className={cn(
                                    "w-10 h-10 rounded-full flex items-center justify-center border-4 transition-all duration-300",
                                    isActive ? "bg-indigo-600 border-indigo-100 dark:border-indigo-900 text-white scale-110 shadow-xl shadow-indigo-500/20" :
                                    isCompleted ? "bg-emerald-500 border-slate-50 dark:border-slate-900 text-white" :
                                    "bg-slate-100 dark:bg-slate-800 border-slate-50 dark:border-slate-900 text-slate-400 group-hover:border-slate-300"
                                )}>
                                    {isCompleted ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-4 h-4 fill-current" />}
                                </div>
                                <div className="mt-3 text-center">
                                    <div className={cn("text-sm font-bold transition-colors", isActive ? "text-indigo-500" : "text-slate-500")}>{step.label}</div>
                                    <div className="text-[10px] text-slate-400 font-mono mt-0.5">{step.desc}</div>
                                </div>
                            </button>
                        )
                    })}
                </div>
            </section>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                {/* 2. TEAM ROSTER */}
                <section className="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 h-full flex flex-col">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 bg-emerald-500/10 rounded-lg text-emerald-500">
                            <Users className="w-5 h-5" />
                        </div>
                        <h2 className="text-lg font-bold text-slate-900 dark:text-white">Project Team</h2>
                    </div>

                    <div className="space-y-6 flex-1">
                        {/* Lead */}
                        <div>
                            <label className="text-xs font-bold uppercase text-slate-500 mb-2 block">Project Lead</label>
                            <div className="relative">
                                <select 
                                    value={project.assignee_id || ""}
                                    onChange={(e) => assignLead(e.target.value)}
                                    className="w-full appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-sm rounded-xl px-4 py-3 pr-8 focus:ring-2 focus:ring-emerald-500 outline-none"
                                >
                                    <option value="" disabled>Select a lead...</option>
                                    {allUsers.map(u => (
                                        <option key={u.user_id} value={u.user_id}>
                                            {u.first_name} {u.last_name} ({u.department})
                                        </option>
                                    ))}
                                </select>
                                <User className="absolute right-3 top-3.5 w-4 h-4 text-slate-400 pointer-events-none" />
                            </div>
                        </div>

                        {/* Collaborators List */}
                        <div>
                            <div className="flex items-center justify-between mb-3">
                                <label className="text-xs font-bold uppercase text-slate-500">Collaborators</label>
                                <button 
                                    onClick={() => setIsAddingCollab(!isAddingCollab)}
                                    className="text-xs font-bold text-indigo-600 hover:text-indigo-500 flex items-center gap-1"
                                >
                                    {isAddingCollab ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>}
                                    {isAddingCollab ? "Cancel" : "Add Member"}
                                </button>
                            </div>

                            {/* Add Member Dropdown */}
                            {isAddingCollab && (
                                <div className="mb-3 animate-in fade-in slide-in-from-top-2">
                                    <select 
                                        onChange={(e) => addCollaborator(e.target.value)}
                                        value=""
                                        className="w-full bg-white dark:bg-slate-800 border border-indigo-200 dark:border-indigo-900/50 text-sm rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500"
                                    >
                                        <option value="" disabled>Select user to add...</option>
                                        {availableUsers.map(u => (
                                            <option key={u.user_id} value={u.user_id}>
                                                {u.first_name} {u.last_name} ({u.department})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {/* List */}
                            <div className="space-y-2">
                                {collaborators.length === 0 && !isAddingCollab && (
                                    <div className="text-sm text-slate-400 italic p-3 bg-white dark:bg-slate-800/50 rounded-lg text-center border border-dashed border-slate-200 dark:border-slate-800">
                                        No additional collaborators.
                                    </div>
                                )}
                                {collaborators.map(c => (
                                    <div key={c.id} className="flex items-center justify-between p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700/50 shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-xs font-bold text-slate-500">
                                                {c.user?.first_name?.[0]}{c.user?.last_name?.[0]}
                                            </div>
                                            <div>
                                                <div className="text-sm font-medium text-slate-900 dark:text-white">
                                                    {c.user?.first_name} {c.user?.last_name}
                                                </div>
                                                <div className="text-[10px] text-slate-500 uppercase">{c.role}</div>
                                            </div>
                                        </div>
                                        <button 
                                            onClick={() => removeCollaborator(c.user_id)}
                                            className="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-md transition-colors"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </section>

                {/* 3. AUDIT LOG */}
                <section className="bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 h-full">
                    <div className="flex items-center gap-3 mb-6">
                        <div className="p-2 bg-blue-500/10 rounded-lg text-blue-500">
                            <History className="w-5 h-5" />
                        </div>
                        <h2 className="text-lg font-bold text-slate-900 dark:text-white">Activity Log</h2>
                    </div>

                    <div className="relative border-l border-slate-200 dark:border-slate-800 ml-2 space-y-6">
                        {logs.length === 0 ? (
                            <div className="pl-6 text-sm text-slate-500">No activity recorded yet.</div>
                        ) : logs.map((log) => (
                            <div key={log.id} className="relative pl-6">
                                <div className="absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full bg-slate-300 dark:bg-slate-600 border-2 border-slate-50 dark:border-slate-900" />
                                <div className="text-sm font-medium text-slate-900 dark:text-white">
                                    <span className="font-bold">{log.profiles?.first_name || 'User'}</span> {formatLogAction(log.action_type)}
                                </div>
                                <div className="text-xs text-slate-500 mt-0.5 font-mono">
                                    {new Date(log.created_at).toLocaleString()}
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            </div>
        </div>
    </div>
  );
}

function formatLogAction(action: string) {
    if (action === 'status_change') return 'changed project status';
    if (action === 'assign_lead') return 'updated project lead';
    if (action === 'add_collaborator') return 'added a team member';
    if (action === 'remove_collaborator') return 'removed a team member';
    if (action === 'config_update') return 'updated configuration';
    if (action === 'simulation_run') return 'ran a simulation';
    return 'updated project';
}\n--- ./app/(app)/projects/[projectId]/presentation/setup/page.tsx ---\n
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { useRouter, useParams } from "next/navigation";
import { 
  ArrowLeft, 
  MapPin, 
  TrendingDown, 
  Wallet, 
  CheckCircle2, 
  Play,
  Settings2,
  MonitorPlay
} from "lucide-react";
import { cn } from "@/lib/utils";
import { supabase } from "@/lib/supabaseClient";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

const PROVINCES = [
  "Gauteng", "Free State", "KwaZulu-Natal", "Western Cape", 
  "Eastern Cape", "Limpopo", "Mpumalanga", "North West", "Northern Cape"
];

export default function PresentationSetupPage() {
  const params = useParams();
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;
  const router = useRouter();
  
  const [loading, setLoading] = useState(true);
  const [project, setProject] = useState<any>(null);

  const [config, setConfig] = useState({
    title: "",
    presenter: "",
    province: "Gauteng",
    includeContext: true,
    includeDecay: true,
    includeFinancials: true,
    includeConclusion: true
  });

  useEffect(() => {
    async function fetchProject() {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}`, {
        headers: { Authorization: `Bearer ${session.access_token}` }
      });
      
      if (res.ok) {
        const data = await res.json();
        setProject(data);
        
        const text = (data.project_name + " " + (data.description || "")).toLowerCase();
        const found = PROVINCES.find(p => text.includes(p.toLowerCase())) || "Gauteng";

        setConfig(prev => ({ 
            ...prev, 
            title: `${data.project_name} Strategic Review`,
            province: found
        }));
      }
      setLoading(false);
    }
    fetchProject();
  }, [projectId]);

  const handleLaunch = () => {
    const query = new URLSearchParams({
        title: config.title,
        province: config.province,
        slides: JSON.stringify({
            context: config.includeContext,
            decay: config.includeDecay,
            finance: config.includeFinancials,
            end: config.includeConclusion
        })
    }).toString();

    router.push(`/projects/${projectId}/presentation/live?${query}`);
  };

  if (loading) return (
      <div className="min-h-screen flex items-center justify-center bg-[var(--background)]">
          <div className="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin" />
      </div>
  );

  return (
    <div className="min-h-screen bg-[var(--background)] flex flex-col font-sans">
      
      {/* Navbar */}
      <header className="border-b border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] px-8 py-4 flex items-center justify-between sticky top-0 z-10">
        <div className="flex items-center gap-4">
          <Link href={`/projects/${projectId}/dashboard`} className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition text-slate-500">
            <ArrowLeft className="h-5 w-5" />
          </Link>
          <div>
            <h1 className="text-lg font-bold flex items-center gap-2 text-slate-900 dark:text-white">
              <Settings2 className="h-5 w-5 text-indigo-500" />
              Presentation Strategy
            </h1>
            <p className="text-xs text-slate-500 font-mono">
              {project?.project_name} â€¢ {config.province}
            </p>
          </div>
        </div>
      </header>

      <main className="flex-1 max-w-6xl mx-auto w-full p-8 grid grid-cols-1 lg:grid-cols-[1.5fr,1fr] gap-12">
        
        {/* Left: Configuration */}
        <div className="space-y-10">
            
            <div className="space-y-4">
                <h2 className="text-sm font-bold uppercase tracking-wider text-slate-400">1. Context</h2>
                <div className="grid grid-cols-2 gap-6">
                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-500">Presentation Title</label>
                        <input 
                            type="text" 
                            value={config.title}
                            onChange={(e) => setConfig({...config, title: e.target.value})}
                            className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none font-medium"
                        />
                    </div>
                    <div className="space-y-2">
                        <label className="text-xs font-bold text-slate-500">Target Province</label>
                        <select 
                            value={config.province}
                            onChange={(e) => setConfig({...config, province: e.target.value})}
                            className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-indigo-500 outline-none"
                        >
                            {PROVINCES.map(p => <option key={p} value={p}>{p}</option>)}
                        </select>
                    </div>
                </div>
            </div>

            <div className="space-y-4">
                <h2 className="text-sm font-bold uppercase tracking-wider text-slate-400">2. Story Board</h2>
                <div className="grid grid-cols-1 gap-3">
                    <ModuleCard 
                        icon={<MapPin className="h-5 w-5 text-blue-500" />}
                        title="Network Overview"
                        desc="High-level map view showing current asset value and condition (VCI)."
                        active={config.includeContext}
                        onClick={() => setConfig({...config, includeContext: !config.includeContext})}
                    />
                    <ModuleCard 
                        icon={<TrendingDown className="h-5 w-5 text-rose-500" />}
                        title="The Risk (Decay)"
                        desc="Visualize the 'Cost of Inaction' with a dramatic deterioration curve."
                        active={config.includeDecay}
                        onClick={() => setConfig({...config, includeDecay: !config.includeDecay})}
                    />
                    <ModuleCard 
                        icon={<Wallet className="h-5 w-5 text-emerald-500" />}
                        title="The Ask (Financials)"
                        desc="Reveal the required budget and investment efficiency metrics."
                        active={config.includeFinancials}
                        onClick={() => setConfig({...config, includeFinancials: !config.includeFinancials})}
                    />
                    <ModuleCard 
                        icon={<CheckCircle2 className="h-5 w-5 text-indigo-500" />}
                        title="Strategic Impact"
                        desc="Comparison graph showing the divergence between funding and failure."
                        active={config.includeConclusion}
                        onClick={() => setConfig({...config, includeConclusion: !config.includeConclusion})}
                    />
                </div>
            </div>
        </div>

        {/* Right: Preview Panel */}
        <div className="sticky top-28 h-fit">
            <div className="bg-slate-900 text-white rounded-3xl p-6 shadow-2xl border border-slate-800 space-y-6">
                <div className="text-center space-y-2">
                    <div className="w-16 h-16 bg-indigo-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-indigo-500/50">
                        <MonitorPlay className="w-8 h-8 text-indigo-400" />
                    </div>
                    <h3 className="text-xl font-bold">Ready to Present</h3>
                    <p className="text-sm text-slate-400">
                        This will launch a full-screen, cinematic data experience designed for boardrooms.
                    </p>
                </div>

                <div className="bg-slate-950 rounded-xl p-4 border border-slate-800">
                    <div className="flex justify-between text-xs text-slate-400 mb-2">
                        <span>Slides</span>
                        <span className="text-white font-mono">{Object.values(config).filter(v => v === true).length - 1}</span>
                    </div>
                    <div className="flex justify-between text-xs text-slate-400">
                        <span>Est. Duration</span>
                        <span className="text-white font-mono">10-15 min</span>
                    </div>
                </div>

                <button 
                    onClick={handleLaunch}
                    className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-900/20 flex items-center justify-center gap-2 transition-all active:scale-[0.98]"
                >
                    <Play className="w-4 h-4 fill-white" />
                    Launch Live Mode
                </button>
            </div>
        </div>

      </main>
    </div>
  );
}

function ModuleCard({ icon, title, desc, active, onClick }: any) {
    return (
        <button 
            onClick={onClick}
            className={cn(
                "flex items-start gap-4 p-4 rounded-xl border text-left transition-all group",
                active 
                    ? "border-indigo-500 bg-indigo-50/50 dark:bg-indigo-900/20 ring-1 ring-indigo-500 shadow-sm" 
                    : "border-slate-200 dark:border-slate-800 hover:border-indigo-300 dark:hover:border-indigo-700 hover:bg-slate-50 dark:hover:bg-slate-800"
            )}
        >
            <div className={cn("p-2 rounded-lg transition-colors", active ? "bg-white dark:bg-slate-950 shadow-sm" : "bg-slate-100 dark:bg-slate-800")}>
                {icon}
            </div>
            <div className="flex-1">
                <div className="font-bold text-sm text-slate-900 dark:text-white flex items-center justify-between">
                    {title}
                    <div className={cn("w-5 h-5 rounded-full border flex items-center justify-center transition-all", active ? "bg-indigo-600 border-indigo-600" : "border-slate-300 dark:border-slate-600")}>
                        {active && <CheckCircle2 className="w-3.5 h-3.5 text-white" />}
                    </div>
                </div>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1 leading-relaxed pr-8">
                    {desc}
                </p>
            </div>
        </button>
    );
}\n--- ./app/(app)/projects/[projectId]/presentation/live/components/LiveMap.tsx ---\n
"use client";

import React, { useEffect, useState, useMemo } from "react";
import { MapContainer, TileLayer, Polyline, Tooltip, useMap } from "react-leaflet";
import L from "leaflet";

// @ts-ignore
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// --- PROVINCE CONFIG ---
const PROVINCES = {
    "Gauteng": { center: [-26.1076, 28.0567] as [number, number], zoom: 10 },
    "Free State": { center: [-28.4793, 26.1008] as [number, number], zoom: 8 },
    "Western Cape": { center: [-33.55, 19.50] as [number, number], zoom: 8 },
    "KwaZulu-Natal": { center: [-29.0, 30.5] as [number, number], zoom: 8 },
    "Eastern Cape": { center: [-32.0, 26.5] as [number, number], zoom: 8 },
    "Limpopo": { center: [-24.0, 29.5] as [number, number], zoom: 8 },
    "Mpumalanga": { center: [-25.5, 30.0] as [number, number], zoom: 8 },
    "North West": { center: [-26.0, 26.0] as [number, number], zoom: 8 },
    "Northern Cape": { center: [-29.5, 21.0] as [number, number], zoom: 7 },
    "Default": { center: [-29.0, 26.0] as [number, number], zoom: 6 } 
};

function MapController({ center, zoom }: { center: [number, number], zoom: number }) {
    const map = useMap();
    useEffect(() => {
        map.flyTo(center, zoom, { duration: 3.5, easeLinearity: 0.1 }); // Slower, cinematic fly
    }, [center, zoom, map]);
    return null;
}

const getConditionColor = (iri: number) => {
  if (iri < 3.5) return "#10b981"; // Emerald
  if (iri < 6.5) return "#f59e0b"; // Amber
  return "#f43f5e"; // Rose (Red)
};

export default function LiveMap({ activeLayer, segments, province = "Gauteng" }: any) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => setMounted(true), []);

  const config = useMemo(() => {
      const key = Object.keys(PROVINCES).find(k => province.includes(k)) || "Default";
      return PROVINCES[key as keyof typeof PROVINCES];
  }, [province]);

  // Mock data generator if no real segments
  const displaySegments = useMemo(() => {
      if (segments && segments.length > 0) return segments;
      
      return Array.from({ length: 80 }).map((_, i) => {
          const spread = config.zoom < 8 ? 2.0 : 0.6;
          const lat = config.center[0] + (Math.random() - 0.5) * spread;
          const lng = config.center[1] + (Math.random() - 0.5) * spread;
          
          // Random walk for line shape
          const p1: [number, number] = [lat, lng];
          const p2: [number, number] = [lat + (Math.random() - 0.5)*0.1, lng + (Math.random() - 0.5)*0.1];

          return {
              id: i,
              positions: [p1, p2],
              iri: 1 + Math.random() * 9, // Random IRI 1-10
              name: `Route R${100 + i}`
          };
      });
  }, [segments, config]);

  if (!mounted) return <div className="w-full h-full bg-slate-950" />;

  return (
    <MapContainer 
      center={config.center} 
      zoom={config.zoom} 
      style={{ height: "100%", width: "100%", background: "transparent" }} 
      zoomControl={false}
      scrollWheelZoom={false}
      dragging={false} // Disable dragging for presentation mode
      doubleClickZoom={false}
    >
      <TileLayer
        url="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
        opacity={0.6} // Dim the map so overlays pop
      />
      
      <MapController center={config.center} zoom={config.zoom} />

      {displaySegments.map((line: any) => {
        const color = activeLayer === 'condition' ? getConditionColor(line.iri) : '#3b82f6';
        const isBad = line.iri > 6;
        
        return (
            <Polyline
            key={line.id}
            positions={line.positions}
            pathOptions={{
                color: color,
                weight: activeLayer === 'condition' && isBad ? 3 : 1.5,
                opacity: activeLayer === 'condition' ? (isBad ? 0.9 : 0.3) : 0.4,
            }}
            />
        )
      })}
    </MapContainer>
  );
}\n--- ./app/(app)/projects/[projectId]/presentation/live/page.tsx ---\n
"use client";

import React, { useState, useEffect, useMemo } from "react";
import dynamic from "next/dynamic"; 
import { useSearchParams, useRouter, useParams } from "next/navigation";
import { X, ChevronLeft, ChevronRight, TrendingDown, AlertTriangle, CheckCircle2, DollarSign, MapPin, Building2, Layers } from "lucide-react";
import { cn } from "@/lib/utils";
import { useNetworkSnapshot } from "../../../[projectId]/config/hooks/useNetworkSnapshot";
import { useSimulationResults } from "../../../[projectId]/dashboard/hooks/useSimulationResults";

const LiveMap = dynamic(() => import("./components/LiveMap"), { ssr: false });

// Helper: Format Billions/Millions
const formatCurrency = (value: number) => {
    if (!value) return "0m";
    if (value >= 1000000000) return `${(value / 1000000000).toFixed(2)}bn`;
    return `${(value / 1000000).toFixed(0)}m`;
};

// Helper: Create Smooth SVG Curves
const getPath = (points: number[][], width: number, height: number, maxX: number, maxY: number) => {
    if (points.length === 0) return "";
    const scaleX = width / maxX;
    const scaleY = height / maxY;
    
    // Map points to canvas coordinates
    const P = points.map(([x, y]) => [x * scaleX, height - (y * scaleY)]);

    if (P.length === 2) return `M ${P[0][0]} ${P[0][1]} L ${P[1][0]} ${P[1][1]}`;

    // Catmull-Rom to Bezier conversion for smoothness
    let d = `M ${P[0][0]} ${P[0][1]}`;
    for (let i = 0; i < P.length - 1; i++) {
        const p0 = i > 0 ? P[i - 1] : P[0];
        const p1 = P[i];
        const p2 = P[i + 1];
        const p3 = i !== P.length - 2 ? P[i + 2] : p2;

        const cp1x = p1[0] + (p2[0] - p0[0]) / 6;
        const cp1y = p1[1] + (p2[1] - p0[1]) / 6;
        const cp2x = p2[0] - (p3[0] - p1[0]) / 6;
        const cp2y = p2[1] - (p3[1] - p1[1]) / 6;

        d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2[0]} ${p2[1]}`;
    }
    return d;
};

export default function PresentationLivePage() {
  const router = useRouter();
  const params = useParams();
  const searchParams = useSearchParams();
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;
  
  const title = searchParams.get("title") || "Strategy Presentation";
  const provinceOverride = searchParams.get("province");
  const slideConfig = JSON.parse(searchParams.get("slides") || "{}");

  const { data: snapshot } = useNetworkSnapshot(projectId || "");
  const { results } = useSimulationResults(projectId || "");

  // 1. DATA PREP
  const province = useMemo(() => {
      if (provinceOverride) return provinceOverride;
      const name = ((snapshot as any)?.project_name || "").toLowerCase();
      if (name.includes("free state")) return "Free State";
      if (name.includes("eastern cape")) return "Eastern Cape";
      if (name.includes("western cape")) return "Western Cape";
      if (name.includes("kzn") || name.includes("natal")) return "KwaZulu-Natal";
      if (name.includes("limpopo")) return "Limpopo";
      return "Gauteng"; 
  }, [snapshot, provinceOverride]);

  const startYear = (snapshot as any)?.start_year || new Date().getFullYear() + 1;
  const duration = results?.year_count || 10;
  const endYear = startYear + duration;

  // 2. CHART PREP (SMOOTH CURVES)
  const chartConfig = useMemo(() => {
      const currentVci = snapshot?.avgVci || 60;
      
      // Do Nothing (Decay) Data
      const redPoints = Array.from({ length: duration + 1 }).map((_, i) => {
          const val = Math.max(0, currentVci - (i * 3.5)); // Simulated decay
          return [i, val];
      });

      // Funded (Improve) Data
      const greenPoints = results?.yearly_data 
          ? results.yearly_data.map((d: any, i: number) => [i, d.avg_condition_index])
          : [[0, currentVci], [duration, Math.min(100, currentVci + 5)]]; // Fallback

      const redPath = getPath(redPoints, 800, 300, duration, 100);
      const greenPath = getPath(greenPoints, 800, 300, duration, 100);

      const finalRed = redPoints[redPoints.length - 1][1];
      const finalGreen = greenPoints[greenPoints.length - 1][1];

      return { redPath, greenPath, finalRed, finalGreen };
  }, [snapshot, results, duration]);

  // 3. SLIDES
  const slides = useMemo(() => {
      const s = [];
      if (slideConfig.context !== false) s.push({ id: "intro", label: "Baseline", layer: "default" });
      if (slideConfig.decay !== false) s.push({ id: "decay", label: "The Risk", layer: "condition" }); // Map turns colorful
      if (slideConfig.finance !== false) s.push({ id: "ask", label: "Investment", layer: "default" });
      if (slideConfig.end !== false) s.push({ id: "impact", label: "Strategy", layer: "default" });
      return s.length > 0 ? s : [{ id: "intro", label: "Overview", layer: "default" }];
  }, [slideConfig]);

  const [activeSlide, setActiveSlide] = useState(0);
  const currentSlide = slides[activeSlide];

  // Keyboard navigation
  useEffect(() => {
    const handleKey = (e: KeyboardEvent) => {
        if (e.key === "ArrowRight") setActiveSlide(curr => Math.min(slides.length - 1, curr + 1));
        if (e.key === "ArrowLeft") setActiveSlide(curr => Math.max(0, curr - 1));
    };
    window.addEventListener("keydown", handleKey);
    return () => window.removeEventListener("keydown", handleKey);
  }, [slides.length]);

  return (
    <div className="relative h-screen w-screen overflow-hidden bg-slate-950 text-white font-sans selection:bg-indigo-500/30">
      
      {/* 1. BACKGROUND MAP (Dynamic Opacity) */}
      <div className="absolute inset-0 z-0 transition-all duration-1000">
         <div className={cn(
             "absolute inset-0 bg-slate-950 transition-opacity duration-1000 z-10",
             currentSlide.layer === 'condition' ? 'opacity-40' : 'opacity-80'
         )} />
         <div className={cn(
             "absolute inset-0 bg-gradient-to-t from-slate-950 via-transparent to-slate-950 z-20 transition-opacity duration-1000",
             currentSlide.id === 'decay' ? 'opacity-90 from-slate-950 via-rose-950/20 to-slate-950' : 'opacity-100'
         )} />
         <LiveMap activeLayer={currentSlide.layer} province={province} />
      </div>

      {/* 2. HEADER (Fixed) */}
      <header className="absolute top-0 w-full z-50 p-8 flex justify-between items-start">
        <div className="flex items-center gap-4">
            <div className="w-12 h-1 bg-indigo-500/50 rounded-full backdrop-blur-md" />
            <div>
                <h1 className="text-xl font-bold tracking-tight text-white/90">{title}</h1>
                <div className="text-[10px] uppercase tracking-widest text-slate-400 font-medium">
                    {province} Strategy â€¢ {startYear}-{endYear}
                </div>
            </div>
        </div>
        <button onClick={() => router.back()} className="group p-3 bg-white/5 hover:bg-white/10 rounded-full transition-all border border-white/5 hover:border-white/20 backdrop-blur-md">
            <X className="h-5 w-5 text-white/50 group-hover:text-white" />
        </button>
      </header>

      {/* 3. MAIN STAGE */}
      <main className="absolute inset-0 z-30 flex items-center justify-center pointer-events-none p-12">
        
        {/* SLIDE: INTRO (Asset Context) */}
        {currentSlide.id === "intro" && (
            <div className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-2 gap-12 items-end animate-in fade-in zoom-in-95 duration-1000">
                <div className="space-y-6">
                    <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-bold uppercase tracking-widest">
                        <Layers className="w-3 h-3" /> Current Network Status
                    </div>
                    <h2 className="text-7xl font-black leading-tight tracking-tighter drop-shadow-2xl">
                        Asset <br/> <span className="text-transparent bg-clip-text bg-gradient-to-r from-slate-100 to-slate-500">Baseline.</span>
                    </h2>
                    <p className="text-xl text-slate-400 max-w-md leading-relaxed">
                        A detailed review of the current engineering inventory and valuation for the {province} region.
                    </p>
                </div>
                
                {/* HUD Grid */}
                <div className="grid grid-cols-2 gap-4">
                    <HudCard label="Replacement Cost" value={`R${((snapshot?.assetValue || 0)/1e9).toFixed(1)}bn`} icon={<Building2 className="w-5 h-5 text-indigo-400"/>} delay={100} />
                    <HudCard label="Network Size" value={`${(snapshot?.totalLengthKm || 0).toLocaleString()} km`} icon={<MapPin className="w-5 h-5 text-blue-400"/>} delay={200} />
                    <HudCard label="Avg Condition" value={`VCI ${(snapshot?.avgVci || 0).toFixed(0)}`} icon={<TrendingDown className="w-5 h-5 text-emerald-400"/>} delay={300} />
                    <HudCard label="Current Backlog" value={`R${formatCurrency(results?.total_cost_npv ? results.total_cost_npv * 0.4 : 0)}`} icon={<AlertTriangle className="w-5 h-5 text-amber-400"/>} delay={400} sub="Est. Immediate Need" />
                </div>
            </div>
        )}

        {/* SLIDE: DECAY (The Risk) */}
        {currentSlide.id === "decay" && (
            <div className="w-full max-w-6xl flex flex-col items-center text-center animate-in slide-in-from-bottom-10 fade-in duration-700">
                <div className="p-4 bg-rose-500/20 rounded-full border border-rose-500/30 mb-6 animate-pulse">
                    <AlertTriangle className="w-12 h-12 text-rose-500" />
                </div>
                <h2 className="text-6xl font-black text-white mb-6 tracking-tight drop-shadow-2xl">
                    The Cost of <span className="text-rose-500">Inaction.</span>
                </h2>
                <div className="max-w-2xl bg-black/60 backdrop-blur-xl border border-rose-500/30 p-8 rounded-3xl">
                    <p className="text-2xl text-slate-200 leading-relaxed font-light">
                        Without intervention, network quality will degrade to <strong className="text-rose-400 font-bold">VCI {chartConfig.finalRed.toFixed(0)}</strong> (Poor) by {endYear}.
                    </p>
                    <div className="mt-6 h-1 w-full bg-gradient-to-r from-rose-900/0 via-rose-500 to-rose-900/0 opacity-50" />
                    <p className="mt-6 text-sm text-rose-300 font-mono uppercase tracking-widest">
                        Liability grows by R{(results?.total_cost_npv ? results.total_cost_npv * 0.12 / 1e6 : 0).toFixed(0)}m annually
                    </p>
                </div>
            </div>
        )}

        {/* SLIDE: FINANCIALS (The Ask) */}
        {currentSlide.id === "ask" && (
            <div className="w-full max-w-5xl text-center animate-in zoom-in-95 duration-700">
                <div className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 text-xs font-bold uppercase tracking-widest mb-8">
                    <CheckCircle2 className="w-4 h-4" /> Strategic Recommendation
                </div>
                
                <h1 className="text-[140px] font-black text-white leading-[0.9] tracking-tighter drop-shadow-2xl mb-4">
                    R {formatCurrency(results?.total_cost_npv || 0)}
                </h1>
                
                <p className="text-2xl text-slate-400 font-light mb-12">
                    Total investment requirement over the <strong>{duration}-Year</strong> MTEF period.
                </p>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-left">
                    <ValueProp title="Fiscal Efficiency" desc="Reduces long-term capital demand by ~40% vs reactive repairs." delay={100} />
                    <ValueProp title="Service Delivery" desc={`Stabilizes key corridors in the ${province} region.`} delay={200} />
                    <ValueProp title="Asset Security" desc={`Maintains VCI above ${chartConfig.finalGreen.toFixed(0)}, preserving asset value.`} delay={300} />
                </div>
            </div>
        )}

        {/* SLIDE: CONCLUSION (The Graph) */}
        {currentSlide.id === "impact" && (
            <div className="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-[1fr,2fr] gap-12 items-center animate-in slide-in-from-right duration-700">
                <div className="space-y-6">
                    <h2 className="text-5xl font-black text-white leading-none">Strategic <br/> Impact.</h2>
                    <p className="text-lg text-slate-400">
                        Visualizing the divergence between the "Do Nothing" scenario and the "Funded Strategy."
                    </p>
                    <div className="space-y-4 pt-4">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-1 bg-emerald-500 rounded-full" />
                            <div className="text-sm font-bold text-emerald-400 uppercase tracking-widest">Funded (Safe)</div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-1 bg-rose-500 rounded-full opacity-50" />
                            <div className="text-sm font-bold text-rose-400 uppercase tracking-widest">Do Nothing (Risk)</div>
                        </div>
                    </div>
                </div>

                <div className="relative h-[400px] w-full bg-slate-900/50 backdrop-blur-xl border border-white/10 rounded-3xl p-8 shadow-2xl">
                    {/* Y-Axis Labels */}
                    <div className="absolute left-4 top-8 bottom-8 flex flex-col justify-between text-xs text-slate-600 font-mono">
                        <span>100 (Good)</span>
                        <span>50 (Fair)</span>
                        <span>0 (Poor)</span>
                    </div>
                    
                    {/* Chart Canvas */}
                    <div className="absolute inset-0 left-16 right-8 top-8 bottom-8">
                        <svg className="w-full h-full overflow-visible" viewBox="0 0 800 300" preserveAspectRatio="none">
                            {/* Grid Lines */}
                            <line x1="0" y1="0" x2="800" y2="0" stroke="white" strokeOpacity="0.05" />
                            <line x1="0" y1="150" x2="800" y2="150" stroke="white" strokeOpacity="0.05" strokeDasharray="4 4" />
                            <line x1="0" y1="300" x2="800" y2="300" stroke="white" strokeOpacity="0.05" />

                            {/* Red Path (Under) */}
                            <path d={chartConfig.redPath} fill="none" stroke="#f43f5e" strokeWidth="4" strokeOpacity="0.6" strokeDasharray="10 5" />
                            
                            {/* Green Path (Top) */}
                            <path d={chartConfig.greenPath} fill="none" stroke="#10b981" strokeWidth="6" strokeLinecap="round" className="drop-shadow-[0_0_15px_rgba(16,185,129,0.5)]" />
                            
                            {/* End Points */}
                            <circle cx="800" cy={300 - (chartConfig.finalGreen * 3)} r="6" fill="#10b981" />
                            <circle cx="800" cy={300 - (chartConfig.finalRed * 3)} r="6" fill="#f43f5e" />
                        </svg>
                    </div>
                </div>
            </div>
        )}

      </main>

      {/* 4. CONTROLS (Footer) */}
      <footer className="absolute bottom-8 w-full z-50 flex justify-center pointer-events-auto">
          <div className="flex items-center gap-4 bg-white/5 backdrop-blur-md border border-white/10 p-2 pl-6 pr-2 rounded-full shadow-2xl transition-transform hover:scale-105">
              <div className="flex flex-col">
                  <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{activeSlide + 1} / {slides.length}</span>
                  <span className="text-sm font-bold text-white">{currentSlide.label}</span>
              </div>
              <div className="h-8 w-px bg-white/10 mx-2" />
              <div className="flex gap-2">
                  <button 
                    onClick={() => setActiveSlide(curr => Math.max(0, curr - 1))}
                    disabled={activeSlide === 0}
                    className="p-3 bg-white/5 hover:bg-white/10 rounded-full transition disabled:opacity-20"
                  >
                      <ChevronLeft className="w-5 h-5 text-white" />
                  </button>
                  <button 
                    onClick={() => setActiveSlide(curr => Math.min(slides.length - 1, curr + 1))}
                    disabled={activeSlide === slides.length - 1}
                    className="p-3 bg-indigo-600 hover:bg-indigo-500 rounded-full transition shadow-lg disabled:opacity-20 disabled:bg-slate-700"
                  >
                      <ChevronRight className="w-5 h-5 text-white" />
                  </button>
              </div>
          </div>
      </footer>

    </div>
  );
}

// --- SUB-COMPONENTS ---

function HudCard({ label, value, icon, delay, sub }: any) {
    return (
        <div 
            className="p-5 bg-slate-900/60 backdrop-blur-md border border-white/10 rounded-xl hover:bg-white/5 transition-colors group animate-in slide-in-from-bottom-4 fade-in fill-mode-backwards"
            style={{ animationDelay: `${delay}ms` }}
        >
            <div className="flex justify-between items-start mb-2">
                <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold group-hover:text-slate-300 transition-colors">{label}</div>
                {icon}
            </div>
            <div className="text-3xl font-bold font-mono text-white tracking-tight">{value}</div>
            {sub && <div className="text-[10px] text-rose-400 mt-1 font-medium">{sub}</div>}
        </div>
    )
}

function ValueProp({ title, desc, delay }: any) {
    return (
        <div 
            className="p-6 bg-white/5 border border-white/5 rounded-2xl hover:bg-white/10 transition-colors animate-in slide-in-from-bottom-8 fade-in fill-mode-backwards"
            style={{ animationDelay: `${delay}ms` }}
        >
            <div className="w-8 h-1 bg-emerald-500 rounded-full mb-4" />
            <h3 className="text-lg font-bold text-white mb-2">{title}</h3>
            <p className="text-sm text-slate-400 leading-relaxed">{desc}</p>
        </div>
    )
}\n--- ./app/(app)/projects/[projectId]/presentation/share/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useParams } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { Share2, Copy, Check, ExternalLink, RefreshCcw } from "lucide-react";
import { cn } from "@/lib/utils";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

export default function PresentationSharePage() {
  const params = useParams();
  const projectId = Array.isArray(params?.projectId)
    ? params?.projectId[0]
    : (params?.projectId as string | undefined);

  const [loading, setLoading] = useState(false);
  const [checking, setChecking] = useState(false);

  const [slug, setSlug] = useState<string | null>(null);
  const [copied, setCopied] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // âœ… SSR/Next-safe origin
  const [origin, setOrigin] = useState("");
  useEffect(() => {
    setOrigin(window.location.origin);
  }, []);

  const publicUrl = useMemo(() => {
    return slug && origin ? `${origin}/p/${slug}` : "";
  }, [slug, origin]);

  // Optional: load existing slug if backend supports it (doesn't break if 404)
  const loadExisting = async () => {
    if (!projectId) return;
    setChecking(true);
    setError(null);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) throw new Error("Not authenticated");

      // âœ… Optional endpoint:
      // GET /api/v1/projects/:id/presentation/share -> { slug } (or 404 if none)
      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/presentation/share`,
        {
          headers: { Authorization: `Bearer ${token}` },
        }
      );

      if (res.status === 404) {
        setSlug(null);
        return;
      }

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || "Failed to load existing share link");
      }

      const data = await res.json();
      if (data?.slug) setSlug(data.slug);
    } catch (e: any) {
      // keep non-fatal so page still works even if you haven't built GET
      setError(e?.message || "Failed to load existing link");
    } finally {
      setChecking(false);
    }
  };

  useEffect(() => {
    loadExisting();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  const generateLink = async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) throw new Error("Not authenticated");

      // âœ… Backend should create/update share slug
      // POST /api/v1/projects/:id/presentation/share -> { slug }
      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/presentation/share`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json",
          },
          // Later you can persist title/province/slides here (and have public endpoint return them)
          body: JSON.stringify({}),
        }
      );

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || "Failed to generate link");
      }

      const data = await res.json();
      if (!data?.slug) throw new Error("Share link created but no slug returned");
      setSlug(data.slug);
    } catch (e: any) {
      setError(e?.message || "Failed to generate link");
    } finally {
      setLoading(false);
    }
  };

  const copyLink = async () => {
    if (!publicUrl) return;
    try {
      await navigator.clipboard.writeText(publicUrl);
      setCopied(true);
      setTimeout(() => setCopied(false), 1500);
    } catch {
      // Fallback: select/copy would need an input; keep simple
      setError("Clipboard permission blocked. Please copy the link manually.");
    }
  };

  return (
    <div className="min-h-screen bg-[var(--background)] p-8">
      <div className="max-w-3xl mx-auto space-y-6">
        <div className="p-6 rounded-3xl bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800">
          <div className="flex items-center justify-between gap-3 mb-3">
            <div className="flex items-center gap-3">
              <div className="p-3 rounded-2xl bg-indigo-500/10 border border-indigo-500/20">
                <Share2 className="w-6 h-6 text-indigo-500" />
              </div>
              <div>
                <h1 className="text-2xl font-black text-slate-900 dark:text-white">
                  Public Share Link
                </h1>
                <p className="text-sm text-slate-500">
                  Generate a view-only link that anyone can open (no login).
                </p>
              </div>
            </div>

            <button
              onClick={loadExisting}
              disabled={checking || !projectId}
              className={cn(
                "inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 transition text-sm font-semibold",
                (checking || !projectId) && "opacity-60"
              )}
              title="Re-check existing share link"
            >
              <RefreshCcw className={cn("w-4 h-4", checking && "animate-spin")} />
              Refresh
            </button>
          </div>

          {error && (
            <div className="p-3 rounded-xl bg-rose-50 dark:bg-rose-900/20 border border-rose-200 dark:border-rose-800 text-sm text-rose-700 dark:text-rose-300">
              {error}
            </div>
          )}

          <div className="mt-5 flex flex-col md:flex-row gap-3">
            <button
              onClick={generateLink}
              disabled={loading || !projectId}
              className={cn(
                "px-5 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition flex items-center justify-center gap-2",
                (loading || !projectId) && "opacity-70"
              )}
            >
              <Share2 className="w-4 h-4" />
              {loading ? "Generating..." : slug ? "Regenerate Link" : "Generate Public Link"}
            </button>

            <button
              onClick={copyLink}
              disabled={!slug || !publicUrl}
              className="px-5 py-3 rounded-xl font-bold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 transition flex items-center justify-center gap-2 disabled:opacity-50"
            >
              {copied ? (
                <Check className="w-4 h-4 text-emerald-500" />
              ) : (
                <Copy className="w-4 h-4" />
              )}
              {copied ? "Copied" : "Copy Link"}
            </button>

            {slug && publicUrl && (
              <a
                href={publicUrl}
                target="_blank"
                rel="noreferrer"
                className="px-5 py-3 rounded-xl font-bold border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 transition flex items-center justify-center gap-2"
              >
                <ExternalLink className="w-4 h-4" />
                Open
              </a>
            )}
          </div>

          {slug && (
            <div className="mt-4 space-y-2">
              <div className="text-xs uppercase tracking-widest text-slate-400 font-bold">
                View-only URL
              </div>
              <div className="text-xs text-slate-500 font-mono break-all p-3 rounded-xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
                {publicUrl}
              </div>
              <div className="text-[11px] text-slate-500">
                Anyone with this link can view the presentation. No login required.
              </div>
            </div>
          )}
        </div>

        <div className="p-5 rounded-2xl bg-amber-50 dark:bg-amber-900/10 border border-amber-200 dark:border-amber-800 text-sm text-amber-800 dark:text-amber-300">
          <strong>Backend note:</strong> the public page expects{" "}
          <span className="font-mono">GET /api/v1/public/presentations/:slug</span>{" "}
          returning config (title/province/slides) and a resolvable{" "}
          <span className="font-mono">projectId</span>.
          <div className="mt-2 text-xs text-amber-700/80 dark:text-amber-300/80">
            Optional but recommended: also implement{" "}
            <span className="font-mono">GET /api/v1/projects/:id/presentation/share</span>{" "}
            to fetch existing slugs (this page already supports it).
          </div>
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/projects/governance/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";
import { 
  ShieldAlert, 
  CheckCircle2, 
  Clock, 
  AlertCircle, 
  FileText,
  ArrowRight,
  Loader2,
} from "lucide-react";
import { cn } from "@/lib/utils";

// --- TYPES ---
type Profile = {
  user_id: string;
  first_name: string;
  last_name: string;
};

type ProjectGovSummary = {
  id: string;
  project_name: string;
  province: string;
  status: 'backlog' | 'planning' | 'review' | 'published';
  assignee_id: string | null;
  assignee?: Profile; 
  updated_at: string;
};

export default function GlobalGovernancePage() {
  const [projects, setProjects] = useState<ProjectGovSummary[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadGovernanceOverview() {
      // 1. Fetch Projects (No Joins to prevent 400 Error)
      const { data: projectData, error: projError } = await supabase
          .from("projects")
          .select("id, project_name, province, status, updated_at, assignee_id")
          .order("updated_at", { ascending: false });

      if (projError) {
          console.error("Error loading projects:", projError);
          setLoading(false);
          return;
      }

      // 2. Fetch Profiles Separately
      const assigneeIds = [...new Set(projectData?.map(p => p.assignee_id).filter(Boolean))];
      let profileMap = new Map<string, Profile>();
      
      if (assigneeIds.length > 0) {
          const { data: profileData } = await supabase
              .from("profiles")
              .select("user_id, first_name, last_name")
              .in("user_id", assigneeIds);
          
          profileData?.forEach((p: any) => profileMap.set(p.user_id, p));
      }

      // 3. Merge Data
      const combined = (projectData || []).map((p: any) => ({
          ...p,
          status: p.status || 'backlog',
          assignee: p.assignee_id ? profileMap.get(p.assignee_id) : undefined
      }));

      setProjects(combined);
      setLoading(false);
    }
    loadGovernanceOverview();
  }, []);

  // Helper to count projects by status
  const count = (status: string) => projects.filter(p => p.status === status).length;

  return (
    <div className="h-full w-full bg-[var(--background)] p-8 overflow-y-auto">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* HEADER */}
        <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">Governance Oversight</h1>
            <p className="text-slate-500 dark:text-slate-400 mt-1">Monitor compliance, approval workflows, and project lifecycle status.</p>
        </div>

        {/* 1. KPI CARDS */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <KpiCard label="In Planning" value={count('planning')} icon={<FileText className="w-5 h-5 text-blue-500"/>} />
            <KpiCard label="Needs Review" value={count('review')} icon={<AlertCircle className="w-5 h-5 text-amber-500"/>} highlight />
            <KpiCard label="Published" value={count('published')} icon={<CheckCircle2 className="w-5 h-5 text-emerald-500"/>} />
            <KpiCard label="Backlog" value={count('backlog')} icon={<Clock className="w-5 h-5 text-slate-500"/>} />
        </div>

        {/* 2. PROJECT TABLE */}
        <section className="bg-white dark:bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-2xl overflow-hidden shadow-sm">
            <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <h3 className="font-bold text-slate-900 dark:text-white">Project Portfolio Status</h3>
            </div>
            
            {loading ? (
                <div className="p-12 flex justify-center"><Loader2 className="w-6 h-6 animate-spin text-slate-400"/></div>
            ) : projects.length === 0 ? (
                <div className="p-12 text-center text-slate-500">No projects found.</div>
            ) : (
                <div className="divide-y divide-slate-100 dark:divide-slate-800">
                    <div className="grid grid-cols-12 px-6 py-3 bg-slate-50/50 dark:bg-slate-900/50 text-xs font-bold uppercase tracking-wider text-slate-500">
                        <div className="col-span-4">Project Name</div>
                        <div className="col-span-2">Province</div>
                        <div className="col-span-2">Lead</div>
                        <div className="col-span-2">Status</div>
                        <div className="col-span-2 text-right">Action</div>
                    </div>
                    {projects.map((p) => (
                        <div key={p.id} className="grid grid-cols-12 px-6 py-4 items-center hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
                            <div className="col-span-4 font-medium text-slate-900 dark:text-white truncate pr-4">
                                {p.project_name}
                            </div>
                            <div className="col-span-2 text-sm text-slate-500">{p.province}</div>
                            <div className="col-span-2 text-sm text-slate-500">
                                {p.assignee ? `${p.assignee.first_name} ${p.assignee.last_name}` : <span className="text-slate-400 italic">Unassigned</span>}
                            </div>
                            <div className="col-span-2">
                                <StatusBadge status={p.status} />
                            </div>
                            <div className="col-span-2 text-right">
                                <Link 
                                    href={`/projects/${p.id}/governance`} 
                                    className="inline-flex items-center gap-1 text-xs font-bold text-indigo-600 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300"
                                >
                                    Manage <ArrowRight className="w-3 h-3" />
                                </Link>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </section>

      </div>
    </div>
  );
}

// --- SUB-COMPONENTS (Global View) ---

function KpiCard({ label, value, icon, highlight }: any) {
    return (
        <div className={cn(
            "p-5 rounded-2xl border flex flex-col justify-between h-28",
            highlight 
                ? "bg-amber-50 dark:bg-amber-950/20 border-amber-200 dark:border-amber-800" 
                : "bg-white dark:bg-[var(--surface-bg)] border-slate-200 dark:border-slate-800"
        )}>
            <div className="flex justify-between items-start">
                <span className="text-xs font-bold uppercase tracking-wider text-slate-500">{label}</span>
                {icon}
            </div>
            <div className="text-3xl font-black text-slate-900 dark:text-white">{value}</div>
        </div>
    )
}

function StatusBadge({ status }: { status: string }) {
    type StatusKey = 'backlog' | 'planning' | 'review' | 'published';
    const config: Record<StatusKey, { color: string; label: string }> = {
        backlog: { color: "bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400", label: "Backlog" },
        planning: { color: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400", label: "Planning" },
        review: { color: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400", label: "In Review" },
        published: { color: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400", label: "Published" },
    };
    const activeConfig = config[status as StatusKey] || config.backlog;
    return (
        <span className={cn("px-2.5 py-1 rounded-full text-[10px] uppercase font-bold tracking-wider", activeConfig.color)}>
            {activeConfig.label}
        </span>
    );
}\n--- ./app/(app)/projects/page.tsx ---\n
"use client";

import React, { useEffect, useState, useMemo } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { ProjectCreateForm } from "./ProjectCreateForm";
import {
  Plus,
  Search,
  Clock,
  FileText,
  AlertCircle,
  User,
  LayoutGrid,
} from "lucide-react";
import { cn } from "@/lib/utils";

// --- TYPES ---
type Profile = {
  user_id: string;
  first_name: string;
  last_name: string;
  email: string;
};

type Project = {
  id: string;
  project_name: string;
  province: string;
  start_year: number;
  status: "backlog" | "planning" | "review" | "published" | "archived";
  due_date: string | null;
  created_at: string;
  assignee_id: string | null;
  assignee?: Profile;
};

// --- MODAL COMPONENT ---
function Modal({
  children,
  isOpen,
  onClose,
}: {
  children: React.ReactNode;
  isOpen: boolean;
  onClose: () => void;
}) {
  if (!isOpen) return null;
  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
      onClick={onClose}
    >
      <div
        className="relative w-full max-w-lg bg-[var(--surface-bg)] rounded-xl shadow-2xl overflow-hidden"
        onClick={(e) => e.stopPropagation()}
      >
        {children}
      </div>
    </div>
  );
}

export default function ProjectsPage() {
  const router = useRouter();

  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState("all");
  const [search, setSearch] = useState("");
  const [currentUser, setCurrentUser] = useState<string | null>(null);

  // Modal State
  const [isFormOpen, setIsFormOpen] = useState(false);

  async function loadData() {
    setLoading(true);

    // A. Get Current User
    const {
      data: { user },
      error: userErr,
    } = await supabase.auth.getUser();

    if (userErr) console.warn("auth.getUser error:", userErr);

    if (!user) {
      setCurrentUser(null);
      setProjects([]);
      setLoading(false);
      router.replace("/login");
      return;
    }

    setCurrentUser(user.id);

    // B. Fetch Projects (Raw)
    const { data: projectsData, error: projError } = await supabase
      .from("projects")
      .select("*")
      .order("created_at", { ascending: false });

    if (projError) {
      console.error("Error loading projects:", projError);
      setLoading(false);
      return;
    }

    // C. Fetch Profiles (for Assignees)
    const { data: profilesData, error: profErr } = await supabase
      .from("profiles")
      .select("*");

    if (profErr) console.warn("Error loading profiles:", profErr);

    const profileMap = new Map<string, Profile>();
    profilesData?.forEach((p: any) => profileMap.set(p.user_id, p));

    // D. Merge Data
    const mergedProjects = (projectsData || []).map((p: any) => ({
      ...p,
      status: (p.status || "backlog") as Project["status"],
      assignee: p.assignee_id ? profileMap.get(p.assignee_id) : undefined,
    }));

    setProjects(mergedProjects);
    setLoading(false);
  }

  useEffect(() => {
    loadData();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // --- FILTER LOGIC ---
  const filteredProjects = useMemo(() => {
    return projects.filter((p) => {
      const searchLower = search.toLowerCase();
      const matchesSearch =
        p.project_name.toLowerCase().includes(searchLower) ||
        p.province.toLowerCase().includes(searchLower);

      if (!matchesSearch) return false;

      if (activeTab === "all") return true;

      // Note: "My Assignments" only works if assignee_id is populated
      if (activeTab === "mine") return p.assignee_id === currentUser;

      if (activeTab === "planning") return p.status === "planning";
      if (activeTab === "review") return p.status === "review";
      if (activeTab === "backlog") return p.status === "backlog" || !p.status;

      return true;
    });
  }, [projects, activeTab, search, currentUser]);

  const counts = useMemo(() => {
    const planning = projects.filter((p) => p.status === "planning").length;
    const review = projects.filter((p) => p.status === "review").length;
    const backlog = projects.filter((p) => p.status === "backlog" || !p.status).length;
    return { planning, review, backlog };
  }, [projects]);

  return (
    <div className="h-full w-full bg-[var(--background)] p-6 overflow-y-auto">
      <div className="max-w-7xl mx-auto space-y-8 pb-10">
        {/* HEADER */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
              Mission Control
            </h1>
            <p className="text-slate-500 dark:text-slate-400 mt-1">
              Manage province-first road programmes and approval workflows.
            </p>
          </div>

          <button
            onClick={() => setIsFormOpen(true)}
            className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl font-bold transition-all shadow-lg hover:shadow-indigo-500/25"
          >
            <Plus className="w-5 h-5" />
            New Provincial Proposal
          </button>
        </div>

        {/* WORKFLOW TABS */}
        <div className="flex flex-col sm:flex-row items-center justify-between border-b border-slate-200 dark:border-slate-800 pb-1 gap-4">
          <div className="flex items-center gap-2 overflow-x-auto w-full sm:w-auto no-scrollbar pb-2 sm:pb-0">
            <TabButton
              active={activeTab === "all"}
              onClick={() => setActiveTab("all")}
              label="All Proposals"
              count={projects.length}
            />
            <TabButton
              active={activeTab === "mine"}
              onClick={() => setActiveTab("mine")}
              label="My Assignments"
              icon={<User className="w-4 h-4" />}
            />
            <TabButton
              active={activeTab === "planning"}
              onClick={() => setActiveTab("planning")}
              label="Active Planning"
              icon={<FileText className="w-4 h-4 text-blue-500" />}
              count={counts.planning}
            />
            <TabButton
              active={activeTab === "review"}
              onClick={() => setActiveTab("review")}
              label="Needs Review"
              icon={<AlertCircle className="w-4 h-4 text-amber-500" />}
              count={counts.review}
            />
            <TabButton
              active={activeTab === "backlog"}
              onClick={() => setActiveTab("backlog")}
              label="Backlog"
              icon={<Clock className="w-4 h-4 text-slate-400" />}
              count={counts.backlog}
            />
          </div>

          {/* Search */}
          <div className="relative w-full sm:w-64 mt-2 sm:mt-0">
            <Search className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
            <input
              type="text"
              placeholder="Search by province or title..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="w-full pl-9 pr-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg text-sm outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
        </div>

        {/* PROJECT GRID */}
        {loading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1, 2, 3].map((i) => (
              <div
                key={i}
                className="h-48 bg-slate-100 dark:bg-slate-800 rounded-2xl animate-pulse"
              />
            ))}
          </div>
        ) : filteredProjects.length === 0 ? (
          <div className="py-20 text-center border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl">
            <div className="w-16 h-16 bg-slate-50 dark:bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
              <LayoutGrid className="w-8 h-8" />
            </div>
            <h3 className="text-lg font-bold text-slate-900 dark:text-white">
              No proposals found
            </h3>
            <p className="text-slate-500 mt-2">
              Try adjusting your filters or create a new provincial proposal.
            </p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-in fade-in duration-500">
            {filteredProjects.map((project) => (
              <ProjectCard key={project.id} project={project} />
            ))}
          </div>
        )}
      </div>

      {/* CREATE MODAL */}
      <Modal isOpen={isFormOpen} onClose={() => setIsFormOpen(false)}>
        <ProjectCreateForm
          onClose={(created, newProjectId) => {
            setIsFormOpen(false);
            if (created) {
              loadData();
              if (newProjectId) router.push(`/projects/${newProjectId}/config`);
            }
          }}
        />
      </Modal>
    </div>
  );
}

// --- SUB-COMPONENTS ---

function TabButton({ active, onClick, label, count, icon }: any) {
  return (
    <button
      onClick={onClick}
      className={cn(
        "flex items-center gap-2 px-3 py-2 text-sm font-medium transition-colors whitespace-nowrap rounded-lg",
        active
          ? "bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400"
          : "text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800"
      )}
    >
      {icon}
      {label}
      {count !== undefined && (
        <span
          className={cn(
            "px-2 py-0.5 rounded-full text-[10px] font-bold ml-1",
            active
              ? "bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300"
              : "bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400"
          )}
        >
          {count}
        </span>
      )}
    </button>
  );
}

function ProjectCard({ project }: { project: Project }) {
  const statusConfig =
    {
      backlog: {
        color:
          "bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-400",
        label: "Backlog",
      },
      planning: {
        color:
          "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400",
        label: "Planning",
      },
      review: {
        color:
          "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
        label: "In Review",
      },
      published: {
        color:
          "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400",
        label: "Published",
      },
      archived: { color: "bg-slate-100 text-slate-400", label: "Archived" },
    }[project.status || "backlog"];

  const formattedDate = project.created_at
    ? new Date(project.created_at).toLocaleDateString()
    : "N/A";

  return (
    <Link
      href={`/projects/${project.id}/config`}
      className="group relative bg-white dark:bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-2xl p-6 hover:border-indigo-500 dark:hover:border-indigo-500 hover:shadow-xl hover:shadow-indigo-500/10 transition-all duration-300 flex flex-col h-full"
    >
      <div className="flex justify-between items-start mb-4">
        <div className="p-3 bg-slate-50 dark:bg-slate-800 rounded-xl group-hover:scale-110 transition-transform duration-300">
          <FileText className="w-6 h-6 text-indigo-600 dark:text-indigo-400" />
        </div>
        <span
          className={cn(
            "px-2.5 py-1 rounded-lg text-[10px] uppercase font-bold tracking-wider",
            statusConfig.color
          )}
        >
          {statusConfig.label}
        </span>
      </div>

      <div className="mb-4 flex-1">
        <h3 className="font-bold text-lg text-slate-900 dark:text-white mb-1 group-hover:text-indigo-600 transition-colors">
          {project.project_name}
        </h3>
        <div className="flex items-center gap-2 text-xs text-slate-500">
          <span className="font-medium text-slate-700 dark:text-slate-300">
            {project.province}
          </span>
          <span>â€¢</span>
          <span>FY{project.start_year}</span>
        </div>
      </div>

      <div className="pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between">
        <div className="flex items-center gap-2">
          {project.assignee ? (
            <div
              className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-700 flex items-center justify-center text-[10px] font-bold"
              title={`${project.assignee.first_name} ${project.assignee.last_name}`}
            >
              {project.assignee.first_name[0]}
              {project.assignee.last_name[0]}
            </div>
          ) : (
            <div className="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 flex items-center justify-center">
              <User className="w-3 h-3" />
            </div>
          )}
          <span className="text-xs text-slate-400">
            {project.assignee ? `${project.assignee.first_name}` : "Unassigned"}
          </span>
        </div>

        <div className="flex items-center gap-1 text-[10px] font-mono text-slate-400">
          <Clock className="w-3 h-3" />
          {formattedDate}
        </div>
      </div>
    </Link>
  );
}\n--- ./app/(app)/projects/recent/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";
import { 
  Activity, 
  FileText, 
  User, 
  Clock, 
  ArrowLeft,
  CheckCircle2,
  UploadCloud,
  ShieldAlert,
  Plus,
  Settings, // New Icon
  Play      // New Icon
} from "lucide-react";
import { cn } from "@/lib/utils";

// --- TYPES ---
type ActivityLog = {
  id: string;
  project_id: string | null;
  user_id: string | null;
  action_type: string;
  details: any;
  created_at: string;
  // Hydrated fields
  project_name?: string;
  user_name?: string;
  user_email?: string;
};

export default function RecentActivityPage() {
  const [activities, setActivities] = useState<ActivityLog[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadFeed() {
      setLoading(true);

      // 1. Fetch Logs
      const { data: logs, error } = await supabase
        .from("project_activity_log")
        .select("*")
        .order("created_at", { ascending: false })
        .limit(50);

      if (error || !logs) {
        console.error("Error fetching logs", error);
        setLoading(false);
        return;
      }

      // 2. Extract IDs for bulk fetching
      const userIds = [...new Set(logs.map(l => l.user_id).filter(Boolean))];
      const projectIds = [...new Set(logs.map(l => l.project_id).filter(Boolean))];

      // 3. Fetch Related Data
      const [usersRes, projectsRes] = await Promise.all([
        supabase.from("profiles").select("user_id, first_name, last_name, email").in("user_id", userIds),
        supabase.from("projects").select("id, project_name").in("id", projectIds)
      ]);

      // 4. Create Lookup Maps
      const userMap = new Map(usersRes.data?.map(u => [u.user_id, u]));
      const projectMap = new Map(projectsRes.data?.map(p => [p.id, p]));

      // 5. Hydrate Logs
      const hydratedLogs = logs.map(log => {
        const user = userMap.get(log.user_id);
        const project = projectMap.get(log.project_id);
        return {
          ...log,
          user_name: user ? `${user.first_name} ${user.last_name}` : "Unknown User",
          user_email: user?.email,
          project_name: project?.project_name || "Deleted Project"
        };
      });

      setActivities(hydratedLogs);
      setLoading(false);
    }

    loadFeed();
  }, []);

  return (
    <div className="h-full w-full bg-[var(--background)] p-8 overflow-y-auto">
      <div className="max-w-4xl mx-auto space-y-8 pb-12">
        
        {/* HEADER */}
        <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
                <Link href="/projects" className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <ArrowLeft className="w-5 h-5 text-slate-500" />
                </Link>
                <div>
                    <h1 className="text-2xl font-bold text-slate-900 dark:text-white tracking-tight flex items-center gap-2">
                        <Activity className="w-6 h-6 text-indigo-500" />
                        Activity Feed
                    </h1>
                    <p className="text-slate-500 dark:text-slate-400 text-sm">Real-time audit log of all project actions.</p>
                </div>
            </div>
        </div>

        {/* FEED LIST */}
        <div className="bg-white dark:bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden">
            {loading ? (
                <div className="p-12 space-y-4">
                    {[1,2,3,4].map(i => (
                        <div key={i} className="flex gap-4 animate-pulse">
                            <div className="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800" />
                            <div className="flex-1 space-y-2">
                                <div className="h-4 bg-slate-100 dark:bg-slate-800 rounded w-1/3" />
                                <div className="h-3 bg-slate-100 dark:bg-slate-800 rounded w-1/4" />
                            </div>
                        </div>
                    ))}
                </div>
            ) : activities.length === 0 ? (
                <div className="py-20 text-center flex flex-col items-center">
                    <div className="w-16 h-16 bg-slate-50 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 text-slate-400">
                        <Clock className="w-8 h-8" />
                    </div>
                    <h3 className="font-bold text-slate-900 dark:text-white">No activity yet</h3>
                    <p className="text-slate-500 text-sm mt-1">Actions taken on projects will appear here.</p>
                </div>
            ) : (
                <div className="divide-y divide-slate-100 dark:divide-slate-800">
                    {activities.map((log) => (
                        <LogItem key={log.id} log={log} />
                    ))}
                </div>
            )}
        </div>

      </div>
    </div>
  );
}

// --- SUB COMPONENT: Log Item ---

function LogItem({ log }: { log: ActivityLog }) {
    
    // Determine Icon & Color based on Action Type
    const getConfig = (type: string) => {
        switch(type) {
            case 'create_project': return { icon: <Plus className="w-4 h-4"/>, color: "bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400", text: "created a new program" };
            case 'status_change': return { icon: <CheckCircle2 className="w-4 h-4"/>, color: "bg-blue-100 text-blue-600 dark:bg-blue-900/30 dark:text-blue-400", text: "updated status to" };
            case 'data_upload': return { icon: <UploadCloud className="w-4 h-4"/>, color: "bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400", text: "uploaded new data" };
            case 'assign_lead': return { icon: <User className="w-4 h-4"/>, color: "bg-purple-100 text-purple-600 dark:bg-purple-900/30 dark:text-purple-400", text: "assigned a lead" };
            // NEW ACTIONS:
            case 'config_update': return { icon: <Settings className="w-4 h-4"/>, color: "bg-indigo-100 text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-400", text: "updated configuration" };
            case 'simulation_run': return { icon: <Play className="w-4 h-4"/>, color: "bg-rose-100 text-rose-600 dark:bg-rose-900/30 dark:text-rose-400", text: "ran a simulation" };
            
            default: return { icon: <FileText className="w-4 h-4"/>, color: "bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400", text: "updated" };
        }
    };

    const config = getConfig(log.action_type);
    
    // Format timestamp nicely
    const date = new Date(log.created_at);
    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const dateStr = date.toLocaleDateString([], { month: 'short', day: 'numeric' });

    // Extract detail value if available (handling different detail structures)
    const detailText = log.details?.to || log.details?.filename || log.details?.note || "";

    return (
        <div className="group flex items-start gap-4 p-5 hover:bg-slate-50 dark:hover:bg-slate-800/30 transition-colors">
            
            {/* 1. Icon */}
            <div className={cn("w-10 h-10 rounded-full flex items-center justify-center shrink-0 mt-1", config.color)}>
                {config.icon}
            </div>

            {/* 2. Content */}
            <div className="flex-1 min-w-0">
                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-1">
                    <p className="text-sm text-slate-900 dark:text-slate-200">
                        <span className="font-bold">{log.user_name}</span>{" "}
                        <span className="text-slate-500 dark:text-slate-400">{config.text}</span>{" "}
                        {/* Only show detail chip if not generic "note" or if it is a specific value like "Planning" */}
                        {detailText && detailText !== "User saved new inputs" && (
                            <span className="font-mono text-xs bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded text-slate-600 dark:text-slate-300 mx-1">
                                {String(detailText).toUpperCase()}
                            </span>
                        )}
                    </p>
                    <span className="text-[10px] text-slate-400 whitespace-nowrap flex items-center gap-1">
                        <Clock className="w-3 h-3" />
                        {dateStr} at {timeStr}
                    </span>
                </div>
                
                {log.project_id && (
                    <Link 
                        href={`/projects/${log.project_id}/dashboard`}
                        className="inline-flex items-center gap-1.5 mt-1.5 text-xs font-medium text-indigo-600 dark:text-indigo-400 hover:underline"
                    >
                        <FileText className="w-3 h-3" />
                        {log.project_name}
                    </Link>
                )}
            </div>
        </div>
    );
}\n--- ./app/(app)/network/components/NetworkInspector.tsx ---\n
"use client";

import React, { useState, useMemo, useEffect } from "react";
import { Layers, Play, Settings2, Truck, Package, Scale, X, FileText, CheckCircle2, AlertTriangle, RefreshCw, CloudRain, Sun, Gauge } from "lucide-react";
import dynamic from "next/dynamic";
import type { CargoType, WeatherType } from "./RealModel3D"; 

const RoadModel3D = dynamic(() => import("./RealModel3D"), { ssr: false });

interface InspectorProps {
    selectedSegment: {
        iri: number;
        width: number;
        surface: "paved" | "gravel";
        name: string;
    } | null;
    province?: string;
}

// --- SUB-COMPONENT: ADVANCED SIMULATION REPORT ---
function SimulationReport({ iri, cargoType, cargoWeight, onClose, onReplay, weather, speedLimit }: any) {
    
    // 1. COMPLEX RISK ALGORITHM
    const isBadRoad = iri > 4.5;
    const isWet = weather === "rain";
    const isSpeeding = speedLimit > 80;
    const isHeavy = cargoWeight > 30;
    const isFragile = cargoType === "electronics" || cargoType === "produce";

    // Calculate Damage Factors (0-100)
    let roadDamage = (iri / 10) * 40; 
    let weatherDamage = isWet ? 15 : 0; 
    let speedDamage = (speedLimit / 120) * 20; 
    let weightDamage = (cargoWeight / 50) * 25; 

    if (isBadRoad && isSpeeding) speedDamage *= 1.5; 
    if (isWet && isSpeeding) weatherDamage *= 1.5;   
    
    const fragilityFactor = isFragile ? 1.5 : 0.8;

    const rawRisk = (roadDamage + weatherDamage + speedDamage + weightDamage) * fragilityFactor;
    const integrityLost = Math.min(100, Math.max(0, rawRisk));
    const cargoHealth = 100 - integrityLost;

    // Financial Calc
    const cargoValuePerTon = cargoType === "electronics" ? 50000 : cargoType === "produce" ? 15000 : 5000;
    const totalCargoValue = cargoValuePerTon * cargoWeight;
    const financialLoss = (totalCargoValue * (integrityLost / 100)).toLocaleString('en-ZA', { style: 'currency', currency: 'ZAR' });

    // 2. DYNAMIC NARRATIVE ENGINE
    const analysis = useMemo(() => {
        if (cargoHealth > 90) return "Transport completed within optimal safety parameters. Logistics efficiency is high.";
        
        const factors = [];
        if (roadDamage > 20) factors.push(`rough surface (IRI ${iri.toFixed(1)})`);
        if (isWet && isSpeeding) factors.push("traction loss (rain + speed)");
        if (isHeavy && isBadRoad) factors.push("excessive load on poor pavement");
        if (isFragile && integrityLost > 20) factors.push("cargo fragility");
        
        return `Logistics failure detected. Primary failure vectors: ${factors.join(" + ")}. Recommendation: Improve pavement quality or reduce transport speed.`;
    }, [cargoHealth, roadDamage, isWet, isSpeeding, isHeavy, isBadRoad, isFragile, integrityLost, iri]);

    const statusColor = cargoHealth > 90 ? "emerald" : cargoHealth > 60 ? "amber" : "rose";

    return (
        <div className="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-md animate-in fade-in zoom-in-95 duration-300">
            <div className="bg-white dark:bg-slate-950 border border-slate-200 dark:border-slate-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                
                {/* Header */}
                <div className="p-5 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-start">
                    <div>
                        <h2 className="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                            <FileText className="w-5 h-5 text-indigo-500" /> Post-Mortem Analysis
                        </h2>
                        <p className="text-xs text-slate-500 mt-1 uppercase tracking-wide font-mono">SIM-ID: {Math.random().toString(36).substr(2, 6).toUpperCase()}</p>
                    </div>
                    <button onClick={onClose} className="p-1 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors">
                        <X className="w-5 h-5 text-slate-400" />
                    </button>
                </div>

                {/* Body */}
                <div className="p-6 space-y-6 overflow-y-auto">
                    
                    {/* 1. VERDICT BANNER */}
                    <div className={`p-4 rounded-xl border flex items-start gap-4 bg-${statusColor}-50 dark:bg-${statusColor}-900/10 border-${statusColor}-200 dark:border-${statusColor}-800`}>
                        {cargoHealth > 90 ? <CheckCircle2 className="w-6 h-6 text-emerald-600" /> : <AlertTriangle className={`w-6 h-6 text-${statusColor}-600`} />}
                        <div>
                            <h3 className={`font-bold text-sm text-${statusColor}-700 dark:text-${statusColor}-400`}>
                                {cargoHealth > 90 ? "Delivery Successful" : cargoHealth > 60 ? "Cargo Damaged" : "Catastrophic Failure"}
                            </h3>
                            <p className="text-xs opacity-90 mt-1 leading-relaxed text-slate-700 dark:text-slate-300">
                                {analysis}
                            </p>
                        </div>
                    </div>

                    {/* 2. FINANCIAL IMPACT */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800">
                            <span className="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Estimated Loss</span>
                            <div className="text-xl font-mono font-bold text-slate-900 dark:text-white mt-1">{financialLoss}</div>
                        </div>
                        <div className="p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800">
                            <span className="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Cargo Integrity</span>
                            <div className={`text-xl font-mono font-bold mt-1 text-${statusColor}-500`}>
                                {cargoHealth.toFixed(1)}%
                            </div>
                        </div>
                    </div>

                    {/* 3. DETAILED INPUT TELEMETRY */}
                    <div>
                        <h4 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                            <Settings2 className="w-3 h-3" /> Simulation Inputs & Variables
                        </h4>
                        <div className="bg-slate-50 dark:bg-slate-900/50 rounded-lg border border-slate-200 dark:border-slate-800 p-4 space-y-3">
                            <div className="flex justify-between items-center text-xs border-b border-slate-200 dark:border-slate-800 pb-2">
                                <span className="text-slate-500 flex items-center gap-2"><Layers className="w-3 h-3"/> Surface Condition (IRI)</span>
                                <span className={`font-mono font-medium ${isBadRoad ? "text-rose-500" : "text-emerald-500"}`}>
                                    {iri.toFixed(2)} {isBadRoad ? "(POOR)" : "(GOOD)"}
                                </span>
                            </div>
                            <div className="flex justify-between items-center text-xs border-b border-slate-200 dark:border-slate-800 pb-2">
                                <span className="text-slate-500 flex items-center gap-2"><Package className="w-3 h-3"/> Cargo Config</span>
                                <span className="font-mono text-slate-700 dark:text-slate-300 capitalize">{cargoWeight}t {cargoType}</span>
                            </div>
                            <div className="flex justify-between items-center text-xs pt-1">
                                <span className="text-slate-500 flex items-center gap-2"><Gauge className="w-3 h-3"/> Speed / Weather</span>
                                <span className="font-mono text-slate-700 dark:text-slate-300 capitalize">{speedLimit}km/h | {weather}</span>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Footer */}
                <div className="p-4 bg-slate-50 dark:bg-slate-900/50 border-t border-slate-100 dark:border-slate-800 flex gap-3">
                    <button onClick={onReplay} className="flex-1 flex items-center justify-center gap-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-medium py-2.5 rounded-lg text-xs transition-colors">
                        <RefreshCw className="w-4 h-4" /> Replay Simulation
                    </button>
                    <button onClick={onClose} className="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg text-xs transition-colors shadow-sm">
                        Dismiss Report
                    </button>
                </div>
            </div>
        </div>
    );
}

// --- MAIN COMPONENT ---
export function NetworkInspector({ selectedSegment, province = "Gauteng" }: InspectorProps) {
  const [year, setYear] = useState(2025);
  const [surfaceOverride, setSurfaceOverride] = useState<"paved" | "gravel" | null>(null);
  const [layersOpen, setLayersOpen] = useState(false);
  
  // Simulation State
  const [isDriving, setIsDriving] = useState(false);
  const [showReport, setShowReport] = useState(false);
  
  // Inputs
  const [cargoType, setCargoType] = useState<CargoType>("electronics");
  const [cargoWeight, setCargoWeight] = useState(20);
  const [weather, setWeather] = useState<WeatherType>("sunny");
  const [speedLimit, setSpeedLimit] = useState(100);

  useEffect(() => {
    if (selectedSegment) { setSurfaceOverride(null); }
  }, [selectedSegment]);

  const activeSurface = surfaceOverride || selectedSegment?.surface || "paved";
  const startIRI = selectedSegment?.iri || 2.5; 
  const roadWidth = selectedSegment?.width || 8;
  const roadName = selectedSegment?.name || "Demo Segment";

  const age = year - 2024;
  const iri = useMemo(() => {
     const degradationRate = activeSurface === "paved" ? 0.4 : 1.2;
     return startIRI + (age * degradationRate);
  }, [age, activeSurface, startIRI]);

  return (
    <div className="flex flex-col h-full bg-[var(--surface-bg)] border-l border-slate-200 dark:border-slate-800 relative">
        
        {/* REPORT MODAL */}
        {showReport && (
            <SimulationReport 
                iri={iri} 
                cargoType={cargoType} 
                cargoWeight={cargoWeight} 
                weather={weather}
                speedLimit={speedLimit}
                onClose={() => setShowReport(false)}
                onReplay={() => { setShowReport(false); setIsDriving(true); }}
            />
        )}

        {/* HEADER */}
        <div className="px-5 py-3 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 flex justify-between items-center shrink-0">
            <div>
                <h3 className="text-[10px] font-bold uppercase tracking-wide text-slate-500">Active Asset</h3>
                <p className="text-sm font-semibold text-slate-900 dark:text-slate-100 truncate max-w-[200px]" title={roadName}>{roadName}</p>
            </div>
            <button 
                onClick={() => setIsDriving(true)}
                disabled={isDriving}
                className={`text-xs flex items-center gap-2 px-4 py-2 rounded-full font-bold border transition-all shadow-sm ${isDriving ? 'bg-emerald-500 text-white border-emerald-500 cursor-wait' : 'bg-slate-900 text-white hover:bg-slate-800 border-transparent'}`}
            >
                <Truck className="w-3 h-3" />
                {isDriving ? "Simulating..." : "Test Drive"}
            </button>
        </div>

        {/* 3D VIEWPORT - ADJUSTED TO 55% to give Controls more room */}
        <div className="h-[55%] relative border-b border-slate-200 dark:border-slate-800 bg-slate-900 overflow-hidden group">
            <RoadModel3D 
                width={roadWidth} 
                iri={iri} 
                surface={activeSurface} 
                showLayers={layersOpen}
                isDriving={isDriving}
                onDriveComplete={() => { setIsDriving(false); setShowReport(true); }}
                province={province}
                cargoType={cargoType}
                cargoWeight={cargoWeight}
                weather={weather}
                speedLimit={speedLimit}
            />
            <button onClick={() => setLayersOpen(!layersOpen)} className={`absolute bottom-4 right-4 p-2.5 rounded-full border transition-all z-10 shadow-lg ${layersOpen ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-black/50 text-white border-white/20 hover:bg-black/70'}`}>
                <Layers className="w-5 h-5" />
            </button>
        </div>

        {/* CONTROLS - NOW TAKES REMAINING SPACE (Approx 45%) */}
        <div className="flex-1 overflow-y-auto p-5 space-y-5 bg-[var(--surface-bg)]">
            
            {/* 1. Timeline */}
            <div className="space-y-2 pb-4 border-b border-slate-200 dark:border-slate-800">
                <div className="flex justify-between items-center">
                    <h3 className="text-xs font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2"><Play className="w-3 h-3 text-indigo-500"/> Project Timeline</h3>
                    <span className="text-[10px] font-mono bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded text-slate-600 dark:text-slate-400">Year {year}</span>
                </div>
                <input type="range" min={2025} max={2035} step={1} value={year} onChange={(e) => setYear(Number(e.target.value))} className="w-full accent-indigo-500 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer" />
                <div className="flex justify-between text-[10px] text-slate-500">
                    <span>Current IRI: <strong className={iri > 5 ? "text-rose-500" : "text-emerald-500"}>{iri.toFixed(1)}</strong></span>
                    <span>Status: {iri < 3 ? "Good" : iri < 6 ? "Fair" : "Failed"}</span>
                </div>
            </div>

            {/* 2. Simulation Inputs (Grid) */}
            <div className="space-y-3">
                <h3 className="text-xs font-bold text-slate-700 dark:text-slate-300 flex items-center gap-2"><Settings2 className="w-3 h-3 text-slate-400"/> Drive Conditions</h3>
                
                <div className="grid grid-cols-2 gap-3">
                    
                    {/* Cargo */}
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-bold text-slate-400 flex items-center gap-1"><Package className="w-3 h-3"/> Payload</label>
                        <select value={cargoType} onChange={(e) => setCargoType(e.target.value as any)} className="w-full text-xs p-2 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none">
                            <option value="electronics">Electronics (Fragile)</option>
                            <option value="produce">Fresh Produce (Std)</option>
                            <option value="bricks">Construction (Heavy)</option>
                        </select>
                    </div>

                    {/* Weight */}
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-bold text-slate-400 flex items-center gap-1"><Scale className="w-3 h-3"/> Weight</label>
                        <div className="flex items-center gap-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded px-2 py-1.5">
                            <input type="range" min={5} max={50} value={cargoWeight} onChange={(e) => setCargoWeight(Number(e.target.value))} className="flex-1 accent-indigo-500 h-1.5 bg-slate-200 dark:bg-slate-800 rounded-lg appearance-none" />
                            <span className="text-[10px] font-mono w-5 text-right">{cargoWeight}t</span>
                        </div>
                    </div>

                    {/* Weather Toggle */}
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-bold text-slate-400 flex items-center gap-1"><CloudRain className="w-3 h-3"/> Weather</label>
                        <div className="flex rounded border border-slate-200 dark:border-slate-700 overflow-hidden bg-white dark:bg-slate-900">
                            <button onClick={() => setWeather("sunny")} className={`flex-1 py-1.5 flex justify-center transition-colors ${weather === 'sunny' ? 'bg-amber-100 text-amber-600' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`} title="Sunny"><Sun className="w-3.5 h-3.5" /></button>
                            <div className="w-px bg-slate-200 dark:bg-slate-700"></div>
                            <button onClick={() => setWeather("rain")} className={`flex-1 py-1.5 flex justify-center transition-colors ${weather === 'rain' ? 'bg-cyan-100 text-cyan-600' : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`} title="Raining"><CloudRain className="w-3.5 h-3.5" /></button>
                        </div>
                    </div>

                    {/* Speed Limit */}
                    <div className="space-y-1">
                        <label className="text-[10px] uppercase font-bold text-slate-400 flex items-center gap-1"><Gauge className="w-3 h-3"/> Speed Limit</label>
                        <select value={speedLimit} onChange={(e) => setSpeedLimit(Number(e.target.value))} className="w-full text-xs p-2 rounded border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-1 focus:ring-indigo-500 outline-none appearance-none">
                            <option value={60}>60 km/h (Urban)</option>
                            <option value={80}>80 km/h (Rural)</option>
                            <option value={100}>100 km/h (Highway)</option>
                            <option value={120}>120 km/h (Freeway)</option>
                        </select>
                    </div>

                </div>
            </div>
        </div>
    </div>
  );
}\n--- ./app/(app)/network/components/NetworkProjectSelector.tsx ---\n
// app/(app)/network/components/NetworkProjectSelector.tsx
"use client";

import React from "react";
import { AlertTriangle, RefreshCw } from "lucide-react";

type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
  discount_rate?: number | null;
};

type Props = {
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
  selectedProjectId: string;
  onSelectedProjectChange: (id: string) => void;
  snapshotLoading: boolean;
  onRefreshSnapshot: () => void;
  selectedProject: Project | null;
};

export function NetworkProjectSelector({
  projects,
  projectsLoading,
  projectsError,
  selectedProjectId,
  onSelectedProjectChange,
  snapshotLoading,
  onRefreshSnapshot,
  selectedProject,
}: Props) {
  return (
    <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-3">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Project
          </p>
          <p className="text-sm font-medium">
            {selectedProject ? selectedProject.project_name : "Select a project"}
          </p>
        </div>

        <div className="flex items-center gap-3">
          <select
            value={selectedProjectId}
            onChange={(e) => onSelectedProjectChange(e.target.value)}
            disabled={projectsLoading || projects.length === 0}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="" disabled>
              {projectsLoading
                ? "Loading projectsâ€¦"
                : projects.length === 0
                ? "No projects found"
                : "Select project"}
            </option>
            {projects.map((p) => (
              <option key={p.id} value={p.id}>
                {p.project_name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={onRefreshSnapshot}
            disabled={!selectedProjectId || snapshotLoading}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
          >
            <RefreshCw className="h-3 w-3" />
            {snapshotLoading ? "Refreshingâ€¦" : "Refresh snapshot"}
          </button>
        </div>
      </div>

      {projectsError && (
        <p className="text-xs text-red-500 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          {projectsError}
        </p>
      )}

      {selectedProject && (
        <p className="text-[11px] text-slate-500 dark:text-slate-400">
          {selectedProject.description && (
            <>
              <span className="font-medium">Overview:</span>{" "}
              {selectedProject.description}{" "}
            </>
          )}
          {(selectedProject.start_year || selectedProject.forecast_duration) && (
            <>
              |
              {selectedProject.start_year && (
                <> Start year: {selectedProject.start_year}</>
              )}
              {selectedProject.forecast_duration && (
                <> â€¢ Horizon: {selectedProject.forecast_duration} years</>
              )}
            </>
          )}
        </p>
      )}
    </section>
  );
}\n--- ./app/(app)/network/components/NetworkBreakdowns.tsx ---\n
"use client";

import React from "react";
import { Layers, Coins } from "lucide-react";
// ðŸ‘‡ Import the NEW type we defined in the hook
import type { NetworkProfile } from "../../projects/[projectId]/config/hooks/useNetworkSnapshot";

type Props = {
  snapshot: NetworkProfile | null;
};

// Helper to format large currency numbers
function fmtMoney(val: number) {
  if (val >= 1_000_000_000) return `R ${(val / 1_000_000_000).toFixed(1)} bn`;
  if (val >= 1_000_000) return `R ${(val / 1_000_000).toFixed(1)} m`;
  return `R ${val.toLocaleString()}`;
}

export function NetworkBreakdowns({ snapshot }: Props) {
  if (!snapshot) return null;

  const totalKm = snapshot.totalLengthKm || 1; // Avoid divide by zero
  
  // 1. Calculate Length Percentages
  const pavedPct = (snapshot.pavedLengthKm / totalKm) * 100;
  const gravelPct = (snapshot.gravelLengthKm / totalKm) * 100;

  // 2. Estimate Value Split (Replicating Backend Logic for Visualization)
  // Rates: Paved ~R3.5m/km, Gravel ~R0.25m/km
  const estimatedPavedVal = snapshot.pavedLengthKm * 3_500_000;
  const estimatedGravelVal = snapshot.gravelLengthKm * 250_000;
  const totalEstVal = estimatedPavedVal + estimatedGravelVal || 1;

  const pavedValPct = (estimatedPavedVal / totalEstVal) * 100;
  const gravelValPct = (estimatedGravelVal / totalEstVal) * 100;

  return (
    <div className="space-y-6">
      
      {/* CARD 1: Surface Composition (Physical Length) */}
      <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
        <h2 className="text-sm font-semibold flex items-center gap-2 text-slate-700 dark:text-slate-200">
          <Layers className="h-4 w-4 text-indigo-500" />
          Network Composition
        </h2>
        
        {/* Visual Bar */}
        <div className="h-2 w-full flex rounded-full overflow-hidden bg-slate-100 dark:bg-slate-800">
          <div className="h-full bg-indigo-500" style={{ width: `${pavedPct}%` }} />
          <div className="h-full bg-amber-500" style={{ width: `${gravelPct}%` }} />
        </div>

        <div className="space-y-3 pt-2">
          {/* Paved Row */}
          <div>
            <div className="flex justify-between items-center text-xs mb-1">
              <div className="flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-indigo-500" />
                <span className="text-slate-500 dark:text-slate-400 font-medium">Paved</span>
              </div>
              <span className="font-mono text-slate-700 dark:text-slate-200">
                {snapshot.pavedLengthKm.toLocaleString()} km
              </span>
            </div>
            <div className="text-[10px] text-slate-400 pl-4">
              {pavedPct.toFixed(1)}% of network length
            </div>
          </div>

          {/* Gravel Row */}
          <div>
             <div className="flex justify-between items-center text-xs mb-1">
              <div className="flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-amber-500" />
                <span className="text-slate-500 dark:text-slate-400 font-medium">Gravel</span>
              </div>
              <span className="font-mono text-slate-700 dark:text-slate-200">
                {snapshot.gravelLengthKm.toLocaleString()} km
              </span>
            </div>
            <div className="text-[10px] text-slate-400 pl-4">
              {gravelPct.toFixed(1)}% of network length
            </div>
          </div>
        </div>
      </div>

      {/* CARD 2: Asset Value Distribution (Financial Weight) */}
      <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
        <h2 className="text-sm font-semibold flex items-center gap-2 text-slate-700 dark:text-slate-200">
          <Coins className="h-4 w-4 text-emerald-500" />
          Asset Value Distribution
        </h2>
        
        {/* Visual Bar */}
        <div className="h-2 w-full flex rounded-full overflow-hidden bg-slate-100 dark:bg-slate-800">
          <div className="h-full bg-emerald-500" style={{ width: `${pavedValPct}%` }} />
          <div className="h-full bg-amber-500/50" style={{ width: `${gravelValPct}%` }} />
        </div>

        <div className="space-y-3 pt-2">
           {/* Paved Value Row */}
           <div>
            <div className="flex justify-between items-center text-xs mb-1">
              <div className="flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-emerald-500" />
                <span className="text-slate-500 dark:text-slate-400 font-medium">Paved Assets</span>
              </div>
              <span className="font-mono text-slate-700 dark:text-slate-200 font-semibold">
                {fmtMoney(estimatedPavedVal)}
              </span>
            </div>
            <div className="text-[10px] text-slate-400 pl-4">
               Holds {pavedValPct.toFixed(0)}% of total value
            </div>
          </div>

          {/* Gravel Value Row */}
          <div>
            <div className="flex justify-between items-center text-xs mb-1">
              <div className="flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-amber-500/50" />
                <span className="text-slate-500 dark:text-slate-400 font-medium">Gravel Assets</span>
              </div>
              <span className="font-mono text-slate-700 dark:text-slate-200 font-semibold">
                {fmtMoney(estimatedGravelVal)}
              </span>
            </div>
            <div className="text-[10px] text-slate-400 pl-4">
               Holds {gravelValPct.toFixed(0)}% of total value
            </div>
          </div>
        </div>
      </div>

    </div>
  );
}\n--- ./app/(app)/network/components/RealModel3D.tsx ---\n
"use client";

import React, { useMemo, useRef, useState, Suspense } from "react";
import { Canvas, useFrame, useThree } from "@react-three/fiber";
import { OrbitControls, Sky, PerspectiveCamera, Cloud } from "@react-three/drei";
import * as THREE from "three";

// --- Types ---
type SurfaceType = "paved" | "gravel";
export type CargoType = "electronics" | "bricks" | "produce";
export type WeatherType = "sunny" | "rain";

interface ModelProps {
  width?: number;
  iri?: number;
  surface?: SurfaceType;
  showLayers?: boolean;
  isDriving?: boolean;
  onDriveComplete?: () => void;
  province?: string;
  cargoWeight?: number;
  cargoType?: CargoType;
  weather?: WeatherType;
  speedLimit?: number;
}

// --- SUB-COMPONENT: RAIN SYSTEM ---
function RainSystem({ active }: { active: boolean }) {
  const count = 2000;

  const positions = useMemo(() => {
    const pos = new Float32Array(count * 3);
    for (let i = 0; i < count; i++) {
      pos[i * 3] = (Math.random() - 0.5) * 100;
      pos[i * 3 + 1] = Math.random() * 40;
      pos[i * 3 + 2] = (Math.random() - 0.5) * 100;
    }
    return pos;
  }, [count]);

  const ref = useRef<THREE.Points>(null);

  useFrame((_, delta) => {
    if (!active) return;
    if (!ref.current) return;

    const posAttribute = ref.current.geometry.getAttribute(
      "position"
    ) as THREE.BufferAttribute;

    const array = posAttribute.array as Float32Array;

    for (let i = 0; i < count; i++) {
      array[i * 3 + 1] -= 25 * delta;
      if (array[i * 3 + 1] < 0) array[i * 3 + 1] = 40;
    }

    posAttribute.needsUpdate = true;
  });

  return (
    <points ref={ref} visible={active}>
      <bufferGeometry>
        <bufferAttribute attach="attributes-position" args={[positions, 3]} />
      </bufferGeometry>
      <pointsMaterial
        color="#a5f3fc"
        size={0.15}
        transparent
        opacity={0.6}
        sizeAttenuation
        depthWrite={false}
      />
    </points>
  );
}

// --- SUB-COMPONENT: CHASE CAMERA ---
function ChaseCamera({
  targetRef,
  iri,
}: {
  targetRef: React.MutableRefObject<THREE.Group>;
  iri: number;
}) {
  const { camera } = useThree();
  const vec = new THREE.Vector3();

  useFrame((state) => {
    if (!targetRef.current) return;

    const truckPos = targetRef.current.position;
    const targetCamPos = new THREE.Vector3(0, 5, truckPos.z - 18);
    const lookAtPos = new THREE.Vector3(0, 2, truckPos.z + 20);

    const time = state.clock.getElapsedTime();
    const shakeIntensity = (Math.max(0, iri - 3) / 10) * 0.5;

    const noiseX = Math.sin(time * 20) * shakeIntensity;
    const noiseY = Math.cos(time * 25) * shakeIntensity;

    vec.copy(targetCamPos).add(new THREE.Vector3(noiseX, noiseY, 0));
    camera.position.lerp(vec, 0.08);
    camera.lookAt(lookAtPos);
  });

  return null;
}

// --- SUB-COMPONENT: TRUCK ---
function Truck({
  isDriving,
  iri,
  onComplete,
  sharedRef,
  cargoType,
  cargoWeight,
  weather,
  speedLimit,
}: any) {
  const cargoRef = useRef<THREE.Group>(null);
  const [lightTarget, setLightTarget] = useState<THREE.Object3D | null>(null);

  const baseSpeed = (speedLimit || 80) / 3.6;
  const weatherPenalty = weather === "rain" ? 0.7 : 1.0;
  const conditionFactor = Math.max(0.2, 1 - iri / 20);
  const currentSpeed = Math.min(35, baseSpeed * weatherPenalty * conditionFactor);
  const maxDistance = 450;

  useFrame((state, delta) => {
    if (!sharedRef.current) return;
    const group = sharedRef.current;

    if (isDriving) {
      group.position.z += currentSpeed * delta;

      const time = state.clock.getElapsedTime();
      const bounceAmplitude = (iri / 15) * 0.4;
      const yBounce =
        Math.sin(time * 20) * bounceAmplitude +
        Math.cos(time * 35) * (bounceAmplitude * 0.5);
      group.position.y = yBounce;

      if (cargoRef.current) {
        cargoRef.current.rotation.z = Math.sin(time * 12) * (bounceAmplitude * 1.5);
        cargoRef.current.rotation.x = Math.cos(time * 18) * (bounceAmplitude * 1.5);
      }

      if (group.position.z > maxDistance) onComplete();
    } else {
      group.position.z = -20;
      group.position.y = 0;
      if (cargoRef.current) cargoRef.current.rotation.set(0, 0, 0);
    }
  });

  const cargoColor =
    cargoType === "bricks" ? "#7f1d1d" : cargoType === "produce" ? "#65a30d" : "#fbbf24";

  return (
    <group ref={sharedRef} position={[2, 0, -20]}>
      <object3D ref={setLightTarget} position={[0, 0, 20]} />

      {/* â†“â†“â†“ PERF FIX: in rain, donâ€™t go crazy on spotlight intensity/shadows */}
      {lightTarget && (
        <>
          <spotLight
            position={[0.8, 1.5, 2.5]}
            target={lightTarget}
            angle={0.6}
            penumbra={0.5}
            intensity={weather === "rain" ? 10 : 12}
            color="#fffbeb"
            distance={weather === "rain" ? 60 : 60}
            castShadow={false}
          />
          <spotLight
            position={[-0.8, 1.5, 2.5]}
            target={lightTarget}
            angle={0.6}
            penumbra={0.5}
            intensity={weather === "rain" ? 10 : 12}
            color="#fffbeb"
            distance={weather === "rain" ? 60 : 60}
            castShadow={false}
          />
        </>
      )}

      <mesh position={[0, 0.6, 0]} castShadow>
        <boxGeometry args={[2.2, 0.5, 6]} />
        <meshStandardMaterial color="#b91c1c" roughness={0.4} />
      </mesh>

      <mesh position={[0, 1.8, 2]} castShadow>
        <boxGeometry args={[2.2, 1.8, 1.8]} />
        <meshStandardMaterial color="#991b1b" />
      </mesh>

      <mesh position={[0, 2.2, 2.91]}>
        <planeGeometry args={[2, 0.8]} />
        <meshStandardMaterial color="#1e293b" roughness={0.1} metalness={0.8} />
      </mesh>

      <group ref={cargoRef} position={[0, 0.9, -1]}>
        <mesh position={[0, 0.6, 0]} castShadow>
          <boxGeometry args={[2, 1.2 + cargoWeight / 100, 2]} />
          <meshStandardMaterial color={cargoColor} />
        </mesh>
      </group>

      <mesh position={[-1.2, 0.4, 1.5]} rotation={[0, 0, Math.PI / 2]}>
        <cylinderGeometry args={[0.4, 0.4, 0.4]} />
        <meshStandardMaterial color="#111" />
      </mesh>
      <mesh position={[1.2, 0.4, 1.5]} rotation={[0, 0, Math.PI / 2]}>
        <cylinderGeometry args={[0.4, 0.4, 0.4]} />
        <meshStandardMaterial color="#111" />
      </mesh>
      <mesh position={[-1.2, 0.4, -1.5]} rotation={[0, 0, Math.PI / 2]}>
        <cylinderGeometry args={[0.4, 0.4, 0.4]} />
        <meshStandardMaterial color="#111" />
      </mesh>
      <mesh position={[1.2, 0.4, -1.5]} rotation={[0, 0, Math.PI / 2]}>
        <cylinderGeometry args={[0.4, 0.4, 0.4]} />
        <meshStandardMaterial color="#111" />
      </mesh>
    </group>
  );
}

// --- SUB-COMPONENT: ROAD SEGMENT ---
function RoadSegment({ width, length, condition, surface, showLayers, weather }: any) {
  const isWet = weather === "rain";
  const roadColor = surface === "paved" ? (isWet ? "#1e293b" : "#334155") : "#d97706";
  const roughness = surface === "paved" ? (isWet ? 0.1 : 0.6) : 1.0;

  const potholes = useMemo(() => {
    if (condition < 4) return [];
    return Array.from({ length: Math.floor((condition - 3) * 2) }).map(() => ({
      x: (Math.random() - 0.5) * (width - 1),
      z: (Math.random() - 0.5) * (length - 2),
      size: 0.2 + Math.random() * 0.4,
    }));
  }, [condition, width, length]);

  const layerGap = showLayers ? 0.6 : 0;

  return (
    <group>
      <mesh
        position={[0, 0.1 + layerGap * 2, 0]}
        rotation={[-Math.PI / 2, 0, 0]}
        receiveShadow
      >
        <planeGeometry args={[width, length, 16, 16]} />
        <meshStandardMaterial color={roadColor} roughness={roughness} metalness={isWet ? 0.4 : 0.1} />
      </mesh>

      {potholes.map((ph, i) => (
        <mesh
          key={i}
          position={[ph.x, 0.11 + layerGap * 2, ph.z]}
          rotation={[-Math.PI / 2, 0, 0]}
        >
          <circleGeometry args={[ph.size, 16]} />
          <meshStandardMaterial color={isWet ? "#000" : "#0f172a"} roughness={isWet ? 0 : 1} />
        </mesh>
      ))}

      {surface === "paved" && (
        <mesh position={[0, 0.11 + layerGap * 2, 0]} rotation={[-Math.PI / 2, 0, 0]}>
          <planeGeometry args={[0.15, length]} />
          <meshBasicMaterial color="#fff" />
        </mesh>
      )}

      <mesh position={[0, -0.25 + layerGap, 0]}>
        <boxGeometry args={[width, 0.5, length]} />
        <meshStandardMaterial color="#78350f" />
      </mesh>
    </group>
  );
}

// --- ENVIRONMENT ---
function Biome({ province, weather }: { province: string; weather: string }) {
  const isFreeState = province.toLowerCase().includes("free");
  const roughness = weather === "rain" ? 0.2 : 1;
  return (
    <mesh rotation={[-Math.PI / 2, 0, 0]} position={[0, -0.8, 0]} receiveShadow>
      <planeGeometry args={[1000, 1000]} />
      <meshStandardMaterial color={isFreeState ? "#eab308" : "#166534"} roughness={roughness} />
    </mesh>
  );
}

export default function RealModel3D({
  width = 8,
  iri = 2.0,
  surface = "paved",
  showLayers = false,
  isDriving = false,
  onDriveComplete,
  province = "Gauteng",
  cargoWeight = 10,
  cargoType = "electronics",
  weather = "sunny",
  speedLimit = 120,
}: ModelProps) {
  const truckRef = useRef<THREE.Group>(null!);

  return (
    <div className="h-full w-full bg-slate-900 relative rounded-xl overflow-hidden shadow-2xl">
      <Canvas
        shadows
        // â†“â†“â†“ PERF FIX: lower DPR so rain mode doesnâ€™t kill the GPU
        dpr={[1, 1.2]}
        gl={{ antialias: true, powerPreference: "high-performance" }}
        onCreated={({ gl }) => {
          // Avoid the white "blank" look if context drops for a frame
          gl.setClearColor(new THREE.Color("#0b1220"), 1);

          // Optional: prove context loss if it happens
          const el = gl.domElement;
          el.addEventListener("webglcontextlost", (e) => {
            e.preventDefault();
            console.warn("âš ï¸ WebGL context lost");
          });
        }}
      >
        {/* Force consistent background */}
        <color attach="background" args={["#0b1220"]} />

        <PerspectiveCamera makeDefault position={[15, 10, 15]} fov={50} far={1000} />

        <Sky
          sunPosition={weather === "rain" ? [0, 10, -100] : [100, 20, 100]}
          turbidity={weather === "rain" ? 18 : 10}
          rayleigh={weather === "rain" ? 0.15 : 0.5}
        />

        {/* PERF FIX: make clouds lighter. If it still blanks, comment this out to confirm Cloud is the culprit. */}
        {weather === "rain" && (
          <Suspense fallback={null}>
            <Cloud
              opacity={0.25}
              speed={0.25}
              bounds={[35, 4, 35]}
              segments={10}
              position={[0, 18, 0]}
            />
          </Suspense>
        )}

        <ambientLight intensity={weather === "rain" ? 0.25 : 0.6} />

        <directionalLight
          position={[50, 50, 25]}
          intensity={weather === "rain" ? 0.6 : 1.4}
          castShadow
          shadow-mapSize={[1024, 1024]}
        />

        <Biome province={province} weather={weather} />
        <RainSystem active={weather === "rain"} />

        {/* ROAD LOOP */}
        {Array.from({ length: 15 }).map((_, i) => (
          <group key={i} position={[0, 0, i * 30 - 40]}>
            <RoadSegment
              width={width}
              length={30}
              condition={iri}
              surface={surface}
              showLayers={showLayers}
              weather={weather}
            />
          </group>
        ))}

        <Truck
          sharedRef={truckRef}
          isDriving={isDriving}
          iri={iri}
          onComplete={onDriveComplete}
          cargoType={cargoType}
          cargoWeight={cargoWeight}
          weather={weather}
          speedLimit={speedLimit}
        />

        {isDriving ? (
          <ChaseCamera targetRef={truckRef} iri={iri} />
        ) : (
          <OrbitControls minPolarAngle={0} maxPolarAngle={Math.PI / 2.1} maxDistance={60} />
        )}
      </Canvas>
    </div>
  );
}\n--- ./app/(app)/network/components/LiveMap.tsx ---\n
"use client";

import React, { useEffect, useState, useMemo } from "react";
import { MapContainer, TileLayer, Polyline, Popup, useMap, Marker } from "react-leaflet";
import { Search, Navigation, Loader2, MapPin } from "lucide-react";
import L from "leaflet";

// @ts-ignore
import "leaflet/dist/leaflet.css";

// Fix Leaflet Icons
// @ts-ignore
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// --- TYPES ---
export type RoadSegment = {
  id: string;
  name: string;
  coordinates: [number, number][]; 
  iri: number;
  width: number;
  surface: "paved" | "gravel";
  distance: number; // km
};

// --- PROVINCE CONFIG (ALL 9) ---
const PROVINCE_CONFIG: Record<string, { center: [number, number], zoom: number }> = {
    "Gauteng": { center: [-26.1076, 28.0567], zoom: 10 },
    "Free State": { center: [-28.4793, 26.1008], zoom: 8 },
    "Western Cape": { center: [-33.2278, 21.8569], zoom: 8 },
    "KwaZulu-Natal": { center: [-29.0, 30.0], zoom: 8 }, // Adjusted KZN center
    "Eastern Cape": { center: [-32.2968, 26.4194], zoom: 8 },
    "Limpopo": { center: [-23.4013, 29.4179], zoom: 8 },
    "Mpumalanga": { center: [-25.5656, 30.5279], zoom: 8 },
    "North West": { center: [-26.6639, 25.2838], zoom: 8 },
    "Northern Cape": { center: [-29.0467, 21.8569], zoom: 7 },
};

const DEFAULT_CONFIG = PROVINCE_CONFIG["Gauteng"];

// --- API HELPERS ---
async function geocode(query: string): Promise<[number, number] | null> {
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
        const data = await res.json();
        if (data && data[0]) {
            return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        }
    } catch (e) {
        console.error("Geocoding failed", e);
    }
    return null;
}

async function fetchRoute(start: [number, number], end: [number, number]): Promise<[number, number][]> {
    try {
        const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`);
        const data = await res.json();
        if (data.routes && data.routes[0]) {
            return data.routes[0].geometry.coordinates.map((c: number[]) => [c[1], c[0]]);
        }
    } catch (e) {
        console.error("Routing failed", e);
    }
    return [];
}

// --- CONTROLLER (HANDLES MAP MOVEMENT) ---
function MapController({ 
    target, 
    provinceCenter,
    zoom 
}: { 
    target: [number, number] | null, 
    provinceCenter: [number, number],
    zoom: number
}) {
    const map = useMap();

    // 1. Handle Province Switching
    useEffect(() => {
        if (provinceCenter) {
             console.log("Flying to province:", provinceCenter);
             map.flyTo(provinceCenter, zoom, { duration: 2.5, easeLinearity: 0.25 });
        }
    }, [provinceCenter, zoom, map]);

    // 2. Handle Search Target
    useEffect(() => {
        if (target) {
            map.flyTo(target, 12, { duration: 1.5 });
        }
    }, [target, map]);

    return null;
}

// --- MAIN COMPONENT ---
interface LiveMapProps {
    province?: string; 
    onSegmentSelect: (segment: RoadSegment) => void;
}

export default function LiveMap({ province = "Gauteng", onSegmentSelect }: LiveMapProps) {
  
  // 1. IMPROVED CONFIG MATCHING
  // This logic strips spaces, hyphens and casing to ensure "KwaZulu Natal" matches "KwaZulu-Natal"
  const activeConfig = useMemo(() => {
      if (!province) return DEFAULT_CONFIG;

      // Normalize helper: "Eastern Cape" -> "easterncape"
      const normalize = (s: string) => s.toLowerCase().replace(/[^a-z]/g, "");
      
      const input = normalize(province);

      // Handle common aliases manually
      if (input.includes("kzn") || input.includes("natal")) return PROVINCE_CONFIG["KwaZulu-Natal"];
      if (input.includes("gauteng") || input.includes("gp")) return PROVINCE_CONFIG["Gauteng"];
      if (input.includes("freestate") || input.includes("fs")) return PROVINCE_CONFIG["Free State"];
      if (input.includes("eastern") || input.includes("ec")) return PROVINCE_CONFIG["Eastern Cape"];
      if (input.includes("western") || input.includes("wc")) return PROVINCE_CONFIG["Western Cape"];
      if (input.includes("northern") || input.includes("nc")) return PROVINCE_CONFIG["Northern Cape"];
      if (input.includes("limpopo")) return PROVINCE_CONFIG["Limpopo"];
      if (input.includes("mpumalanga")) return PROVINCE_CONFIG["Mpumalanga"];
      if (input.includes("northwest") || input.includes("nw")) return PROVINCE_CONFIG["North West"];

      // Fallback: Check if any config key contains the input
      const key = Object.keys(PROVINCE_CONFIG).find(k => normalize(k).includes(input));
      return PROVINCE_CONFIG[key || "Gauteng"] || DEFAULT_CONFIG;

  }, [province]);

  const [segments, setSegments] = useState<RoadSegment[]>([]);
  const [activeId, setActiveId] = useState<string | null>(null);
  const [fromAddr, setFromAddr] = useState("");
  const [toAddr, setToAddr] = useState("");
  const [isSearching, setIsSearching] = useState(false);
  const [mapCenter, setMapCenter] = useState<[number, number] | null>(null);

  // 2. Clear map when province changes
  useEffect(() => {
      setSegments([]); 
      setFromAddr("");
      setToAddr("");
  }, [activeConfig]);

  const handleSearch = async (e: React.FormEvent) => {
      e.preventDefault();
      if (!fromAddr || !toAddr) return;

      setIsSearching(true);
      
      // A. Geocode
      // Append province to query to ensure results are local
      const regionContext = province !== "Gauteng" ? province : "South Africa";
      
      const startCoords = await geocode(`${fromAddr}, ${regionContext}`);
      const endCoords = await geocode(`${toAddr}, ${regionContext}`);

      if (startCoords && endCoords) {
          // B. Route
          const routeCoords = await fetchRoute(startCoords, endCoords);
          
          if (routeCoords.length > 0) {
              const newSegment: RoadSegment = {
                  id: `route-${Date.now()}`,
                  name: `${fromAddr} to ${toAddr}`,
                  coordinates: routeCoords,
                  iri: 2 + Math.random() * 6, 
                  width: 10,
                  surface: "paved",
                  distance: routeCoords.length * 0.1 
              };

              setSegments([newSegment]); 
              setActiveId(newSegment.id);
              onSegmentSelect(newSegment);
              
              const midIndex = Math.floor(routeCoords.length / 2);
              setMapCenter(routeCoords[midIndex]);
          } else {
              alert("Could not calculate route. Try closer locations.");
          }
      } else {
          alert("Could not locate one of those places. Check spelling.");
      }
      
      setIsSearching(false);
  };

  return (
    <div className="w-full h-full bg-slate-900 relative z-0 group">
      <MapContainer 
        center={activeConfig.center} 
        zoom={activeConfig.zoom} 
        style={{ height: "100%", width: "100%", background: "#0f172a" }}
        zoomControl={false}
      >
        <TileLayer
          attribution='&copy; OpenStreetMap'
          url="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
        />

        {segments.map((seg) => {
            const color = seg.iri < 3 ? "#10b981" : seg.iri < 6 ? "#f59e0b" : "#ef4444";
            const isActive = activeId === seg.id;

            return (
                <React.Fragment key={seg.id}>
                    <Marker position={seg.coordinates[0]} />
                    <Polyline
                        positions={seg.coordinates}
                        pathOptions={{ 
                            color: isActive ? "#3b82f6" : color,
                            weight: isActive ? 6 : 4,
                            opacity: 0.8
                        }}
                        eventHandlers={{
                            click: () => {
                                setActiveId(seg.id);
                                onSegmentSelect(seg);
                            }
                        }}
                    >
                        <Popup className="custom-popup">
                            <div className="text-slate-900 p-1">
                                <strong className="text-sm">{seg.name}</strong>
                                <div className="text-xs mt-1 text-slate-600">
                                    Condition: <strong>{seg.iri.toFixed(1)} IRI</strong><br/>
                                    Surface: {seg.surface}
                                </div>
                            </div>
                        </Popup>
                    </Polyline>
                    <Marker position={seg.coordinates[seg.coordinates.length - 1]} />
                </React.Fragment>
            );
        })}
        
        <MapController 
            target={mapCenter} 
            provinceCenter={activeConfig.center} 
            zoom={activeConfig.zoom}
        />
      </MapContainer>
      
      {/* SEARCH OVERLAY */}
      <div className="absolute top-6 left-6 z-[1000] w-80">
          <form onSubmit={handleSearch} className="bg-black/80 backdrop-blur-md border border-white/10 rounded-2xl p-4 shadow-2xl space-y-3">
              <div className="flex items-center gap-2 mb-2">
                  <Navigation className="w-4 h-4 text-indigo-500" />
                  <span className="text-xs font-bold uppercase tracking-wider text-slate-300">
                      {province} Planner
                  </span>
              </div>
              <div className="space-y-2">
                  <div className="relative">
                      <MapPin className="w-3 h-3 text-slate-400 absolute left-3 top-3" />
                      <input 
                        type="text" 
                        placeholder="Start (e.g. Town Hall)" 
                        value={fromAddr} 
                        onChange={(e) => setFromAddr(e.target.value)} 
                        className="w-full bg-slate-800/50 border border-white/10 rounded-lg py-2 pl-8 pr-3 text-sm text-white focus:ring-1 focus:ring-indigo-500 outline-none placeholder:text-slate-500" 
                      />
                  </div>
                  <div className="relative">
                      <MapPin className="w-3 h-3 text-slate-400 absolute left-3 top-3" />
                      <input 
                        type="text" 
                        placeholder="End (e.g. Main Road)" 
                        value={toAddr} 
                        onChange={(e) => setToAddr(e.target.value)} 
                        className="w-full bg-slate-800/50 border border-white/10 rounded-lg py-2 pl-8 pr-3 text-sm text-white focus:ring-1 focus:ring-indigo-500 outline-none placeholder:text-slate-500" 
                      />
                  </div>
              </div>
              <button type="submit" disabled={isSearching} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                  {isSearching ? <Loader2 className="w-4 h-4 animate-spin" /> : <><Search className="w-4 h-4" /> Find & Mark Road</>}
              </button>
          </form>
          
          {segments.length > 0 && (
              <div className="mt-2 bg-emerald-900/50 border border-emerald-500/30 p-2 rounded-lg text-xs text-emerald-200 text-center animate-in fade-in">
                  Route found and marked.
              </div>
          )}
      </div>

      {/* LEGEND */}
      <div className="absolute bottom-6 right-6 bg-black/80 backdrop-blur border border-white/10 p-4 rounded-xl z-[1000] text-xs text-white shadow-xl">
        <h4 className="font-bold mb-2 uppercase tracking-wider text-slate-400">Layer Info</h4>
        <div className="space-y-2">
            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-emerald-500"/> Good</div>
            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-amber-500"/> Warning</div>
            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-rose-500"/> Critical</div>
        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/network/components/NetworkSnapshotSummary.tsx ---\n
"use client";

import React from "react";
import { AlertTriangle, Map, TrendingUp, Coins, Activity } from "lucide-react";
// ðŸ‘‡ Import the NEW type
import type { NetworkProfile } from "../../projects/[projectId]/config/hooks/useNetworkSnapshot";

type Props = {
  snapshot: NetworkProfile | null;
  loading: boolean;
  error: string | null;
};

function fmtCurrency(val: number) {
  if (val >= 1_000_000_000) return `R ${(val / 1_000_000_000).toFixed(1)} bn`;
  if (val >= 1_000_000) return `R ${(val / 1_000_000).toFixed(1)} m`;
  return `R ${val.toLocaleString()}`;
}

export function NetworkSnapshotSummary({ snapshot, loading, error }: Props) {
  if (loading) {
    return (
      <div className="p-6 text-center text-sm text-slate-500 bg-[var(--surface-bg)] rounded-xl border border-slate-200 dark:border-slate-800">
        Loading network profile...
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-6 bg-rose-50 dark:bg-rose-900/20 text-rose-600 rounded-xl border border-rose-200 dark:border-rose-800 flex items-center gap-2 text-sm">
        <AlertTriangle className="h-4 w-4" />
        {error}
      </div>
    );
  }

  if (!snapshot) {
    return (
      <div className="p-6 text-center text-sm text-slate-500 bg-[var(--surface-bg)] rounded-xl border border-dashed border-slate-200 dark:border-slate-800">
        No network data found. Please configure the project inputs first.
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      {/* 1. Total Network Length */}
      <div className="p-5 bg-[var(--surface-bg)] rounded-xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
        <div className="flex items-center gap-2 text-slate-500 mb-2">
          <Map className="w-4 h-4" />
          <span className="text-xs font-semibold uppercase tracking-wider">Total Network</span>
        </div>
        <div className="text-2xl font-bold text-slate-900 dark:text-slate-100">
          {snapshot.totalLengthKm.toLocaleString()} <span className="text-sm font-medium text-slate-500">km</span>
        </div>
        <div className="text-xs text-slate-400 mt-1">
           {snapshot.pavedLengthKm.toLocaleString()} km Paved â€¢ {snapshot.gravelLengthKm.toLocaleString()} km Gravel
        </div>
      </div>

      {/* 2. Asset Value */}
      <div className="p-5 bg-[var(--surface-bg)] rounded-xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
        <div className="flex items-center gap-2 text-slate-500 mb-2">
          <Coins className="w-4 h-4 text-emerald-500" />
          <span className="text-xs font-semibold uppercase tracking-wider">Asset Value</span>
        </div>
        <div className="text-2xl font-bold text-slate-900 dark:text-slate-100">
          {fmtCurrency(snapshot.assetValue)}
        </div>
         <div className="text-xs text-slate-400 mt-1">
           Current Replacement Cost (CRC)
        </div>
      </div>

      {/* 3. Avg Condition (VCI) */}
      <div className="p-5 bg-[var(--surface-bg)] rounded-xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
        <div className="flex items-center gap-2 text-slate-500 mb-2">
          <Activity className="w-4 h-4 text-indigo-500" />
          <span className="text-xs font-semibold uppercase tracking-wider">Avg Condition</span>
        </div>
        <div className="flex items-baseline gap-2">
            <div className="text-2xl font-bold text-slate-900 dark:text-slate-100">
              {snapshot.avgVci.toFixed(1)}
            </div>
            <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${snapshot.avgVci < 50 ? 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-400' : 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400'}`}>
                {snapshot.avgVci < 50 ? 'POOR' : 'FAIR/GOOD'}
            </span>
        </div>
         <div className="w-full bg-slate-100 dark:bg-slate-700 h-1.5 rounded-full mt-2 overflow-hidden">
             <div className={`h-full ${snapshot.avgVci < 50 ? 'bg-rose-500' : 'bg-emerald-500'}`} style={{ width: `${Math.min(snapshot.avgVci, 100)}%`}} />
         </div>
      </div>

       {/* 4. Traffic / Utilization */}
       <div className="p-5 bg-[var(--surface-bg)] rounded-xl border border-slate-200/60 dark:border-slate-800 shadow-sm">
        <div className="flex items-center gap-2 text-slate-500 mb-2">
          <TrendingUp className="w-4 h-4 text-amber-500" />
          <span className="text-xs font-semibold uppercase tracking-wider">Traffic Load</span>
        </div>
        <div className="text-2xl font-bold text-slate-900 dark:text-slate-100">
          {(snapshot.totalVehicleKm / 1_000_000).toFixed(1)} <span className="text-sm font-medium text-slate-500">m</span>
        </div>
         <div className="text-xs text-slate-400 mt-1">
           Annual Vehicle Km
        </div>
      </div>

    </div>
  );
}\n--- ./app/(app)/network/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import dynamic from "next/dynamic";
import { supabase } from "@/lib/supabaseClient";
import { AlertTriangle, Loader2 } from "lucide-react";
import { useNetworkSnapshot } from "../projects/[projectId]/config/hooks/useNetworkSnapshot";
import { NetworkProjectSelector } from "./components/NetworkProjectSelector";
import { NetworkSnapshotSummary } from "./components/NetworkSnapshotSummary";
import { NetworkBreakdowns } from "./components/NetworkBreakdowns";
import { NetworkInspector } from "./components/NetworkInspector";

// Dynamic Import for Map
const LiveMap = dynamic(() => import("./components/LiveMap"), {
    ssr: false,
    loading: () => (
        <div className="w-full h-full flex items-center justify-center bg-slate-950 text-slate-500">
            <Loader2 className="w-6 h-6 animate-spin mr-2" /> Loading GIS Engine...
        </div>
    )
});

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

type Project = {
  id: string;
  project_name: string;
  description?: string;
  province?: string; // Added province field from DB
  created_at?: string; // Added created_at field to fix sorting error
};

export default function NetworkPage() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [projectsLoading, setProjectsLoading] = useState(false);
  const [projectsError, setProjectsError] = useState<string | null>(null);
  const [selectedProjectId, setSelectedProjectId] = useState<string>("");

  // --- STATE FOR TWIN SYNC ---
  const [selectedSegmentData, setSelectedSegmentData] = useState<{
      iri: number;
      width: number;
      surface: "paved" | "gravel";
      name: string;
  } | null>(null);

  // --- Fetch projects ---
  useEffect(() => {
    const fetchProjects = async () => {
      setProjectsLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;
        if (!token) { setProjectsError("Please log in."); return; }
        
        const res = await fetch(`${API_BASE}/api/v1/projects`, { headers: { Authorization: `Bearer ${token}` } });
        if (!res.ok) throw new Error("Failed to load projects");
        
        const data: Project[] = await res.json();
        // Sort by newest first
        const sorted = data.sort((a, b) => new Date(b.created_at || "").getTime() - new Date(a.created_at || "").getTime());
        setProjects(sorted);
        
        if (sorted.length > 0 && !selectedProjectId) setSelectedProjectId(sorted[0].id);
      } catch (err: any) { setProjectsError(err.message); } 
      finally { setProjectsLoading(false); }
    };
    fetchProjects();
  }, []); //

  const { data: snapshot, loading: snapshotLoading, error: snapshotError, refetch } = useNetworkSnapshot(selectedProjectId || "");
  const selectedProject = useMemo(() => projects.find((p) => p.id === selectedProjectId) || null, [projects, selectedProjectId]); //
  
  // --- ROBUST PROVINCE DETECTION ---
  const activeProvince = useMemo(() => {
      if (!selectedProject) return "Gauteng";

      // 1. Normalize strings for comparison
      const dbProvince = (selectedProject.province || "").trim();
      const nameText = (selectedProject.project_name || "").toLowerCase();
      const combinedText = `${dbProvince.toLowerCase()} ${nameText}`; //

      // 2. Exact Match Check (DB Field)
      if (dbProvince === "Western Cape") return "Western Cape";
      if (dbProvince === "Eastern Cape") return "Eastern Cape";
      if (dbProvince === "Northern Cape") return "Northern Cape";
      if (dbProvince === "North West") return "North West";
      if (dbProvince === "Free State") return "Free State";
      if (dbProvince === "KwaZulu-Natal") return "KwaZulu-Natal";

      // 3. Fuzzy Match Check (Name Analysis)
      if (combinedText.includes("western")) return "Western Cape";
      if (combinedText.includes("eastern")) return "Eastern Cape";
      if (combinedText.includes("northern")) return "Northern Cape";
      if (combinedText.includes("north west") || combinedText.includes("northwest")) return "North West";
      if (combinedText.includes("free state") || combinedText.includes("freestate")) return "Free State";
      if (combinedText.includes("natal") || combinedText.includes("kzn")) return "KwaZulu-Natal";
      if (combinedText.includes("limpopo")) return "Limpopo";
      if (combinedText.includes("mpumala")) return "Mpumalanga"; 
      
      return "Gauteng"; // Fallback
  }, [selectedProject]); //

  return (
    <div className="space-y-8 pb-20">
      
      {/* HEADER & SELECTOR */}
      <div className="space-y-4">
        <header>
            <h1 className="text-2xl font-semibold tracking-tight">Network Explorer</h1>
            <p className="text-sm text-slate-500">Master data analysis and digital twin simulation.</p>
        </header>
        <NetworkProjectSelector
            projects={projects}
            projectsLoading={projectsLoading}
            projectsError={projectsError}
            selectedProjectId={selectedProjectId}
            onSelectedProjectChange={setSelectedProjectId}
            snapshotLoading={snapshotLoading}
            onRefreshSnapshot={refetch}
            selectedProject={selectedProject}
        />
      </div>

      {selectedProjectId ? (
        <>
          {/* KPI SUMMARY */}
          <NetworkSnapshotSummary snapshot={snapshot} loading={snapshotLoading} error={snapshotError} />

          {/* SECTION A: THE LIVE MAP */}
          <section className="space-y-2">
             <div className="flex items-center justify-between px-1">
                 <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">
                    Live GIS Network
                 </h3>
                 <span className="text-xs text-slate-500">
                    Displaying Assets for: <strong className="text-indigo-500">{activeProvince}</strong>
                 </span>
             </div>
             
             <div className="h-[550px] w-full rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg overflow-hidden relative">
                 <LiveMap 
                    province={activeProvince} 
                    onSegmentSelect={(seg) => {
                        setSelectedSegmentData({
                            iri: seg.iri,
                            width: seg.width,
                            surface: seg.surface,
                            name: seg.name
                        });
                        document.getElementById('inspector-section')?.scrollIntoView({ behavior: 'smooth' });
                    }} 
                 />
             </div>
          </section>

          {/* SECTION B: THE INSPECTOR */}
          <section id="inspector-section" className="space-y-2">
             <div className="flex items-center justify-between px-1">
                 <h3 className="text-sm font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wide">
                    Asset Digital Twin
                 </h3>
             </div>
             {/* Height set to 800px for immersive view */}
             <div className="h-[800px] w-full rounded-2xl border border-slate-200 dark:border-slate-800 shadow-lg overflow-hidden bg-[var(--surface-bg)]">
                <NetworkInspector selectedSegment={selectedSegmentData} province={activeProvince}/>
             </div>
          </section>

          {/* BREAKDOWNS */}
          <div className="pt-8 border-t border-slate-200 dark:border-slate-800">
             <NetworkBreakdowns snapshot={snapshot} />
          </div>
        </>
      ) : (
        <p className="text-xs text-slate-500 flex items-center gap-1"><AlertTriangle className="h-3 w-3" /> Select a project above.</p>
      )}
    </div>
  );
}\n--- ./app/(app)/dashboard/page.tsx ---\n
"use client";

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { supabase } from "@/lib/supabaseClient";
import { LayoutDashboard, ArrowRight, BarChart3 } from 'lucide-react';
import { cn } from '@/lib/utils';

// const API_BASE = "http://127.0.0.1:8000";
const API_BASE = process.env.NEXT_PUBLIC_API_URL;

interface Project {
    id: string;
    project_name: string;
    description: string;
    created_at: string;
}

export default function DashboardHub() {
    const [projects, setProjects] = useState<Project[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        const fetchProjects = async () => {
            setLoading(true);
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const res = await fetch(`${API_BASE}/api/v1/projects`, {
                    headers: { 'Authorization': `Bearer ${session.access_token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    setProjects(data);
                } else {
                    setError("Could not load projects");
                }
            } catch (err) {
                console.error(err);
                setError("Connection failed");
            } finally {
                setLoading(false);
            }
        };
        fetchProjects();
    }, []);

    return (
      <div className="space-y-6">
        <div className="space-y-1">
            <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
                <LayoutDashboard className="h-6 w-6 text-sky-500" />
                Executive Dashboards
            </h1>
            <p className="text-sm text-slate-500 dark:text-slate-400">
                Select a project below to view its performance forecast and analytics.
            </p>
        </div>

        {loading && <div className="py-10 text-center text-slate-500">Loading projects...</div>}
        
        {error && <div className="py-10 text-center text-red-500">{error}</div>}

        {!loading && !error && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {projects.map((project) => (
                    <Link 
                        key={project.id} 
                        href={`/projects/${project.id}/dashboard`}
                        className="group relative block p-6 bg-[var(--surface-bg)] border border-slate-200/50 dark:border-slate-800/50 rounded-2xl hover:shadow-md transition-all hover:border-sky-500/30"
                    >
                        <div className="flex items-start justify-between mb-4">
                            <div className="p-2 bg-sky-50 dark:bg-sky-900/20 text-sky-600 rounded-lg group-hover:scale-110 transition-transform">
                                <BarChart3 className="h-5 w-5" />
                            </div>
                            <ArrowRight className="h-4 w-4 text-slate-300 group-hover:text-sky-500 transition-colors" />
                        </div>
                        
                        <h3 className="font-semibold text-lg text-[var(--foreground)] mb-1">
                            {project.project_name}
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">
                            {project.description || "No description provided."}
                        </p>
                        
                        <div className="mt-4 text-xs font-medium text-sky-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                            View Dashboard
                        </div>
                    </Link>
                ))}
            </div>
        )}
        
        {!loading && projects.length === 0 && (
            <div className="text-center py-20 bg-[var(--surface-bg)] rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                <p className="text-slate-500">No projects found.</p>
                <Link href="/projects" className="text-sky-500 hover:underline text-sm">Create one in Projects</Link>
            </div>
        )}
      </div>
    );
}\n--- ./app/(app)/profile/components/ProfileHeader.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { User, Camera, Save, Loader2, Building } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function ProfileHeader() {
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [profile, setProfile] = useState<any>({});

  useEffect(() => {
    async function getProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      const { data } = await supabase
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .single();
      
      // Fallback if no profile record exists yet
      setProfile(data || { 
          first_name: "", 
          last_name: "", 
          email: user.email, 
          title: "", 
          department: "" 
      });
      setLoading(false);
    }
    getProfile();
  }, []);

  const handleSave = async () => {
    setSaving(true);
    const { data: { user } } = await supabase.auth.getUser();
    if (user) {
        const updates = {
            user_id: user.id,
            first_name: profile.first_name,
            last_name: profile.last_name,
            title: profile.title,
            department: profile.department,
            updated_at: new Date().toISOString(),
        };

        const { error } = await supabase.from("profiles").upsert(updates);
        if (error) console.error(error);
        else alert("Profile updated!");
    }
    setSaving(false);
  };

  if (loading) return <div className="h-64 bg-slate-50 rounded-xl animate-pulse" />;

  return (
    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
      
      {/* Avatar Section */}
      <div className="flex flex-col items-center -mt-12 mb-6">
        <div className="relative group">
            <div className="w-24 h-24 rounded-full bg-slate-200 dark:bg-slate-800 border-4 border-white dark:border-slate-950 flex items-center justify-center overflow-hidden">
                {profile.avatar_url ? (
                    <img src={profile.avatar_url} alt="Profile" className="w-full h-full object-cover" />
                ) : (
                    <User className="w-10 h-10 text-slate-400" />
                )}
            </div>
            <button className="absolute bottom-0 right-0 p-2 bg-indigo-600 rounded-full text-white shadow-lg hover:bg-indigo-700 transition-colors">
                <Camera className="w-4 h-4" />
            </button>
        </div>
        <h2 className="mt-3 text-lg font-bold text-slate-900 dark:text-white">
            {profile.first_name} {profile.last_name || "User"}
        </h2>
        <div className="flex items-center gap-1 text-xs text-slate-500 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded-full mt-1">
            <Building className="w-3 h-3" />
            {profile.department || "No Department"}
        </div>
      </div>

      {/* Form Fields */}
      <div className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
            <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 uppercase">First Name</label>
                <input 
                    type="text" 
                    value={profile.first_name || ""}
                    onChange={(e) => setProfile({...profile, first_name: e.target.value})}
                    className="w-full p-2 text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
                />
            </div>
            <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 uppercase">Last Name</label>
                <input 
                    type="text" 
                    value={profile.last_name || ""}
                    onChange={(e) => setProfile({...profile, last_name: e.target.value})}
                    className="w-full p-2 text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
                />
            </div>
        </div>

        <div className="space-y-1">
            <label className="text-xs font-semibold text-slate-500 uppercase">Job Title</label>
            <input 
                type="text" 
                value={profile.title || ""}
                onChange={(e) => setProfile({...profile, title: e.target.value})}
                className="w-full p-2 text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
            />
        </div>

        <div className="space-y-1">
            <label className="text-xs font-semibold text-slate-500 uppercase">Department</label>
            <input 
                type="text" 
                value={profile.department || ""}
                onChange={(e) => setProfile({...profile, department: e.target.value})}
                className="w-full p-2 text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
            />
        </div>

        <button 
            onClick={handleSave}
            disabled={saving}
            className="w-full py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg font-bold text-sm flex items-center justify-center gap-2 hover:opacity-90 transition-opacity"
        >
            {saving ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
            Save Changes
        </button>
      </div>

    </div>
  );
}\n--- ./app/(app)/profile/components/ActivityLog.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { Activity, PlayCircle, FileText } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function ActivityLog() {
  const [logs, setLogs] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadActivity() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        // Fetch recent simulations as a proxy for activity
        const { data } = await supabase
            .from("simulation_results")
            .select("id, run_at, status, projects(project_name)")
            .eq("triggered_by", user.id) // Assuming column exists based on schema
            .order("run_at", { ascending: false })
            .limit(5);
        
        setLogs(data || []);
        setLoading(false);
    }
    loadActivity();
  }, []);

  return (
    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
      <div className="flex items-center gap-2 mb-6 text-slate-900 dark:text-white font-bold text-lg">
          <Activity className="w-5 h-5 text-emerald-500" />
          Recent Activity
      </div>

      <div className="relative border-l-2 border-slate-100 dark:border-slate-800 ml-3 space-y-8 pb-2">
          {loading ? (
              <div className="pl-6 text-sm text-slate-400">Loading activity...</div>
          ) : logs.length === 0 ? (
              <div className="pl-6 text-sm text-slate-400 italic">No recent activity found.</div>
          ) : (
              logs.map((log) => (
                  <div key={log.id} className="relative pl-6 group">
                      {/* Timeline Dot */}
                      <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full border-4 border-white dark:border-slate-900 bg-emerald-500 shadow-sm group-hover:scale-125 transition-transform" />
                      
                      <div className="flex flex-col">
                          <span className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">
                              {new Date(log.run_at).toLocaleString()}
                          </span>
                          <div className="font-medium text-slate-900 dark:text-white text-sm">
                              Executed Simulation Run
                          </div>
                          <div className="text-xs text-slate-500 mt-1 flex items-center gap-1">
                              <PlayCircle className="w-3 h-3" />
                              Project: <span className="font-semibold text-indigo-500">{(log.projects as any)?.project_name || "Unknown"}</span>
                          </div>
                      </div>
                  </div>
              ))
          )}
      </div>
    </div>
  );
}\n--- ./app/(app)/profile/components/ProjectHistory.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { Folder, Clock, ChevronRight, BarChart3, AlertCircle } from "lucide-react";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";

export default function ProjectHistory() {
  const [projects, setProjects] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadProjects() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data } = await supabase
            .from("projects")
            .select("*")
            .eq("user_id", user.id)
            .order("created_at", { ascending: false });
        
        setProjects(data || []);
        setLoading(false);
    }
    loadProjects();
  }, []);

  return (
    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm">
      <div className="flex items-center justify-between mb-6">
        <h3 className="font-bold text-lg text-slate-900 dark:text-white flex items-center gap-2">
            <Folder className="w-5 h-5 text-indigo-500" />
            Project Portfolio
        </h3>
        <span className="text-xs font-mono bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded text-slate-500">
            {projects.length} Total
        </span>
      </div>

      {loading ? (
          <div className="space-y-3">
              {[1,2,3].map(i => <div key={i} className="h-16 bg-slate-50 rounded-xl animate-pulse" />)}
          </div>
      ) : projects.length === 0 ? (
          <div className="p-8 text-center text-slate-400 border border-dashed border-slate-200 rounded-xl">
              <Folder className="w-8 h-8 mx-auto mb-2 opacity-50" />
              No projects created yet.
          </div>
      ) : (
          <div className="space-y-3">
              {projects.map((project) => (
                  <Link 
                    key={project.id} 
                    href={`/projects/${project.id}/dashboard`}
                    className="flex items-center justify-between p-4 rounded-xl border border-slate-100 dark:border-slate-800 hover:border-indigo-200 dark:hover:border-indigo-900 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-all group"
                  >
                      <div className="flex items-center gap-4">
                          <div className="w-10 h-10 rounded-lg bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center text-indigo-600">
                              <BarChart3 className="w-5 h-5" />
                          </div>
                          <div>
                              <div className="font-bold text-slate-900 dark:text-white text-sm group-hover:text-indigo-600 transition-colors">
                                  {project.project_name}
                              </div>
                              <div className="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                  <Clock className="w-3 h-3" />
                                  Created {new Date(project.created_at).toLocaleDateString()}
                              </div>
                          </div>
                      </div>
                      
                      <div className="flex items-center gap-4">
                          <span className={`text-[10px] uppercase font-bold px-2 py-1 rounded ${project.proposal_status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'}`}>
                              {project.proposal_status || 'Draft'}
                          </span>
                          <ChevronRight className="w-4 h-4 text-slate-400 group-hover:translate-x-1 transition-transform" />
                      </div>
                  </Link>
              ))}
          </div>
      )}
    </div>
  );
}\n--- ./app/(app)/profile/components/SecuritySettings.tsx ---\n
"use client";

import React, { useState } from "react";
import { Lock, ShieldCheck, Loader2 } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function SecuritySettings() {
  const [password, setPassword] = useState("");
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState("");

  const handleUpdatePassword = async () => {
    if (password.length < 6) {
        setMessage("Password must be at least 6 characters.");
        return;
    }
    setLoading(true);
    setMessage("");
    
    const { error } = await supabase.auth.updateUser({ password: password });

    if (error) {
        setMessage("Error updating password.");
    } else {
        setMessage("Password updated successfully.");
        setPassword("");
    }
    setLoading(false);
  };

  return (
    <div className="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-6 shadow-sm space-y-6">
      <div className="flex items-center gap-3 pb-4 border-b border-slate-100 dark:border-slate-800">
        <div className="p-2 bg-rose-50 dark:bg-rose-900/20 rounded-lg text-rose-600">
            <ShieldCheck className="w-5 h-5" />
        </div>
        <h3 className="font-bold text-slate-900 dark:text-white">Security</h3>
      </div>

      <div className="space-y-3">
        <label className="text-xs font-semibold text-slate-500 uppercase">New Password</label>
        <div className="relative">
            <Lock className="w-4 h-4 text-slate-400 absolute left-3 top-3" />
            <input 
                type="password" 
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                className="w-full pl-10 p-2.5 text-sm bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"
            />
        </div>
      </div>

      {message && (
          <div className={`text-xs p-2 rounded ${message.includes("Error") ? "bg-rose-50 text-rose-600" : "bg-emerald-50 text-emerald-600"}`}>
              {message}
          </div>
      )}

      <button 
        onClick={handleUpdatePassword}
        disabled={loading}
        className="w-full py-2.5 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 rounded-lg font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2"
      >
        {loading && <Loader2 className="w-3 h-3 animate-spin" />}
        Update Password
      </button>
    </div>
  );
}\n--- ./app/(app)/profile/page.tsx ---\n
"use client";

import React from "react";
import ProfileHeader from "./components/ProfileHeader";
import SecuritySettings from "./components/SecuritySettings";
import ProjectHistory from "./components/ProjectHistory";
import ActivityLog from "./components/ActivityLog";

export default function ProfilePage() {
  return (
    <div className="min-h-screen bg-[var(--background)] p-8">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Page Title */}
        <div>
          <h1 className="text-2xl font-bold text-slate-900 dark:text-white">User Profile</h1>
          <p className="text-slate-500 dark:text-slate-400">Manage your account settings and view your activity history.</p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* LEFT COLUMN: Identity & Security */}
          <div className="space-y-8 lg:col-span-1">
            <ProfileHeader />
            <SecuritySettings />
          </div>

          {/* RIGHT COLUMN: Work & History */}
          <div className="space-y-8 lg:col-span-2">
            <ProjectHistory />
            <ActivityLog />
          </div>

        </div>
      </div>
    </div>
  );
}\n--- ./app/(app)/layout.tsx ---\n
/* --- ./app/(app)/layout.tsx (UPDATED) --- */
"use client";

import { ReactNode, useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { Sidebar } from "@/components/sidebar";
import { Topbar } from "@/components/topbar";

export default function AppLayout({ children }: { children: ReactNode }) {
  const router = useRouter();
  const [checking, setChecking] = useState(true);

  useEffect(() => {
    const checkSession = async () => {
      const { data, error } = await supabase.auth.getSession();
      if (error || !data.session) {
        router.replace("/login");
      } else {
        setChecking(false);
      }
    };

    checkSession();
  }, [router]);

  if (checking) {
    return (
      <div className="flex h-screen w-screen items-center justify-center bg-[var(--background)] text-[var(--foreground)]">
        Checking session...
      </div>
    );
  }

  return (
    // Outer container uses a gap for margin and sets the page background
    // Removed outer shadow for cleaner look based on the reference
    <div className="flex h-screen w-screen overflow-hidden bg-[var(--background)] text-[var(--foreground)] gap-6 p-6">
      <Sidebar />
      <div className="flex h-full flex-1 flex-col gap-6">
        <Topbar />
        {/* Removed bg-[var(--surface-bg)] from main to show page background */}
        {/* Added rounded-2xl to main for visual consistency with topbar/sidebar */}
        <main className="flex-1 overflow-y-auto rounded-2xl">
          {children}
        </main>
      </div>
    </div>
  );
}\n--- ./app/(app)/reports/treasury-view/page.tsx ---\n
"use client";

import React, { useState, useEffect } from "react";
import { 
  Send, 
  FileCheck, 
  Building, 
  Check, 
  Loader2,
  AlertTriangle,
  TrendingUp,
  BrainCircuit,
  Lock,
  Stamp,
  ChevronDown
} from "lucide-react";
import { cn } from "@/lib/utils";
import { useReportData } from "../hooks/useReportData";
import { ResponsiveContainer, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip } from "recharts";
import { supabase } from "@/lib/supabaseClient";

export default function TreasuryViewPage() {
  // 1. Submission State
  const [status, setStatus] = useState<"draft" | "submitting" | "submitted">("draft");
  const [refNumber, setRefNumber] = useState<string | null>(null);
  
  // 2. Project Context
  const [projects, setProjects] = useState<any[]>([]);
  const [projectId, setProjectId] = useState<string | null>(null);

  // Load Project List
  useEffect(() => {
      const fetchProjects = async () => {
        const { data } = await supabase
            .from("projects")
            .select("id, project_name, province")
            .order("updated_at", {ascending: false});
        
        if(data && data.length > 0) {
            setProjects(data);
            setProjectId(data[0].id); // Default to latest
        }
      };
      fetchProjects();
  }, []);

  const { data, loading, error } = useReportData(projectId);

  // 3. The "Formal Submission" Logic
  const handleSubmit = () => {
    if (!window.confirm("CONFIRM SUBMISSION\n\nThis will lock the project version and notify the Provincial Treasury HOD. This action cannot be undone.\n\nProceed?")) {
        return;
    }
    setStatus("submitting");
    setTimeout(() => {
        setStatus("submitted");
        setRefNumber(`TR-${new Date().getFullYear()}-FS-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 2000);
  };

  const formatMoney = (amount: number) => {
    if (!amount) return "R 0.00";
    if (amount >= 1_000_000_000) return `R ${(amount / 1_000_000_000).toFixed(2)}bn`;
    return `R ${(amount / 1_000_000).toFixed(1)}m`;
  };

  // Loading state for initial project fetch
  if (!projectId && projects.length === 0) return (
      <div className="h-[60vh] flex flex-col items-center justify-center text-slate-400 gap-3">
          <Loader2 className="w-8 h-8 animate-spin text-indigo-500"/>
          <p>Loading Projects...</p>
      </div>
  );

  return (
    <div className="p-8 pb-32 max-w-6xl mx-auto">
      
      {/* 1. Header & Actions */}
      <div className="flex flex-col md:flex-row md:items-start justify-between gap-6 mb-12">
        <div>
          {/* Dynamic Status Badge */}
          <div className={cn(
              "inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest mb-3 border",
              status === "submitted" 
                  ? "bg-amber-50 border-amber-200 text-amber-700" 
                  : "bg-indigo-50 border-indigo-100 text-indigo-600"
          )}>
            {status === "submitted" ? <Stamp className="w-3 h-3" /> : <Building className="w-3 h-3" />}
            {status === "submitted" ? `Pending Review â€¢ Ref: ${refNumber}` : "Draft Submission"}
          </div>

          <div className="flex items-center gap-4">
            <h1 className="text-4xl font-black text-slate-900 dark:text-white tracking-tight">Executive Case</h1>
            
            {/* PROJECT SELECTOR DROPDOWN */}
            <div className="relative group">
                <select 
                    value={projectId || ""}
                    onChange={(e) => setProjectId(e.target.value)}
                    className="appearance-none bg-slate-100 dark:bg-slate-800 border-none text-lg font-bold text-slate-900 dark:text-white py-2 pl-4 pr-10 rounded-xl cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors focus:ring-2 focus:ring-indigo-500 outline-none"
                >
                    {projects.map((p) => (
                        <option key={p.id} value={p.id}>
                            {p.province} â€” {p.project_name}
                        </option>
                    ))}
                </select>
                <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 pointer-events-none" />
            </div>
          </div>
          
          <p className="text-lg text-slate-500 mt-2">PRMG Funding Motivation â€¢ FY 2027/28</p>
        </div>

        <div className="flex flex-col items-end gap-3">
            {data && (
                <div className="text-right hidden md:block">
                    <div className="text-xs font-bold uppercase text-slate-400">Submission Value</div>
                    <div className="text-xl font-black text-slate-900 dark:text-slate-100">{formatMoney(data.summary.budgetAsk)}</div>
                </div>
            )}

            <button 
                onClick={handleSubmit}
                disabled={status !== "draft" || loading}
                className={cn(
                    "flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl transition-all shadow-lg",
                    status === "draft" && !loading
                        ? "bg-indigo-600 hover:bg-indigo-700 hover:scale-105 text-white shadow-indigo-500/20"
                        : "bg-slate-100 dark:bg-slate-800 text-slate-400 cursor-not-allowed border border-slate-200 dark:border-slate-700 shadow-none"
                )}
            >
                {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : 
                 status === "submitting" ? <Loader2 className="w-4 h-4 animate-spin" /> :
                 status === "submitted" ? <Lock className="w-4 h-4" /> :
                 <Send className="w-4 h-4" />
                }
                
                {loading ? "Loading Data..." :
                 status === "draft" ? "Submit to Treasury" :
                 status === "submitting" ? "Verifying..." :
                 "Submission Locked"
                }
            </button>
            
            {status === "submitted" && (
                <div className="text-[10px] text-emerald-600 font-medium flex items-center gap-1 animate-in fade-in slide-in-from-top-1">
                    <Check className="w-3 h-3" /> Sent to HOD (2 mins ago)
                </div>
            )}
        </div>
      </div>

      {/* LOADING / ERROR STATES */}
      {loading && (
          <div className="h-96 flex flex-col items-center justify-center text-slate-400 gap-3 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border border-dashed border-slate-200 dark:border-slate-800">
              <Loader2 className="w-8 h-8 animate-spin text-indigo-500"/>
              <p>Compiling Report Data...</p>
          </div>
      )}

      {error && !loading && (
          <div className="p-20 text-center text-slate-500 bg-slate-50 dark:bg-slate-900/50 rounded-3xl border border-dashed border-slate-200 dark:border-slate-800">
              <AlertTriangle className="w-10 h-10 mx-auto text-rose-400 mb-4"/>
              <h2 className="text-xl font-bold mb-2">Data Unavailable</h2>
              <p>Please ensure you have run a simulation for this project.</p>
          </div>
      )}

      {/* CONTENT */}
      {!loading && !error && data && (
        <div className={cn("grid grid-cols-1 lg:grid-cols-3 gap-8 transition-opacity duration-500", status === "submitted" && "opacity-80 pointer-events-none select-none grayscale-[0.5]")}>
            
            {/* LEFT COL: The Visual Evidence */}
            <div className="lg:col-span-2 space-y-6">
                
                {/* Graph */}
                <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-sm relative overflow-hidden">
                    <div className="flex justify-between items-center mb-6">
                        <div>
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <TrendingUp className="w-5 h-5 text-indigo-500"/>
                                Impact of Funding vs. Decay
                            </h3>
                            <p className="text-xs text-slate-500 mt-1">10-Year forecast of Network Condition (VCI)</p>
                        </div>
                        <div className="flex gap-4 text-[10px] font-bold uppercase tracking-wider">
                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500"/> Funded</div>
                            <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-rose-500"/> Do Nothing</div>
                        </div>
                    </div>

                    <div className="h-72 w-full">
                        <ResponsiveContainer width="100%" height="100%">
                            {/* FIX: Use data.chartData */}
                            <AreaChart data={data.chartData} margin={{top: 10, right: 0, left: -20, bottom: 0}}>
                                <defs>
                                    <linearGradient id="colorGood" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/>
                                        <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                    </linearGradient>
                                    <linearGradient id="colorBad" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor="#f43f5e" stopOpacity={0.1}/>
                                        <stop offset="95%" stopColor="#f43f5e" stopOpacity={0}/>
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                <XAxis dataKey="year" fontSize={10} tickLine={false} axisLine={false} />
                                <YAxis fontSize={10} tickLine={false} axisLine={false} domain={[0, 100]} />
                                <Tooltip 
                                    contentStyle={{backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px'}}
                                />
                                <Area type="monotone" dataKey="fundedVCI" stroke="#10b981" strokeWidth={3} fillOpacity={1} fill="url(#colorGood)" name="Funded VCI" />
                                <Area type="monotone" dataKey="doNothingVCI" stroke="#f43f5e" strokeWidth={3} strokeDasharray="5 5" fillOpacity={1} fill="url(#colorBad)" name="Decay VCI" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                {/* AI Narrative */}
                <div className="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <div className="flex items-start gap-4">
                        <div className="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl">
                            <BrainCircuit className="w-6 h-6 text-indigo-600 dark:text-indigo-400" />
                        </div>
                        <div className="space-y-2">
                            <h4 className="text-sm font-bold text-slate-900 dark:text-white uppercase tracking-wider">Strategic Assessment</h4>
                            {/* FIX: Use data.narrative */}
                            <p className="text-sm text-slate-600 dark:text-slate-300 leading-relaxed font-medium">
                                "{data.narrative.executiveSummary}"
                            </p>
                            <div className="flex items-center gap-2 pt-2 text-rose-600 dark:text-rose-400 text-xs font-bold">
                                <AlertTriangle className="w-3 h-3" />
                                RISK: {data.narrative.riskStatement}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            {/* RIGHT COL: Compliance & Stats */}
            <div className="space-y-6">
                <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800 space-y-6">
                    <div>
                        <div className="text-xs font-bold text-slate-400 uppercase mb-1">Asset Value At Risk</div>
                        {/* FIX: Use data.summary */}
                        <div className="text-3xl font-black text-slate-900 dark:text-white">{formatMoney(data.summary.assetValue)}</div>
                    </div>
                    <div className="h-px bg-slate-100 dark:bg-slate-800" />
                    <div>
                        <div className="text-xs font-bold text-slate-400 uppercase mb-1">Preventative Ratio</div>
                        <div className="text-3xl font-black text-indigo-600">
                            {data.summary.preservationRatio.toFixed(1)}%
                        </div>
                        <div className="text-xs text-slate-500 mt-1">Target is 2-3% of CRC</div>
                    </div>
                    <div className="h-px bg-slate-100 dark:bg-slate-800" />
                    <div>
                        <div className="text-xs font-bold text-slate-400 uppercase mb-1">Network Health</div>
                        <div className="flex items-center gap-2">
                            <div className="text-3xl font-black text-slate-900 dark:text-white">{data.summary.currentVci.toFixed(0)}</div>
                            <span className={`text-xs px-2 py-1 rounded font-bold ${data.summary.currentVci < 50 ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                {data.summary.currentVci < 50 ? 'POOR' : 'FAIR'}
                            </span>
                        </div>
                    </div>
                </div>

                <div className="bg-white dark:bg-slate-900 p-6 rounded-3xl border border-slate-200 dark:border-slate-800">
                    <div className="flex items-center gap-2 mb-4">
                        <FileCheck className="w-5 h-5 text-emerald-500" />
                        <h3 className="font-bold text-slate-900 dark:text-white">Compliance Check</h3>
                    </div>
                    <div className="space-y-3">
                        <CheckItem label="RAMS Data Verified" checked />
                        <CheckItem label="Treasury 6B Form" checked />
                        <CheckItem label="MTEF Alignment" checked />
                        <CheckItem label="MEC Approval" checked={status === "submitted"} />
                    </div>
                </div>
            </div>
        </div>
      )}
    </div>
  );
}

function CheckItem({ label, checked }: any) {
    return (
        <div className="flex items-center gap-3 text-sm">
            <div className={cn(
                "w-5 h-5 rounded-full flex items-center justify-center border transition-all duration-300",
                checked 
                    ? "bg-emerald-500 border-emerald-500 text-white" 
                    : "border-slate-300 text-transparent"
            )}>
                <Check className="w-3 h-3" />
            </div>
            <span className={cn(checked ? "text-slate-700 dark:text-slate-200" : "text-slate-400")}>{label}</span>
        </div>
    )
}\n--- ./app/(app)/reports/components/ReportLivePreview.tsx ---\n
"use client";

import React from "react";
import { Loader2, TrendingUp, AlertTriangle, Building2, Coins, ArrowUpRight, Calendar, BrainCircuit } from "lucide-react";
import { useReportData } from "../hooks/useReportData";

interface ReportLivePreviewProps {
  config: any;
  previewRef?: React.RefObject<HTMLDivElement | null>;
}

const formatMoney = (amount: number) => {
  if (!amount) return "R 0.00";
  if (amount >= 1_000_000_000) return `R ${(amount / 1_000_000_000).toFixed(2)}bn`;
  return `R ${(amount / 1_000_000).toFixed(1)}m`;
};

export default function ReportLivePreview({ config, previewRef }: ReportLivePreviewProps) {
  const { data, loading } = useReportData(config.projectId, config);

  if (!config.projectId) return <EmptyState label="Select a project from the settings sidebar." />;
  if (loading || !data) return <LoadingState />;

  const { meta, summary, narrative, chartData } = data;

  return (
    <div
      id="report-print-root"
      ref={previewRef}
      style={{
        backgroundColor: "#ffffff",
        color: "#0f172a",
        boxShadow: "0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)"
      }}
      className="w-[210mm] min-h-[297mm] mx-auto p-[15mm] flex flex-col gap-8 origin-top text-sm font-sans"
    >
      {/* ROW 1: HEADER (The Hook) */}
      <header className="border-b-4 border-indigo-600 pb-6 flex justify-between items-end">
        <div>
            <div className="text-indigo-600 font-extrabold text-xs uppercase tracking-[0.2em] mb-2">Strategic Infrastructure Submission</div>
            <h1 className="text-4xl font-black text-slate-900 leading-tight mb-2">{config.title || "Business Case"}</h1>
            <div className="flex items-center gap-3 text-slate-500 font-medium">
                <span>{meta.province}</span>
                <span className="w-1 h-1 bg-slate-300 rounded-full"/>
                <span>{meta.projectName}</span>
                <span className="w-1 h-1 bg-slate-300 rounded-full"/>
                <span>{meta.generatedDate}</span>
            </div>
        </div>
        <div className="text-right">
            <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Funding Requirement</div>
            <div className="text-3xl font-black text-indigo-600">{formatMoney(summary.budgetAsk)}</div>
            <div className="text-xs font-bold text-slate-400 uppercase mt-1">5 Year Horizon</div>
        </div>
      </header>

      {/* ROW 2: ASSET BASELINE (The Context) */}
      <div className="grid grid-cols-3 gap-6">
         <MetricCard 
            icon={<Building2 className="w-5 h-5 text-slate-400"/>} 
            label="Total Network Asset"
            value={formatMoney(summary.assetValue)}
            sub="Current Replacement Cost"
         />
         <MetricCard 
            icon={<TrendingUp className="w-5 h-5 text-slate-400"/>} 
            label="Current Health"
            value={`VCI ${summary.currentVci.toFixed(0)}`}
            sub="Weighted Average Condition"
            color={summary.currentVci < 50 ? "text-rose-600" : "text-emerald-600"}
         />
         <MetricCard 
            icon={<Coins className="w-5 h-5 text-slate-400"/>} 
            label="Investment Ratio"
            value={`${summary.preservationRatio.toFixed(1)}%`}
            sub="Of Asset Value (Target: 2%)"
         />
      </div>

      {/* ROW 3: THE SCISSORS GRAPH (The Why) */}
      <div className="bg-slate-50 border border-slate-100 rounded-xl p-6">
         <div className="flex justify-between items-center mb-6">
            <h3 className="font-bold text-slate-900 flex items-center gap-2">
                <AlertTriangle className="w-4 h-4 text-amber-500"/>
                Impact Analysis: Funding vs. Decay
            </h3>
            <div className="flex gap-4 text-[10px] font-bold uppercase tracking-wider">
                <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-indigo-600"/> Funded Intervention</div>
                <div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-rose-400"/> Do Nothing (Decay)</div>
            </div>
         </div>
         
         <div className="h-48 flex items-end gap-3 px-2">
            {chartData.map((d, i) => (
                <div key={i} className="flex-1 flex flex-col justify-end relative h-full group">
                    {/* Tooltip on hover */}
                    <div className="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] p-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                        Year {d.year}: VCI {d.fundedVCI.toFixed(0)} vs {d.doNothingVCI.toFixed(0)}
                    </div>

                    {/* Bars */}
                    <div className="w-full bg-rose-200 rounded-t-sm relative" style={{ height: `${d.doNothingVCI}%` }}>
                        <div className="absolute inset-0 bg-rose-400 opacity-20"/>
                    </div>
                    <div className="w-full bg-indigo-600 rounded-t-sm absolute bottom-0 left-0 right-0 shadow-lg" style={{ height: `${d.fundedVCI}%` }}/>
                    
                    <div className="text-[10px] text-slate-400 text-center mt-2 font-mono">{d.year}</div>
                </div>
            ))}
         </div>
      </div>

      {/* ROW 4: STRATEGIC JUSTIFICATION (The Argument) */}
      {config.showAiNarrative && (
          <div className="flex gap-6">
             <div className="w-1/3">
                <div className="bg-indigo-600 text-white p-6 rounded-xl h-full flex flex-col justify-between">
                    <BrainCircuit className="w-8 h-8 opacity-50 mb-4"/>
                    <div>
                        <div className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-2">Strategic Driver</div>
                        <div className="text-xl font-bold leading-snug">
                            "{narrative.executiveSummary.split('.')[0]}."
                        </div>
                    </div>
                </div>
             </div>
             <div className="w-2/3 space-y-4 text-sm leading-relaxed text-slate-600">
                <h3 className="font-bold text-slate-900 border-b pb-2 mb-2">Treasury Motivation</h3>
                <p>{narrative.executiveSummary}</p>
                <div className="p-4 bg-rose-50 border border-rose-100 rounded-lg text-rose-800 text-xs font-medium flex gap-3">
                    <AlertTriangle className="w-4 h-4 shrink-0"/>
                    <div>
                        <strong className="block text-rose-900 mb-1">Fiscal Liability Warning:</strong>
                        {narrative.riskStatement}
                    </div>
                </div>
             </div>
          </div>
      )}

      {/* ROW 5: SCHEDULE (The Plan) */}
      {config.showSchedule && (
          <div className="mt-auto">
             <h3 className="font-bold text-slate-900 flex items-center gap-2 mb-4">
                <Calendar className="w-4 h-4 text-slate-400"/>
                Medium Term Expenditure Framework (MTEF)
             </h3>
             <table className="w-full text-xs">
                <thead className="bg-slate-50 text-slate-500 font-bold text-left">
                    <tr>
                        <th className="p-3 rounded-l-lg">Financial Year</th>
                        <th className="p-3">Target Condition</th>
                        <th className="p-3">Risk Mitigation</th>
                        <th className="p-3 text-right rounded-r-lg">Allocation Required</th>
                    </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                    {chartData.slice(0, 5).map((row, i) => (
                        <tr key={i}>
                            <td className="p-3 font-mono font-bold text-slate-700">{row.year} / {row.year+1}</td>
                            <td className="p-3">
                                <div className="flex items-center gap-2">
                                    <div className="w-12 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-emerald-500" style={{width: `${row.fundedVCI}%`}}/>
                                    </div>
                                    VCI {row.fundedVCI.toFixed(0)}
                                </div>
                            </td>
                            <td className="p-3 text-slate-500">
                                {row.fundedVCI > 50 ? "Preventative Maintenance" : "Critical Rehabilitation"}
                            </td>
                            <td className="p-3 text-right font-bold text-slate-900">{formatMoney(row.budget)}</td>
                        </tr>
                    ))}
                </tbody>
             </table>
          </div>
      )}

      <footer className="text-[10px] text-slate-300 text-center uppercase tracking-widest mt-4">
        Generated by Mosianedi â€¢ {config.author} â€¢ {new Date().toLocaleDateString()}
      </footer>
    </div>
  );
}

// --- SUB COMPONENTS ---
function MetricCard({ icon, label, value, sub, color="text-slate-900" }: any) {
    return (
        <div className="border border-slate-200 rounded-xl p-5">
            <div className="flex items-center gap-2 mb-3">
                {icon}
                <span className="text-xs font-bold uppercase tracking-wider text-slate-400">{label}</span>
            </div>
            <div className={`text-2xl font-black ${color}`}>{value}</div>
            <div className="text-[10px] text-slate-400 mt-1">{sub}</div>
        </div>
    )
}

const EmptyState = ({ label }: { label: string }) => (
  <div className="w-[210mm] min-h-[297mm] bg-white shadow-xl mx-auto flex items-center justify-center text-gray-400 text-sm">
    {label}
  </div>
);

const LoadingState = () => (
  <div className="w-[210mm] min-h-[297mm] bg-white shadow-xl mx-auto flex flex-col items-center justify-center text-gray-400 text-sm gap-3">
    <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
    Generating report preview...
  </div>
);\n--- ./app/(app)/reports/components/charts/DecayLineChart.tsx ---\n
\n--- ./app/(app)/reports/components/charts/BudgetPieChart.tsx ---\n
\n--- ./app/(app)/reports/components/ReportFilterSidebar.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { Map, FileText, Settings2, Loader2 } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";

export default function ReportFilterSidebar({ config, onConfigChange }: any) {
  const [projects, setProjects] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadProjects() {
      const { data } = await supabase.from("projects").select("id, project_name").order("created_at", { ascending: false });
      if (data) {
        setProjects(data);
        if (data.length > 0 && !config.projectId) {
            onConfigChange("projectId", data[0].id);
        }
      }
      setLoading(false);
    }
    loadProjects();
  }, []);

  return (
    <div className="p-4 space-y-8 pb-20">
      
      {/* 1. DATA SOURCE */}
      <div className="space-y-3">
        <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider flex items-center gap-2">
            <Map className="w-3 h-3" /> Target Project
        </h3>
        {loading ? <Loader2 className="w-4 h-4 animate-spin text-slate-400"/> : (
            <select 
                value={config.projectId}
                onChange={(e) => onConfigChange("projectId", e.target.value)}
                className="w-full text-xs p-2.5 rounded-lg border bg-slate-50 dark:bg-slate-900 border-slate-200 dark:border-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer"
            >
                {projects.map(p => <option key={p.id} value={p.id}>{p.project_name}</option>)}
            </select>
        )}
      </div>

      <hr className="border-slate-200 dark:border-slate-800" />

      {/* 2. REPORT HEADER */}
      <div className="space-y-3">
        <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider flex items-center gap-2">
            <FileText className="w-3 h-3" /> Document Details
        </h3>
        <div className="space-y-3">
            <div>
                <label className="text-[10px] text-slate-500 mb-1 block">Document Title</label>
                <input 
                    type="text" 
                    value={config.title} 
                    onChange={(e) => onConfigChange("title", e.target.value)}
                    className="w-full text-xs p-2 rounded border bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700 outline-none focus:border-indigo-500 transition-colors" 
                />
            </div>
            <div>
                <label className="text-[10px] text-slate-500 mb-1 block">Prepared By</label>
                <input 
                    type="text" 
                    value={config.author} 
                    onChange={(e) => onConfigChange("author", e.target.value)}
                    className="w-full text-xs p-2 rounded border bg-white dark:bg-slate-950 border-slate-200 dark:border-slate-700 outline-none focus:border-indigo-500 transition-colors" 
                />
            </div>
        </div>
      </div>

      <hr className="border-slate-200 dark:border-slate-800" />

      {/* 3. SECTIONS */}
      <div className="space-y-3">
        <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider flex items-center gap-2">
            <Settings2 className="w-3 h-3" /> Content Sections
        </h3>
        <div className="space-y-2">
            <Toggle label="Include AI Strategy Narrative" checked={config.showAiNarrative} onChange={(v: boolean) => onConfigChange("showAiNarrative", v)} />
            <Toggle label="Include Financial Schedule" checked={config.showSchedule} onChange={(v: boolean) => onConfigChange("showSchedule", v)} />
        </div>
      </div>
    </div>
  );
}

const Toggle = ({ label, checked, onChange }: any) => (
    <label className="flex items-center justify-between cursor-pointer group p-1">
        <span className="text-xs text-slate-600 dark:text-slate-300 group-hover:text-indigo-600 transition">{label}</span>
        <div className={`w-8 h-4 rounded-full p-0.5 transition-colors ${checked ? 'bg-indigo-500' : 'bg-slate-300 dark:bg-slate-700'}`} onClick={() => onChange(!checked)}>
            <div className={`w-3 h-3 bg-white rounded-full shadow-sm transition-transform ${checked ? 'translate-x-4' : ''}`} />
        </div>
    </label>
);\n--- ./app/(app)/reports/components/ReportBuilderShell.tsx ---\n
"use client";

import React, { useState, useRef } from "react";
import { FileText, LayoutTemplate, Download, Loader2 } from "lucide-react";
import ReportFilterSidebar from "./ReportFilterSidebar";
import ReportLivePreview from "./ReportLivePreview";
import jsPDF from "jspdf";
import { toPng } from "html-to-image";

export default function ReportBuilderShell() {
  const [downloading, setDownloading] = useState(false);
  const previewRef = useRef<HTMLDivElement>(null);

  const [reportConfig, setReportConfig] = useState({
    projectId: "",
    title: "Provincial Business Case",
    author: "Chief Engineer",
    showAiNarrative: true,
    showSchedule: true,
  });

  const updateConfig = (key: string, value: any) => {
    setReportConfig((prev) => ({ ...prev, [key]: value }));
  };

  const waitForImages = async (root: HTMLElement, timeoutMs = 4000) => {
    const imgs = Array.from(root.querySelectorAll("img")) as HTMLImageElement[];
    if (imgs.length === 0) return;

    await Promise.race([
      Promise.all(
        imgs.map(
          (img) =>
            new Promise<void>((resolve) => {
              if (img.complete && img.naturalWidth > 0) return resolve();
              const done = () => resolve();
              img.addEventListener("load", done, { once: true });
              img.addEventListener("error", done, { once: true });
            })
        )
      ),
      new Promise<void>((resolve) => setTimeout(resolve, timeoutMs)),
    ]);
  };

  const handleDownload = async () => {
    if (!previewRef.current) return;

    const reportNode =
      (previewRef.current.querySelector(
        "#report-print-root"
      ) as HTMLElement | null) ?? previewRef.current;

    setDownloading(true);

    try {
      // Give the UI a tick to finish layout
      await new Promise((r) => setTimeout(r, 50));
      await waitForImages(reportNode);

      // Generate PNG from DOM
      const dataUrl = await toPng(reportNode, {
        cacheBust: true,
        pixelRatio: 2,
        backgroundColor: "#ffffff",

        // If SVG charts/icons cause issues, keep this filter.
        // Remove it if you want SVGs included (and it works in your case).
        filter: (node) => node.nodeName.toLowerCase() !== "svg",
      });

      // Load image to get natural dimensions
      const img = new Image();
      img.src = dataUrl;
      await new Promise<void>((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = () => reject(new Error("Failed to load export image."));
      });

      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pdfWidth;
      const imgHeight = (img.height * imgWidth) / img.width;

      let heightLeft = imgHeight;
      let position = 0;

      pdf.addImage(dataUrl, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(dataUrl, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      pdf.save(`Business_Case_${new Date().toISOString().slice(0, 10)}.pdf`);
    } catch (err) {
      console.error("PDF Generation failed", err);
      alert("Failed to generate PDF.");
    } finally {
      setDownloading(false);
    }
  };

  return (
    <div className="flex h-full w-full bg-[var(--background)]">
      {/* LEFT PANEL: SETTINGS */}
      <aside className="w-80 border-r border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] flex flex-col shrink-0 z-10">
        <div className="p-4 border-b border-slate-200 dark:border-slate-800 flex items-center gap-2">
          <div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
            <LayoutTemplate className="w-5 h-5" />
          </div>
          <span className="font-bold text-sm">Report Configuration</span>
        </div>
        <div className="flex-1 overflow-y-auto">
          <ReportFilterSidebar
            config={reportConfig}
            onConfigChange={updateConfig}
          />
        </div>
      </aside>

      {/* MAIN PANEL: PREVIEW */}
      <main className="flex-1 bg-slate-100 dark:bg-slate-900/50 flex flex-col relative overflow-hidden">
        <div className="h-16 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 bg-[var(--surface-bg)] shrink-0">
          <div className="flex items-center gap-3">
            <FileText className="w-5 h-5 text-slate-400" />
            <div>
              <div className="text-sm font-bold text-slate-800 dark:text-slate-100">
                Live Preview
              </div>
              <div className="text-[10px] text-slate-500 uppercase tracking-wider font-medium">
                A4 Portrait â€¢ Strategic Business Case
              </div>
            </div>
          </div>

          <button
            onClick={handleDownload}
            disabled={downloading || !reportConfig.projectId}
            className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/20 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {downloading ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Download className="w-4 h-4" />
            )}
            {downloading ? "Publishing..." : "Export PDF"}
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-8 flex justify-center bg-slate-100 dark:bg-slate-900/50">
          <ReportLivePreview previewRef={previewRef} config={reportConfig} />
        </div>
      </main>
    </div>
  );
}\n--- ./app/(app)/reports/components/templates/ExecutivePDF.tsx ---\n
\n--- ./app/(app)/reports/components/templates/EngineeringExcel.ts ---\n
\n--- ./app/(app)/reports/components/templates/GISExport.ts ---\n
\n--- ./app/(app)/reports/components/ExportActionsPanel.tsx ---\n
"use client";

import React, { useState } from "react";
import { FileText, Table, Globe, CheckCircle2, Download, Loader2 } from "lucide-react";
import { cn } from "@/lib/utils";
import html2canvas from "html2canvas";
import jsPDF from "jspdf";

export default function ExportActionsPanel({ activeTemplate, onTemplateChange, previewRef }: any) {
  const [downloading, setDownloading] = useState(false);

  const templates = [
    { id: "executive", label: "Executive Summary", icon: <FileText className="w-4 h-4" />, desc: "High-level visual PDF" },
    { id: "engineering", label: "Engineering Schedule", icon: <Table className="w-4 h-4" />, desc: "Detailed Grid View" },
    { id: "gis", label: "GIS Package", icon: <Globe className="w-4 h-4" />, desc: "GeoJSON / KML" },
  ];

  const handleDownload = async () => {
    if (!previewRef?.current) return;
    setDownloading(true);

    try {
      const canvas = await html2canvas(previewRef.current, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: "#ffffff",
        onclone: (clonedDoc) => {
          // normalize colors to rgb/hex so html2canvas doesn't choke on lab()/oklch()
          const root = clonedDoc.getElementById("report-print-root");
          if (!root) return;

          const colorProps = [
            "color",
            "backgroundColor",
            "borderTopColor",
            "borderRightColor",
            "borderBottomColor",
            "borderLeftColor",
            "outlineColor",
            "textDecorationColor",
          ] as const;

          const normalize = (val: string) => {
            if (!val) return val;
            const lower = val.toLowerCase();
            if (!lower.includes("lab(") && !lower.includes("oklch(") && !lower.includes("lch(")) return val;

            // try to coerce via browser parser into rgb
            const tmp = clonedDoc.createElement("span");
            tmp.style.color = val;
            tmp.style.position = "fixed";
            tmp.style.left = "-9999px";
            clonedDoc.body.appendChild(tmp);

            const computed = clonedDoc.defaultView?.getComputedStyle(tmp).color || val;
            tmp.remove();
            return computed;
          };

          const all = [root, ...Array.from(root.querySelectorAll<HTMLElement>("*"))];

          all.forEach((el) => {
            const cs = clonedDoc.defaultView?.getComputedStyle(el);
            if (!cs) return;

            colorProps.forEach((prop) => {
              const v = (cs as any)[prop] as string;
              const nv = normalize(v);
              if (nv && nv !== v) {
                (el.style as any)[prop] = nv;
              }
            });
          });

          // hard force white background on root (safe)
          (root as HTMLElement).style.backgroundColor = "#ffffff";
          (root as HTMLElement).style.color = (root as HTMLElement).style.color || "#0f172a";
        },
      });

      const imgData = canvas.toDataURL("image/png");

      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

      pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      pdf.save(`Mosianedi_Report_${activeTemplate}_${new Date().toISOString().slice(0, 10)}.pdf`);
    } catch (err) {
      console.error("PDF Generation failed", err);
      alert("Failed to generate PDF. Please try again.");
    } finally {
      setDownloading(false);
    }
  };

  return (
    <div className="p-4 flex flex-col h-full">
      <div className="space-y-4 mb-8">
        <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider">Select Format</h3>
        <div className="space-y-2">
          {templates.map((t) => (
            <button
              key={t.id}
              onClick={() => onTemplateChange(t.id)}
              className={cn(
                "w-full flex items-start gap-3 p-3 rounded-xl border text-left transition-all",
                activeTemplate === t.id
                  ? "border-indigo-600 bg-indigo-50 dark:bg-indigo-900/20 ring-1 ring-indigo-600"
                  : "border-slate-200 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800"
              )}
            >
              <div
                className={cn(
                  "p-2 rounded-lg",
                  activeTemplate === t.id ? "bg-white dark:bg-slate-900 text-indigo-600" : "bg-slate-100 dark:bg-slate-800 text-slate-500"
                )}
              >
                {t.icon}
              </div>
              <div>
                <div className="text-sm font-bold">{t.label}</div>
                <div className="text-[10px] text-slate-500">{t.desc}</div>
              </div>
              {activeTemplate === t.id && <CheckCircle2 className="w-4 h-4 text-indigo-600 ml-auto" />}
            </button>
          ))}
        </div>
      </div>

      <div className="mt-auto pt-6 border-t border-slate-200 dark:border-slate-800 space-y-4">
        <button
          onClick={handleDownload}
          disabled={downloading}
          className="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:scale-[1.02] active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
        >
          {downloading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Download className="w-4 h-4" />}
          {downloading ? "Generating PDF..." : "Download Report"}
        </button>
      </div>
    </div>
  );
}\n--- ./app/(app)/reports/hooks/useReportData.ts ---\n
"use client";

import { useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";

// --- Types ---
export interface ReportData {
  meta: {
    projectName: string;
    province: string;
    generatedDate: string;
    author: string;
  };
  summary: {
    totalLength: number;
    assetValue: number;
    currentVci: number; // Replaces avgCondition
    futureVci: number;
    budgetAsk: number;
    preservationRatio: number;
  };
  narrative: {
    executiveSummary: string;
    riskStatement: string;
    recommendation: string;
    aiGenerated: boolean;
  };
  chartData: {
    year: number;
    fundedVCI: number;    
    doNothingVCI: number; 
    budget: number;
  }[];
  segments: any[];        // Added back for tables
  criticalRisks: any[];   // Added back for top 5 list
  loading: boolean;
  error: string | null;
}

// Helper: Calculate "Do Nothing" Decay
function calculateDecayCurve(startVci: number, years: number) {
  const curve = [];
  let current = startVci;
  for (let i = 0; i < years; i++) {
    const decayRate = current > 70 ? 1.5 : current > 50 ? 2.5 : 4.0; 
    current = Math.max(0, current - decayRate);
    curve.push(current);
  }
  return curve;
}

export function useReportData(projectId: string | null, config?: any) {
  const [data, setData] = useState<ReportData | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!projectId) return;

    let isCancelled = false;

    async function fetchData() {
      setLoading(true);
      setError(null);

      try {
        // 1. Fetch Project Basics
        const { data: project } = await supabase
          .from("projects")
          .select("project_name, province, active_simulation_run_id")
          .eq("id", projectId)
          .single();

        if (!project) throw new Error("Project not found.");

        // 2. Fetch Active Simulation (The "Math")
        let simulationPayload: any = null;
        let aiContent: any = null;

        if (project.active_simulation_run_id) {
            const { data: sim } = await supabase
                .from("simulation_results")
                .select("results_payload")
                .eq("id", project.active_simulation_run_id)
                .single();
            simulationPayload = sim?.results_payload;

            const { data: ai } = await supabase
                .from("ai_insights")
                .select("content")
                .eq("simulation_run_id", project.active_simulation_run_id)
                .eq("status", "final")
                .order("created_at", { ascending: false })
                .limit(1)
                .maybeSingle();
            aiContent = ai?.content;
        } else {
            // Fallback to latest
            const { data: latestSim } = await supabase
                .from("simulation_results")
                .select("results_payload")
                .eq("project_id", projectId)
                .order("run_at", { ascending: false })
                .limit(1)
                .maybeSingle();
            simulationPayload = latestSim?.results_payload;
        }

        // 3. Fetch Segments (The "Evidence")
        // We look for the latest upload to populate the tables
        let segments: any[] = [];
        const { data: upload } = await supabase
            .from("master_data_uploads")
            .select("workbook_payload")
            .eq("project_id", projectId)
            .order("created_at", { ascending: false })
            .limit(1)
            .maybeSingle();
        
        if (upload?.workbook_payload) {
             // Handle different payload structures
             const payload = upload.workbook_payload;
             const rawData = Array.isArray(payload) ? payload : (payload.data || payload.rows || []);
             segments = rawData.map((s: any) => ({
                 road_id: s.Road_ID || s.road_id || "Unknown",
                 surface: s.Surface || s.surface || "Paved",
                 iri: Number(s.IRI || s.iri || 0),
                 length: Number(s.Length || s.length || 0)
             }));
        }

        // 4. Process & Merge
        if (!isCancelled) {
            const yearlyData = simulationPayload?.yearly_data || [];
            const startVci = yearlyData[0]?.avg_condition_index || 50;
            const endVci = yearlyData[yearlyData.length - 1]?.avg_condition_index || 0;
            const assetValue = yearlyData[0]?.asset_value || 0;
            const totalCost = simulationPayload?.total_cost_npv || 0;

            // Generate Curves
            const decayCurve = calculateDecayCurve(startVci, yearlyData.length || 10);
            const chartData = yearlyData.map((d: any, i: number) => ({
                year: d.year,
                fundedVCI: d.avg_condition_index,
                doNothingVCI: decayCurve[i] || 0,
                budget: d.total_maintenance_cost
            }));

            // Identify Risks (Top 5 worst roads)
            const criticalRisks = [...segments]
                .sort((a, b) => b.iri - a.iri)
                .slice(0, 5);

            setData({
                meta: {
                    projectName: project.project_name,
                    province: project.province,
                    generatedDate: new Date().toLocaleDateString(),
                    author: "Provincial Roads Dept"
                },
                summary: {
                    totalLength: segments.reduce((acc, s) => acc + s.length, 0),
                    assetValue: assetValue,
                    currentVci: startVci,
                    futureVci: endVci,
                    budgetAsk: totalCost,
                    preservationRatio: assetValue > 0 ? (totalCost / assetValue) * 100 : 0
                },
                narrative: {
                    executiveSummary: aiContent?.executive_summary || "No strategic narrative generated yet. Run the AI Advisor to populate this section.",
                    riskStatement: aiContent?.fiscal_implications?.liability_growth || "Data insufficient to calculate liability risk.",
                    recommendation: aiContent?.recommendation || "Proceed with budget allocation to prevent asset collapse.",
                    aiGenerated: !!aiContent
                },
                chartData,
                segments,
                criticalRisks,
                loading: false,
                error: null
            });
        }

      } catch (err: any) {
        if (!isCancelled) setError(err.message);
      } finally {
        if (!isCancelled) setLoading(false);
      }
    }

    fetchData();
    return () => { isCancelled = true; };
  }, [projectId]);

  return { data, loading, error };
}\n--- ./app/(app)/reports/page.tsx ---\n
"use client";

import React from "react";
import ReportBuilderShell from "./components/ReportBuilderShell";

export default function ReportsPage() {
  return (
    <div className="h-[calc(100vh-64px)] w-full overflow-hidden">
      <ReportBuilderShell />
    </div>
  );
}\n--- ./app/(app)/reports/budget/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useRef, useState } from "react";
import {
  Wallet,
  TrendingUp,
  PieChart as PieIcon,
  Loader2,
  FileText,
  Sheet,
  ChevronDown
} from "lucide-react";
import { Calendar } from "lucide-react";
import { supabase } from "@/lib/supabaseClient";
import { toPng } from "html-to-image";
import jsPDF from "jspdf";

export default function BudgetSummaryPage() {
  const [loading, setLoading] = useState(true);
  
  // State for Projects & Selection
  const [projects, setProjects] = useState<any[]>([]);
  const [selectedProjectId, setSelectedProjectId] = useState<string | null>(null);
  const [selectedProjectName, setSelectedProjectName] = useState("");
  const [selectedProjectProvince, setSelectedProjectProvince] = useState("");

  // Data State
  const [yearlyData, setYearlyData] = useState<any[]>([]);
  const [totalCost, setTotalCost] = useState(0);

  const [exportingPdf, setExportingPdf] = useState(false);
  const [exportingCsv, setExportingCsv] = useState(false);

  const scheduleRef = useRef<HTMLDivElement>(null);

  // 1. Fetch Projects List on Mount
  useEffect(() => {
    async function fetchProjects() {
        const { data } = await supabase
            .from("projects")
            .select("id, project_name, province")
            .order("updated_at", { ascending: false });

        if (data && data.length > 0) {
            setProjects(data);
            setSelectedProjectId(data[0].id); // Default to first
            setSelectedProjectName(data[0].project_name);
            setSelectedProjectProvince(data[0].province);
        } else {
            setLoading(false);
        }
    }
    fetchProjects();
  }, []);

  // 2. Fetch Simulation Data when Project Changes
  useEffect(() => {
    async function fetchEngineeringData() {
      if(!selectedProjectId) return;
      
      setLoading(true);
      try {
        // Update labels based on selection
        const proj = projects.find(p => p.id === selectedProjectId);
        if(proj) {
            setSelectedProjectName(proj.project_name);
            setSelectedProjectProvince(proj.province);
        }

        const { data: sim } = await supabase
          .from("simulation_results")
          .select("results_payload")
          .eq("project_id", selectedProjectId)
          .order("run_at", { ascending: false })
          .limit(1)
          .single();

        if (sim?.results_payload) {
          setYearlyData(sim.results_payload.yearly_data || []);
          setTotalCost(sim.results_payload.total_cost_npv || 0);
        } else {
            setYearlyData([]);
            setTotalCost(0);
        }
      } catch (e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    }
    fetchEngineeringData();
  }, [selectedProjectId, projects]);

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("en-ZA", {
      style: "currency",
      currency: "ZAR",
      notation: "compact",
    }).format(amount);
  };

  const fileStem = useMemo(() => {
    const province = selectedProjectProvince?.replace(/\s+/g, "_") ?? "Province";
    const name = selectedProjectName?.replace(/\s+/g, "_") ?? "Project";
    const date = new Date().toISOString().slice(0, 10);
    return `Expenditure_Schedule_${province}_${name}_${date}`;
  }, [selectedProjectName, selectedProjectProvince]);

  // Export functions (CSV/PDF) omitted for brevity as they remain largely the same, 
  // relying on `yearlyData` which is now dynamic.
  const downloadBlob = (blob: Blob, filename: string) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };

  const toCsv = (rows: any[]) => {
    const header = [
      "financial_year",
      "avg_condition_index_vci",
      "pct_good",
      "pct_fair",
      "pct_poor",
      "required_budget_zar",
    ];
    const lines = rows.map((y) => {
      const fy = `FY ${y.year}/${y.year + 1}`;
      const safe = (v: any) => {
        const s = String(v ?? "");
        if (s.includes(",") || s.includes('"') || s.includes("\n")) {
          return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
      };
      return [
        safe(fy),
        safe(Number(y.avg_condition_index ?? 0).toFixed(2)),
        safe(Number(y.pct_good ?? 0).toFixed(2)),
        safe(Number(y.pct_fair ?? 0).toFixed(2)),
        safe(Number(y.pct_poor ?? 0).toFixed(2)),
        safe(Number(y.total_maintenance_cost ?? 0).toFixed(2)),
      ].join(",");
    });
    return [header.join(","), ...lines].join("\n");
  };

  const handleExportCsv = async () => {
    setExportingCsv(true);
    try {
      const csv = toCsv(yearlyData || []);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      downloadBlob(blob, `${fileStem}.csv`);
    } catch (e) {
      console.error(e);
      alert("Failed to export CSV.");
    } finally {
      setExportingCsv(false);
    }
  };

  const handleExportPdf = async () => {
    if (!scheduleRef.current) return;
    setExportingPdf(true);
    try {
      await new Promise((r) => setTimeout(r, 50));
      const node = scheduleRef.current;
      const dataUrl = await toPng(node, {
        cacheBust: true,
        pixelRatio: 2,
        backgroundColor: "#ffffff",
      });
      const img = new Image();
      img.src = dataUrl;
      await new Promise<void>((resolve, reject) => {
        img.onload = () => resolve();
        img.onerror = () => reject(new Error("Failed to load export image"));
      });
      const pdf = new jsPDF("p", "mm", "a4");
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pdfWidth;
      const imgHeight = (img.height * imgWidth) / img.width;
      let heightLeft = imgHeight;
      let position = 0;
      pdf.addImage(dataUrl, "PNG", 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
      while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(dataUrl, "PNG", 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }
      pdf.save(`${fileStem}.pdf`);
    } catch (e) {
      console.error(e);
      alert("Failed to export PDF.");
    } finally {
      setExportingPdf(false);
    }
  };

  return (
    <div className="p-8 pb-20 max-w-7xl mx-auto space-y-8">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Engineering Programme</h1>
          
          <div className="mt-1 flex items-center gap-2">
             {/* PROJECT DROPDOWN */}
             <div className="relative group">
                <select 
                    value={selectedProjectId || ""}
                    onChange={(e) => setSelectedProjectId(e.target.value)}
                    disabled={projects.length === 0}
                    className="appearance-none bg-transparent border-none text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 pr-6 cursor-pointer font-medium focus:ring-0 focus:outline-none"
                >
                    {projects.length === 0 && <option>No Projects Found</option>}
                    {projects.map((p) => (
                        <option key={p.id} value={p.id}>{p.province}: {p.project_name}</option>
                    ))}
                </select>
                <ChevronDown className="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none" />
             </div>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={handleExportCsv}
            disabled={exportingCsv || yearlyData.length === 0}
            className="flex items-center gap-2 px-4 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold rounded-lg hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {exportingCsv ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sheet className="w-4 h-4" />}
            {exportingCsv ? "Exporting..." : "Export CSV"}
          </button>

          <button
            onClick={handleExportPdf}
            disabled={exportingPdf || yearlyData.length === 0}
            className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {exportingPdf ? <Loader2 className="w-4 h-4 animate-spin" /> : <FileText className="w-4 h-4" />}
            {exportingPdf ? "Exporting..." : "Export PDF"}
          </button>
        </div>
      </div>

      {loading ? (
          <div className="h-64 flex items-center justify-center">
            <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
          </div>
      ) : (
        <>
            {/* KPI Grid */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="p-6 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="flex items-center gap-3 mb-2">
                    <div className="p-2 bg-blue-100 text-blue-600 rounded-lg">
                    <Wallet className="w-5 h-5" />
                    </div>
                    <span className="text-xs font-bold uppercase text-slate-500">Program Total (NPV)</span>
                </div>
                <div className="text-3xl font-black text-slate-900 dark:text-white">{formatCurrency(totalCost)}</div>
                <div className="text-sm text-slate-500 mt-1">{yearlyData.length} Year Horizon</div>
                </div>

                <div className="p-6 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm">
                <div className="flex items-center gap-3 mb-2">
                    <div className="p-2 bg-emerald-100 text-emerald-600 rounded-lg">
                    <TrendingUp className="w-5 h-5" />
                    </div>
                    <span className="text-xs font-bold uppercase text-slate-500">Target Condition</span>
                </div>
                <div className="text-3xl font-black text-slate-900 dark:text-white">
                    VCI {yearlyData.length > 0 ? yearlyData[yearlyData.length - 1].avg_condition_index.toFixed(0) : "0"}
                </div>
                <div className="text-sm text-emerald-600 mt-1 font-medium">Sustainable Level</div>
                </div>

                <div className="p-6 bg-amber-50 dark:bg-amber-900/10 rounded-2xl border border-amber-200 dark:border-amber-800 shadow-sm">
                <div className="flex items-center gap-3 mb-2">
                    <div className="p-2 bg-amber-100 text-amber-600 rounded-lg">
                    <Calendar className="w-5 h-5" />
                    </div>
                    <span className="text-xs font-bold uppercase text-amber-700 dark:text-amber-400">Peak Funding Year</span>
                </div>
                <div className="text-3xl font-black text-amber-600 dark:text-amber-400">2027</div>
                <div className="text-sm text-amber-600/80 mt-1">Critical Rehab Phase</div>
                </div>
            </div>

            {/* Yearly Breakdown Table + â€œchart barsâ€ */}
            <div
                ref={scheduleRef}
                className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden"
            >
                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <h3 className="font-bold text-slate-900 dark:text-white flex items-center gap-2">
                    <PieIcon className="w-4 h-4 text-slate-400" />
                    Annual Expenditure Schedule
                </h3>
                </div>

                <table className="w-full text-sm text-left">
                <thead className="bg-slate-50 dark:bg-slate-800/50 text-xs uppercase font-bold text-slate-500">
                    <tr>
                    <th className="px-6 py-4">Financial Year</th>
                    <th className="px-6 py-4">Network Condition (VCI)</th>
                    <th className="px-6 py-4">Good / Fair / Poor (%)</th>
                    <th className="px-6 py-4 text-right">Required Budget</th>
                    </tr>
                </thead>

                <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                    {yearlyData.map((year: any) => (
                    <tr key={year.year} className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <td className="px-6 py-4 font-bold text-slate-900 dark:text-white">FY {year.year}/{year.year + 1}</td>

                        <td className="px-6 py-4">
                        <div className="flex items-center gap-2">
                            <div className="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                            <div className="h-full bg-emerald-500" style={{ width: `${year.avg_condition_index}%` }} />
                            </div>
                            <span className="font-mono text-slate-600 dark:text-slate-300">
                            {Number(year.avg_condition_index ?? 0).toFixed(1)}
                            </span>
                        </div>
                        </td>

                        <td className="px-6 py-4 text-slate-500 text-xs">
                        <span className="text-emerald-600 font-bold">{Number(year.pct_good ?? 0).toFixed(0)}%</span> /{" "}
                        <span className="text-amber-600 font-bold">{Number(year.pct_fair ?? 0).toFixed(0)}%</span> /{" "}
                        <span className="text-rose-600 font-bold">{Number(year.pct_poor ?? 0).toFixed(0)}%</span>
                        </td>

                        <td className="px-6 py-4 text-right font-mono font-bold text-slate-900 dark:text-white">
                        {formatCurrency(Number(year.total_maintenance_cost ?? 0))}
                        </td>
                    </tr>
                    ))}

                    {yearlyData.length === 0 && (
                    <tr>
                        <td colSpan={4} className="p-8 text-center text-slate-400">
                        No schedule available for this project. Try running a simulation first.
                        </td>
                    </tr>
                    )}
                </tbody>
                </table>
            </div>
        </>
      )}
    </div>
  );
}\n--- ./app/layout.tsx ---\n
import type { Metadata } from "next";
import "./globals.css";
import { ThemeProvider } from "@/components/theme-provider";

export const metadata: Metadata = {
  title: "Mosianedi",
  description: "Road investment modeling platform",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      {/* no bg/text classes here, they come from globals.css via vars */}
      <body>
        <ThemeProvider>{children}</ThemeProvider>
      </body>
    </html>
  );
}\n--- ./app/(public)/p/[slug]/public-client.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useParams } from "next/navigation";
import { AlertTriangle } from "lucide-react";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

type PublicBundle = {
  title: string;
  province: string;
  slides: {
    context?: boolean;
    decay?: boolean;
    finance?: boolean;
    corridors?: boolean;
    implementation?: boolean;
    end?: boolean;
  };
  projectId: string;
};

export default function PublicPresentationClient() {
  const params = useParams();
  const slug = Array.isArray(params?.slug) ? params?.slug[0] : (params?.slug as string);

  const [bundle, setBundle] = useState<PublicBundle | null>(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function load() {
      try {
        const res = await fetch(`${API_BASE}/api/v1/public/presentations/${slug}`);
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || "Unable to load presentation");
        }
        const data = await res.json();
        setBundle(data);
      } catch (e: any) {
        setError(e?.message || "Unable to load presentation");
      }
    }
    if (slug) load();
  }, [slug]);

  const redirectUrl = useMemo(() => {
    if (!bundle) return "";
    const query = new URLSearchParams({
      title: bundle.title,
      province: bundle.province,
      slides: JSON.stringify(bundle.slides || {}),
      public: "1",
    }).toString();

    return `/projects/${bundle.projectId}/presentation/live?${query}`;
  }, [bundle]);

  if (error) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center p-8">
        <div className="max-w-lg p-6 rounded-2xl bg-white/5 border border-white/10">
          <div className="flex items-center gap-2 text-rose-300 font-bold">
            <AlertTriangle className="w-5 h-5" />
            Public link unavailable
          </div>
          <div className="mt-3 text-sm text-white/70 whitespace-pre-wrap">{error}</div>
        </div>
      </div>
    );
  }

  if (!bundle) {
    return (
      <div className="min-h-screen bg-slate-950 text-white flex items-center justify-center">
        <div className="w-10 h-10 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  if (typeof window !== "undefined") {
    window.location.replace(redirectUrl);
  }

  return null;
}\n--- ./app/(public)/p/[slug]/page.tsx ---\n
import PublicPresentationClient from "./public-client";

export default function PublicPresentationPage() {
  return <PublicPresentationClient />;
}\n--- ./app/maintenance/page.tsx ---\n
"use client";

import React, { useRef, useState } from "react";
import { Canvas, useFrame } from "@react-three/fiber";
import { 
  Text, 
  Float, 
  OrbitControls, 
  PerspectiveCamera, 
  ContactShadows, 
  Environment, 
  Stars 
} from "@react-three/drei";
import * as THREE from "three";
import { useRouter } from "next/navigation";
import { ArrowLeft } from "lucide-react";

// --- 3D COMPONENTS ---

function RoadSegment() {
  return (
    <group rotation={[-Math.PI / 2, 0, 0]} position={[0, -1, 0]}>
      {/* Asphalt */}
      <mesh receiveShadow>
        <planeGeometry args={[10, 20]} />
        <meshStandardMaterial 
            color="#1e293b" 
            roughness={0.8} 
            metalness={0.2}
        />
      </mesh>
      {/* Road Markings (Yellow Line) */}
      <mesh position={[0, 0, 0.02]}>
        <planeGeometry args={[0.3, 20]} />
        <meshStandardMaterial color="#fbbf24" emissive="#fbbf24" emissiveIntensity={0.5} />
      </mesh>
      {/* White Lines */}
      <mesh position={[-3, 0, 0.02]}>
        <planeGeometry args={[0.2, 20]} />
        <meshStandardMaterial color="white" opacity={0.5} transparent />
      </mesh>
      <mesh position={[3, 0, 0.02]}>
        <planeGeometry args={[0.2, 20]} />
        <meshStandardMaterial color="white" opacity={0.5} transparent />
      </mesh>
    </group>
  );
}

function TrafficCone({ position }: { position: [number, number, number] }) {
  const mesh = useRef<THREE.Mesh>(null);
  
  // Subtle bounce animation
  useFrame((state) => {
    if (mesh.current) {
        mesh.current.position.y = position[1] + Math.sin(state.clock.elapsedTime * 2 + position[0]) * 0.1;
    }
  });

  return (
    <group position={position}>
      <mesh ref={mesh} castShadow>
        <coneGeometry args={[0.4, 1.5, 32]} />
        <meshStandardMaterial color="#f97316" roughness={0.3} />
      </mesh>
      {/* Reflective Strip */}
      <mesh position={[0, 0.4, 0]}>
        <cylinderGeometry args={[0.25, 0.3, 0.3, 32]} />
        <meshStandardMaterial color="white" emissive="white" emissiveIntensity={0.8} />
      </mesh>
      <mesh position={[0, -0.75, 0]}>
        <boxGeometry args={[0.9, 0.1, 0.9]} />
        <meshStandardMaterial color="#1f2937" />
      </mesh>
    </group>
  );
}

function FloatingText() {
  return (
    <Float speed={2} rotationIntensity={0.1} floatIntensity={0.5} floatingRange={[0, 0.5]}>
      <group position={[0, 1.5, -2]}>
        <Text
          fontSize={1.2}
          color="#ffffff"
          anchorX="center"
          anchorY="middle"
          font="https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff"
        >
          SYSTEM UPGRADE
        </Text>
        <Text
          position={[0, -0.8, 0]}
          fontSize={0.4}
          color="#94a3b8"
          anchorX="center"
          anchorY="middle"
          font="https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff"
        >
          We are paving the way for better data.
        </Text>
        <Text
            position={[0, -1.4, 0]}
            fontSize={0.25}
            color="#6366f1"
            anchorX="center"
            anchorY="middle"
        >
            ESTIMATED COMPLETION: 3 Days
        </Text>
      </group>
    </Float>
  );
}

// --- MAIN PAGE COMPONENT ---

export default function MaintenancePage() {
  const router = useRouter();

  return (
    <div className="h-screen w-screen bg-[#020617] text-white overflow-hidden relative">
      
      {/* 3D Canvas */}
      <div className="absolute inset-0 z-0">
        <Canvas shadows dpr={[1, 2]}>
          <PerspectiveCamera makeDefault position={[0, 3, 8]} fov={50} />
          
          {/* Lighting */}
          <ambientLight intensity={0.5} />
          <spotLight position={[10, 10, 10]} angle={0.15} penumbra={1} intensity={1} castShadow />
          <pointLight position={[-10, -10, -10]} intensity={0.5} color="blue" />

          {/* Environment */}
          <Stars radius={100} depth={50} count={5000} factor={4} saturation={0} fade speed={1} />
          <Environment preset="city" />

          {/* Objects */}
          <group position={[0, -1, 0]}>
            <RoadSegment />
            <TrafficCone position={[-2, 0, 2]} />
            <TrafficCone position={[2, 0, 4]} />
            <TrafficCone position={[-1.5, 0, 5]} />
            <FloatingText />
          </group>

          {/* Shadows on the floor */}
          <ContactShadows resolution={1024} scale={20} blur={2} opacity={0.5} far={10} color="#000000" />

          {/* Controls (Auto Rotate for cinematic feel) */}
          <OrbitControls 
            enableZoom={false} 
            enablePan={false} 
            autoRotate 
            autoRotateSpeed={0.5} 
            maxPolarAngle={Math.PI / 2.1} 
            minPolarAngle={Math.PI / 3}
          />
        </Canvas>
      </div>

      {/* Overlay UI */}
      <div className="absolute top-0 left-0 w-full p-8 z-10 flex justify-between items-start pointer-events-none">
        <div className="pointer-events-auto">
            <h1 className="text-xl font-bold tracking-tight text-white flex items-center gap-2">
                <span className="w-3 h-3 rounded-full bg-amber-500 animate-pulse"/>
                Maintenance Mode
            </h1>
            <p className="text-xs text-slate-400 font-mono mt-1">
                Server Patch v2.4.1 â€¢ Deploying updates
            </p>
        </div>
      </div>

      <div className="absolute bottom-10 w-full text-center z-10 pointer-events-none">
        <div className="pointer-events-auto inline-block">
            <button 
                onClick={() => router.back()}
                className="flex items-center gap-2 px-6 py-3 bg-white/5 hover:bg-white/10 backdrop-blur-md border border-white/10 rounded-full text-sm font-medium transition-all hover:scale-105"
            >
                <ArrowLeft className="w-4 h-4" /> Go Back
            </button>
        </div>
      </div>

    </div>
  );
}\n--- ./app/(auth)/register/page.tsx ---\n
"use client";

import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";

const DEPARTMENTS = [
  "Planning",
  "Design",
  "Construction",
  "Maintenance",
  "Asset Management",
];

const JOB_TITLES = [
  "Roads Design Engineer",
  "Pavement Engineer",
  "Transportation Planner",
  "Project Manager",
  "Asset Management Specialist",
];

export default function RegisterPage() {
  const router = useRouter();

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [username, setUsername] = useState("");
  const [department, setDepartment] = useState(DEPARTMENTS[0]);
  const [title, setTitle] = useState(JOB_TITLES[0]);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);

    if (password !== confirmPassword) {
      setError("Passwords do not match.");
      return;
    }

    setSubmitting(true);

    const { data, error: signUpError } = await supabase.auth.signUp({
      email,
      password,
    });

    if (signUpError || !data.user) {
      setSubmitting(false);
      setError(signUpError?.message || "Unable to create account.");
      return;
    }

    const user = data.user;

    const { error: profileError } = await supabase.from("profiles").insert({
      user_id: user.id,
      first_name: firstName,
      last_name: lastName,
      username,
      email,
      department,
      title,
    });

    setSubmitting(false);

    if (profileError) {
      setError(profileError.message);
      return;
    }

    router.replace("/projects");
  };

  return (
    <div className="w-full max-w-2xl rounded-2xl border border-slate-200/70 bg-[var(--surface-bg)]/95 p-8 shadow-lg dark:border-slate-800/70">
      <h1 className="text-xl font-semibold text-[var(--foreground)]">
        Create account
      </h1>
      <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">
        Start modeling with <strong>SA Roads Funding Gap Solutions</strong>.
      </p>

      <form onSubmit={handleSubmit} className="mt-6 space-y-4">
        {/* Name Row */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              First name
            </label>
            <input
              type="text"
              required
              value={firstName}
              onChange={(e) => setFirstName(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Last name
            </label>
            <input
              type="text"
              required
              value={lastName}
              onChange={(e) => setLastName(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            />
          </div>
        </div>

        {/* Username */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Username
          </label>
          <input
            type="text"
            required
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            placeholder="jabu.mosianedi"
          />
        </div>

        {/* Department + Job title */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Department
            </label>
            <select
              value={department}
              onChange={(e) => setDepartment(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            >
              {DEPARTMENTS.map((d) => (
                <option key={d} value={d}>{d}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Job title
            </label>
            <select
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            >
              {JOB_TITLES.map((t) => (
                <option key={t} value={t}>{t}</option>
              ))}
            </select>
          </div>
        </div>

        {/* Email */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Email
          </label>
          <input
            type="email"
            required
            autoComplete="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
            placeholder="you@example.com"
          />
        </div>

        {/* Passwords */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Password
            </label>
            <input
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Confirm password
            </label>
            <input
              type="password"
              required
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)] placeholder:text-slate-400 dark:placeholder:text-slate-500 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>
        </div>

        {error && <p className="text-xs text-red-500">{error}</p>}

        <button
          type="submit"
          disabled={submitting}
          className="mt-2 inline-flex w-full items-center justify-center rounded-xl bg-[var(--accent-color)] px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-70 transition"
        >
          {submitting ? "Creating accountâ€¦" : "Sign up"}
        </button>
      </form>

      <p className="mt-4 text-center text-xs text-slate-500 dark:text-slate-400">
        Already have an account? <button type="button" onClick={() => router.push("/login")} className="font-medium text-[var(--accent-color)] hover:underline">Sign in</button>
      </p>
    </div>
  );
}\n--- ./app/(auth)/layout.tsx ---\n
/* --- ./app/(auth)/layout.tsx (NO CHANGES) --- */
import type { ReactNode } from "react";

export default function AuthLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen w-full bg-[var(--background)] text-[var(--foreground)]">
      <div className="mx-auto flex min-h-screen max-w-5xl items-center justify-center px-4">
        {children}
      </div>
    </div>
  );
}\n--- ./app/(auth)/login/page.tsx ---\n
"use client";

import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { TrendingUp, BarChart3, BrainCircuit, CheckCircle2 } from "lucide-react";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    setSubmitting(false);

    if (error) {
      setError(error.message);
      return;
    }

    if (data.session) {
      router.replace("/projects");
    }
  };

  return (
    <div className="min-h-screen w-full flex bg-[var(--background)]">
      
      {/* LEFT: SAAS OVERVIEW (Hidden on mobile) */}
      <div className="hidden lg:flex w-1/2 bg-indigo-900 relative overflow-hidden flex-col justify-between p-12 text-white">
         <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop')] bg-cover bg-center opacity-20 mix-blend-overlay" />
         <div className="absolute inset-0 bg-gradient-to-br from-indigo-900/90 to-slate-900/90" />
         
         <div className="relative z-10">
             <div className="flex items-center gap-3 mb-8">
                 <div className="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                    <TrendingUp className="w-6 h-6 text-emerald-400" />
                 </div>
                 <span className="font-bold text-lg tracking-tight">SA Roads Funding Gap Solutions</span>
             </div>
             
             <h1 className="text-5xl font-black leading-tight mb-6">
                 Bridge the gap between <span className="text-emerald-400">Engineering</span> & <span className="text-indigo-400">Treasury.</span>
             </h1>
             
             <p className="text-lg text-indigo-100 max-w-md leading-relaxed">
                 The only specialized modeling platform designed to justify provincial road maintenance budgets using actuarial decay simulation.
             </p>
         </div>

         <div className="relative z-10 space-y-6">
             <FeatureItem 
                icon={<BarChart3 className="w-5 h-5 text-indigo-300"/>} 
                title="Scenario Modeling" 
                desc="Visualize the impact of budget cuts on VCI over 10 years." 
             />
             <FeatureItem 
                icon={<BrainCircuit className="w-5 h-5 text-indigo-300"/>} 
                title="AI Strategic Advisor" 
                desc="Generate Treasury-compliant motivation memorandums instantly." 
             />
         </div>

         <div className="relative z-10 text-xs text-indigo-300/60 font-mono">
             v2.4.0 â€¢ Secure Government Gateway
         </div>
      </div>

      {/* RIGHT: LOGIN FORM */}
      <div className="w-full lg:w-1/2 flex items-center justify-center p-8">
        <div className="w-full max-w-md space-y-8">
            
            <div className="text-center lg:text-left">
                <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Welcome back</h2>
                <p className="text-sm text-slate-500 mt-2">Please sign in to your accredited workspace.</p>
            </div>

            <div className="bg-[var(--surface-bg)] p-8 rounded-3xl border border-slate-200 dark:border-slate-800 shadow-xl">
                <form onSubmit={handleSubmit} className="space-y-5">
                    <div>
                    <label className="block text-xs font-bold uppercase text-slate-500 mb-1.5">Email Address</label>
                    <input
                        type="email"
                        autoComplete="email"
                        required
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-4 py-3 text-sm text-[var(--input-text)] focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 dark:border-slate-700 outline-none transition-all"
                        placeholder="engineer@province.gov.za"
                    />
                    </div>

                    <div>
                    <label className="block text-xs font-bold uppercase text-slate-500 mb-1.5">Password</label>
                    <input
                        type="password"
                        autoComplete="current-password"
                        required
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-4 py-3 text-sm text-[var(--input-text)] focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 dark:border-slate-700 outline-none transition-all"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    />
                    </div>

                    {error && (
                    <div className="p-3 rounded-lg bg-rose-50 text-rose-600 text-xs font-medium border border-rose-100">
                        {error}
                    </div>
                    )}

                    <button
                    type="submit"
                    disabled={submitting}
                    className="w-full py-3.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed"
                    >
                    {submitting ? "Authenticating..." : "Access Workspace"}
                    </button>
                </form>
            </div>

            <p className="text-center text-xs text-slate-400">
                Don't have an account? <button onClick={() => router.push("/register")} className="text-indigo-600 font-bold hover:underline">Request Access</button>
            </p>
        </div>
      </div>
    </div>
  );
}

function FeatureItem({ icon, title, desc }: any) {
    return (
        <div className="flex gap-4 items-start">
            <div className="p-2 bg-white/5 rounded-lg border border-white/10">{icon}</div>
            <div>
                <div className="font-bold text-white text-sm">{title}</div>
                <div className="text-xs text-indigo-200 mt-0.5">{desc}</div>
            </div>
        </div>
    )
}\n--- ./app/page.tsx ---\n
import { redirect } from "next/navigation";

export default function Home() {
  redirect("/maintenance");
}\n--- ./app/globals.css ---\n
/* --- ./app/globals.css (FINAL CORRECTED VERSION) --- */
@import "tailwindcss";
@import "leaflet/dist/leaflet.css";
/* Define Custom Color Variables */
:root {
  /* Light Theme */
  --background: #f4f6fb;   /* Main canvas background */
  --foreground: #1e293b;   /* Main text color (slate-800) */
  --surface-bg: #ffffff;   /* Elevated element background (cards, sidebar) */
  --sidebar-bg: var(--surface-bg);
  --accent-color: #4c51f0; /* Accent color (deep purple/blue for CTAs) */
  --input-bg: #ffffff;     /* Input background: White in light mode */
  --input-text: #1e293b;   /* Input text: Dark text in light mode */
}

/* Dark Theme */
.dark {
  --background: #09090b;   /* Deep near-black background (slate-950) */
  --foreground: #f1f5f9;   /* Light text color (slate-100) */
  --surface-bg: #111827;   /* Dark elevated surface (slate-900) */
  --sidebar-bg: var(--surface-bg);
  --accent-color: #5d62f3; 
  --input-bg: #1e293d;     /* Input background: Slate-800 for contrast */
  --input-text: #f1f5f9;   /* Input text: Light text in dark mode */
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}\n--- ./postcss.config.mjs ---\n
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
\n--- ./next-env.d.ts ---\n
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
\n--- ./components/theme-provider.tsx ---\n
"use client";

import { ThemeProvider as NextThemesProvider } from "next-themes";
import type { ReactNode } from "react";

export function ThemeProvider({ children }: { children: ReactNode }) {
  return (
    <NextThemesProvider
      attribute="class"
      defaultTheme="dark"
      enableSystem={false}
    >
      {children}
    </NextThemesProvider>
  );
}\n--- ./components/topbar.tsx ---\n
"use client";

import { useTheme } from "next-themes";
import { useEffect, useState } from "react";
import { MoonStar, Sun, Bell, Search, TrendingUp } from "lucide-react";

export function Topbar() {
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = useState(false);

  useEffect(() => setMounted(true), []);

  const isDark = theme === "dark";
  const toggleTheme = () => setTheme(isDark ? "light" : "dark");
  
  return (
    <header
      className="
        flex items-center gap-6
        px-8 py-3
        bg-[var(--surface-bg)]/95 backdrop-blur-md
        shadow-lg rounded-2xl
      "
    >
      {/* App Name */}
      <div className="flex items-center gap-2">
        <div className="p-1.5 bg-indigo-600 rounded-lg">
            <TrendingUp className="w-4 h-4 text-white" />
        </div>
        <span
          className="
            px-2 py-2
            text-base font-bold tracking-tight
            text-[var(--foreground)]
          "
        >
          SA Roads Funding Gap Solutions
        </span>
      </div>

      {/* Search Section */}
      <div className="flex flex-1 items-center justify-center">
        <div className="relative w-full max-w-lg">
          <span className="pointer-events-none absolute inset-y-0 left-4 flex items-center">
            <Search className="h-5 w-5 text-slate-400 dark:text-slate-500" />
          </span>

          <input
            type="text"
            placeholder="Search projects, roads, KPIs..."
            className="
              w-full
              h-11
              pl-12 pr-4
              rounded-2xl
              text-sm
              shadow-sm
              bg-[var(--background)] border border-slate-200/50 dark:border-slate-800/50
              text-[var(--foreground)]
              placeholder:text-slate-400 dark:placeholder:text-slate-500
              focus:ring-2 focus:ring-sky-300/60 dark:focus:ring-sky-800/40
              focus:border-sky-400
              outline-none
              transition-all
            "
          />
        </div>
      </div>

      {/* Right Actions */}
      <div className="flex items-center gap-4">
        <button
          type="button"
          className="
            h-10 w-10 flex items-center justify-center
            rounded-full
            border border-slate-200/50 dark:border-slate-800/50
            bg-[var(--surface-bg)] 
            text-[var(--foreground)]
            hover:bg-[var(--background)]
            shadow-sm
            transition
          "
        >
          <Bell className="h-5 w-5" />
        </button>

        {mounted && (
          <button
            onClick={toggleTheme}
            className="
              flex items-center gap-2
              px-4 py-2
              rounded-full
              bg-[var(--surface-bg)]
              border border-slate-200/50 dark:border-slate-800/50
              text-xs font-medium
              text-[var(--foreground)]
              shadow-sm
              hover:bg-[var(--background)]
              transition
            "
          >
            {isDark ? (
              <>
                <MoonStar className="h-4 w-4" />
                Dark mode
              </>
            ) : (
              <>
                <Sun className="h-4 w-4" />
                Light mode
              </>
            )}
          </button>
        )}
      </div>
    </header>
  );
}\n--- ./components/nav-link.tsx ---\n
/* --- ./components/nav-link.tsx (UPDATED - Icon Color) --- */
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { ReactNode } from "react";
import { cn } from "@/lib/utils";

interface NavLinkProps {
  href: string;
  icon?: ReactNode;
  label: string;
}

export function NavLink({ href, icon, label }: NavLinkProps) {
  const pathname = usePathname();
  const isActive = pathname === href;
  
  // Define classes for icon color based on active state
  const iconClasses = isActive
    ? "" // Active state icon color is inherited from parent (text-white)
    : "text-slate-500 dark:text-slate-400"; // Inactive state uses fixed slate colors

  return (
    <Link
      href={href}
      className={cn(
        "flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium transition-colors",
        isActive
          ? "bg-[var(--accent-color)] text-white shadow-sm"
          // Inactive state uses explicit fixed colors for the specific muted look
          : "text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-50"
      )}
    >
      {icon && <span className={cn("shrink-0", iconClasses)}>{icon}</span>}
      {label && <span className="truncate">{label}</span>}
    </Link>
  );
}\n--- ./components/sidebar.tsx ---\n
"use client";

import { useEffect, useState } from "react";
import { useRouter, usePathname, useParams } from "next/navigation";
import Link from "next/link";
import { cn } from "@/lib/utils";
import { supabase } from "@/lib/supabaseClient";
import {
  FolderKanban,
  ChevronRight,
  ChevronDown,
  ChevronsLeft,
  ChevronsRight,
  LogOut,
  Presentation,
  Clock,
  FileText,
  ShieldAlert,
  Briefcase,
  LayoutDashboard,
  Layers,
  FileCheck,
  Sparkles,
  Wallet,
  Map,
  TrendingUp // Added for the Logo
} from "lucide-react";

type Profile = {
  first_name: string;
  last_name: string;
  username: string;
  department: string;
  title: string;
};

// --- 1. NAV GROUP (Accordion) ---
function NavGroup({ label, icon, active, expanded, onToggle, children, sidebarOpen }: any) {
    if (!sidebarOpen) {
        return (
            <div className="relative group">
                <button onClick={onToggle} className={cn("flex w-full items-center justify-center p-3 rounded-xl transition-colors", active ? "bg-[var(--accent-color)] text-white shadow-md" : "text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 dark:text-slate-400")}>
                    {icon}
                </button>
                <div className="absolute left-16 top-2 bg-slate-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity z-50 whitespace-nowrap">{label}</div>
            </div>
        );
    }
    return (
        <div className="space-y-1">
            <button onClick={onToggle} className={cn("w-full flex items-center justify-between gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition-colors", active ? "bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" : "text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-800/50 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200")}>
                <div className="flex items-center gap-3">
                    {icon && <span className={cn("shrink-0", active ? "text-[var(--accent-color)]" : "")}>{icon}</span>}
                    <span className="truncate">{label}</span>
                </div>
                {expanded ? <ChevronDown className="h-4 w-4 opacity-50"/> : <ChevronRight className="h-4 w-4 opacity-50"/>}
            </button>
            {expanded && <div className="ml-4 pl-3 border-l-2 border-slate-100 dark:border-slate-800 space-y-1 mt-1 animate-in slide-in-from-left-1 duration-200">{children}</div>}
        </div>
    );
}

// --- 2. NAV ITEM (Sub-Link) ---
function NavItem({ href, label, icon }: any) {
    const pathname = usePathname();
    const isActive = href ? pathname === href : false;
    return (
        <Link href={href} className={cn("flex items-center gap-2 px-3 py-2 text-xs font-medium rounded-lg transition-colors", isActive ? "bg-[var(--accent-color)]/10 text-[var(--accent-color)]" : "text-slate-500 hover:text-slate-900 dark:hover:text-slate-200")}>
            {icon && <span className="w-3 h-3 opacity-70">{icon}</span>}
            {label}
        </Link>
    );
}

// --- 3. SIMPLE LINK (Single Level) ---
function SimpleLink({ href, icon, label, active, open }: any) {
    return (
        <Link href={href} className={cn("flex items-center gap-3 rounded-xl px-3 py-2.5 text-sm font-medium transition-all group relative", active ? "bg-[var(--accent-color)] text-white shadow-md shadow-indigo-500/20" : "text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-slate-900 dark:text-slate-400 dark:hover:text-slate-200", !open && "justify-center")}>
            {icon}
            {open ? <span>{label}</span> : <div className="absolute left-14 bg-slate-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50 transition-opacity">{label}</div>}
        </Link>
    );
}

// --- MAIN COMPONENT ---
export function Sidebar() {
  const [open, setOpen] = useState(true);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [loggingOut, setLoggingOut] = useState(false);

  const router = useRouter();
  const pathname = usePathname();
  const params = useParams();
  
  // Extract projectId if we are in a project context
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;

  const [projectsOpen, setProjectsOpen] = useState(true);
  const [reportingOpen, setReportingOpen] = useState(true);

  useEffect(() => {
    const loadProfile = async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data } = await supabase.from("profiles").select("*").eq("user_id", user.id).single();
      if (data) setProfile(data as Profile);
    };
    loadProfile();
  }, []);

  const handleLogout = async () => {
    setLoggingOut(true);
    await supabase.auth.signOut();
    router.replace("/login");
  };

  const initials = profile ? (profile.first_name[0] + profile.last_name[0]).toUpperCase() : "U";

  const toggleSidebar = () => {
      setOpen(!open);
      if (open) { setProjectsOpen(false); setReportingOpen(false); }
  };

  // âœ… DYNAMIC ROUTES
  const dashboardHref = projectId ? `/projects/${projectId}/dashboard` : "/dashboard";
  const advisorHref = projectId ? `/projects/${projectId}/advisor` : "/advisor";

  // âœ… REPORT LINKS
  const executiveCaseHref = "/reports/treasury-view";
  const engineeringProgHref = "/reports/budget";
  const reportsBuilderHref = "/reports";

  return (
    <aside className={cn("flex h-full flex-col bg-[var(--sidebar-bg)] border-r border-slate-200 dark:border-slate-800 transition-all duration-300 ease-in-out z-20 shrink-0", open ? "w-64" : "w-20")}>
      
      {/* HEADER - UPDATED BRANDING */}
      <div className={cn("flex items-center h-16 px-4 border-b border-slate-100 dark:border-slate-800/50", open ? "justify-between" : "justify-center")}>
        {open ? (
             <div className="flex items-center gap-2 font-bold text-sm tracking-tight text-slate-900 dark:text-white leading-none">
                <div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white shrink-0">
                    <TrendingUp className="w-5 h-5" />
                </div>
                <span className="leading-tight">SA Roads Funding Gap Solutions</span>
             </div>
        ) : (
            <div className="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold">
                <TrendingUp className="w-5 h-5" />
            </div>
        )}
      </div>

      {/* NAV */}
      <nav className="flex-1 space-y-1 p-3 overflow-y-auto no-scrollbar">
        {/* PROJECTS */}
        <NavGroup 
            label="Projects" 
            icon={<FolderKanban className="w-5 h-5"/>} 
            active={pathname.includes("/projects") || pathname.includes("/advisor")}
            expanded={projectsOpen}
            onToggle={() => { if (!open) setOpen(true); setProjectsOpen(!projectsOpen); }}
            sidebarOpen={open}
        >
            <NavItem href="/projects/recent" label="Recent Activity" icon={<Clock className="w-3 h-3"/>} />
            <NavItem href="/projects" label="All Proposals" icon={<FileText className="w-3 h-3"/>} />
            <NavItem href={advisorHref} label="AI Advisor" icon={<Sparkles className="w-3 h-3 text-purple-500"/>} />
            <NavItem href={projectId ? `/projects/${projectId}/governance` : "/projects/governance"} label="Governance" icon={<ShieldAlert className="w-3 h-3"/>} />
        </NavGroup>

        {/* DASHBOARD */}
        <SimpleLink href={dashboardHref} icon={<LayoutDashboard className="w-5 h-5"/>} label="Dashboard" active={pathname.includes("/dashboard")} open={open} />
        
        {/* NETWORK & GIS */}
        <SimpleLink href="/network" icon={<Map className="w-5 h-5"/>} label="Network & GIS" active={pathname.includes("/network")} open={open} />

        {/* PROVINCIAL REPORTING */}
        <NavGroup 
            label="Provincial Reporting" 
            icon={<Briefcase className="w-5 h-5"/>} 
            active={pathname.includes("/reports")}
            expanded={reportingOpen}
            onToggle={() => { if (!open) setOpen(true); setReportingOpen(!reportingOpen); }}
            sidebarOpen={open}
        >
            <NavItem href={executiveCaseHref} label="Executive Case" icon={<Presentation className="w-3 h-3"/>} />
            <NavItem href={engineeringProgHref} label="Engineering Prog." icon={<Wallet className="w-3 h-3"/>} />
            <NavItem href={reportsBuilderHref} label="Submission Builder" icon={<FileCheck className="w-3 h-3"/>} />
        </NavGroup>

        <SimpleLink href="/presentationmode" icon={<Presentation className="w-5 h-5"/>} label="Boardroom Mode" active={pathname === "/presentationmode"} open={open} />
      </nav>

      {/* FOOTER */}
      <div className="p-4 border-t border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50">
          <div className={cn("flex items-center gap-3 mb-4", !open && "justify-center")}>
              <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xs font-bold text-white shadow-sm shrink-0">{initials}</div>
              {open && (
                  <div className="flex-1 overflow-hidden">
                      <div className="truncate text-sm font-bold text-slate-700 dark:text-slate-200">{profile ? `${profile.first_name} ${profile.last_name}` : "User"}</div>
                      <div className="truncate text-[10px] text-slate-500 uppercase font-bold tracking-wider">{profile?.department || "Admin"}</div>
                  </div>
              )}
          </div>
          <div className="flex gap-2">
            <button onClick={handleLogout} disabled={loggingOut} className={cn("flex-1 flex items-center justify-center gap-2 rounded-lg py-2 text-xs font-bold transition-colors border", "border-slate-200 dark:border-slate-700 hover:bg-rose-50 hover:text-rose-600 dark:hover:bg-rose-900/20 dark:hover:text-rose-400 text-slate-500")}>
                <LogOut className="w-3.5 h-3.5" />{open && "Log Out"}
            </button>
            <button onClick={toggleSidebar} className="w-9 h-9 flex items-center justify-center rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 transition-colors">
                {open ? <ChevronsLeft className="w-4 h-4" /> : <ChevronsRight className="w-4 h-4" />}
            </button>
          </div>
      </div>
    </aside>
  );
}\n--- ./package.json ---\n
{
  "name": "mosianedi-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@react-three/drei": "^10.7.7",
    "@react-three/fiber": "^9.5.0",
    "@supabase/supabase-js": "^2.83.0",
    "@types/leaflet": "^1.9.21",
    "@types/three": "^0.181.0",
    "html-to-image": "^1.11.13",
    "html2canvas": "^1.4.1",
    "jspdf": "^4.0.0",
    "leaflet": "^1.9.4",
    "lucide-react": "^0.554.0",
    "next": "^16.0.8",
    "next-themes": "^0.4.6",
    "react": "^19.2.1",
    "react-dom": "^19.2.1",
    "react-leaflet": "^5.0.0",
    "react-to-print": "^3.2.0",
    "recharts": "^3.5.0",
    "three": "^0.181.2"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
\n--- ./lib/routes.ts ---\n
\n--- ./lib/auth-mock.ts ---\n
\n--- ./lib/supabaseClient.ts ---\n
// lib/supabaseClient.ts
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

export async function getCurrentProfile() {
    const {
      data: { user },
    } = await supabase.auth.getUser();
  
    if (!user) return null;
  
    const { data, error } = await supabase
      .from("profiles")
      .select("*")
      .eq("user_id", user.id)
      .single();
  
    if (error) {
      console.error("Error fetching profile", error);
      return null;
    }
  
    return data;
  }\n--- ./lib/utils.ts ---\n
// lib/utils.ts

// Simple Tailwind-friendly classnames helper.
// Usage: cn("base", condition && "extra")
export function cn(
    ...classes: Array<string | false | null | undefined>
  ): string {
    return classes.filter(Boolean).join(" ");
  }\n--- ./lib/config.ts ---\n
// lib/config.ts

// 1. Get the base URL from environment or default to localhost
const BASE_URL = process.env.NEXT_PUBLIC_API_URL || "http://127.0.0.1:8000";

// 2. Helper to ensure no trailing slash problems
// This prevents errors like "https://api.com//api/v1"
export const API_BASE_URL = BASE_URL.endsWith("/") 
  ? BASE_URL.slice(0, -1) 
  : BASE_URL;\n--- ./tsconfig.json ---\n
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
\n--- ./eslint.config.mjs ---\n
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
\n--- ./next.config.ts ---\n
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
