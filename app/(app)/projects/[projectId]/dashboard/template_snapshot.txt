\n--- ./advisor/page.tsx ---\n
"use client";

import React from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { ArrowLeft, Sparkles, LayoutDashboard } from "lucide-react";

import { useProjectMeta } from "../../config/hooks/useProjectMeta";
import { useNetworkSnapshot } from "../../config/hooks/useNetworkSnapshot";
import { useSimulationResults } from "../hooks/useSimulationResults";

import { useAiAdvisor } from "../hooks/useAiAdvisor";
import { AiStrategyCard } from "../components/AiStrategyCard";
import { DashboardMainPanel } from "../components/DashboardMainPanel";

export default function AdvisorInsightsPage() {
  const params = useParams();
  const projectId = params.projectId as string;

  const { data: project } = useProjectMeta(projectId);
  const { data: snapshot, loading: snapLoading } = useNetworkSnapshot(projectId);
  const { results, loading: simLoading } = useSimulationResults(projectId);

  const { analysis, loading: aiLoading, error: aiError, generateAnalysis } = useAiAdvisor(projectId);

  const loading = snapLoading || simLoading;

  return (
    <div className="space-y-6 pb-20">
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div>
          <Link
            href={`/projects/${projectId}/dashboard`}
            className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
          >
            <ArrowLeft className="w-3 h-3" /> Back to Dashboard
          </Link>

          <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <Sparkles className="w-6 h-6 text-indigo-500" />
            AI Advisor Insights
          </h1>
          <p className="text-sm text-slate-500 mt-1">
            {project?.project_name || "Project"} ‚Äî generate a Treasury-ready executive narrative from your simulation.
          </p>
        </div>
      </header>

      {/* If no simulation exists, show a proper call-to-action */}
      {!loading && !results && (
        <div className="flex flex-col items-center justify-center h-[55vh] text-center space-y-4">
          <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-full">
            <LayoutDashboard className="w-8 h-8 text-slate-400" />
          </div>
          <h2 className="text-xl font-semibold text-slate-900 dark:text-slate-100">
            No Simulation Yet
          </h2>
          <p className="text-slate-500 max-w-md">
            AI insights require a simulation run. Go to Inputs, run your forecast, then return here.
          </p>
          <Link
            href={`/projects/${projectId}/config`}
            className="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            Go to Inputs
          </Link>
        </div>
      )}

      {/* Optional: show context snapshot + charts (same as dashboard) */}
      {loading && (
        <div className="flex h-48 items-center justify-center">
          <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
        </div>
      )}

      {!loading && snapshot && (
        <div className="rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] p-4">
          <p className="text-[10px] uppercase tracking-wider font-bold text-slate-500">
            Context Preview
          </p>
          <p className="text-xs text-slate-500 mt-1">
            This is the same context used in your dashboard (network snapshot + latest simulation).
          </p>

          <div className="mt-4">
            <DashboardMainPanel
              projectId={projectId}
              snapshot={snapshot}
              loading={false}
              error={null}
              adjustedAssetValue={null}
              simulationResults={results}
            />
          </div>
        </div>
      )}

      {/* AI Strategy Card (CTA + Result) */}
      {!loading && results && (
        <AiStrategyCard
          analysis={analysis}
          loading={aiLoading}
          error={aiError}
          onGenerate={generateAnalysis}
        />
      )}
    </div>
  );
}\n--- ./types.ts ---\n
// app/(app)/dashboard/types.ts

export type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
};

export type Dashboard = {
  id: string;
  projectId: string;
  userId: string;
  name: string;
  description?: string | null;
  isFavorite: boolean;
  layout?: any | null;
  overrides?: any | null;
  createdAt: string;
  updatedAt: string;
};\n--- ./components/ScenarioImpactCard.tsx ---\n
// app/(app)/dashboard/components/ScenarioImpactCard.tsx
"use client";

import React from "react";
import { BarChart3 } from "lucide-react";

type Props = {
  adjustedAssetValue: number | null;
};

export function ScenarioImpactCard({ adjustedAssetValue }: Props) {
  if (adjustedAssetValue == null) return null;

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-2">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <BarChart3 className="h-4 w-4 text-amber-500" />
        Scenario impact (rough illustrative)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        This uses your live scenario controls on the right (analysis horizon +
        budget level) to estimate an indicative{" "}
        <span className="font-medium">lifetime investment envelope</span>. Later
        we‚Äôll plug in full RONET logic.
      </p>
      <p className="text-lg font-semibold mt-1">
        R {(adjustedAssetValue / 1_000_000).toFixed(1)} m
      </p>
    </div>
  );
}\n--- ./components/AiInsightChip.tsx ---\n
"use client";

import React from "react";
import { Sparkles } from "lucide-react";

export function AiInsightChip({ text, loading }: { text?: string; loading: boolean }) {
  if (loading) {
    return (
      <div className="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full animate-pulse">
        <div className="w-3 h-3 bg-slate-300 dark:bg-slate-600 rounded-full" />
        <div className="w-32 h-2 bg-slate-300 dark:bg-slate-600 rounded" />
      </div>
    );
  }

  if (!text) return null;

  return (
    <div className="group relative flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-full cursor-help transition-all hover:bg-indigo-100 dark:hover:bg-indigo-900/40">
      <Sparkles className="w-3 h-3 text-indigo-600 dark:text-indigo-400 animate-pulse" />
      <span className="text-[10px] font-semibold text-indigo-700 dark:text-indigo-300 uppercase tracking-wide">
        AI Insight
      </span>
      
      {/* Tooltip Popup */}
      <div className="absolute bottom-full left-0 mb-2 w-64 p-3 bg-slate-900 text-white text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-50 pointer-events-none">
        <div className="relative z-10 font-medium leading-relaxed">
            "{text}"
        </div>
        {/* Little triangle arrow */}
        <div className="absolute -bottom-1 left-4 w-2 h-2 bg-slate-900 rotate-45" />
      </div>
    </div>
  );
}\n--- ./components/ProjectDashboardSelector.tsx ---\n
// app/(app)/dashboard/components/ProjectDashboardSelector.tsx
"use client";

import React from "react";
import { AlertTriangle, RefreshCw, Save } from "lucide-react";
import type { Dashboard, Project } from "../types";

type Props = {
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
  dashboards: Dashboard[];
  dashboardsLoading: boolean;
  dashboardsError: string | null;

  selectedProjectId: string;
  onProjectChange: (projectId: string) => void;
  selectedProject: Project | null;

  selectedDashboardId: string;
  onDashboardChange: (dashboardId: string) => void;

  snapshotLoading: boolean;
  onRefreshSnapshot: () => void;

  onSaveNew: () => void;
  onSaveExisting: () => void;
};

export function ProjectDashboardSelector({
  projects,
  projectsLoading,
  projectsError,
  dashboards,
  dashboardsLoading,
  dashboardsError,
  selectedProjectId,
  onProjectChange,
  selectedProject,
  selectedDashboardId,
  onDashboardChange,
  snapshotLoading,
  onRefreshSnapshot,
  onSaveNew,
  onSaveExisting,
}: Props) {
  return (
    <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-4">
      {/* Project row */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Project
          </p>
          <p className="text-sm font-medium">
            {selectedProject ? selectedProject.project_name : "Select a project"}
          </p>
          {selectedProject && (
            <p className="text-[11px] text-slate-500 dark:text-slate-400">
              {selectedProject.description && (
                <>
                  <span className="font-medium">Overview:</span>{" "}
                  {selectedProject.description}{" "}
                </>
              )}
              {(selectedProject.start_year || selectedProject.forecast_duration) && (
                <>
                  |
                  {selectedProject.start_year && (
                    <> Start year: {selectedProject.start_year}</>
                  )}
                  {selectedProject.forecast_duration && (
                    <> ‚Ä¢ Horizon: {selectedProject.forecast_duration} years</>
                  )}
                </>
              )}
            </p>
          )}
        </div>

        <div className="flex flex-wrap items-center gap-3">
          <select
            value={selectedProjectId}
            onChange={(e) => onProjectChange(e.target.value)}
            disabled={projectsLoading || projects.length === 0}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="" disabled>
              {projectsLoading
                ? "Loading projects‚Ä¶"
                : projects.length === 0
                ? "No projects found"
                : "Select project"}
            </option>
            {projects.map((p) => (
              <option key={p.id} value={p.id}>
                {p.project_name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={onRefreshSnapshot}
            disabled={!selectedProjectId || snapshotLoading}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
          >
            <RefreshCw className="h-3 w-3" />
            {snapshotLoading ? "Refreshing data‚Ä¶" : "Refresh data"}
          </button>
        </div>
      </div>

      {/* Dashboard selection row */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div className="flex items-center gap-2">
          <span className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Dashboard
          </span>
          <select
            value={selectedDashboardId}
            onChange={(e) => onDashboardChange(e.target.value)}
            disabled={!selectedProjectId || dashboardsLoading}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">
              {dashboardsLoading
                ? "Loading dashboards‚Ä¶"
                : dashboards.length === 0
                ? "Unsaved view"
                : "Unsaved view (current controls)"}
            </option>
            {dashboards.map((d) => (
              <option key={d.id} value={d.id}>
                {d.name}
                {d.isFavorite ? " ‚òÖ" : ""}
              </option>
            ))}
          </select>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={onSaveNew}
            disabled={!selectedProjectId}
            className="inline-flex items-center gap-1.5 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs font-medium text-white px-3 py-1.5 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Save as new dashboard
          </button>
          <button
            type="button"
            onClick={onSaveExisting}
            disabled={!selectedProjectId || !selectedDashboardId}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-200 px-3 py-1.5 hover:bg-slate-800/60 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Update selected
          </button>
        </div>
      </div>

      {(projectsError || dashboardsError) && (
        <p className="text-xs text-red-500 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          {projectsError || dashboardsError}
        </p>
      )}
    </section>
  );
}\n--- ./components/SimulationCharts.tsx ---\n
"use client";

import React from "react";
import {
  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
import { Activity, DollarSign } from "lucide-react";
import type { SimulationOutput } from "../../config/types";

type Props = {
  results: SimulationOutput | null;
};

export function SimulationCharts({ results }: Props) {
  if (!results) return null;

  return (
    <div className="grid gap-4 lg:grid-cols-2 mt-6">
      
      {/* Chart 1: Condition Over Time */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <Activity className="h-4 w-4 text-blue-500" />
            Predicted Network Condition
          </h2>
          <span className="text-[10px] text-slate-500">Average IRI (Lower is better)</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} domain={[0, 'auto']} />
              <Tooltip 
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
              />
              <Legend wrapperStyle={{ fontSize: "10px" }} />
              <Line 
                type="monotone" 
                dataKey="avg_condition_index" 
                name="Average IRI" 
                stroke="#3b82f6" 
                strokeWidth={3} 
                dot={false} 
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Chart 2: Cost Profile */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
        <h2 className="text-sm font-semibold flex items-center gap-2">
            {/* Replaced DollarSign with a styled 'R' */}
            <span className="h-4 w-4 flex items-center justify-center text-emerald-500 font-bold">
              R
            </span>
            Annual Expenditure
          </h2>
          <span className="text-[10px] text-slate-500">Maintenance Budget Needed</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis 
                stroke="#94a3b8" 
                fontSize={10} 
                tickLine={false} 
                axisLine={false}
                tickFormatter={(val) => `R${val/1000000}M`} 
              />
              <Tooltip 
                cursor={{ fill: 'transparent' }}
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
                formatter={(value: number) => [`R${(value).toLocaleString()}`, 'Cost']}
              />
              <Bar dataKey="total_maintenance_cost" name="Maintenance Cost" fill="#10b981" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

    </div>
  );
}\n--- ./components/DashboardHeader.tsx ---\n
// app/(app)/dashboard/components/DashboardHeader.tsx
"use client";

import React from "react";
import { LayoutDashboard } from "lucide-react";

export function DashboardHeader() {
  return (
    <header className="space-y-1">
      <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
        <LayoutDashboard className="h-6 w-6 text-sky-500" />
        Dashboards
      </h1>
      <p className="text-sm text-slate-500 dark:text-slate-400">
        Build presentation-ready dashboards for each project. Adjust scenario
        knobs live for board meetings, and optionally save favourite
        configurations as named dashboards.
      </p>
    </header>
  );
}\n--- ./components/AiStrategyCard.tsx ---\n
"use client";

import React from "react";
import { Sparkles, BrainCircuit, AlertTriangle, CheckCircle2, TrendingUp, Loader2 } from "lucide-react";
// Import Type only
import type { AiAnalysis } from "../hooks/useAiAdvisor";

// üëá Props now accept the state from the parent
type Props = {
    analysis: AiAnalysis | null;
    loading: boolean;
    error: string | null;
    onGenerate: () => void;
};

export function AiStrategyCard({ analysis, loading, error, onGenerate }: Props) {

  // 1. Initial State (Call to Action)
  if (!analysis && !loading) {
    return (
      <div className="mt-8 p-1 rounded-2xl bg-gradient-to-r from-slate-200 to-slate-300 dark:from-slate-800 dark:to-slate-900 shadow-sm opacity-80 hover:opacity-100 transition-opacity">
        <div className="bg-white dark:bg-slate-950 rounded-xl p-8 text-center space-y-4">
          <div className="inline-flex p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-full mb-2">
             <Sparkles className="w-6 h-6 text-indigo-600 dark:text-indigo-400" />
          </div>
          <h2 className="text-xl font-bold text-slate-900 dark:text-white">
            Unlock Strategic Insights
          </h2>
          <p className="text-sm text-slate-500 max-w-md mx-auto">
            Ready to finalize your strategy? Ask the <strong>Mosianedi AI</strong> to synthesize your simulation results into a formal Treasury motivation.
          </p>
          
          {error && <div className="text-xs text-rose-500">{error}</div>}

          <button
            onClick={onGenerate}
            className="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold text-sm hover:scale-105 transition-transform flex items-center gap-2 mx-auto shadow-lg shadow-indigo-500/30"
          >
            <BrainCircuit className="w-4 h-4" />
            Generate Final Report
          </button>
        </div>
      </div>
    );
  }

  // 2. Loading State
  if (loading) {
    return (
      <div className="mt-8 p-8 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] flex flex-col items-center justify-center text-center space-y-4 min-h-[300px]">
        <div className="relative">
            <div className="absolute inset-0 bg-indigo-500 blur-xl opacity-20 animate-pulse rounded-full" />
            <Loader2 className="w-10 h-10 text-indigo-600 dark:text-indigo-400 animate-spin relative z-10" />
        </div>
        <div>
            <h3 className="text-lg font-semibold animate-pulse">Synthesizing Strategy...</h3>
            <p className="text-xs text-slate-500 mt-1">Analyzing graphs & financial liabilities</p>
        </div>
      </div>
    );
  }

  // 3. Result State (The Report)
  return (
    <div className="mt-8 rounded-2xl border border-indigo-100 dark:border-indigo-900/50 bg-indigo-50/50 dark:bg-indigo-950/10 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-700">
      
      {/* Header */}
      <div className="bg-indigo-100/80 dark:bg-indigo-900/20 px-6 py-4 border-b border-indigo-200 dark:border-indigo-800 flex items-center justify-between">
         <div className="flex items-center gap-2">
            <Sparkles className="w-5 h-5 text-indigo-600 dark:text-indigo-400" />
            <h3 className="font-bold text-indigo-900 dark:text-indigo-200">Strategic Executive Conclusion</h3>
         </div>
         <span className="text-[10px] uppercase font-bold tracking-wider text-indigo-400 bg-white dark:bg-slate-900 px-2 py-1 rounded">
            AI Generated
         </span>
      </div>

      <div className="p-6 grid gap-6 md:grid-cols-2">
         {/* ... (Keep the rest of your display logic from previous step) ... */}
         <div className="space-y-6">
            <div>
                <h4 className="text-xs uppercase font-bold text-slate-500 mb-2">Executive Overview</h4>
                <p className="text-sm text-slate-700 dark:text-slate-300 leading-relaxed font-medium">
                    {analysis?.executive_summary}
                </p>
            </div>
            {/* ... etc ... */}
             <div className="p-4 bg-rose-50 dark:bg-rose-900/10 rounded-xl border border-rose-100 dark:border-rose-800/30">
                <h4 className="text-xs uppercase font-bold text-rose-600 dark:text-rose-400 mb-2 flex items-center gap-1">
                    <AlertTriangle className="w-3 h-3" /> Risk Analysis
                </h4>
                <p className="text-xs text-rose-800 dark:text-rose-200 leading-relaxed">
                    {analysis?.risk_analysis}
                </p>
            </div>
         </div>

         <div className="space-y-6">
            <div>
                <h4 className="text-xs uppercase font-bold text-slate-500 mb-2">Recommended Actions</h4>
                <ul className="space-y-2">
                    {analysis?.recommended_action.map((action, i) => (
                        <li key={i} className="flex items-start gap-2 text-sm text-slate-600 dark:text-slate-300 bg-white dark:bg-slate-900 p-2.5 rounded-lg border border-slate-100 dark:border-slate-800 shadow-sm">
                            <CheckCircle2 className="w-4 h-4 text-emerald-500 shrink-0 mt-0.5" />
                            {action}
                        </li>
                    ))}
                </ul>
            </div>
             <div>
                 <h4 className="text-xs uppercase font-bold text-slate-500 mb-2 flex items-center gap-1">
                    <TrendingUp className="w-3 h-3" /> Economic Context
                 </h4>
                 <p className="text-xs text-slate-500 italic">
                    "{analysis?.economic_impact}"
                 </p>
            </div>
         </div>
      </div>
    </div>
  );
}\n--- ./components/ScenarioControlsCard.tsx ---\n
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControlsCard({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (presentation only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> modify
        your underlying data. They only drive this dashboard‚Äôs story. When
        you‚Äôre happy with a configuration, save it as a named dashboard.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET runs use 20 years; adjust to explore shorter or longer
          investment horizons.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used to scale indicative figures on
          the dashboard.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {(
            [
              {
                value: "preventive" as const,
                label: "Preventive heavy",
                desc: "Prioritise good/fair roads.",
              },
              {
                value: "balanced" as const,
                label: "Balanced",
                desc: "Mix of preventive + rehab.",
              },
              {
                value: "reactive" as const,
                label: "Reactive",
                desc: "Worst-first; more backlog risk.",
              },
            ] as const
          ).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./components/ScenarioControls.tsx ---\n
// app/(app)/dashboard/components/ScenarioControls.tsx
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControls({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (live only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> change the
        underlying data ‚Äì they only drive this dashboard view. Use them during
        board presentations, and save as a named dashboard when you like the
        story.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET uses 20 years; extend or shorten for presentation
          ‚Äúwhat-if‚Äù runs.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used only for indicative dashboard
          figures.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {([
            {
              value: "preventive" as PolicyBias,
              label: "Preventive heavy",
              desc: "Prioritise good/fair roads.",
            },
            {
              value: "balanced" as PolicyBias,
              label: "Balanced",
              desc: "Mix of preventive + rehab.",
            },
            {
              value: "reactive" as PolicyBias,
              label: "Reactive",
              desc: "Worst-first, more backlog.",
            },
          ] as const).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./components/DashboardMainPanel.tsx ---\n
"use client";

import React, { useMemo } from "react";
import {
  ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, Legend, CartesianGrid,
} from "recharts";
import { TrendingUp, Activity, Coins, Map, BarChart3 } from "lucide-react";

import type { NetworkProfile } from "../../config/hooks/useNetworkSnapshot";
import type { SimulationOutput } from "../../config/types";
import { SimulationCharts } from "./SimulationCharts";

// üëá 1. Imports for AI Features
import { AiStrategyCard } from "./AiStrategyCard";
import { AiInsightChip } from "./AiInsightChip";
import { useAiAdvisor } from "../hooks/useAiAdvisor";

type Props = {
  // üëá 2. Add projectId here so TypeScript stops complaining
  projectId: string; 
  snapshot: NetworkProfile | null;
  loading: boolean;
  error: string | null;
  adjustedAssetValue: number | null; 
  simulationResults: SimulationOutput | null;
};

const SURFACE_COLOURS = ["#6366f1", "#f59e0b"]; 

function fmtCurrency(val: number) {
  if (val >= 1_000_000_000) return `R ${(val / 1_000_000_000).toFixed(1)} bn`;
  if (val >= 1_000_000) return `R ${(val / 1_000_000).toFixed(1)} m`;
  return `R ${val.toLocaleString()}`;
}

export function DashboardMainPanel({
  projectId, // üëà 3. Destructure it
  snapshot,
  loading,
  error,
  adjustedAssetValue,
  simulationResults,
}: Props) {

  // üëá 4. Initialize AI Hook here to share data with Chips and Card
  const { analysis, loading: aiLoading, error: aiError, generateAnalysis } = useAiAdvisor(projectId);
  
  // ----- Data Prep ----------------------------------------
  const surfaceMixData = useMemo(() => {
    if (!snapshot) return [];
    return [
      { name: "Paved", value: snapshot.pavedLengthKm },
      { name: "Gravel", value: snapshot.gravelLengthKm },
    ];
  }, [snapshot]);

  const assetMixData = useMemo(() => {
    if (!snapshot) return [];
    const pavedVal = snapshot.pavedLengthKm * 3_500_000;
    const gravelVal = snapshot.gravelLengthKm * 250_000;
    return [
      { name: "Paved Assets", value: pavedVal, fill: "#6366f1" },
      { name: "Gravel Assets", value: gravelVal, fill: "#f59e0b" },
    ];
  }, [snapshot]);

  // ---------------------------------------------------------

  if (loading) return <div className="p-8 text-center text-slate-500">Loading dashboard...</div>;
  if (error) return <div className="p-8 text-center text-rose-500">Error: {error}</div>;
  if (!snapshot) return <div className="p-8 text-center text-slate-500">No network data found.</div>;

  return (
    <div className="space-y-6">
      
      {/* --- ROW 1: KPI CARDS --- */}
      <div className="grid gap-4 md:grid-cols-4">
        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)]">
          <p className="text-[10px] uppercase tracking-wide text-slate-500 flex items-center gap-2">
            <Map className="w-3 h-3" /> Total Length
          </p>
          <div className="mt-2 text-2xl font-bold text-slate-900 dark:text-slate-100">
            {snapshot.totalLengthKm.toLocaleString()} <span className="text-sm font-medium text-slate-500">km</span>
          </div>
          <div className="mt-1 text-xs text-slate-400">Current Network Size</div>
        </div>

        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)]">
          <p className="text-[10px] uppercase tracking-wide text-slate-500 flex items-center gap-2">
            <Activity className="w-3 h-3" /> Network VCI
          </p>
          <div className="mt-2 text-2xl font-bold text-slate-900 dark:text-slate-100 flex items-baseline gap-2">
            {snapshot.avgVci.toFixed(1)}
            <span className={`text-xs px-1.5 py-0.5 rounded font-bold ${snapshot.avgVci < 50 ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}`}>
                {snapshot.avgVci < 50 ? 'POOR' : 'FAIR'}
            </span>
          </div>
          <div className="mt-1 text-xs text-slate-400">Weighted Average Condition</div>
        </div>

        <div className="p-4 rounded-2xl border border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] col-span-2 bg-gradient-to-br from-slate-900 to-slate-800 text-white">
          <div className="flex justify-between items-start">
             <div>
                <p className="text-[10px] uppercase tracking-wide text-slate-400 flex items-center gap-2">
                    <Coins className="w-3 h-3 text-emerald-400" /> Current Replacement Cost
                </p>
                <div className="mt-2 text-3xl font-bold">{fmtCurrency(snapshot.assetValue)}</div>
                <div className="mt-1 text-xs text-slate-400">Total Estimated Value</div>
             </div>
             {adjustedAssetValue && (
                 <div className="text-right">
                    <p className="text-[10px] text-slate-400">Scenario Adjusted</p>
                    <p className="font-mono text-emerald-400 font-bold">{fmtCurrency(adjustedAssetValue)}</p>
                 </div>
             )}
          </div>
        </div>
      </div>

      {/* --- ROW 2: VISUAL BREAKDOWNS --- */}
      <div className="grid gap-4 lg:grid-cols-2">
        <div className="p-6 rounded-2xl bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800">
          <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2">
             <BarChart3 className="w-4 h-4 text-indigo-500" />
             Network Surface Composition
          </h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={surfaceMixData} dataKey="value" nameKey="name" innerRadius={60} outerRadius={80} paddingAngle={5}>
                  {surfaceMixData.map((_, idx) => <Cell key={`cell-${idx}`} fill={SURFACE_COLOURS[idx]} />)}
                </Pie>
                <Tooltip formatter={(val: number) => `${val.toLocaleString()} km`} />
                <Legend verticalAlign="bottom" height={36}/>
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="p-6 rounded-2xl bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800">
          <h2 className="text-sm font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2">
            <TrendingUp className="w-4 h-4 text-emerald-500"/>
            Estimated Value Distribution
          </h2>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={assetMixData} layout="vertical" margin={{ left: 20 }}>
                <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                <XAxis type="number" hide />
                <YAxis dataKey="name" type="category" width={100} tick={{fontSize: 12}} />
                <Tooltip formatter={(val: number) => fmtCurrency(val)} cursor={{fill: 'transparent'}} />
                <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={32} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* --- ROW 3: SIMULATION RESULTS --- */}
      {simulationResults && (
        <div className="mt-8 pt-6 border-t border-slate-200 dark:border-slate-800">
            <div className="mb-6 flex items-center justify-between">
                <div>
                    <h2 className="text-lg font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                        <Activity className="w-5 h-5 text-indigo-500" />
                        Strategic Forecast
                    </h2>
                    <p className="text-sm text-slate-500">
                        Projected performance over the next {simulationResults.year_count} years.
                    </p>
                </div>
                {/* üëá AI INSIGHT CHIP (Condition) */}
                <AiInsightChip 
                    text={analysis?.chart_insights.condition_forecast} 
                    loading={aiLoading} 
                />
            </div>
            
            <SimulationCharts results={simulationResults} />
            
            <div className="flex justify-end mt-2">
                 {/* üëá AI INSIGHT CHIP (Budget) */}
                 <AiInsightChip 
                    text={analysis?.chart_insights.budget_impact} 
                    loading={aiLoading} 
                />
            </div>
        </div>
      )}

      {/* üëá 5. AI STRATEGY CARD (Moved to Bottom) */}
      <AiStrategyCard 
         analysis={analysis} 
         loading={aiLoading} 
         error={aiError} 
         onGenerate={generateAnalysis} 
      />
    </div>
  );
}\n--- ./hooks/useAiAdvisor.ts ---\n
"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL;

export type AiAnalysis = {
  // üëá New Section
  chart_insights: {
    condition_forecast: string;
    budget_impact: string;
  };
  // Existing Section
  executive_summary: string;
  risk_analysis: string;
  economic_impact: string;
  recommended_action: string[];
};

export function useAiAdvisor(projectId: string) {
  const [analysis, setAnalysis] = useState<AiAnalysis | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const generateAnalysis = async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/advisor/generate`,
        {
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (!res.ok) throw new Error("Failed to generate insights.");

      const data = await res.json();
      setAnalysis(data);
      
    } catch (err: any) {
      console.error(err);
      setError("AI Service Unavailable.");
    } finally {
      setLoading(false);
    }
  };

  return { analysis, loading, error, generateAnalysis };
}\n--- ./hooks/useSimulationResults.ts ---\n
"use client";

import { useState, useEffect } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import type { SimulationOutput } from "../../config/types";

export function useSimulationResults(projectId: string) {
  const [results, setResults] = useState<SimulationOutput | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let isCancelled = false;

    async function fetchResults() {
      if (!projectId) return;
      
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/latest`,
          {
            headers: { Authorization: `Bearer ${session.access_token}` },
          }
        );

        if (isCancelled) return;

        if (res.status === 404) {
            // No simulation run yet
            setResults(null); 
        } else if (res.ok) {
            const wrapper = await res.json();
            // üëá CRITICAL FIX: Unwrap the payload from the history wrapper
            // The backend returns { id: "...", results_payload: { ...data... } }
            if (wrapper && wrapper.results_payload) {
                setResults(wrapper.results_payload);
            } else {
                // Fallback in case the structure is flat (legacy) or empty
                setResults(null);
            }
        } else {
            setError("Failed to fetch results");
        }
      } catch (err: any) {
        if (!isCancelled) {
            console.error("Simulation fetch error:", err);
            setError("Network error");
        }
      } finally {
        if (!isCancelled) setLoading(false);
      }
    }

    fetchResults();

    return () => {
      isCancelled = true;
    };
  }, [projectId]);

  return { results, loading, error };
}\n--- ./hooks/useProjectDashboards.ts ---\n
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Dashboard } from "../types";

const API_BASE = process.env.NEXT_PUBLIC_API_URL;

export function useProjectDashboards(projectId: string | undefined) {
  const [dashboards, setDashboards] = useState<Dashboard[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchDashboards = useCallback(async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (!res.ok) {
        // Handle 404 silently (just empty list)
        if (res.status === 404) {
            setDashboards([]);
            return;
        }
        throw new Error("Failed to load dashboards");
      }

      const data = await res.json();
      // Map snake_case to camelCase
      const mapped: Dashboard[] = data.map((d: any) => ({
        id: d.id,
        projectId: d.project_id,
        userId: d.user_id,
        name: d.name,
        description: d.description,
        isFavorite: d.is_favorite,
        layout: d.layout,
        overrides: d.overrides,
        createdAt: d.created_at,
        updatedAt: d.updated_at,
      }));

      setDashboards(mapped);
    } catch (err: any) {
      console.error("[useProjectDashboards] error:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchDashboards();
  }, [fetchDashboards]);

  // Create Dashboard
  const createDashboard = useCallback(async (payload: {
      name: string;
      description?: string;
      overrides?: any;
      layout?: any;
      isFavorite?: boolean;
    }) => {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) throw new Error("Failed to create dashboard");
      await fetchDashboards();
  }, [projectId, fetchDashboards]);

  // Update Dashboard
  const updateDashboard = useCallback(async (
      dashboardId: string,
      payload: Partial<Dashboard>
    ) => {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards/${dashboardId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) throw new Error("Failed to update dashboard");
      await fetchDashboards();
  }, [projectId, fetchDashboards]);

  return {
    dashboards,
    loading,
    error,
    refetch: fetchDashboards,
    createDashboard,
    updateDashboard,
  };
}\n--- ./history/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import { cn } from "@/lib/utils";
import {
  ArrowLeft,
  History,
  RefreshCw,
  Calendar,
  Activity,
  Download,
  AlertTriangle,
  FileText,
} from "lucide-react";

type SimulationRun = {
  id: string;
  created_at: string;
  // simulation_results payload shape may vary; keep it flexible
  results_payload?: any;
};

function fmtDate(dt: string) {
  const d = new Date(dt);
  if (Number.isNaN(d.getTime())) return dt;
  return d.toLocaleString();
}

export default function SimulationHistoryPage() {
  const params = useParams();
  const projectId = params.projectId as string;

  const [runs, setRuns] = useState<SimulationRun[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchRuns = async () => {
    if (!projectId) return;
    setError(null);
    setLoading(true);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      // ‚úÖ Backend endpoint we assume exists (or will exist):
      // GET /api/v1/projects/{projectId}/simulation/runs
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/runs`,
        { headers: { Authorization: `Bearer ${session.access_token}` } }
      );

      if (res.status === 404) {
        setRuns([]);
        return;
      }

      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Failed to load simulation history");
      }

      const data = await res.json();

      // Accept either: [{id, created_at, results_payload}] OR something similar
      const mapped: SimulationRun[] = (Array.isArray(data) ? data : []).map((r: any) => ({
        id: r.id,
        created_at: r.created_at || r.createdAt || new Date().toISOString(),
        results_payload: r.results_payload ?? r.resultsPayload ?? r,
      }));

      setRuns(mapped);
    } catch (e: any) {
      setError(e?.message ?? "Failed to load simulation history");
      setRuns([]);
    } finally {
      setLoading(false);
    }
  };

  const onRefresh = async () => {
    setRefreshing(true);
    await fetchRuns();
    setRefreshing(false);
  };

  useEffect(() => {
    fetchRuns();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  const latest = useMemo(() => runs?.[0] ?? null, [runs]);

  return (
    <div className="space-y-6 pb-20">
      {/* HEADER */}
      <header className="flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div>
          <Link
            href={`/projects/${projectId}/dashboard`}
            className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
          >
            <ArrowLeft className="w-3 h-3" /> Back to Dashboard
          </Link>

          <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center gap-2">
            <History className="w-6 h-6 text-indigo-500" />
            Simulation History
          </h1>
          <p className="text-sm text-slate-500 mt-1">
            Review prior simulation runs for this project. Useful for audit trails and Treasury justification.
          </p>
        </div>

        <button
          onClick={onRefresh}
          disabled={refreshing}
          className={cn(
            "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border transition-colors",
            "border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800",
            "hover:bg-slate-50 dark:hover:bg-slate-700",
            "text-slate-700 dark:text-slate-200 disabled:opacity-60"
          )}
        >
          <RefreshCw className={cn("w-4 h-4", refreshing && "animate-spin")} />
          {refreshing ? "Refreshing‚Ä¶" : "Refresh"}
        </button>
      </header>

      {/* ERROR */}
      {error && (
        <div className="p-4 rounded-xl border border-rose-200 dark:border-rose-900/40 bg-rose-50 dark:bg-rose-950/20 text-rose-700 dark:text-rose-300 flex items-start gap-2">
          <AlertTriangle className="w-4 h-4 mt-0.5" />
          <div className="text-sm whitespace-pre-wrap">{error}</div>
        </div>
      )}

      {/* EMPTY */}
      {!loading && !error && runs.length === 0 && (
        <div className="p-10 rounded-2xl border-2 border-dashed border-slate-200 dark:border-slate-800 text-center">
          <div className="mx-auto w-14 h-14 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
            <Activity className="w-7 h-7 text-slate-400" />
          </div>
          <h3 className="mt-4 text-lg font-bold text-slate-900 dark:text-white">
            No simulation runs yet
          </h3>
          <p className="mt-2 text-sm text-slate-500 max-w-md mx-auto">
            Run a simulation from the Inputs page to generate a forecast. Once generated, each run will appear here.
          </p>
          <Link
            href={`/projects/${projectId}/config`}
            className="inline-flex mt-5 items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            <FileText className="w-4 h-4" />
            Go to Inputs
          </Link>
        </div>
      )}

      {/* LOADING */}
      {loading && (
        <div className="flex h-48 items-center justify-center">
          <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
        </div>
      )}

      {/* LIST */}
      {!loading && runs.length > 0 && (
        <div className="grid gap-4">
          {/* Latest highlight */}
          {latest && (
            <div className="p-5 rounded-2xl bg-gradient-to-br from-indigo-50 to-white dark:from-indigo-950/30 dark:to-slate-950 border border-indigo-100 dark:border-indigo-900/40">
              <div className="flex items-start justify-between gap-4">
                <div>
                  <p className="text-[10px] uppercase tracking-wider font-bold text-indigo-600 dark:text-indigo-300">
                    Latest run
                  </p>
                  <h3 className="mt-1 text-lg font-bold text-slate-900 dark:text-white">
                    {latest.id}
                  </h3>
                  <p className="mt-1 text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-slate-400" />
                    {fmtDate(latest.created_at)}
                  </p>
                </div>

                <button
                  type="button"
                  onClick={() => {
                    // simple export JSON
                    const blob = new Blob([JSON.stringify(latest.results_payload ?? {}, null, 2)], {
                      type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `simulation_${projectId}_${latest.id}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                  }}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200"
                >
                  <Download className="w-4 h-4" />
                  Export JSON
                </button>
              </div>
            </div>
          )}

          {/* Table-like cards */}
          <div className="overflow-hidden rounded-2xl border border-slate-200 dark:border-slate-800">
            <div className="grid grid-cols-12 gap-2 px-4 py-3 bg-slate-50 dark:bg-slate-900/40 text-[10px] uppercase tracking-wider font-bold text-slate-500">
              <div className="col-span-5">Run ID</div>
              <div className="col-span-5">Created</div>
              <div className="col-span-2 text-right">Export</div>
            </div>

            <div className="divide-y divide-slate-100 dark:divide-slate-800">
              {runs.map((r) => (
                <div key={r.id} className="grid grid-cols-12 gap-2 px-4 py-3 bg-white dark:bg-slate-950">
                  <div className="col-span-5">
                    <p className="text-sm font-semibold text-slate-900 dark:text-slate-100 truncate">
                      {r.id}
                    </p>
                  </div>
                  <div className="col-span-5">
                    <p className="text-sm text-slate-600 dark:text-slate-300">
                      {fmtDate(r.created_at)}
                    </p>
                  </div>
                  <div className="col-span-2 flex justify-end">
                    <button
                      type="button"
                      onClick={() => {
                        const blob = new Blob([JSON.stringify(r.results_payload ?? {}, null, 2)], {
                          type: "application/json",
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `simulation_${projectId}_${r.id}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                      }}
                      className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200"
                    >
                      <Download className="w-3.5 h-3.5" />
                      JSON
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <p className="text-xs text-slate-500">
            Note: This page expects a backend endpoint for run history. If you haven‚Äôt added it yet, I‚Äôll give you the FastAPI route + repo SQL next.
          </p>
        </div>
      )}
    </div>
  );
}\n--- ./page.tsx ---\n
"use client";

import React from "react";
import { useParams } from "next/navigation";
import Link from "next/link";
import { LayoutDashboard, ArrowLeft, Download, Sparkles, History } from "lucide-react";

import { useSimulationResults } from "./hooks/useSimulationResults";
import { useProjectMeta } from "../config/hooks/useProjectMeta";
import { DashboardMainPanel } from "./components/DashboardMainPanel";
import { useNetworkSnapshot } from "../config/hooks/useNetworkSnapshot";

export default function ProjectDashboardPage() {
  const params = useParams();
  const projectId = params.projectId as string;

  const { data: project } = useProjectMeta(projectId);
  const { results, loading: simLoading } = useSimulationResults(projectId);
  const { data: snapshot, loading: snapLoading } = useNetworkSnapshot(projectId);

  const isLoading = simLoading || snapLoading;

  if (isLoading) {
    return (
      <div className="flex h-64 items-center justify-center">
        <div className="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin" />
      </div>
    );
  }

  // No simulation yet
  if (!results) {
    return (
      <div className="flex flex-col items-center justify-center h-[65vh] text-center space-y-4">
        <div className="p-4 bg-slate-100 dark:bg-slate-800 rounded-full">
          <LayoutDashboard className="w-8 h-8 text-slate-400" />
        </div>

        <h2 className="text-xl font-semibold text-slate-900 dark:text-slate-100">
          No Strategy Generated
        </h2>

        <p className="text-slate-500 max-w-md">
          You haven&apos;t run a simulation for this project yet. Go to Inputs and generate a forecast first.
        </p>

        <div className="flex flex-col sm:flex-row gap-3">
          <Link
            href={`/projects/${projectId}/config`}
            className="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors"
          >
            Go to Inputs
          </Link>

          <Link
            href={`/projects/${projectId}/dashboard/advisor`}
            className="px-5 py-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 rounded-lg font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors inline-flex items-center justify-center gap-2"
            title="AI needs a simulation run first"
          >
            <Sparkles className="w-4 h-4 text-indigo-500" />
            AI Advisor (after sim)
          </Link>
        </div>
      </div>
    );
  }

  const startYear = results?.yearly_data?.[0]?.year;
  const endYear = results?.yearly_data?.[results.yearly_data.length - 1]?.year;

  return (
    <div className="space-y-6 pb-20">
      {/* HEADER */}
      <header className="flex flex-col gap-4 border-b border-slate-200 dark:border-slate-800 pb-6">
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <Link
              href={`/projects/${projectId}/config`}
              className="inline-flex items-center gap-1 text-xs font-medium text-slate-500 hover:text-indigo-600 mb-2 transition-colors"
            >
              <ArrowLeft className="w-3 h-3" /> Back to Inputs
            </Link>

            <h1 className="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100">
              {project?.project_name || "Project"} Strategy
            </h1>

            <p className="text-sm text-slate-500 flex items-center gap-2 mt-1">
              {results.year_count}-Year Forecast {startYear && endYear ? `(${startYear} - ${endYear})` : ""}
            </p>
          </div>

          {/* Primary action: Send user to report builder/share flow */}
          <Link
            href={`/projects/${projectId}/presentation/share`}
            className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors"
          >
            <Download className="w-4 h-4" />
            Compile Report
          </Link>
        </div>

        {/* Quick actions row */}
        <div className="flex flex-wrap gap-2">
          <Link
            href={`/projects/${projectId}/dashboard/advisor`}
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors"
          >
            <Sparkles className="w-3.5 h-3.5 text-indigo-500" />
            AI Advisor Insights
          </Link>

          <Link
            href={`/projects/${projectId}/dashboard/history`}
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors"
          >
            <History className="w-3.5 h-3.5 text-slate-500" />
            Simulation History
          </Link>

          <Link
            href={`/projects/${projectId}/presentation/live`}
            className="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-200 transition-colors"
          >
            <LayoutDashboard className="w-3.5 h-3.5 text-emerald-500" />
            Boardroom View
          </Link>
        </div>
      </header>

      {/* MAIN PANEL */}
      <DashboardMainPanel
        projectId={projectId}
        snapshot={snapshot}
        loading={false}
        error={null}
        adjustedAssetValue={null}
        simulationResults={results}
      />
    </div>
  );
}