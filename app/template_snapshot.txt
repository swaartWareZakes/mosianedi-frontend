\n--- ./(app)/settings/page.tsx ---\n
export default function SettingsPage() {
    return (
      <div className="space-y-4">
        <h1 className="text-xl font-semibold tracking-tight">Settings</h1>
        <p className="text-sm text-slate-500">
          App settings, units, currencies and defaults will go here.
        </p>
      </div>
    );
  }\n--- ./(app)/presentationmode/page.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { supabase } from "@/lib/supabaseClient";
import { 
  Presentation, 
  Calendar, 
  User, 
  ChevronRight, 
  GitBranch, 
  Loader2,
  Briefcase,
  Map,
  Clock,
  ArrowUpRight
} from "lucide-react";
import { cn } from "@/lib/utils";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

interface Project {
  id: string;
  project_name: string;
  description: string;
  created_at: string;
  start_year: number;
  forecast_duration: number;
}

export default function PresentationHub() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchProjects() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const res = await fetch(`${API_BASE}/api/v1/projects`, {
          headers: { Authorization: `Bearer ${session.access_token}` },
        });

        if (res.ok) {
          const data = await res.json();
          // Sort by newest first
          setProjects(data.sort((a: Project, b: Project) => 
            new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
          ));
        }
      } catch (error) {
        console.error("Failed to load projects", error);
      } finally {
        setLoading(false);
      }
    }
    fetchProjects();
  }, []);

  return (
    <div className="relative min-h-screen w-full">
      
      {/* 1. COOL BACKGROUND (Dot Pattern) */}
      <div className="absolute inset-0 -z-10 h-full w-full bg-[var(--background)] bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px] dark:bg-[radial-gradient(#1e293b_1px,transparent_1px)]">
        {/* Gradient Overlay for Fade */}
        <div className="absolute inset-0 bg-gradient-to-b from-[var(--background)] via-transparent to-transparent opacity-80" />
      </div>

      <div className="max-w-5xl mx-auto py-12 px-6">
        
        {/* Header Section */}
        <div className="mb-12 space-y-4">
          <div className="inline-flex items-center gap-2 rounded-full bg-purple-50 dark:bg-purple-900/20 px-3 py-1 text-xs font-medium text-purple-600 dark:text-purple-300 ring-1 ring-inset ring-purple-500/20">
            <Presentation className="h-3 w-3" /> Executive Suite
          </div>
          <h1 className="text-4xl font-bold tracking-tight text-[var(--foreground)]">
            Presentation Hub
          </h1>
          <p className="text-lg text-slate-500 dark:text-slate-400 max-w-2xl leading-relaxed">
            Select a strategic initiative below to configure the presentation environment. 
            Prepare your narrative, maps, and financial forecasts for the boardroom.
          </p>
        </div>

        {/* The Tree List */}
        <div className="relative border-l-2 border-slate-200 dark:border-slate-800 ml-4 space-y-10 pb-20">
          
          {loading && (
              <div className="pl-12 flex items-center gap-3 text-slate-500">
                  <div className="h-2 w-2 rounded-full bg-slate-300 animate-pulse"/>
                  <span className="text-sm font-medium">Loading your portfolio...</span>
              </div>
          )}

          {!loading && projects.length === 0 && (
              <div className="pl-12 text-slate-500">
                  <div className="p-6 border border-dashed border-slate-300 rounded-xl bg-slate-50/50">
                    No projects found. Go to Projects to create one first.
                  </div>
              </div>
          )}

          {projects.map((project) => (
            <div key={project.id} className="relative pl-10 group">
              
              {/* The "Node" Dot on the Tree Line */}
              <div className="absolute -left-[9px] top-8 h-4 w-4 rounded-full border-4 border-[var(--background)] bg-slate-300 dark:bg-slate-600 group-hover:bg-purple-500 group-hover:scale-110 transition-all duration-300 shadow-sm z-10" />

              {/* The Card */}
              <Link 
                  // üëá POINTS TO THE NEW SETUP PAGE
                  href={`/projects/${project.id}/presentation/setup`} 
                  className="block group-hover:-translate-y-1 transition-transform duration-300"
              >
                  <div className="bg-[var(--surface-bg)]/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-200/60 dark:border-slate-800 shadow-sm group-hover:shadow-xl group-hover:border-purple-500/20 transition-all">
                      
                      {/* Top Row: Title & Action */}
                      <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center gap-3">
                              <div className="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg group-hover:bg-purple-100 dark:group-hover:bg-purple-900/30 transition-colors">
                                <Briefcase className="h-5 w-5 text-slate-500 group-hover:text-purple-600 dark:group-hover:text-purple-400" />
                              </div>
                              <div>
                                <h2 className="text-lg font-bold text-[var(--foreground)] group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
                                    {project.project_name}
                                </h2>
                                <div className="flex items-center gap-2 text-xs text-slate-400 mt-0.5">
                                  <Clock className="h-3 w-3" />
                                  <span>Last modified {new Date(project.created_at).toLocaleDateString()}</span>
                                </div>
                              </div>
                          </div>
                          
                          <div className="h-8 w-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center group-hover:bg-purple-600 group-hover:text-white transition-all">
                              <ArrowUpRight className="h-4 w-4" />
                          </div>
                      </div>

                      {/* Middle: Description */}
                      <p className="text-sm text-slate-500 dark:text-slate-400 leading-relaxed pl-[52px] mb-6 line-clamp-2">
                          {project.description || "No strategic description provided for this scenario."}
                      </p>

                      {/* Bottom: Rich Metadata Grid */}
                      <div className="pl-[52px] grid grid-cols-2 md:grid-cols-4 gap-4">
                          {/* Horizon */}
                          <div className="flex flex-col">
                            <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Horizon</span>
                            <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1 flex items-center gap-1">
                              <Calendar className="h-3 w-3" />
                              {project.start_year} - {project.start_year + (project.forecast_duration || 20)}
                            </span>
                          </div>

                          {/* Duration */}
                          <div className="flex flex-col">
                            <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Duration</span>
                            <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1">
                              {project.forecast_duration || 20} Years
                            </span>
                          </div>

                          {/* Assets (Placeholder for now, implies dashboard data) */}
                          <div className="flex flex-col">
                            <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Network</span>
                            <span className="text-xs font-mono text-slate-600 dark:text-slate-300 mt-1 flex items-center gap-1">
                              <Map className="h-3 w-3" />
                              Full Coverage
                            </span>
                          </div>

                          {/* Status */}
                          <div className="flex flex-col">
                            <span className="text-[10px] uppercase text-slate-400 font-semibold tracking-wider">Status</span>
                            <span className="inline-flex w-fit items-center rounded-md bg-emerald-50 px-2 py-1 text-xs font-medium text-emerald-700 ring-1 ring-inset ring-emerald-600/20 dark:bg-emerald-900/20 dark:text-emerald-400">
                              Ready
                            </span>
                          </div>
                      </div>
                  </div>
              </Link>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./(app)/projects/ProjectCreateForm.tsx ---\n
/* --- app/(app)/projects/ProjectCreateForm.tsx --- */
"use client";

import React, { useState } from "react";
import { useRouter } from "next/navigation";
import { NewProject } from "@/types/project"; 
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config"; // <-- IMPORT THIS

// USE THE IMPORTED CONFIG
const PROJECTS_ENDPOINT = `${API_BASE_URL}/api/v1/projects`; 
const getCurrentYear = () => new Date().getFullYear();

export function ProjectCreateForm({ onClose }: { onClose: (success: boolean) => void }) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  // State to handle redirect after modal closes
  const [redirectUrl, setRedirectUrl] = useState<string | null>(null);

  const [project, setProject] = useState<NewProject>({
    project_name: "",
    description: "",
    start_year: getCurrentYear(),
    forecast_duration: 5,
    discount_rate: 8.0,
  });

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    const { name, value } = e.target;
    setProject((prev) => ({
      ...prev,
      [name]:
        name === "start_year" || name === "forecast_duration"
          ? parseInt(value) || 0
          : name === "discount_rate"
          ? parseFloat(value) || 0
          : value,
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setErrorMsg(null);
    setLoading(true);

    let success = false;
    let newRedirectUrl: string | null = null;

    try {
        const { data: { session } } = await supabase.auth.getSession(); 
        const token = session?.access_token;

        if (!token) {
             throw new Error("User session expired or unauthorized.");
        }
        
        // USE THE CENTRALIZED ENDPOINT
        const response = await fetch(PROJECTS_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(project),
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || `API error: ${response.status}`);
        }

        // Success: Prepare redirect URL
        const newProjectId = data.project_id;
        newRedirectUrl = `/projects/${newProjectId}/config`;
        success = true;
        
    } catch (err) {
        console.error("Project Creation Failed:", err);
        const msg = err instanceof Error ? err.message : 'Unknown error';
        setErrorMsg(`Failed to create project: ${msg}`);
        success = false; 
        newRedirectUrl = null;
    } finally {
        setLoading(false);
        setRedirectUrl(newRedirectUrl);
        onClose(success); // Signal parent to close modal and refresh list
        
        // Perform redirect ensuring state updates don't conflict with unmounting
        if (success && newRedirectUrl) {
             router.push(newRedirectUrl);
        }
    }
  };

  return (
    <div className="bg-[var(--surface-bg)] rounded-2xl p-6 shadow-xl">
        <h2 className="text-xl font-semibold text-[var(--foreground)] mb-2">Create New Project Scenario</h2>
        <p className="text-sm text-slate-500 dark:text-slate-400 mb-6">
            Define the scope and planning horizon for your road investment simulation.
        </p>

        <form onSubmit={handleSubmit} className="space-y-4">
            {/* Project Name */}
            <div>
                <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                    Project Name
                </label>
                <input
                    type="text"
                    name="project_name"
                    required
                    value={project.project_name}
                    onChange={handleChange}
                    className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2 text-sm text-[var(--input-text)] focus:border-sky-500 focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
                    placeholder="e.g., 5-Year National Road Maintenance"
                />
            </div>
            
            {/* Description */}
            <div>
                <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                    Description / Scope
                </label>
                <textarea
                    name="description"
                    rows={3}
                    required
                    value={project.description}
                    onChange={handleChange}
                    className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2 text-sm text-[var(--input-text)] focus:border-sky-500 focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
                    placeholder="Justify this simulation and outline key assumptions."
                />
            </div>

            {/* Start Year / Duration / Discount Rate */}
            <div className="grid grid-cols-3 gap-4">
                <div>
                    <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                        Start Year
                    </label>
                    <input
                        type="number"
                        name="start_year"
                        required
                        value={project.start_year}
                        onChange={handleChange}
                        className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2 text-sm text-[var(--input-text)] focus:border-sky-500 focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
                    />
                </div>
                <div>
                    <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                        Duration (Years)
                    </label>
                    <input
                        type="number"
                        name="forecast_duration"
                        required
                        min={1}
                        max={30}
                        value={project.forecast_duration}
                        onChange={handleChange}
                        className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2 text-sm text-[var(--input-text)] focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
                    />
                </div>
                <div>
                    <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
                        Discount Rate (%)
                    </label>
                    <input
                        type="number"
                        name="discount_rate"
                        required
                        step="0.1"
                        min="0"
                        max="100"
                        value={project.discount_rate}
                        onChange={handleChange}
                        className="w-full rounded-xl border border-slate-300 bg-[var(--input-bg)] px-3 py-2 text-sm text-[var(--input-text)] focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100 dark:border-slate-700 dark:focus:ring-sky-800/40"
                    />
                </div>
            </div>

            {errorMsg && (
                <p className="text-xs text-red-500">{errorMsg}</p>
            )}

            <div className="flex justify-end space-x-3 pt-2">
                <button
                    type="button"
                    onClick={() => onClose(false)}
                    className="px-4 py-2 text-sm font-medium text-slate-500 hover:text-[var(--foreground)] transition-colors"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    disabled={loading}
                    className="rounded-xl bg-[var(--accent-color)] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:brightness-110 disabled:opacity-70 transition"
                >
                    {loading ? "Creating..." : "Create Project"}
                </button>
            </div>
        </form>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/config/types.ts ---\n
// app/(app)/projects/[projectId]/config/types.ts

// High-level upload status that the UI understands
export type UploadStatus = "success" | "processing" | "failed" | "none";

// Shape of the ‚Äúlast upload‚Äù that we show in the status card
export interface LastUpload {
  id?: string;
  project_id: string;
  file_name: string | null;
  status: UploadStatus;
  row_count?: number | null;
  uploaded_at: string | null;

  // Extra metadata from backend
  validation_errors?: Record<string, any> | null;
  original_filename?: string | null;
}

// Response from /master-data/preview
export interface PreviewResponse {
  preview_data: Record<string, any>[]; // array of row objects
  total_rows: number;
  columns: string[];
}

// (For future ‚Äúhistory‚Äù view ‚Äì list of past uploads)
export interface UploadHistoryItem {
  id: string;
  project_id: string;
  user_id: string;
  original_filename: string | null;
  mime_type: string | null;
  file_size: number | null;
  status: string | null;
  row_count: number | null;
  validation_errors?: Record<string, any> | null;
  created_at: string | null;
}

// --- NEW: Scenario & Parameters Types ---

export type BudgetStrategy = "unconstrained" | "fixed_limit" | "percent_baseline";
export type PolicyBias = "preventive" | "balanced" | "reactive";

export interface RonetParameters {
  analysis_duration: number; // 5-30
  budget_strategy: BudgetStrategy;
  annual_budget_cap: number | null;
  budget_percent_baseline: number; // 50-150
  policy_bias: PolicyBias;
  discount_rate: number;
}

export interface Scenario {
  id: string;
  project_id: string;
  name: string;
  description: string | null;
  is_baseline: boolean;
  parameters: RonetParameters;
  created_at: string;
  updated_at: string;
}


export interface YearlyResult {
  year: number;
  avg_condition_index: number;
  pct_good: number;
  pct_fair: number;
  pct_poor: number;
  total_maintenance_cost: number;
  asset_value: number;
}

export interface SimulationOutput {
  project_id: string;
  scenario_id: string;
  year_count: number;
  yearly_data: YearlyResult[];
  total_cost_npv: number;
  final_network_condition: number;
}\n--- ./(app)/projects/[projectId]/config/components/RunSimulationCard.tsx ---\n
"use client";

import React from "react";
import Link from "next/link";
import { Play, Loader2, BarChart3, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import { useSimulationRun } from "../hooks/useSimulationRun";

export function RunSimulationCard({ projectId }: { projectId: string }) {
  const { runSimulation, isRunning, error, result } = useSimulationRun(projectId);

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold flex items-center gap-2">
          <Play className="h-5 w-5 text-emerald-600 dark:text-emerald-400" />
          3. Run Simulation
        </h2>
      </div>

      <p className="text-sm text-slate-500 dark:text-slate-400 mb-6">
        Combine your <strong>Master Data</strong> with the{" "}
        <strong>Scenario Assumptions</strong> to forecast network performance over
        the analysis period.
      </p>

      {error && (
        <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 rounded-lg text-sm flex items-center gap-2">
          <AlertTriangle className="h-4 w-4" /> {error}
        </div>
      )}

      <div className="flex items-center gap-4">
        <button
          onClick={runSimulation}
          disabled={isRunning}
          className={cn(
            "inline-flex items-center gap-2 rounded-xl px-6 py-3 text-sm font-semibold text-white shadow-sm transition",
            isRunning
              ? "bg-emerald-700 cursor-wait"
              : "bg-emerald-600 hover:bg-emerald-700",
            "disabled:opacity-50 disabled:cursor-not-allowed"
          )}
        >
          {isRunning ? (
            <Loader2 className="h-4 w-4 animate-spin" />
          ) : (
            <Play className="h-4 w-4" />
          )}
          {isRunning ? "Running Engine..." : "Calculate Scenario"}
        </button>
      </div>

      {/* Quick Results Preview */}
      {result && (
        <div className="mt-6 p-4 border border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800/50">
          <h3 className="text-sm font-semibold mb-3 flex items-center gap-2 text-slate-700 dark:text-slate-200">
            <BarChart3 className="h-4 w-4 text-sky-500" />
            Simulation Successful
          </h3>
          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>
              <p className="text-[10px] uppercase tracking-wide text-slate-500">
                Total NPV Cost
              </p>
              <p className="font-mono font-medium text-lg text-[var(--foreground)]">
                {(result.total_cost_npv / 1_000_000).toFixed(1)} M
              </p>
            </div>
            <div>
              <p className="text-[10px] uppercase tracking-wide text-slate-500">
                Final Avg IRI
              </p>
              <p className="font-mono font-medium text-lg text-[var(--foreground)]">
                {result.final_network_condition.toFixed(2)}
              </p>
            </div>
          </div>
          <div className="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700">
            <Link
              href={`/projects/${projectId}/dashboard`}
              className="text-xs font-medium text-[var(--accent-color)] hover:underline flex items-center gap-1"
            >
              Go to Dashboard &rarr;
            </Link>
          </div>
        </div>
      )}
    </div>
  );
}\n--- ./(app)/projects/[projectId]/config/components/UploadStatusCard.tsx ---\n
// app/(app)/projects/[projectId]/config/components/UploadStatusCard.tsx
"use client";

import React from "react";
import { CheckCircle, AlertTriangle, Clock, Table } from "lucide-react";
import { cn } from "@/lib/utils";
import type { LastUpload, UploadStatus } from "../types";

interface UploadStatusCardProps {
  // current / selected upload
  lastUpload: LastUpload | null;

  // loading + error for the "last upload" / status fetch
  statusLoading: boolean;
  statusError: string | null;

  // optional: full history of uploads for dropdown
  uploadsHistory?: LastUpload[];
  historyLoading?: boolean;
  historyError?: string | null;

  // which upload ID is selected in the dropdown
  selectedUploadId?: string | null;

  // preview state
  previewLoading: boolean;

  // handlers
  onPreview: (uploadId?: string) => void;
  onSelectUpload?: (uploadId: string) => void;
}

function statusColorFromStatus(status: UploadStatus | undefined): string {
  if (status === "success") return "bg-green-500";
  if (status === "processing") return "bg-amber-400";
  if (status === "failed") return "bg-red-500";
  return "bg-slate-300";
}

function statusLabelFromStatus(
  status: UploadStatus | undefined,
  statusLoading: boolean
): string {
  if (status === "success") return "Last upload OK";
  if (status === "processing") return "Upload processing";
  if (status === "failed") return "Last upload failed";
  if (statusLoading) return "Checking status‚Ä¶";
  return "No data uploaded yet";
}

function statusIconFromStatus(status: UploadStatus | undefined) {
  if (status === "success") return CheckCircle;
  if (status === "processing") return Clock;
  if (status === "failed") return AlertTriangle;
  return Clock;
}

function formatTimestamp(iso?: string | null): string {
  if (!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("en-ZA", {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  });
}

export const UploadStatusCard: React.FC<UploadStatusCardProps> = ({
  lastUpload,
  statusLoading,
  statusError,
  uploadsHistory,
  historyLoading,
  historyError,
  selectedUploadId,
  previewLoading,
  onPreview,
  onSelectUpload,
}) => {
  const status = lastUpload?.status;
  const StatusIcon = statusIconFromStatus(status);
  const statusColor = statusColorFromStatus(status);
  const statusLabel = statusLabelFromStatus(status, statusLoading);

  const hasHistoryDropdown =
    uploadsHistory && uploadsHistory.length > 1 && !!onSelectUpload;

  const effectiveSelectedId =
    selectedUploadId || lastUpload?.id || (uploadsHistory?.[0]?.id ?? "");

  const canPreview =
    !!lastUpload && lastUpload.status === "success" && !previewLoading;

  const handlePreviewClick = () => {
    if (!lastUpload?.id) return;
    onPreview(lastUpload.id);
  };

  const handleSelectChange = (
    e: React.ChangeEvent<HTMLSelectElement>
  ): void => {
    const newId = e.target.value;
    if (onSelectUpload && newId) {
      onSelectUpload(newId);
    }
  };

  return (
    <div className="min-w-[260px]">
      <div className="rounded-xl border border-slate-200/40 dark:border-slate-800/60 px-3 py-2 text-xs bg-white/60 dark:bg-slate-900/40 shadow-sm">
        {/* Top row: status dot + label */}
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2">
            <span
              className={cn(
                "h-2.5 w-2.5 rounded-full shadow-sm",
                statusColor
              )}
            />
            <span className="font-semibold text-slate-800 dark:text-slate-100">
              {statusLabel}
            </span>
          </div>
          <StatusIcon className="h-3.5 w-3.5 text-slate-400" />
        </div>

        {/* History dropdown (optional) */}
        {hasHistoryDropdown && (
          <div className="mt-2">
            <label className="block text-[10px] mb-1 text-slate-500 dark:text-slate-400">
              Upload history
            </label>
            <select
              className={cn(
                "w-full rounded-lg border border-slate-300 dark:border-slate-700",
                "bg-white/80 dark:bg-slate-900/60",
                "px-2 py-1 text-[10px] focus:outline-none focus:ring-1 focus:ring-slate-400"
              )}
              value={effectiveSelectedId}
              onChange={handleSelectChange}
              disabled={!!historyLoading}
            >
              {uploadsHistory!.map((u) => (
                <option key={u.id} value={u.id ?? ""}>
                  {u.file_name || u.original_filename || "Untitled file"} ‚Ä¢{" "}
                  {formatTimestamp(u.uploaded_at)} ‚Ä¢{" "}
                  {typeof u.row_count === "number"
                    ? `${u.row_count} rows`
                    : "rows ?"}
                </option>
              ))}
            </select>
          </div>
        )}

        <div className="mt-1 space-y-0.5 text-[10px] text-slate-500 dark:text-slate-400">
          {/* Error messages */}
          {statusError && (
            <div className="text-red-500 text-[10px]">{statusError}</div>
          )}
          {historyError && (
            <div className="text-red-500 text-[10px]">{historyError}</div>
          )}

          {/* Last upload details */}
          {lastUpload ? (
            <>
              <div className="truncate">
                File:{" "}
                <span className="font-medium">
                  {lastUpload.file_name ||
                    lastUpload.original_filename ||
                    "‚Äî"}
                </span>
              </div>
              <div>
                When:{" "}
                <span className="font-medium">
                  {formatTimestamp(lastUpload.uploaded_at)}
                </span>
              </div>
              {typeof lastUpload.row_count === "number" && (
                <div>Rows: {lastUpload.row_count}</div>
              )}

              {/* Validation errors summary (if failed) */}
              {lastUpload.status === "failed" &&
                lastUpload.validation_errors && (
                  <div className="mt-1 text-[10px] text-red-500">
                    Validation errors detected. Check missing columns or file
                    format.
                  </div>
                )}
            </>
          ) : !statusError && !statusLoading ? (
            <div>No uploads yet for this project.</div>
          ) : null}
        </div>

        {/* View data button */}
        <div className="mt-2 flex justify-end">
          <button
            type="button"
            disabled={!canPreview}
            onClick={handlePreviewClick}
            className={cn(
              "inline-flex items-center gap-1 rounded-lg px-2.5 py-1 text-[10px] font-medium border",
              "border-slate-300 dark:border-slate-700",
              "text-slate-700 dark:text-slate-200",
              "disabled:opacity-50 disabled:cursor-not-allowed"
            )}
          >
            <Table className="h-3 w-3" />
            {previewLoading ? "Loading‚Ä¶" : "View data"}
          </button>
        </div>
      </div>
    </div>
  );
};\n--- ./(app)/projects/[projectId]/config/components/DataPreviewTable.tsx ---\n
// app/(app)/projects/[projectId]/config/components/DataPreviewTable.tsx
"use client";

import React from "react";
import { Table as TableIcon } from "lucide-react";
import type { PreviewResponse } from "../types";

type DataPreviewTableProps = {
  preview: PreviewResponse;
};

export const DataPreviewTable: React.FC<DataPreviewTableProps> = ({
  preview,
}) => {
  const { preview_data, total_rows, columns } = preview;
  const shownCount = preview_data.length;

  return (
    <div className="mt-6 text-xs">
      {/* Header row */}
      <div className="mb-2 flex items-center justify-between">
        <div className="font-semibold flex items-center gap-2">
          <TableIcon className="h-3.5 w-3.5" />
          <span>Master data preview</span>
        </div>
        <div className="text-[10px] text-slate-500 dark:text-slate-400">
          Showing{" "}
          <span className="font-medium">
            {shownCount.toLocaleString("en-ZA")}
          </span>{" "}
          of{" "}
          <span className="font-medium">
            {total_rows.toLocaleString("en-ZA")}
          </span>{" "}
          rows
        </div>
      </div>

      {/* Table */}
      <div className="overflow-auto max-h-64 border border-slate-200 dark:border-slate-700 rounded-lg">
        <table className="min-w-full text-[11px]">
          <thead className="bg-slate-50 dark:bg-slate-800">
            <tr>
              {columns.map((col) => (
                <th
                  key={col}
                  className="px-2 py-1 text-left font-semibold whitespace-nowrap"
                >
                  {col}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {preview_data.map((row, i) => (
              <tr
                key={i}
                className={
                  i % 2 === 0
                    ? ""
                    : "bg-slate-50/60 dark:bg-slate-900/30"
                }
              >
                {columns.map((col) => {
                  const value = (row as Record<string, any>)[col];
                  const display =
                    value === null || value === undefined || value === ""
                      ? "‚Äî"
                      : String(value);

                  return (
                    <td
                      key={col}
                      className="px-2 py-1 whitespace-nowrap max-w-[160px] truncate"
                      title={display === "‚Äî" ? "" : display}
                    >
                      {display}
                    </td>
                  );
                })}
              </tr>
            ))}

            {preview_data.length === 0 && (
              <tr>
                <td
                  colSpan={columns.length || 1}
                  className="px-2 py-3 text-center text-[11px] text-slate-500"
                >
                  No rows available in preview.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};\n--- ./(app)/projects/[projectId]/config/components/ScenarioAssumptionsCard.tsx ---\n
"use client";

import React from "react";
import { Zap, Save } from "lucide-react";
import { cn } from "@/lib/utils";
import { useScenarioAssumptions } from "../hooks/useScenarioAssumptions";

export function ScenarioAssumptionsCard({ projectId }: { projectId: string }) {
  const { parameters, loading, isSaving, updateParameter } =
    useScenarioAssumptions(projectId);

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4 relative">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold flex items-center gap-2">
          <Zap className="h-5 w-5 text-yellow-600 dark:text-yellow-400" />
          2. Scenario Assumptions
        </h2>
        {/* Saving Indicator */}
        <div className="h-4 flex items-center">
          {isSaving && (
            <span className="text-[10px] text-slate-400 flex items-center gap-1">
              <Save className="h-3 w-3 animate-pulse" /> Saving...
            </span>
          )}
        </div>
      </div>

      {loading || !parameters ? (
        <div className="py-8 text-center text-xs text-slate-500 dark:text-slate-400">
          Loading default assumptions...
        </div>
      ) : (
        <>
          <p className="text-xs text-slate-500 dark:text-slate-400">
            Configure the high-level assumptions. Changes serve as the "Baseline".
          </p>

          {/* 1. Analysis Period */}
          <div className="space-y-1">
            <div className="flex items-center justify-between text-xs">
              <span className="font-medium text-slate-700 dark:text-slate-200">
                Analysis period
              </span>
              <span className="text-slate-500 dark:text-slate-400">
                {parameters.analysis_duration} years
              </span>
            </div>
            <input
              type="range"
              min={5}
              max={30}
              step={1}
              value={parameters.analysis_duration}
              onChange={(e) =>
                updateParameter("analysis_duration", Number(e.target.value))
              }
              className="w-full accent-[var(--accent-color)] cursor-pointer"
            />
            <p className="text-[10px] text-slate-500 dark:text-slate-400">
              Typical RONET analyses use 20 years.
            </p>
          </div>

          {/* 2. Budget Level */}
          <div className="space-y-1">
            <div className="flex items-center justify-between text-xs">
              <span className="font-medium text-slate-700 dark:text-slate-200">
                Annual budget level
              </span>
              <span className="text-slate-500 dark:text-slate-400">
                {parameters.budget_percent_baseline}% of required
              </span>
            </div>
            <input
              type="range"
              min={50}
              max={150}
              step={5}
              value={parameters.budget_percent_baseline}
              onChange={(e) =>
                updateParameter(
                  "budget_percent_baseline",
                  Number(e.target.value)
                )
              }
              className="w-full accent-[var(--accent-color)] cursor-pointer"
            />
            <div className="flex justify-between text-[10px] text-slate-400 px-1">
              <span>Constraint</span>
              <span>Baseline</span>
              <span>Growth</span>
            </div>
          </div>

          {/* 3. Policy Bias */}
          <div className="space-y-2 pt-2">
            <p className="text-xs font-medium text-slate-700 dark:text-slate-200">
              Maintenance policy bias
            </p>
            <div className="flex flex-wrap gap-2">
              {(
                [
                  {
                    value: "preventive",
                    label: "Preventive",
                    desc: "Fix good roads first",
                  },
                  {
                    value: "balanced",
                    label: "Balanced",
                    desc: "Optimal mix",
                  },
                  {
                    value: "reactive",
                    label: "Reactive",
                    desc: "Fix worst first",
                  },
                ] as const
              ).map((option) => (
                <button
                  key={option.value}
                  type="button"
                  onClick={() => updateParameter("policy_bias", option.value)}
                  className={cn(
                    "flex-1 min-w-[80px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                    parameters.policy_bias === option.value
                      ? "border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-900 dark:text-yellow-100"
                      : "border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/60 text-slate-600 dark:text-slate-200"
                  )}
                >
                  <div className="font-semibold">{option.label}</div>
                  <div className="text-[9px] opacity-80 leading-tight mt-0.5">
                    {option.desc}
                  </div>
                </button>
              ))}
            </div>
          </div>
        </>
      )}
    </div>
  );
}\n--- ./(app)/projects/[projectId]/config/components/NetworkSnapshotCard.tsx ---\n
"use client";

import React from "react";
import { Map, RefreshCw, AlertTriangle } from "lucide-react";
import { cn } from "@/lib/utils";
import { useNetworkSnapshot } from "../hooks/useNetworkSnapshot";

export function NetworkSnapshotCard({ projectId }: { projectId: string }) {
  const { snapshot, loading, error, refetch } = useNetworkSnapshot(projectId);

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <div className="flex items-center justify-between gap-3">
        <h2 className="text-lg font-semibold flex items-center gap-2">
          <Map className="h-5 w-5 text-sky-600 dark:text-sky-400" />
          Network Snapshot
        </h2>
        <button
          type="button"
          onClick={refetch}
          disabled={loading}
          className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-50"
        >
          <RefreshCw className={cn("h-3 w-3", loading && "animate-spin")} />
          {loading ? "Refreshing..." : "Refresh"}
        </button>
      </div>

      {!loading && error && (
        <div className="flex items-start gap-2 text-xs text-red-500">
          <AlertTriangle className="h-4 w-4 mt-0.5" />
          <span>{error}</span>
        </div>
      )}

      {!loading && !error && !snapshot && (
        <p className="text-xs text-slate-500 dark:text-slate-400">
          No snapshot available yet.
        </p>
      )}

      {!loading && snapshot && (
        <div className="space-y-4 text-sm">
          <div className="grid grid-cols-2 gap-4">
            <div className="rounded-xl bg-slate-50 dark:bg-slate-900/40 px-3 py-2.5">
              <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Total Network
              </p>
              <p className="mt-1 text-lg font-semibold">
                {snapshot.totalLengthKm.toLocaleString()} km
              </p>
              <p className="mt-0.5 text-[11px] text-slate-500 dark:text-slate-400">
                Segments: {snapshot.totalSegments.toLocaleString()}
              </p>
            </div>
            <div className="rounded-xl bg-slate-50 dark:bg-slate-900/40 px-3 py-2.5">
              <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Surface Mix
              </p>
              <p className="mt-1 text-sm font-medium">
                {snapshot.pavedLengthKm.toLocaleString()} paved
              </p>
              <p className="text-sm font-medium text-slate-500 dark:text-slate-400">
                {snapshot.gravelLengthKm.toLocaleString()} gravel
              </p>
            </div>
          </div>
          {/* Condition Bars */}
          <div>
            <div className="flex justify-between text-[10px] text-slate-500 dark:text-slate-400 mb-1">
              <span>Condition Split (Approx)</span>
              <span>Good / Fair / Poor</span>
            </div>
            <div className="h-2 flex rounded-full overflow-hidden w-full bg-slate-200 dark:bg-slate-800">
              <div
                className="bg-emerald-500"
                style={{ width: `${snapshot.goodConditionPct}%` }}
              />
              <div
                className="bg-amber-500"
                style={{ width: `${snapshot.fairConditionPct}%` }}
              />
              <div
                className="bg-rose-500"
                style={{ width: `${snapshot.poorConditionPct}%` }}
              />
            </div>
            <div className="mt-1 flex justify-between text-[10px] font-medium">
              <span className="text-emerald-600 dark:text-emerald-400">
                {snapshot.goodConditionPct.toFixed(0)}%
              </span>
              <span className="text-amber-600 dark:text-amber-400">
                {snapshot.fairConditionPct.toFixed(0)}%
              </span>
              <span className="text-rose-600 dark:text-rose-400">
                {snapshot.poorConditionPct.toFixed(0)}%
              </span>
            </div>
          </div>

          <p className="text-[10px] text-slate-500 dark:text-slate-500">
            Snapshot calculated at{" "}
            <span className="font-mono">
              {snapshot.calculatedAt
                ? new Date(snapshot.calculatedAt).toLocaleString("en-ZA")
                : "Unknown"}
            </span>
          </p>
        </div>
      )}
    </div>
  );
}\n--- ./(app)/projects/[projectId]/config/hooks/useSimulationRun.ts ---\n
// app/(app)/projects/[projectId]/config/hooks/useSimulationRun.ts
"use client";

import { useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import { SimulationOutput } from "../types";

export function useSimulationRun(projectId: string) {
  const [result, setResult] = useState<SimulationOutput | null>(null);
  const [isRunning, setIsRunning] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const runSimulation = async () => {
    setIsRunning(true);
    setError(null);
    setResult(null);

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error("Not authenticated");

      // Trigger the calculation engine
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/run`,
        {
          method: "POST",
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || "Simulation run failed.");
      }

      const data: SimulationOutput = await res.json();
      setResult(data);
      
    } catch (err: any) {
      console.error("Simulation error:", err);
      setError(err.message || "An unexpected error occurred.");
    } finally {
      setIsRunning(false);
    }
  };

  return {
    runSimulation,
    isRunning,
    error,
    result
  };
}\n--- ./(app)/projects/[projectId]/config/hooks/useScenarioAssumptions.ts ---\n
// app/(app)/projects/[projectId]/config/hooks/useScenarioAssumptions.ts
"use client";

import { useState, useEffect, useRef, useCallback } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import { Scenario, RonetParameters } from "../types";

export function useScenarioAssumptions(projectId: string) {
  const [scenario, setScenario] = useState<Scenario | null>(null);
  const [loading, setLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [lastSavedAt, setLastSavedAt] = useState<Date | null>(null);

  // We keep a ref for the debounce timer
  const saveTimeoutRef = useRef<NodeJS.Timeout | null>(null);

  // 1. Fetch Baseline on Mount
  const fetchBaseline = useCallback(async () => {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/scenarios/baseline`,
        {
          headers: { Authorization: `Bearer ${session.access_token}` },
        }
      );

      if (res.ok) {
        const data: Scenario = await res.json();
        setScenario(data);
      } else {
        console.error("Failed to fetch baseline scenario");
      }
    } catch (err) {
      console.error("Error fetching baseline:", err);
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    if (projectId) fetchBaseline();
  }, [fetchBaseline, projectId]);

  // 2. Update Function (Optimistic UI + Debounced Save)
  const updateParameter = (key: keyof RonetParameters, value: any) => {
    if (!scenario) return;

    // A. Optimistic Update (Instant UI feedback)
    const updatedParams = { ...scenario.parameters, [key]: value };
    const updatedScenario = { ...scenario, parameters: updatedParams };
    setScenario(updatedScenario);
    setIsSaving(true);

    // B. Debounced API Call
    if (saveTimeoutRef.current) {
      clearTimeout(saveTimeoutRef.current);
    }

    saveTimeoutRef.current = setTimeout(async () => {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        // Backend expects { parameters: { ... } } inside the payload
        const payload = {
            parameters: updatedParams 
        };

        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/scenarios/${scenario.id}`,
          {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${session.access_token}`,
            },
            body: JSON.stringify(payload),
          }
        );

        if (!res.ok) {
            console.error("Failed to save scenario parameters");
            // Optional: Revert state here if critical
        } else {
            setLastSavedAt(new Date());
        }
      } catch (err) {
        console.error("Error saving scenario:", err);
      } finally {
        setIsSaving(false);
      }
    }, 600); // Wait 600ms after last change before sending
  };

  return {
    scenario,
    parameters: scenario?.parameters,
    loading,
    isSaving,
    lastSavedAt,
    updateParameter,
  };
}\n--- ./(app)/projects/[projectId]/config/hooks/useMasterDataUpload.ts ---\n
// app/(app)/projects/[projectId]/config/hooks/useMasterDataUpload.ts
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
// üëá IMPORT THE CENTRAL CONFIG
import { API_BASE_URL } from "@/lib/config";
import type { LastUpload, PreviewResponse, UploadStatus } from "../types";

/**
 * Map whatever the API gives us to our UI status.
 * Handles things like "validated", "ready", "failed", etc.
 */
function mapApiStatusToUiStatus(
  rawStatus: string | null | undefined,
  rowCount?: number | null
): UploadStatus {
  const s = rawStatus?.toLowerCase();

  if (s === "success" || s === "validated" || s === "ready") {
    return "success";
  }

  if (s === "processing" || s === "uploading" || s === "pending") {
    return "processing";
  }

  if (
    s === "failed" ||
    s === "validation_failed" ||
    s === "error" ||
    s === "invalid"
  ) {
    return "failed";
  }

  // Fallback: if we clearly have rows, treat as success
  if (typeof rowCount === "number" && rowCount > 0) {
    return "success";
  }

  return "none";
}

export function useMasterDataUpload(projectId: string) {
  // -------------------------------------------------------------
  // File + upload state
  // -------------------------------------------------------------
  const [file, setFile] = useState<File | null>(null);
  const [status, setStatus] = useState<
    "idle" | "uploading" | "processing" | "ready"
  >("idle");
  const [error, setError] = useState<string | null>(null);

  // -------------------------------------------------------------
  // Last-upload + history
  // -------------------------------------------------------------
  const [lastUpload, setLastUpload] = useState<LastUpload | null>(null);
  const [statusLoading, setStatusLoading] = useState(false);
  const [statusError, setStatusError] = useState<string | null>(null);

  const [uploadsHistory, setUploadsHistory] = useState<LastUpload[]>([]);
  const [historyLoading, setHistoryLoading] = useState(false);
  const [historyError, setHistoryError] = useState<string | null>(null);

  // Which upload is currently selected in the dropdown
  const [selectedUploadId, setSelectedUploadId] = useState<string | null>(null);

  // -------------------------------------------------------------
  // Preview
  // -------------------------------------------------------------
  const [preview, setPreview] = useState<PreviewResponse | null>(null);
  const [previewLoading, setPreviewLoading] = useState(false);
  const [previewError, setPreviewError] = useState<string | null>(null);

  const isUploading = status === "uploading" || status === "processing";
  const isReady = status === "ready";

  // -------------------------------------------------------------
  // Auth helper
  // -------------------------------------------------------------
  const getAuthToken = async () => {
    const {
      data: { session },
    } = await supabase.auth.getSession();
    return session?.access_token;
  };

  // -------------------------------------------------------------
  // Preview fetcher (by upload ID)
  // -------------------------------------------------------------
  const fetchPreview = useCallback(
    async (token: string, uploadId?: string) => {
      setPreviewLoading(true);
      setPreviewError(null);
      setPreview(null);

      try {
        const targetUploadId =
          uploadId ||
          selectedUploadId ||
          (lastUpload && lastUpload.id) ||
          undefined;

        if (!targetUploadId) {
          setPreviewError("No upload selected for preview.");
          return;
        }

        // üëá USE API_BASE_URL
        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/uploads/${targetUploadId}/preview`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (res.status === 404) {
          setPreviewError(
            "File preview could not be generated (maybe archived or removed)."
          );
          return;
        }

        if (!res.ok) {
          const payload = await res.json().catch(() => ({}));
          throw new Error(payload.detail || `Preview failed: ${res.status}`);
        }

        const data: PreviewResponse = await res.json();
        setPreview(data);
      } catch (err: any) {
        console.error("Preview failed:", err);
        setPreviewError(err.message || "Could not load preview.");
      } finally {
        setPreviewLoading(false);
      }
    },
    [projectId, selectedUploadId, lastUpload]
  );

  // -------------------------------------------------------------
  // Fetch ALL uploads (history)
  // -------------------------------------------------------------
  const fetchUploadsHistory = useCallback(async () => {
    setHistoryLoading(true);
    setHistoryError(null);

    try {
      const token = await getAuthToken();
      if (!token) {
        setHistoryError("Please log in to see upload history.");
        return;
      }

      // üëá USE API_BASE_URL
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/uploads`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (res.status === 404) {
        // No uploads yet
        setUploadsHistory([]);
        setLastUpload(null);
        setSelectedUploadId(null);
        return;
      }

      if (!res.ok) {
        const errorBody = await res.json().catch(() => ({}));
        throw new Error(errorBody.detail || `History error: ${res.status}`);
      }

      const data = (await res.json()) as any[];

      const mapped: LastUpload[] = data.map((item) => {
        const uiStatus = mapApiStatusToUiStatus(
          item.status,
          item.row_count
        );

        return {
          id: item.id,
          project_id: item.project_id,
          file_name: item.file_name ?? item.original_filename ?? null,
          status: uiStatus,
          row_count:
            typeof item.row_count === "number" ? item.row_count : null,
          uploaded_at: item.uploaded_at ?? item.created_at ?? null,
          validation_errors: item.validation_errors || null,
          original_filename: item.original_filename || null,
        } as LastUpload;
      });

      setUploadsHistory(mapped);

      // Default selection: most recent upload
      if (mapped.length > 0) {
        const mostRecent = mapped[0];
        setLastUpload(mostRecent);
        setSelectedUploadId(mostRecent.id ?? null);
      } else {
        setLastUpload(null);
        setSelectedUploadId(null);
      }
    } catch (err: any) {
      console.error("fetchUploadsHistory failed:", err);
      setHistoryError(err.message || "Could not load upload history.");
      setUploadsHistory([]);
      setLastUpload(null);
      setSelectedUploadId(null);
    } finally {
      setHistoryLoading(false);
    }
  }, [projectId]);

  // -------------------------------------------------------------
  // Initial load
  // -------------------------------------------------------------
  useEffect(() => {
    fetchUploadsHistory();
    setFile(null);
    setPreview(null);
  }, [fetchUploadsHistory]);

  // -------------------------------------------------------------
  // File change + upload
  // -------------------------------------------------------------
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0]);
      setStatus("idle");
      setError(null);
      setPreview(null);
    }
  };

  const handleUpload = async () => {
    if (!file) return;

    setError(null);
    setStatus("uploading");

    try {
      const token = await getAuthToken();
      if (!token) {
        setStatus("idle");
        setError("You need to be logged in to upload data.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      // üëá USE API_BASE_URL
      const uploadUrl = `${API_BASE_URL}/api/v1/projects/${projectId}/master-data/upload`;

      setStatus("processing");

      const res = await fetch(uploadUrl, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          // DO NOT set Content-Type; browser does it for FormData
        },
        body: formData,
      });

      const payload = await res.json().catch(() => null);

      if (!res.ok) {
        const detail =
          (payload && (payload.detail || payload.message)) ||
          `Upload failed with status ${res.status}`;
        throw new Error(detail);
      }

      if (payload.status === "failed") {
        setStatus("idle");
        throw new Error(
          `Validation Failed: Missing required columns: ${
            payload.validation_errors?.missing_columns?.join(", ") ||
            "See status card."
          }`
        );
      }

      setStatus("ready");
      setFile(null);

      // Refresh history & lastUpload after a successful upload
      await fetchUploadsHistory();
    } catch (e: any) {
      console.error("Upload failed", e);
      setError(
        e instanceof Error ? e.message : "Upload failed. Please try again."
      );
      setStatus("idle");
    }
  };

  // -------------------------------------------------------------
  // Handlers for preview + selecting uploads in dropdown
  // -------------------------------------------------------------
  const handlePreview = async (uploadId?: string) => {
    setPreviewError(null);

    try {
      const token = await getAuthToken();
      if (!token) {
        setPreviewError("You need to be logged in to view data.");
        return;
      }

      await fetchPreview(token, uploadId);
    } catch (e: any) {
      console.error("handlePreview error:", e);
      setPreviewError(
        e instanceof Error ? e.message : "Could not load preview."
      );
    }
  };

  const handleSelectUpload = (uploadId: string) => {
    setSelectedUploadId(uploadId);

    const selected = uploadsHistory.find((u) => u.id === uploadId);
    if (selected) {
      setLastUpload(selected);
    }

    // Optionally, auto-refresh preview when selection changes:
    // getAuthToken().then(token => token && fetchPreview(token, uploadId));
  };

  // -------------------------------------------------------------
  // Public API of the hook
  // -------------------------------------------------------------
  return {
    // file + upload flow
    file,
    status,
    error,
    isUploading,
    isReady,

    // last upload + history
    lastUpload,
    statusLoading,
    statusError,
    uploadsHistory,
    historyLoading,
    historyError,
    selectedUploadId,

    // preview
    preview,
    previewLoading,
    previewError,

    // handlers
    handleFileChange,
    handleUpload,
    handlePreview,
    handleSelectUpload,

    // utilities
    refreshHistory: fetchUploadsHistory,
  };
}\n--- ./(app)/projects/[projectId]/config/hooks/useNetworkSnapshot.ts ---\n
// app/(app)/projects/[projectId]/config/hooks/useNetworkSnapshot.ts
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
// üëá IMPORT THE CENTRAL CONFIG
import { API_BASE_URL } from "@/lib/config"; 

// -------------------------
// Raw API types (snake_case)
// -------------------------

export type LengthByCategoryApi = {
  label: string;
  length_km: number;
};

export type AssetValueByCategoryApi = {
  label: string;
  value: number;
};

export type UnitCostByCategoryApi = {
  label: string;
  cost_per_km: number;
};

export type NetworkSnapshotApi = {
  project_id: string;
  upload_id: string;

  total_length_km: number;
  total_segments: number;
  total_roads?: number | null;

  length_by_road_class?: LengthByCategoryApi[];
  length_by_surface_type?: LengthByCategoryApi[];

  total_network_length_km?: number | null;
  length_by_network_type?: LengthByCategoryApi[];

  total_asset_value?: number | null;
  asset_value_by_category?: AssetValueByCategoryApi[];

  unit_costs_by_surface?: UnitCostByCategoryApi[];

  // Optional timestamp if backend adds it
  calculated_at?: string | null;
};

// -------------------------
// UI types (camelCase)
// -------------------------

export type LengthByCategoryUi = {
  label: string;
  lengthKm: number;
};

export type AssetValueByCategoryUi = {
  label: string;
  value: number;
};

export type UnitCostByCategoryUi = {
  label: string;
  costPerKm: number;
};

export type NetworkSnapshotUi = {
  projectId: string;
  uploadId: string;

  totalLengthKm: number;
  totalSegments: number;
  totalRoads: number | null;

  pavedLengthKm: number;
  gravelLengthKm: number;

  goodConditionPct: number;
  fairConditionPct: number;
  poorConditionPct: number;

  totalNetworkLengthKm: number | null;
  lengthByRoadClass: LengthByCategoryUi[];
  lengthBySurfaceType: LengthByCategoryUi[];
  lengthByNetworkType: LengthByCategoryUi[];

  totalAssetValue: number | null;
  assetValueByCategory: AssetValueByCategoryUi[];

  unitCostsBySurface: UnitCostByCategoryUi[];

  calculatedAt: string | null;
};

// -------------------------
// Hook state
// -------------------------

type State = {
  snapshot: NetworkSnapshotUi | null;
  loading: boolean;
  error: string | null;
};

// -------------------------
// Hook implementation
// -------------------------

export function useNetworkSnapshot(projectId: string) {
  const [state, setState] = useState<State>({
    snapshot: null,
    loading: false,
    error: null,
  });

  const fetchSnapshot = useCallback(async () => {
    // If no project yet, just reset and bail out
    if (!projectId) {
      setState((prev) => ({
        ...prev,
        snapshot: null,
        error: null,
        loading: false,
      }));
      return;
    }

    setState((prev) => ({ ...prev, loading: true, error: null }));

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;

      if (!token) {
        // Soft error to avoid flashing red if just logged out/loading
        setState((prev) => ({
            ...prev,
            loading: false,
            error: "Please log in to view network snapshot."
        }));
        return;
      }

      // üëá USE API_BASE_URL FROM CONFIG
      const res = await fetch(
        `${API_BASE_URL}/api/v1/projects/${projectId}/network/snapshot`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (!res.ok) {
        // Handle 404 gracefully (no snapshot yet)
        if (res.status === 404) {
            setState({ snapshot: null, loading: false, error: null });
            return;
        }
        
        const body = await res.json().catch(() => ({}));
        throw new Error(
          body.detail || `Failed to load network snapshot (${res.status})`
        );
      }

      const api: NetworkSnapshotApi = await res.json();

      // ----- Core length logic ---------------------------------------------
      // Prioritize network_length sheet if available, else segments sum
      const totalLengthKm =
        api.total_network_length_km ??
        api.total_length_km ??
        0;

      const lengthBySurfaceApi = api.length_by_surface_type ?? [];

      // Calculate paved/gravel split from surface types
      let pavedLengthKm = 0;
      let gravelLengthKm = 0;
      
      lengthBySurfaceApi.forEach((row) => {
        const label = (row.label || "").toLowerCase();
        if (
          label.includes("paved") ||
          label.includes("seal") ||
          label.includes("asphalt") ||
          label.includes("concrete") ||
          label.includes("surfaced")
        ) {
          pavedLengthKm += row.length_km || 0;
        } else if (
            label.includes("gravel") || 
            label.includes("earth") || 
            label.includes("unpaved")
        ) {
          gravelLengthKm += row.length_km || 0;
        } else {
            // Default bucket if unclear
            gravelLengthKm += row.length_km || 0;
        }
      });

      // ----- Condition split (placeholder until we wire real condition) ----
      const goodConditionPct = 60;
      const fairConditionPct = 25;
      const poorConditionPct = 15;

      // ----- Map to UI model -----------------------------------------------
      const snapshotUi: NetworkSnapshotUi = {
        projectId: api.project_id,
        uploadId: api.upload_id,
        totalLengthKm,
        totalSegments: api.total_segments ?? 0,
        totalRoads: api.total_roads ?? null,
        
        pavedLengthKm,
        gravelLengthKm,

        goodConditionPct,
        fairConditionPct,
        poorConditionPct,

        totalNetworkLengthKm: api.total_network_length_km ?? null,
        
        lengthByRoadClass: (api.length_by_road_class ?? []).map((row) => ({
          label: row.label,
          lengthKm: row.length_km ?? 0,
        })),
        
        lengthBySurfaceType: lengthBySurfaceApi.map((row) => ({
          label: row.label,
          lengthKm: row.length_km ?? 0,
        })),
        
        lengthByNetworkType: (api.length_by_network_type ?? []).map((row) => ({
          label: row.label,
          lengthKm: row.length_km ?? 0,
        })),

        totalAssetValue: api.total_asset_value ?? null,
        assetValueByCategory: (api.asset_value_by_category ?? []).map((row) => ({
          label: row.label,
          value: row.value ?? 0,
        })),

        unitCostsBySurface: (api.unit_costs_by_surface ?? []).map((row) => ({
          label: row.label,
          costPerKm: row.cost_per_km ?? 0,
        })),

        calculatedAt: api.calculated_at ?? null,
      };

      setState({
        snapshot: snapshotUi,
        loading: false,
        error: null,
      });
    } catch (err: any) {
      console.error("[useNetworkSnapshot] error:", err);
      setState({
        snapshot: null,
        loading: false,
        error: err.message || "Could not load network snapshot.",
      });
    }
  }, [projectId]);

  useEffect(() => {
    fetchSnapshot();
  }, [fetchSnapshot]);

  return {
    snapshot: state.snapshot,
    loading: state.loading,
    error: state.error,
    refetch: fetchSnapshot,
  };
}\n--- ./(app)/projects/[projectId]/config/page.tsx ---\n
"use client";

import React from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { ArrowLeft } from "lucide-react";

import { DataInputCard } from "./DataInputCard";
import { NetworkSnapshotCard } from "./components/NetworkSnapshotCard";
import { ScenarioAssumptionsCard } from "./components/ScenarioAssumptionsCard";
import { RunSimulationCard } from "./components/RunSimulationCard";

export default function ProjectConfigPage() {
  const params = useParams();
  const projectId = Array.isArray(params?.projectId)
    ? params?.projectId[0]
    : params?.projectId;

  if (!projectId) {
    return <div>Error: Project ID not found.</div>;
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <header className="flex items-center justify-between gap-4">
        <div className="space-y-1">
          <div className="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
            <Link
              href="/projects"
              className="inline-flex items-center gap-1 hover:text-slate-700 dark:hover:text-slate-200"
            >
              <ArrowLeft className="h-4 w-4" />
              Back to projects
            </Link>
          </div>
          <h1 className="text-2xl font-semibold tracking-tight">
            Project Configuration
          </h1>
          <p className="text-xs text-slate-500 dark:text-slate-400">
            Project ID:{" "}
            <span className="font-mono bg-slate-100 dark:bg-slate-900/40 px-1.5 py-0.5 rounded">
              {projectId}
            </span>
          </p>
        </div>
      </header>

      {/* Main layout */}
      <div className="grid gap-6 lg:grid-cols-[1.7fr,1.3fr]">
        
        {/* LEFT COLUMN: Inputs */}
        <div className="space-y-6">
            {/* 1. UPLOAD */}
            <DataInputCard projectId={projectId} />

            {/* 2. ASSUMPTIONS */}
            <ScenarioAssumptionsCard projectId={projectId} />
        </div>

        {/* RIGHT COLUMN: Info & Action */}
        <div className="space-y-6">
            {/* Info */}
            <NetworkSnapshotCard projectId={projectId} />

            {/* 3. RUN SIMULATION */}
            <RunSimulationCard projectId={projectId} />
        </div>
      </div>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/config/DataInputCard.tsx ---\n
/* --- app/(app)/projects/[projectId]/config/DataInputCard.tsx --- */
"use client";

import React from "react";
import { Upload, CheckCircle, Database } from "lucide-react";
import { cn } from "@/lib/utils";
import { useMasterDataUpload } from "./hooks/useMasterDataUpload";
import { UploadStatusCard } from "./components/UploadStatusCard";
import { DataPreviewTable } from "./components/DataPreviewTable";

export function DataInputCard({ projectId }: { projectId: string }) {
  const {
    // state
    file,
    status,
    error,
    lastUpload,
    statusLoading,
    statusError,
    uploadsHistory,
    historyLoading,
    historyError,
    selectedUploadId,
    preview,
    previewLoading,
    previewError,
    isUploading,
    isReady,
    // handlers
    handleFileChange,
    handleUpload,
    handlePreview,
    handleSelectUpload,
  } = useMasterDataUpload(projectId);

  // --- Render -----------------------------------------------------
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg">
      <div className="flex items-start justify-between gap-4 mb-3">
        <div>
          <h2 className="text-xl font-semibold mb-1 flex items-center gap-2">
            <Database className="h-5 w-5 text-[var(--accent-color)]" />
            1. Master Data Input
          </h2>
          <p className="text-sm text-slate-500 dark:text-slate-400">
            Upload the road inventory/condition data (Excel/CSV) to set the
            baseline for this project ({projectId}).
          </p>
        </div>

        <UploadStatusCard
          lastUpload={lastUpload}
          statusLoading={statusLoading}
          statusError={statusError}
          uploadsHistory={uploadsHistory}
          historyLoading={historyLoading}
          historyError={historyError}
          selectedUploadId={selectedUploadId}
          previewLoading={previewLoading}
          onPreview={handlePreview}
          onSelectUpload={handleSelectUpload}
        />
      </div>

      {/* Upload area */}
      <div
        className={cn(
          "p-6 border-2 border-dashed rounded-xl transition-colors",
          isReady
            ? "border-green-400 dark:border-green-600"
            : "border-slate-300 dark:border-slate-700"
        )}
      >
        <input
          type="file"
          accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
          onChange={handleFileChange}
          className="hidden"
          id={`file-upload-${projectId}`}
          disabled={isUploading}
        />

        <label
          htmlFor={`file-upload-${projectId}`}
          className={cn(
            "block p-4 text-center rounded-lg cursor-pointer transition-colors",
            isReady
              ? "bg-green-50 dark:bg-green-900/20"
              : "hover:bg-slate-50 dark:hover:bg-slate-800/50"
          )}
        >
          <Upload className="h-6 w-6 mx-auto mb-2 text-slate-500" />
          {file ? (
            <span className="font-medium text-[var(--foreground)]">
              {file.name}
            </span>
          ) : (
            <span className="text-slate-500">
              Click to select file or drag here
            </span>
          )}
        </label>

        {/* General upload error */}
        {error && <p className="text-xs text-red-500 mt-2">{error}</p>}

        <div className="mt-4 flex justify-between items-center gap-3">
          <p className="text-[11px] text-slate-500 dark:text-slate-400">
            Later we‚Äôll add <span className="font-semibold">manual edits</span>{" "}
            on top of this uploaded baseline (hybrid mode).
          </p>

          <button
            onClick={handleUpload}
            disabled={!file || isUploading}
            className={cn(
              "inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-semibold text-white shadow-sm transition",
              isReady
                ? "bg-green-600 hover:bg-green-700"
                : "bg-[var(--accent-color)] hover:brightness-110",
              "disabled:cursor-not-allowed disabled:opacity-70"
            )}
          >
            {isReady ? (
              <>
                <CheckCircle className="h-4 w-4" /> Data Ready
              </>
            ) : isUploading ? (
              "Processing data..."
            ) : (
              <>
                <Upload className="h-4 w-4" /> Upload &amp; Validate
              </>
            )}
          </button>
        </div>

        {/* Preview error */}
        {previewError && (
          <p className="text-xs text-red-500 mt-3">{previewError}</p>
        )}

        {/* Inline preview */}
        {preview && (
          <div className="mt-6">
            <DataPreviewTable preview={preview} />
          </div>
        )}
      </div>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/types.ts ---\n
// app/(app)/dashboard/types.ts

export type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
};

export type Dashboard = {
  id: string;
  projectId: string;
  userId: string;
  name: string;
  description?: string | null;
  isFavorite: boolean;
  layout?: any | null;
  overrides?: any | null;
  createdAt: string;
  updatedAt: string;
};\n--- ./(app)/projects/[projectId]/dashboard/components/ScenarioImpactCard.tsx ---\n
// app/(app)/dashboard/components/ScenarioImpactCard.tsx
"use client";

import React from "react";
import { BarChart3 } from "lucide-react";

type Props = {
  adjustedAssetValue: number | null;
};

export function ScenarioImpactCard({ adjustedAssetValue }: Props) {
  if (adjustedAssetValue == null) return null;

  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-2">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <BarChart3 className="h-4 w-4 text-amber-500" />
        Scenario impact (rough illustrative)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        This uses your live scenario controls on the right (analysis horizon +
        budget level) to estimate an indicative{" "}
        <span className="font-medium">lifetime investment envelope</span>. Later
        we‚Äôll plug in full RONET logic.
      </p>
      <p className="text-lg font-semibold mt-1">
        R {(adjustedAssetValue / 1_000_000).toFixed(1)} m
      </p>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/ProjectDashboardSelector.tsx ---\n
// app/(app)/dashboard/components/ProjectDashboardSelector.tsx
"use client";

import React from "react";
import { AlertTriangle, RefreshCw, Save } from "lucide-react";
import type { Dashboard, Project } from "../types";

type Props = {
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
  dashboards: Dashboard[];
  dashboardsLoading: boolean;
  dashboardsError: string | null;

  selectedProjectId: string;
  onProjectChange: (projectId: string) => void;
  selectedProject: Project | null;

  selectedDashboardId: string;
  onDashboardChange: (dashboardId: string) => void;

  snapshotLoading: boolean;
  onRefreshSnapshot: () => void;

  onSaveNew: () => void;
  onSaveExisting: () => void;
};

export function ProjectDashboardSelector({
  projects,
  projectsLoading,
  projectsError,
  dashboards,
  dashboardsLoading,
  dashboardsError,
  selectedProjectId,
  onProjectChange,
  selectedProject,
  selectedDashboardId,
  onDashboardChange,
  snapshotLoading,
  onRefreshSnapshot,
  onSaveNew,
  onSaveExisting,
}: Props) {
  return (
    <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-4">
      {/* Project row */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Project
          </p>
          <p className="text-sm font-medium">
            {selectedProject ? selectedProject.project_name : "Select a project"}
          </p>
          {selectedProject && (
            <p className="text-[11px] text-slate-500 dark:text-slate-400">
              {selectedProject.description && (
                <>
                  <span className="font-medium">Overview:</span>{" "}
                  {selectedProject.description}{" "}
                </>
              )}
              {(selectedProject.start_year || selectedProject.forecast_duration) && (
                <>
                  |
                  {selectedProject.start_year && (
                    <> Start year: {selectedProject.start_year}</>
                  )}
                  {selectedProject.forecast_duration && (
                    <> ‚Ä¢ Horizon: {selectedProject.forecast_duration} years</>
                  )}
                </>
              )}
            </p>
          )}
        </div>

        <div className="flex flex-wrap items-center gap-3">
          <select
            value={selectedProjectId}
            onChange={(e) => onProjectChange(e.target.value)}
            disabled={projectsLoading || projects.length === 0}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="" disabled>
              {projectsLoading
                ? "Loading projects‚Ä¶"
                : projects.length === 0
                ? "No projects found"
                : "Select project"}
            </option>
            {projects.map((p) => (
              <option key={p.id} value={p.id}>
                {p.project_name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={onRefreshSnapshot}
            disabled={!selectedProjectId || snapshotLoading}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
          >
            <RefreshCw className="h-3 w-3" />
            {snapshotLoading ? "Refreshing data‚Ä¶" : "Refresh data"}
          </button>
        </div>
      </div>

      {/* Dashboard selection row */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div className="flex items-center gap-2">
          <span className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Dashboard
          </span>
          <select
            value={selectedDashboardId}
            onChange={(e) => onDashboardChange(e.target.value)}
            disabled={!selectedProjectId || dashboardsLoading}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">
              {dashboardsLoading
                ? "Loading dashboards‚Ä¶"
                : dashboards.length === 0
                ? "Unsaved view"
                : "Unsaved view (current controls)"}
            </option>
            {dashboards.map((d) => (
              <option key={d.id} value={d.id}>
                {d.name}
                {d.isFavorite ? " ‚òÖ" : ""}
              </option>
            ))}
          </select>
        </div>

        <div className="flex items-center gap-2">
          <button
            type="button"
            onClick={onSaveNew}
            disabled={!selectedProjectId}
            className="inline-flex items-center gap-1.5 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs font-medium text-white px-3 py-1.5 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Save as new dashboard
          </button>
          <button
            type="button"
            onClick={onSaveExisting}
            disabled={!selectedProjectId || !selectedDashboardId}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-200 px-3 py-1.5 hover:bg-slate-800/60 disabled:opacity-60"
          >
            <Save className="h-3 w-3" />
            Update selected
          </button>
        </div>
      </div>

      {(projectsError || dashboardsError) && (
        <p className="text-xs text-red-500 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          {projectsError || dashboardsError}
        </p>
      )}
    </section>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/SimulationCharts.tsx ---\n
"use client";

import React from "react";
import {
  LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
} from 'recharts';
import { Activity, DollarSign } from "lucide-react";
import type { SimulationOutput } from "../../config/types";

type Props = {
  results: SimulationOutput | null;
};

export function SimulationCharts({ results }: Props) {
  if (!results) return null;

  return (
    <div className="grid gap-4 lg:grid-cols-2 mt-6">
      
      {/* Chart 1: Condition Over Time */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <Activity className="h-4 w-4 text-blue-500" />
            Predicted Network Condition
          </h2>
          <span className="text-[10px] text-slate-500">Average IRI (Lower is better)</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} domain={[0, 'auto']} />
              <Tooltip 
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
              />
              <Legend wrapperStyle={{ fontSize: "10px" }} />
              <Line 
                type="monotone" 
                dataKey="avg_condition_index" 
                name="Average IRI" 
                stroke="#3b82f6" 
                strokeWidth={3} 
                dot={false} 
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* Chart 2: Cost Profile */}
      <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <DollarSign className="h-4 w-4 text-emerald-500" />
            Annual Expenditure
          </h2>
          <span className="text-[10px] text-slate-500">Maintenance Budget Needed</span>
        </div>
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={results.yearly_data} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.3} />
              <XAxis dataKey="year" stroke="#94a3b8" fontSize={10} tickLine={false} axisLine={false} />
              <YAxis 
                stroke="#94a3b8" 
                fontSize={10} 
                tickLine={false} 
                axisLine={false}
                tickFormatter={(val) => `R${val/1000000}M`} 
              />
              <Tooltip 
                cursor={{ fill: 'transparent' }}
                contentStyle={{ backgroundColor: '#1e293b', border: 'none', borderRadius: '8px', color: '#fff', fontSize: '12px' }}
                formatter={(value: number) => [`R${(value).toLocaleString()}`, 'Cost']}
              />
              <Bar dataKey="total_maintenance_cost" name="Maintenance Cost" fill="#10b981" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/DashboardHeader.tsx ---\n
// app/(app)/dashboard/components/DashboardHeader.tsx
"use client";

import React from "react";
import { LayoutDashboard } from "lucide-react";

export function DashboardHeader() {
  return (
    <header className="space-y-1">
      <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
        <LayoutDashboard className="h-6 w-6 text-sky-500" />
        Dashboards
      </h1>
      <p className="text-sm text-slate-500 dark:text-slate-400">
        Build presentation-ready dashboards for each project. Adjust scenario
        knobs live for board meetings, and optionally save favourite
        configurations as named dashboards.
      </p>
    </header>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/ScenarioControlsCard.tsx ---\n
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControlsCard({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (presentation only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> modify
        your underlying data. They only drive this dashboard‚Äôs story. When
        you‚Äôre happy with a configuration, save it as a named dashboard.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET runs use 20 years; adjust to explore shorter or longer
          investment horizons.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used to scale indicative figures on
          the dashboard.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {(
            [
              {
                value: "preventive" as const,
                label: "Preventive heavy",
                desc: "Prioritise good/fair roads.",
              },
              {
                value: "balanced" as const,
                label: "Balanced",
                desc: "Mix of preventive + rehab.",
              },
              {
                value: "reactive" as const,
                label: "Reactive",
                desc: "Worst-first; more backlog risk.",
              },
            ] as const
          ).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/ScenarioControls.tsx ---\n
// app/(app)/dashboard/components/ScenarioControls.tsx
"use client";

import React from "react";
import { SlidersHorizontal } from "lucide-react";

type PolicyBias = "preventive" | "balanced" | "reactive";

type Props = {
  analysisYears: number;
  budgetLevel: number;
  policyBias: PolicyBias;
  onAnalysisYearsChange: (value: number) => void;
  onBudgetLevelChange: (value: number) => void;
  onPolicyBiasChange: (value: PolicyBias) => void;
};

export function ScenarioControls({
  analysisYears,
  budgetLevel,
  policyBias,
  onAnalysisYearsChange,
  onBudgetLevelChange,
  onPolicyBiasChange,
}: Props) {
  return (
    <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
      <h2 className="text-sm font-semibold flex items-center gap-2">
        <SlidersHorizontal className="h-4 w-4 text-yellow-500" />
        Scenario controls (live only)
      </h2>
      <p className="text-xs text-slate-500 dark:text-slate-400">
        These controls do <span className="font-semibold">not</span> change the
        underlying data ‚Äì they only drive this dashboard view. Use them during
        board presentations, and save as a named dashboard when you like the
        story.
      </p>

      {/* Analysis period */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Analysis period</span>
          <span className="text-slate-400">{analysisYears} years</span>
        </div>
        <input
          type="range"
          min={5}
          max={30}
          step={1}
          value={analysisYears}
          onChange={(e) => onAnalysisYearsChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Typical RONET uses 20 years; extend or shorten for presentation
          ‚Äúwhat-if‚Äù runs.
        </p>
      </div>

      {/* Budget level */}
      <div className="space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="font-medium text-slate-200">Annual budget level</span>
          <span className="text-slate-400">{budgetLevel}% of baseline</span>
        </div>
        <input
          type="range"
          min={50}
          max={150}
          step={5}
          value={budgetLevel}
          onChange={(e) => onBudgetLevelChange(Number(e.target.value))}
          className="w-full"
        />
        <p className="text-[10px] text-slate-500 dark:text-slate-400">
          Below 100% simulates underfunding; above 100% simulates more
          aggressive investment. Currently used only for indicative dashboard
          figures.
        </p>
      </div>

      {/* Policy bias */}
      <div className="space-y-2">
        <p className="text-xs font-medium text-slate-200">
          Maintenance policy bias
        </p>
        <div className="flex flex-wrap gap-2">
          {([
            {
              value: "preventive" as PolicyBias,
              label: "Preventive heavy",
              desc: "Prioritise good/fair roads.",
            },
            {
              value: "balanced" as PolicyBias,
              label: "Balanced",
              desc: "Mix of preventive + rehab.",
            },
            {
              value: "reactive" as PolicyBias,
              label: "Reactive",
              desc: "Worst-first, more backlog.",
            },
          ] as const).map((o) => (
            <button
              key={o.value}
              type="button"
              onClick={() => onPolicyBiasChange(o.value)}
              className={[
                "flex-1 min-w-[90px] px-3 py-2 rounded-xl border text-left transition text-[11px]",
                policyBias === o.value
                  ? "border-yellow-500 bg-yellow-50/10 text-yellow-100"
                  : "border-slate-600 hover:bg-slate-800/60 text-slate-300",
              ].join(" ")}
            >
              <div className="font-semibold">{o.label}</div>
              <div className="text-[10px] text-slate-400">{o.desc}</div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/components/DashboardMainPanel.tsx ---\n
"use client";

import React, { useMemo } from "react";
import {
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  Legend,
  CartesianGrid,
} from "recharts";
import { AlertTriangle, BarChart3, TrendingUp, Activity } from "lucide-react";
import type { NetworkSnapshotUi } from "../../config/hooks/useNetworkSnapshot";
import type { SimulationOutput } from "../../config/types";
import { SimulationCharts } from "./SimulationCharts";

type Props = {
  snapshot: NetworkSnapshotUi | null;
  loading: boolean;
  error: string | null;
  adjustedAssetValue: number | null; // Optional, can be null
  simulationResults: SimulationOutput | null;
};

const SURFACE_COLOURS = ["#38bdf8", "#64748b"]; // paved, gravel
const CONDITION_COLOURS = ["#22c55e", "#fbbf24", "#f97373"]; // good, fair, poor

export function DashboardMainPanel({
  snapshot,
  loading,
  error,
  adjustedAssetValue,
  simulationResults,
}: Props) {
  // ----- derived chart data --------------------------------------------------

  const surfaceMixData = useMemo(() => {
    if (!snapshot) return [];
    return [
      { name: "Paved", value: snapshot.pavedLengthKm },
      { name: "Gravel", value: snapshot.gravelLengthKm },
    ];
  }, [snapshot]);

  const roadClassData = useMemo(() => {
    if (!snapshot?.lengthByRoadClass) return [];
    return snapshot.lengthByRoadClass.map((row) => ({
      name: row.label,
      km: row.lengthKm,
    }));
  }, [snapshot]);

  const totalLengthKm = snapshot?.totalLengthKm ?? 0;
  const gravelShare =
    snapshot && totalLengthKm > 0
      ? (snapshot.gravelLengthKm / totalLengthKm) * 100
      : 0;

  // --------------------------------------------------------------------------

  return (
    <div className="space-y-6">
      {/* errors / loading */}
      {loading && (
        <p className="text-xs text-slate-500 dark:text-slate-400">
          Loading dashboard data‚Ä¶
        </p>
      )}

      {!loading && error && (
        <div className="flex items-start gap-2 text-xs text-red-500">
          <AlertTriangle className="h-4 w-4 mt-0.5" />
          <span>{error}</span>
        </div>
      )}

      {/* nothing yet */}
      {!loading && !error && !snapshot && (
        <p className="text-xs text-slate-500 dark:text-slate-400">
          No snapshot yet. Upload and validate master data for this project on
          the <span className="font-medium">Configuration</span> page to see
          dashboards here.
        </p>
      )}

      {/* main content */}
      {!loading && snapshot && (
        <>
          {/* KPI strip */}
          <div className="grid gap-3 md:grid-cols-4">
            {/* Total length */}
            <div className="rounded-2xl border border-slate-200/10 dark:border-slate-800/60 bg-[var(--surface-bg)] px-4 py-3 flex flex-col justify-between">
              <p className="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Total network length
              </p>
              <div className="mt-1 text-xl font-semibold">
                {snapshot.totalLengthKm.toFixed(1)}{" "}
                <span className="text-xs font-normal text-slate-400">km</span>
              </div>
              <p className="mt-1 text-[10px] text-slate-500 dark:text-slate-500">
                Based on latest master dataset
              </p>
            </div>

            {/* Good share */}
            <div className="rounded-2xl border border-slate-200/10 dark:border-slate-800/60 bg-[var(--surface-bg)] px-4 py-3 flex flex-col justify-between">
              <p className="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Good condition
              </p>
              <div className="mt-1 text-xl font-semibold text-emerald-400">
                {snapshot.goodConditionPct.toFixed(0)}%
              </div>
              <p className="mt-1 text-[10px] text-slate-500 dark:text-slate-500">
                Share of network length in{" "}
                <span className="font-medium">‚Äúgood‚Äù</span> band
              </p>
            </div>

            {/* Gravel share */}
            <div className="rounded-2xl border border-slate-200/10 dark:border-slate-800/60 bg-[var(--surface-bg)] px-4 py-3 flex flex-col justify-between">
              <p className="text-[10px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                Gravel share
              </p>
              <div className="mt-1 text-xl font-semibold text-sky-400">
                {gravelShare.toFixed(0)}%
              </div>
              <p className="mt-1 text-[10px] text-slate-500 dark:text-slate-500">
                {snapshot.gravelLengthKm.toFixed(1)} km of{" "}
                {snapshot.totalLengthKm.toFixed(1)} km total
              </p>
            </div>

            {/* Asset value */}
            {snapshot.totalAssetValue != null && (
              <div className="rounded-2xl border border-slate-200/10 dark:border-slate-800/60 bg-gradient-to-br from-slate-900/80 to-slate-900/30 px-4 py-3 flex flex-col justify-between">
                <div className="flex items-center justify-between">
                  <p className="text-[10px] uppercase tracking-wide text-slate-400">
                    Network asset value
                  </p>
                  <TrendingUp className="h-4 w-4 text-emerald-400" />
                </div>
                <div className="mt-1 text-xl font-semibold text-slate-50">
                  R {(snapshot.totalAssetValue / 1_000_000).toFixed(1)}{" "}
                  <span className="text-xs font-normal text-slate-400">m</span>
                </div>
                {adjustedAssetValue != null && (
                  <p className="mt-1 text-[10px] text-emerald-300">
                    Scenario envelope:&nbsp;
                    <span className="font-semibold">
                      R {(adjustedAssetValue / 1_000_000).toFixed(1)} m
                    </span>
                  </p>
                )}
              </div>
            )}
          </div>

          {/* Current State Charts */}
          <div className="grid gap-4 lg:grid-cols-2">
            {/* Condition split: stacked bar */}
            <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
              <div className="flex items-center justify-between">
                <h2 className="text-sm font-semibold flex items-center gap-2">
                  <BarChart3 className="h-4 w-4 text-sky-400" />
                  Current Condition Split
                </h2>
                <span className="text-[10px] text-slate-500 dark:text-slate-500">
                  % of total length
                </span>
              </div>
              <div className="h-40">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart
                    data={[
                      {
                        name: "Network",
                        Good: snapshot.goodConditionPct,
                        Fair: snapshot.fairConditionPct,
                        Poor: snapshot.poorConditionPct,
                      },
                    ]}
                    layout="vertical"
                    stackOffset="expand"
                    margin={{ top: 0, right: 0, left: 0, bottom: 0 }}
                  >
                    <CartesianGrid vertical={false} strokeDasharray="3 3" />
                    <XAxis type="number" hide />
                    <YAxis dataKey="name" type="category" hide />
                    <Tooltip
                      formatter={(value: any) => `${value.toFixed(0)}%`}
                      contentStyle={{
                        backgroundColor: "#1e293b",
                        border: "none",
                        fontSize: "12px",
                        color: "#fff",
                      }}
                    />
                    <Legend
                      wrapperStyle={{ fontSize: "10px", marginTop: "5px" }}
                    />
                    <Bar
                      dataKey="Good"
                      stackId="a"
                      fill={CONDITION_COLOURS[0]}
                      barSize={20}
                    />
                    <Bar
                      dataKey="Fair"
                      stackId="a"
                      fill={CONDITION_COLOURS[1]}
                      barSize={20}
                    />
                    <Bar
                      dataKey="Poor"
                      stackId="a"
                      fill={CONDITION_COLOURS[2]}
                      barSize={20}
                    />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Surface mix donut */}
            <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
              <div className="flex items-center justify-between">
                <h2 className="text-sm font-semibold">Current Surface Mix</h2>
                <span className="text-[10px] text-slate-500 dark:text-slate-500">
                  Paved vs gravel (km)
                </span>
              </div>
              <div className="h-40">
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie
                      data={surfaceMixData}
                      dataKey="value"
                      nameKey="name"
                      innerRadius={40}
                      outerRadius={65}
                      paddingAngle={2}
                    >
                      {surfaceMixData.map((_, idx) => (
                        <Cell
                          key={`cell-surface-${idx}`}
                          fill={SURFACE_COLOURS[idx % SURFACE_COLOURS.length]}
                        />
                      ))}
                    </Pie>
                    <Tooltip
                      formatter={(value: any) =>
                        `${(value as number).toFixed(1)} km`
                      }
                      contentStyle={{
                        backgroundColor: "#1e293b",
                        border: "none",
                        fontSize: "12px",
                        color: "#fff",
                      }}
                    />
                    <Legend
                      wrapperStyle={{ fontSize: "10px" }}
                      align="right"
                      layout="vertical"
                      verticalAlign="middle"
                    />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>

          {/* Road class chart + asset breakdown */}
          <div className="grid gap-4 lg:grid-cols-[2.1fr,1.2fr]">
            {/* Road class */}
            <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
              <div className="flex items-center justify-between">
                <h2 className="text-sm font-semibold">Length by Road Class</h2>
                <span className="text-[10px] text-slate-500 dark:text-slate-500">
                  km per class
                </span>
              </div>
              <div className="h-44">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart
                    data={roadClassData}
                    margin={{ top: 10, right: 10, left: 0, bottom: 0 }}
                  >
                    <CartesianGrid vertical={false} strokeDasharray="3 3" />
                    <XAxis
                      dataKey="name"
                      tick={{ fontSize: 10 }}
                      tickMargin={4}
                      axisLine={false}
                    />
                    <YAxis
                      tick={{ fontSize: 10 }}
                      axisLine={false}
                      width={35}
                    />
                    <Tooltip
                      formatter={(value: any) =>
                        `${(value as number).toFixed(1)} km`
                      }
                      contentStyle={{
                        backgroundColor: "#1e293b",
                        border: "none",
                        fontSize: "12px",
                        color: "#fff",
                      }}
                    />
                    <Bar
                      dataKey="km"
                      radius={[4, 4, 0, 0]}
                      fill="#38bdf8"
                      maxBarSize={36}
                    />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Asset value by category */}
            <div className="p-4 rounded-2xl bg-[var(--surface-bg)] border border-slate-200/10 dark:border-slate-800/60 space-y-2">
              <h2 className="text-sm font-semibold flex items-center gap-2">
                <TrendingUp className="h-4 w-4 text-emerald-400" />
                Asset Value
              </h2>
              <div className="space-y-1.5 text-[11px]">
                {snapshot.assetValueByCategory?.map((row) => (
                  <div
                    key={row.label}
                    className="flex items-center justify-between gap-2"
                  >
                    <span className="text-slate-400">{row.label}</span>
                    <span className="font-mono">
                      R {(row.value / 1_000_000).toFixed(1)} m
                    </span>
                  </div>
                ))}
              </div>
              <p className="mt-2 text-[10px] text-slate-500 dark:text-slate-500 border-t border-slate-700/50 pt-2">
                Snapshot as at{" "}
                <span className="font-mono">
                  {snapshot.calculatedAt
                    ? new Date(snapshot.calculatedAt).toLocaleString("en-ZA")
                    : "latest master data upload"}
                </span>
              </p>
            </div>
          </div>

          {/* SIMULATION RESULTS (FUTURE FORECAST) */}
          {simulationResults && (
            <div className="mt-8 border-t border-slate-200/10 dark:border-slate-800/60 pt-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h2 className="text-lg font-semibold flex items-center gap-2">
                    <Activity className="h-5 w-5 text-blue-500" />
                    Future Forecast ({simulationResults.year_count} Years)
                  </h2>
                  <p className="text-sm text-slate-500">
                    Projected performance based on current scenario settings.
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-[10px] uppercase text-slate-500">Total Lifecycle Cost</p>
                  <p className="text-xl font-mono font-bold text-emerald-500">
                    R {(simulationResults.total_cost_npv / 1_000_000).toFixed(1)} M
                  </p>
                </div>
              </div>
              
              {/* Render the Charts Component */}
              <SimulationCharts results={simulationResults} />
            </div>
          )}
        </>
      )}
    </div>
  );
}\n--- ./(app)/projects/[projectId]/dashboard/hooks/useSimulationResults.ts ---\n
"use client";

import { useState, useEffect } from "react";
import { supabase } from "@/lib/supabaseClient";
import { API_BASE_URL } from "@/lib/config";
import type { SimulationOutput } from "../../config/types";

export function useSimulationResults(projectId: string) {
  const [results, setResults] = useState<SimulationOutput | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function fetchResults() {
      if (!projectId) {
          setResults(null);
          return;
      }
      setLoading(true);
      
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;

        const res = await fetch(
          `${API_BASE_URL}/api/v1/projects/${projectId}/simulation/latest`,
          {
            headers: { Authorization: `Bearer ${session.access_token}` },
          }
        );

        if (res.status === 404) {
            setResults(null);
        } else if (!res.ok) {
            throw new Error("Failed to load results");
        } else {
            const data = await res.json();
            setResults(data);
        }
      } catch (err: any) {
        console.error(err);
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }

    fetchResults();
  }, [projectId]);

  return { results, loading, error };
}\n--- ./(app)/projects/[projectId]/dashboard/hooks/useProjectDashboards.ts ---\n
// app/(app)/dashboard/hooks/useProjectDashboards.ts
"use client";

import { useCallback, useEffect, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import { Dashboard } from "../types";

// const API_BASE = "http://127.0.0.1:8000";
const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

export function useProjectDashboards(projectId: string | "") {
  const [dashboards, setDashboards] = useState<Dashboard[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const fetchDashboards = useCallback(async () => {
    if (!projectId) return;
    setLoading(true);
    setError(null);

    try {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) {
        setError("Please log in to load dashboards.");
        setLoading(false);
        return;
      }

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || `Failed to load dashboards (${res.status})`);
      }

      const data = await res.json();
      const mapped: Dashboard[] = data.map((d: any) => ({
        id: d.id,
        projectId: d.project_id,
        userId: d.user_id,
        name: d.name,
        description: d.description,
        isFavorite: d.is_favorite,
        layout: d.layout,
        overrides: d.overrides,
        createdAt: d.created_at,
        updatedAt: d.updated_at,
      }));

      setDashboards(mapped);
    } catch (err: any) {
      console.error("[useProjectDashboards] error:", err);
      setError(err.message || "Could not load dashboards.");
    } finally {
      setLoading(false);
    }
  }, [projectId]);

  useEffect(() => {
    fetchDashboards();
  }, [fetchDashboards]);

  const createDashboard = useCallback(
    async (payload: {
      name: string;
      description?: string;
      overrides?: any;
      layout?: any;
      isFavorite?: boolean;
    }) => {
      if (!projectId) return;
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) throw new Error("Not authenticated.");

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || `Failed to create dashboard (${res.status})`);
      }

      await fetchDashboards();
    },
    [projectId, fetchDashboards]
  );

  const updateDashboard = useCallback(
    async (
      dashboardId: string,
      payload: {
        name?: string;
        description?: string;
        overrides?: any;
        layout?: any;
        isFavorite?: boolean;
      }
    ) => {
      if (!projectId) return;
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) throw new Error("Not authenticated.");

      const res = await fetch(
        `${API_BASE}/api/v1/projects/${projectId}/dashboards/${dashboardId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || `Failed to update dashboard (${res.status})`);
      }

      await fetchDashboards();
    },
    [projectId, fetchDashboards]
  );

  return {
    dashboards,
    loading,
    error,
    refetch: fetchDashboards,
    createDashboard,
    updateDashboard,
  };
}\n--- ./(app)/projects/[projectId]/dashboard/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { supabase } from "@/lib/supabaseClient";
import {
  AlertTriangle,
  LayoutDashboard,
  RefreshCw,
  Save,
} from "lucide-react";

import { useNetworkSnapshot } from "../config/hooks/useNetworkSnapshot";
import { useProjectDashboards } from "./hooks/useProjectDashboards";
import type { Dashboard } from "./types";
import { DashboardMainPanel } from "./components/DashboardMainPanel";
import { ScenarioControlsCard } from "./components/ScenarioControlsCard";

import { useSimulationResults } from "./hooks/useSimulationResults";

// const API_BASE = "http://127.0.0.1:8000";


const API_BASE= `${process.env.NEXT_PUBLIC_API_URL}`;

type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
};

export default function DashboardPage() {
  // -------- Projects ----------
  const [projects, setProjects] = useState<Project[]>([]);
  const [projectsLoading, setProjectsLoading] = useState(false);
  const [projectsError, setProjectsError] = useState<string | null>(null);
  const [selectedProjectId, setSelectedProjectId] = useState<string>("");
  const { results: simulationResults } = useSimulationResults(selectedProjectId || "");

  useEffect(() => {
    const fetchProjects = async () => {
      setProjectsLoading(true);
      setProjectsError(null);
      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        const token = session?.access_token;
        if (!token) {
          setProjectsError("Please log in to view dashboards.");
          setProjectsLoading(false);
          return;
        }

        const res = await fetch(`${API_BASE}/api/v1/projects`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.detail || `Failed to load projects (${res.status})`);
        }

        const data: Project[] = await res.json();
        setProjects(data);
        if (data.length > 0 && !selectedProjectId) {
          setSelectedProjectId(data[0].id);
        }
      } catch (err: any) {
        console.error("[DashboardPage] fetchProjects error:", err);
        setProjectsError(err.message || "Could not load projects.");
      } finally {
        setProjectsLoading(false);
      }
    };

    fetchProjects();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const selectedProject = useMemo(
    () => projects.find((p) => p.id === selectedProjectId) || null,
    [projects, selectedProjectId]
  );

  // -------- Snapshot (base data) ----------
  const {
    snapshot,
    loading: snapshotLoading,
    error: snapshotError,
    refetch: refetchSnapshot,
  } = useNetworkSnapshot(selectedProjectId || "");

  // -------- Dashboards for this project ----------
  const {
    dashboards,
    loading: dashboardsLoading,
    error: dashboardsError,
    createDashboard,
    updateDashboard,
  } = useProjectDashboards(selectedProjectId || "");

  const [selectedDashboardId, setSelectedDashboardId] = useState<string | "">("");

  const selectedDashboard: Dashboard | null = useMemo(
    () => dashboards.find((d) => d.id === selectedDashboardId) || null,
    [dashboards, selectedDashboardId]
  );

  // -------- Local scenario state (what-if) -----------------------------------
  const [analysisYears, setAnalysisYears] = useState(20);
  const [budgetLevel, setBudgetLevel] = useState(100);
  const [policyBias, setPolicyBias] =
    useState<"preventive" | "balanced" | "reactive">("balanced");

  // hydrate scenario controls from selected dashboard overrides
  useEffect(() => {
    if (selectedDashboard?.overrides) {
      const o = selectedDashboard.overrides as any;
      if (typeof o.analysisYears === "number") setAnalysisYears(o.analysisYears);
      if (typeof o.budgetLevel === "number") setBudgetLevel(o.budgetLevel);
      if (typeof o.policyBias === "string") setPolicyBias(o.policyBias);
    }
  }, [selectedDashboardId, selectedDashboard]);

  // simple indicative ‚Äúenvelope‚Äù metric
  const adjustedAssetValue =
    snapshot?.totalAssetValue != null
      ? snapshot.totalAssetValue * (budgetLevel / 100)
      : null;

  // -------- Save handlers ----------------------------------------------------
  const handleSaveNew = async () => {
    if (!selectedProjectId) return;
    const name =
      selectedDashboard?.name ||
      `${selectedProject?.project_name || "Project"} ‚Äì ${budgetLevel}% / ${analysisYears}y`;

    await createDashboard({
      name,
      description: "Presentation dashboard snapshot",
      overrides: { analysisYears, budgetLevel, policyBias },
      layout: {
        version: 1,
        widgets: ["kpiStrip", "conditionChart", "surfaceMix", "roadClass", "assetValue"],
      },
    });
  };

  const handleSaveExisting = async () => {
    if (!selectedProjectId || !selectedDashboardId) return;
    await updateDashboard(selectedDashboardId, {
      overrides: { analysisYears, budgetLevel, policyBias },
    });
  };

  // --------------------------------------------------------------------------

  return (
    <div className="space-y-6">
      {/* Header */}
      <header className="space-y-1">
        <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
          <LayoutDashboard className="h-6 w-6 text-sky-500" />
          Dashboards
        </h1>
        <p className="text-sm text-slate-500 dark:text-slate-400">
          Presentation-ready views of your road network. Use the controls to
          adjust scenarios live in meetings, and save favourite configurations
          as named dashboards per project.
        </p>
      </header>

      {/* Project + dashboard selectors */}
      <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-4">
        <div className="flex flex-wrap items-center justify-between gap-4">
          {/* Project summary */}
          <div>
            <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Project
            </p>
            <p className="text-sm font-medium">
              {selectedProject ? selectedProject.project_name : "Select a project"}
            </p>
            {selectedProject && (
              <p className="text-[11px] text-slate-500 dark:text-slate-400">
                {selectedProject.description && (
                  <>
                    <span className="font-medium">Overview:</span>{" "}
                    {selectedProject.description}{" "}
                  </>
                )}
                {(selectedProject.start_year || selectedProject.forecast_duration) && (
                  <>
                    |
                    {selectedProject.start_year && (
                      <> Start year: {selectedProject.start_year}</>
                    )}
                    {selectedProject.forecast_duration && (
                      <> ‚Ä¢ Horizon: {selectedProject.forecast_duration} years</>
                    )}
                  </>
                )}
              </p>
            )}
          </div>

          {/* Project select + refresh */}
          <div className="flex flex-wrap items-center gap-3">
            <select
              value={selectedProjectId}
              onChange={(e) => {
                setSelectedProjectId(e.target.value);
                setSelectedDashboardId("");
              }}
              disabled={projectsLoading || projects.length === 0}
              className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              <option value="" disabled>
                {projectsLoading
                  ? "Loading projects‚Ä¶"
                  : projects.length === 0
                  ? "No projects found"
                  : "Select project"}
              </option>
              {projects.map((p) => (
                <option key={p.id} value={p.id}>
                  {p.project_name}
                </option>
              ))}
            </select>

            <button
              type="button"
              onClick={refetchSnapshot}
              disabled={!selectedProjectId || snapshotLoading}
              className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
            >
              <RefreshCw className="h-3 w-3" />
              {snapshotLoading ? "Refreshing data‚Ä¶" : "Refresh data"}
            </button>
          </div>
        </div>

        {/* Dashboard selector + actions */}
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div className="flex items-center gap-2">
            <span className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Dashboard
            </span>
            <select
              value={selectedDashboardId}
              onChange={(e) => setSelectedDashboardId(e.target.value)}
              disabled={!selectedProjectId || dashboardsLoading}
              className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              <option value="">
                {dashboardsLoading
                  ? "Loading dashboards‚Ä¶"
                  : dashboards.length === 0
                  ? "Unsaved view"
                  : "Unsaved view (current controls)"}
              </option>
              {dashboards.map((d) => (
                <option key={d.id} value={d.id}>
                  {d.name}
                  {d.isFavorite ? " ‚òÖ" : ""}
                </option>
              ))}
            </select>
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={handleSaveNew}
              disabled={!selectedProjectId}
              className="inline-flex items-center gap-1.5 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs font-medium text-white px-3 py-1.5 disabled:opacity-60"
            >
              <Save className="h-3 w-3" />
              Save as new dashboard
            </button>
            <button
              type="button"
              onClick={handleSaveExisting}
              disabled={!selectedProjectId || !selectedDashboardId}
              className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 text-xs font-medium text-slate-200 px-3 py-1.5 hover:bg-slate-800/60 disabled:opacity-60"
            >
              <Save className="h-3 w-3" />
              Update selected
            </button>
          </div>
        </div>

        {(projectsError || dashboardsError) && (
          <p className="text-xs text-red-500 flex items-center gap-1">
            <AlertTriangle className="h-3 w-3" />
            {projectsError || dashboardsError}
          </p>
        )}
      </section>

      {/* Main layout: left = dashboard, right = scenario controls */}
      {selectedProjectId ? (
        <section className="grid gap-6 2xl:grid-cols-[2fr,1.2fr]">
          {/* Left: KPIs + charts */}
          <DashboardMainPanel
            snapshot={snapshot}
            loading={snapshotLoading}
            error={snapshotError}
            adjustedAssetValue={adjustedAssetValue}
            simulationResults={simulationResults}
          />

         
        </section>
      ) : (
        <p className="text-xs text-slate-500 dark:text-slate-400">
          Select a project above to start building dashboards.
        </p>
      )}
    </div>
  );
}\n--- ./(app)/projects/[projectId]/presentation/setup/page.tsx ---\n
"use client";

import React, { useState, useEffect } from "react";
import Link from "next/link";
import { useRouter, useParams } from "next/navigation";
import { 
  ArrowLeft, 
  Presentation, 
  Map, 
  BarChart3, 
  FileText, 
  Layers, 
  CheckCircle2, 
  Play,
  Settings2
} from "lucide-react";
import { cn } from "@/lib/utils";
import { supabase } from "@/lib/supabaseClient";

const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

export default function PresentationSetupPage() {
  const params = useParams();
  // Handle projectId being string or string[]
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;
  
  const router = useRouter();
  
  const [loading, setLoading] = useState(true);
  const [project, setProject] = useState<any>(null);

  // Configuration State
  const [config, setConfig] = useState({
    title: "",
    presenter: "",
    showMap: true,
    showFinancials: true,
    showScenarios: true,
    showRecommendations: false
  });

  // Fetch Project Name for context
  useEffect(() => {
    async function fetchProject() {
      if (!projectId) return;
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;

      const res = await fetch(`${API_BASE}/api/v1/projects/${projectId}`, {
        headers: { Authorization: `Bearer ${session.access_token}` }
      });
      
      if (res.ok) {
        const data = await res.json();
        setProject(data);
        // Set default title
        setConfig(prev => ({ 
            ...prev, 
            title: `${data.project_name} - Strategic Review` 
        }));
      }
      setLoading(false);
    }
    fetchProject();
  }, [projectId]);

  const handleLaunch = () => {
    // In a real app, we might save this config to the DB or Context.
    // For now, we pass it via query params or just navigate.
    // We will build the 'live' page next.
    router.push(`/projects/${projectId}/presentation/live?title=${encodeURIComponent(config.title)}`);
  };

  if (loading) return <div className="p-10 text-slate-500">Loading configuration...</div>;

  return (
    <div className="min-h-screen bg-[var(--background)] flex flex-col">
      
      {/* Navbar */}
      <header className="border-b border-slate-200 dark:border-slate-800 bg-[var(--surface-bg)] px-8 py-4 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Link 
            href="/presentationmode"
            className="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition text-slate-500"
          >
            <ArrowLeft className="h-5 w-5" />
          </Link>
          <div>
            <h1 className="text-lg font-semibold flex items-center gap-2">
              <Settings2 className="h-5 w-5 text-slate-400" />
              Presentation Setup
            </h1>
            <p className="text-xs text-slate-500">
              {project?.project_name}
            </p>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 max-w-5xl mx-auto w-full p-8 grid grid-cols-1 lg:grid-cols-[1.5fr,1fr] gap-12">
        
        {/* Left Col: Narrative Config */}
        <div className="space-y-8">
            <div className="space-y-2">
                <h2 className="text-2xl font-bold tracking-tight">Set the Stage</h2>
                <p className="text-slate-500 dark:text-slate-400">
                    Define the narrative context for your presentation.
                </p>
            </div>

            <div className="space-y-6">
                <div className="space-y-2">
                    <label className="text-sm font-medium">Session Title</label>
                    <input 
                        type="text" 
                        value={config.title}
                        onChange={(e) => setConfig({...config, title: e.target.value})}
                        className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-purple-500 outline-none text-lg font-medium"
                        placeholder="e.g. Board Meeting Q3"
                    />
                </div>

                <div className="space-y-2">
                    <label className="text-sm font-medium">Presenter Name (Optional)</label>
                    <input 
                        type="text" 
                        value={config.presenter}
                        onChange={(e) => setConfig({...config, presenter: e.target.value})}
                        className="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-purple-500 outline-none"
                        placeholder="e.g. Chief Engineer"
                    />
                </div>
            </div>

            <div className="pt-8">
                <h3 className="text-sm font-medium uppercase tracking-wider text-slate-500 mb-4">Modules to Include</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <ModuleCard 
                        icon={<Map className="h-5 w-5 text-blue-500" />}
                        title="Interactive Map"
                        desc="GIS view of road conditions"
                        active={config.showMap}
                        onClick={() => setConfig({...config, showMap: !config.showMap})}
                    />
                    <ModuleCard 
                        icon={<BarChart3 className="h-5 w-5 text-emerald-500" />}
                        title="Financial Forecast"
                        desc="20-year budget charts"
                        active={config.showFinancials}
                        onClick={() => setConfig({...config, showFinancials: !config.showFinancials})}
                    />
                    <ModuleCard 
                        icon={<Layers className="h-5 w-5 text-purple-500" />}
                        title="Scenario Compare"
                        desc="Baseline vs. Austerity"
                        active={config.showScenarios}
                        onClick={() => setConfig({...config, showScenarios: !config.showScenarios})}
                    />
                    <ModuleCard 
                        icon={<FileText className="h-5 w-5 text-amber-500" />}
                        title="Recommendations"
                        desc="AI-generated summary"
                        active={config.showRecommendations}
                        onClick={() => setConfig({...config, showRecommendations: !config.showRecommendations})}
                    />
                </div>
            </div>
        </div>

        {/* Right Col: Preview & Action */}
        <div className="flex flex-col h-full bg-[var(--surface-bg)] border border-slate-200 dark:border-slate-800 rounded-3xl p-8 shadow-xl">
            <div className="flex-1 flex flex-col items-center justify-center text-center space-y-4 opacity-50">
                <div className="w-full aspect-video bg-slate-100 dark:bg-slate-800 rounded-lg flex items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700">
                    <Presentation className="h-12 w-12 text-slate-400" />
                </div>
                <p className="text-sm text-slate-500">Preview will appear on secondary display</p>
            </div>

            <div className="mt-8 pt-8 border-t border-slate-200 dark:border-slate-800 space-y-4">
                <div className="flex items-center justify-between text-sm">
                    <span className="text-slate-500">Estimated Duration</span>
                    <span className="font-mono font-medium">15 - 30 mins</span>
                </div>
                <div className="flex items-center justify-between text-sm">
                    <span className="text-slate-500">Data Source</span>
                    <span className="font-mono font-medium text-emerald-500">Live & Synced</span>
                </div>

                <button 
                    onClick={handleLaunch}
                    className="w-full group relative flex items-center justify-center gap-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-4 rounded-2xl font-bold text-lg hover:shadow-2xl hover:scale-[1.02] transition-all"
                >
                    <Play className="h-5 w-5 fill-current" />
                    Launch Presentation
                </button>
            </div>
        </div>

      </main>
    </div>
  );
}

function ModuleCard({ icon, title, desc, active, onClick }: any) {
    return (
        <button 
            onClick={onClick}
            className={cn(
                "flex items-start gap-3 p-4 rounded-xl border text-left transition-all",
                active 
                    ? "border-purple-500 bg-purple-50 dark:bg-purple-900/20 ring-1 ring-purple-500" 
                    : "border-slate-200 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-700"
            )}
        >
            <div className={cn("mt-0.5", !active && "opacity-50")}>{icon}</div>
            <div>
                <div className="font-semibold text-sm flex items-center gap-2">
                    {title}
                    {active && <CheckCircle2 className="h-3 w-3 text-purple-600 dark:text-purple-400" />}
                </div>
                <div className="text-xs text-slate-500 dark:text-slate-400">{desc}</div>
            </div>
        </button>
    );
}\n--- ./(app)/projects/[projectId]/presentation/live/components/LiveMap.tsx ---\n
"use client";

import React, { useEffect, useState } from "react";
import { MapContainer, TileLayer, Polyline, Tooltip, useMap } from "react-leaflet";
import L from "leaflet";

// --- 1. Fix Leaflet Icons in Next.js ---
// @ts-ignore
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// --- 2. Mock Coordinates (Gauteng Demo) ---
// In the future, these will come from your uploaded GIS/KML files.
const MOCK_NODES: Record<string, [number, number]> = {
  "N1": [-25.7479, 28.2293], // Pretoria Central
  "N2": [-25.8640, 28.1887], // Centurion
  "N3": [-26.0123, 28.1293], // Midrand
  "P1": [-25.7689, 28.3293], // Pretoria East
  "P2": [-25.8989, 28.2993], // Rietvlei
  "P3": [-25.9989, 28.2593], // Clayville
  "L1": [-25.7313, 28.1698], // Pretoria West
  "L2": [-25.7113, 28.1498], 
};

// --- 3. Helper for Colors ---
const getConditionColor = (iri: number) => {
  if (iri < 2.5) return "#10b981"; // Emerald (Good)
  if (iri < 5.0) return "#f59e0b"; // Amber (Fair)
  return "#ef4444"; // Red (Poor)
};

// --- 4. Component ---
export default function LiveMap({ activeLayer, segments }: { activeLayer: string, segments: any[] }) {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!mounted) return <div className="w-full h-full bg-slate-950 animate-pulse" />;

  // Transform segments into map lines
  const mapLines = segments.map((seg, i) => {
    // If node ID exists in mock, use it. Otherwise, offset slightly so they show up on map.
    const start = MOCK_NODES[seg.from_node] || [-25.7 + (i * 0.02), 28.2 + (i * 0.02)];
    const end = MOCK_NODES[seg.to_node] || [-25.75 + (i * 0.03), 28.25 + (i * 0.03)];
    
    return {
      id: seg.segment_id || `seg-${i}`,
      positions: [start, end] as [number, number][],
      iri: seg.iri || 3.0,
      name: `${seg.road_id || 'Road'}: ${seg.from_node} to ${seg.to_node}`,
      surface: seg.surface_type || 'Unknown'
    };
  });

  return (
    <MapContainer 
      center={[-25.8640, 28.1887]} 
      zoom={10} 
      style={{ height: "100%", width: "100%", background: "#020617" }} // Slate-950
      zoomControl={false}
      scrollWheelZoom={false} // Prevent accidental zooming during presentation
    >
      {/* Dark Matter Tiles for "Command Center" look */}
      <TileLayer
        attribution='&copy; <a href="https://carto.com/">CARTO</a>'
        url="https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      />

      {mapLines.map((line) => (
        <Polyline
          key={line.id}
          positions={line.positions}
          pathOptions={{
            // Logic: Blue for intro/default, Colored for Condition view
            color: activeLayer === 'condition' ? getConditionColor(line.iri) : '#6366f1', 
            weight: activeLayer === 'condition' ? 6 : 3,
            opacity: activeLayer === 'condition' ? 0.9 : 0.5,
          }}
        >
          <Tooltip sticky className="custom-leaflet-tooltip">
            <div className="font-bold text-xs">{line.name}</div>
            <div className="text-xs">IRI: {line.iri.toFixed(1)}</div>
            <div className="text-xs opacity-70">{line.surface}</div>
          </Tooltip>
        </Polyline>
      ))}
    </MapContainer>
  );
}\n--- ./(app)/projects/[projectId]/presentation/live/page.tsx ---\n
"use client";

import React, { useState, useEffect } from "react";
import dynamic from "next/dynamic"; // 1. Use Dynamic Import
import { useSearchParams, useRouter, useParams } from "next/navigation";
import { 
  X, 
  ChevronLeft, 
  ChevronRight, 
  Map as MapIcon, 
  BarChart3, 
  Layers, 
  PlayCircle, 
  PauseCircle
} from "lucide-react";
import { cn } from "@/lib/utils";
import { useNetworkSnapshot } from "../../../[projectId]/config/hooks/useNetworkSnapshot";
import { useSimulationResults } from "../../../[projectId]/dashboard/hooks/useSimulationResults";

// --- 2. DYNAMIC MAP COMPONENT ---
// We import the LiveMap component dynamically so it only loads in the browser.
// This fixes "window is not defined" errors common with Leaflet.
const LiveMap = dynamic(
  () => import("./components/LiveMap"),
  { 
    ssr: false, 
    loading: () => <div className="w-full h-full bg-slate-950 animate-pulse flex items-center justify-center text-slate-600 font-mono text-sm">INITIALIZING GIS ENGINE...</div> 
  }
);

// --- 3. DEMO DATA FOR MAP ---
// These segments match the mock coordinates in LiveMap.tsx
const DEMO_SEGMENTS = [
    { segment_id: "S1", road_id: "R101", from_node: "N1", to_node: "N2", iri: 2.1, surface_type: "Paved" }, // Pta -> Centurion
    { segment_id: "S2", road_id: "R101", from_node: "N2", to_node: "N3", iri: 2.8, surface_type: "Paved" }, // Centurion -> Midrand
    { segment_id: "S3", road_id: "P201", from_node: "P1", to_node: "P2", iri: 4.5, surface_type: "Gravel" }, // East -> Rietvlei
    { segment_id: "S4", road_id: "P201", from_node: "P2", to_node: "P3", iri: 6.2, surface_type: "Gravel" }, // Rietvlei -> Clayville
    { segment_id: "S5", road_id: "L305", from_node: "L1", to_node: "L2", iri: 3.2, surface_type: "Paved" }, // West
];

export default function PresentationLivePage() {
  const router = useRouter();
  const params = useParams();
  const searchParams = useSearchParams();
  
  const projectId = Array.isArray(params?.projectId) ? params?.projectId[0] : params?.projectId;
  const title = searchParams.get("title") || "Strategic Review";

  // Data Hooks
  const { snapshot } = useNetworkSnapshot(projectId || "");
  const { results } = useSimulationResults(projectId || "");

  // Presentation State
  const [activeSlide, setActiveSlide] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [activeLayer, setActiveLayer] = useState("default"); // default, condition

  // Slides Config
  const slides = [
    { id: "intro", label: "Executive Summary", layer: "default" },
    { id: "current", label: "Current Network State", layer: "condition" },
    { id: "forecast", label: "20-Year Forecast", layer: "investment" },
    { id: "financials", label: "Investment Needs", layer: "default" },
  ];

  // Auto-switch map layer when slide changes
  useEffect(() => {
      setActiveLayer(slides[activeSlide].layer);
  }, [activeSlide, slides]);

  // Auto-play Loop
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isPlaying) {
      interval = setInterval(() => {
        setActiveSlide((prev) => (prev + 1) % slides.length);
      }, 6000);
    }
    return () => clearInterval(interval);
  }, [isPlaying, slides.length]);

  const currentSlide = slides[activeSlide];

  return (
    <div className="relative h-screen w-screen overflow-hidden bg-slate-950 text-white font-sans selection:bg-purple-500/30">
      
      {/* 1. BACKGROUND MAP LAYER (Z-INDEX 0) */}
      <div className="absolute inset-0 z-0">
         <LiveMap activeLayer={activeLayer} segments={DEMO_SEGMENTS} />
      </div>

      {/* 2. TOP HEADER */}
      <header className="absolute top-0 left-0 right-0 z-50 p-6 flex justify-between items-start bg-gradient-to-b from-black/90 via-black/40 to-transparent pointer-events-none">
        <div className="pointer-events-auto">
            <h1 className="text-2xl font-bold tracking-tight text-white/90">{title}</h1>
            <p className="text-sm text-white/70 flex items-center gap-2">
                <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"/>
                Live Session ‚Ä¢ {new Date().toLocaleDateString()}
            </p>
        </div>
        <button 
            onClick={() => router.back()}
            className="p-2 bg-black/20 hover:bg-white/20 backdrop-blur-md rounded-full transition-colors text-white pointer-events-auto border border-white/10"
        >
            <X className="h-6 w-6" />
        </button>
      </header>

      {/* 3. MAIN STAGE OVERLAYS (Z-INDEX 10) */}
      <main className="absolute inset-0 z-10 flex items-center justify-center pointer-events-none">
        
        {/* SLIDE 1: INTRO */}
        {currentSlide.id === "intro" && (
            <div className="text-center space-y-6 animate-in fade-in zoom-in duration-500 bg-black/30 p-12 rounded-3xl backdrop-blur-sm border border-white/5 shadow-2xl">
                <div className="inline-block px-4 py-1.5 rounded-full border border-purple-500/50 bg-purple-500/20 text-purple-300 text-sm font-medium">
                    Mosianedi Strategy Engine
                </div>
                <h2 className="text-6xl font-black tracking-tighter text-white drop-shadow-2xl">
                    Network Master Plan
                </h2>
                <div className="flex gap-8 justify-center text-left pt-8">
                    <StatCard label="Total Asset Value" value={`R ${((snapshot?.totalAssetValue || 0) / 1000000).toFixed(1)}M`} />
                    <StatCard label="Network Size" value={`${snapshot?.totalLengthKm.toFixed(1)} km`} />
                    <StatCard label="Scenario" value={results ? `${results.year_count} Years` : "Baseline"} color="text-emerald-400" />
                </div>
            </div>
        )}

        {/* SLIDE 2: CURRENT STATE */}
        {currentSlide.id === "current" && (
            <div className="absolute left-10 top-32 w-[350px] pointer-events-auto animate-in slide-in-from-left duration-500">
                <div className="bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 p-6 rounded-3xl shadow-2xl">
                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                        <MapIcon className="h-5 w-5 text-blue-400" /> Condition Map
                    </h3>
                    <p className="text-sm text-slate-300 mb-4">
                        Visualizing IRI (Roughness) across the network. <br/>
                        <span className="text-emerald-400 font-bold">Green</span> is Good, <span className="text-rose-500 font-bold">Red</span> is Critical.
                    </p>
                    <div className="space-y-3 bg-black/30 p-4 rounded-xl border border-white/5">
                        <div className="flex items-center justify-between text-xs">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-emerald-500"/> Good</div>
                            <span className="font-mono text-emerald-400">{snapshot?.goodConditionPct.toFixed(0)}%</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-amber-500"/> Fair</div>
                            <span className="font-mono text-amber-400">{snapshot?.fairConditionPct.toFixed(0)}%</span>
                        </div>
                        <div className="flex items-center justify-between text-xs">
                            <div className="flex items-center gap-2"><div className="w-3 h-3 rounded-full bg-rose-500"/> Poor</div>
                            <span className="font-mono text-rose-400">{snapshot?.poorConditionPct.toFixed(0)}%</span>
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* SLIDE 3: FORECAST */}
        {currentSlide.id === "forecast" && (
             <div className="absolute right-10 bottom-32 w-[500px] pointer-events-auto animate-in slide-in-from-right duration-500">
                <div className="bg-black/60 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl">
                    <h3 className="text-xl font-bold mb-2 flex items-center gap-2 text-white">
                        <BarChart3 className="h-5 w-5 text-purple-400" /> 
                        {results?.year_count || 20}-Year Horizon
                    </h3>
                    <p className="text-sm text-white/60 mb-6">
                        Projected deterioration under current funding levels.
                    </p>
                    
                    {/* Visual Bar Chart (Simplified CSS Bars) */}
                    <div className="h-40 flex items-end gap-1.5 border-b border-white/10 pb-2 mb-4">
                        {results?.yearly_data.map((d, i) => (
                            <div 
                                key={i} 
                                className="flex-1 bg-purple-500/50 hover:bg-purple-400 transition-all rounded-t-sm relative group" 
                                style={{ height: `${Math.min(100, (d.avg_condition_index / 8) * 100)}%` }}
                            >
                                <div className="absolute -top-10 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 bg-white text-black text-[10px] px-2 py-1 rounded transition-opacity font-bold whitespace-nowrap z-50">
                                    Year {d.year}: IRI {d.avg_condition_index}
                                </div>
                            </div>
                        ))}
                        {!results && <div className="text-xs text-white/40 w-full text-center mt-10">Run simulation to see forecast data.</div>}
                    </div>
                    
                    <div className="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5">
                        <span className="text-sm text-white/70">Total Lifecycle Liability</span>
                        <span className="text-xl font-mono font-bold text-white">
                            R {((results?.total_cost_npv || 0) / 1000000).toFixed(1)} M
                        </span>
                    </div>
                </div>
             </div>
        )}

        {/* SLIDE 4: FINANCIALS */}
        {currentSlide.id === "financials" && (
            <div className="text-center animate-in fade-in zoom-in duration-500">
                <h2 className="text-4xl font-bold text-white mb-4">Investment Strategy</h2>
                <div className="bg-emerald-900/40 backdrop-blur-md p-8 rounded-3xl border border-emerald-500/30">
                    <p className="text-2xl text-emerald-100">
                        Recommended Annual Budget: <span className="font-bold text-white">R {(snapshot?.totalLengthKm || 0) * 85000}</span>
                    </p>
                </div>
            </div>
        )}

      </main>

      {/* 4. BOTTOM DOCK (Controls) */}
      <footer className="absolute bottom-8 left-1/2 -translate-x-1/2 z-50 flex items-center gap-4 pointer-events-auto">
        
        {/* Navigation Deck */}
        <div className="bg-black/60 backdrop-blur-xl border border-white/10 p-2 rounded-full flex items-center gap-1 shadow-2xl">
            <button 
                onClick={() => setActiveSlide(Math.max(0, activeSlide - 1))}
                disabled={activeSlide === 0}
                className="p-3 hover:bg-white/10 rounded-full disabled:opacity-30 transition-colors text-white"
            >
                <ChevronLeft className="h-5 w-5" />
            </button>

            <div className="px-6 flex flex-col items-center min-w-[200px]">
                <span className="text-[10px] font-bold tracking-widest uppercase text-white/40">
                    Slide {activeSlide + 1} / {slides.length}
                </span>
                <span className="text-sm font-medium text-white">{currentSlide.label}</span>
            </div>

            <button 
                onClick={() => setActiveSlide(Math.min(slides.length - 1, activeSlide + 1))}
                disabled={activeSlide === slides.length - 1}
                className="p-3 hover:bg-white/10 rounded-full disabled:opacity-30 transition-colors text-white"
            >
                <ChevronRight className="h-5 w-5" />
            </button>
        </div>

        {/* Play/Pause */}
        <button 
            onClick={() => setIsPlaying(!isPlaying)}
            className="p-4 bg-white text-black hover:bg-slate-200 rounded-full shadow-lg transition-transform hover:scale-105"
        >
            {isPlaying ? <PauseCircle className="h-6 w-6" /> : <PlayCircle className="h-6 w-6" />}
        </button>
        
        {/* Layer Toggle */}
        <div className="bg-black/60 backdrop-blur-xl border border-white/10 p-2 rounded-full flex items-center gap-2 shadow-2xl">
            <button 
                onClick={() => setActiveLayer(activeLayer === 'condition' ? 'default' : 'condition')}
                className={cn("p-3 rounded-full transition-colors", activeLayer === "condition" ? "bg-emerald-600 text-white" : "hover:bg-white/10 text-white/50")}
                title="Toggle Condition Map"
            >
                <Layers className="h-5 w-5" />
            </button>
        </div>
      </footer>
    </div>
  );
}

// Helper Component for Stats
function StatCard({ label, value, color = "text-white" }: any) {
    return (
        <div className="bg-black/40 border border-white/10 p-4 rounded-2xl backdrop-blur-md min-w-[160px]">
            <div className="text-[10px] uppercase tracking-wider text-white/60 mb-1">{label}</div>
            <div className={cn("text-2xl font-bold font-mono", color)}>{value}</div>
        </div>
    );
}\n--- ./(app)/projects/page.tsx ---\n
/* --- ./app/(app)/projects/page.tsx (FINAL CONSOLIDATED FIX) --- */
"use client";

import { useState, useEffect, useCallback } from 'react';
import { Plus, FolderKanban, TrendingUp, DollarSign } from 'lucide-react';
import { cn } from '@/lib/utils';
import { ProjectCreateForm } from './ProjectCreateForm'; 
import Link from 'next/link';
import { supabase } from "@/lib/supabaseClient";
// üëá IMPORT THE CONFIG WE CREATED
import { API_BASE_URL } from "@/lib/config"; 

// Define the Project type based on the data returned from the FastAPI endpoint
interface Project {
    id: string; // Matches backend ProjectDB.id (UUID)
    project_name: string;
    description: string;
    start_year: number;
    forecast_duration: number;
    discount_rate: number;
    created_at: string;
}

// üëá USE THE CENTRAL API URL
const PROJECTS_ENDPOINT = `${API_BASE_URL}/api/v1/projects`; 

// Placeholder component for a simple modal backdrop
function Modal({ children, isOpen, onClose }: { children: React.ReactNode, isOpen: boolean, onClose: (success: boolean) => void }) {
    if (!isOpen) return null;

    return (
        <div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-black/30 dark:bg-black/70 backdrop-blur-sm transition-opacity" 
            onClick={() => onClose(false)} 
        >
            <div 
                className="relative max-h-full max-w-lg overflow-y-auto"
                onClick={(e) => e.stopPropagation()}
            >
                {children}
            </div>
        </div>
    );
}

// Project Card Component
const ProjectCard = ({ project }: { project: Project }) => (
    <Link 
        // Using project.id correctly
        href={`/projects/${project.id}/config`}
        className="block p-4 border border-slate-200/50 dark:border-slate-800/50 rounded-xl hover:shadow-md transition-shadow bg-[var(--surface-bg)]"
    >
        <div className="flex items-center justify-between">
            <h3 className="font-semibold text-lg hover:text-[var(--accent-color)] transition-colors">
                {project.project_name}
            </h3>
            <FolderKanban className="h-5 w-5 text-slate-500 dark:text-slate-400" />
        </div>
        <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 line-clamp-2">
            {project.description || 'No description provided.'}
        </p>
        <div className="mt-3 flex text-xs text-slate-500 dark:text-slate-500 space-x-4">
            <span className="flex items-center gap-1">
                <TrendingUp className="h-3 w-3" /> Duration: {project.forecast_duration} Years
            </span>
            <span className="flex items-center gap-1">
                <DollarSign className="h-3 w-3" /> Discount Rate: {project.discount_rate}%
            </span>
        </div>
    </Link>
);


export default function ProjectsPage() {
    const [isFormOpen, setIsFormOpen] = useState(false);
    const [projects, setProjects] = useState<Project[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    // Function to fetch projects from the backend
    const fetchProjects = useCallback(async () => {
        setLoading(true);
        setError(null);
        
        // --- JWT RETRIEVAL ---
        const { data: { session } } = await supabase.auth.getSession();
        const token = session?.access_token;

        if (!token) {
            setLoading(false);
            setError('Authorization required. Please log in.');
            return; // EARLY EXIT if no token
        }
        // --- END JWT RETRIEVAL ---

        try {
            // üëá USE THE CONFIG ENDPOINT
            const response = await fetch(PROJECTS_ENDPOINT, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`, 
                    'Content-Type': 'application/json',
                },
            });
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Your session has expired or the token is invalid.');
                }
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || `API error: ${response.status}`);
            }
            
            const data = await response.json(); 
            // Safety check: Ensure data is an array before setting state
            if (Array.isArray(data)) {
                 setProjects(data as Project[]); 
            } else {
                 setProjects([]);
            }
           
        } catch (err) {
            console.error("Fetch Projects Failed:", err);
            setError(`Could not load projects: ${err instanceof Error ? err.message : 'Unknown error'}`);
        } finally {
            setLoading(false);
        }
    }, []);

    // Initial load and subsequent fetches
    useEffect(() => {
        fetchProjects();
    }, [fetchProjects]);


    // Handler to run after the form submission closes
    const handleFormClose = (projectCreated: boolean) => {
        setIsFormOpen(false);
        if (projectCreated) {
            // Refresh the project list if a new project was successfully created
            fetchProjects();
        }
    };

    let content;
    // Check if error is specifically due to authorization missing (initial load scenario)
    const isAuthError = error && error.includes('Authorization required');

    if (loading) {
        content = (
            <div className="text-center py-20 text-slate-400 dark:text-slate-600">
                <p>Loading projects...</p>
            </div>
        );
    } else if (isAuthError) { // Handle the initial unauthorized state gracefully
        content = (
            <div className="text-center py-20 text-red-500">
                <p>‚ö†Ô∏è {error}</p>
                <p className="mt-2 text-sm text-slate-500 dark:text-slate-400">Please navigate back to the sign-in page to log in.</p>
            </div>
        );
    } else if (error) { // Handle other API errors
        content = (
            <div className="text-center py-20 text-red-500">
                <p>{error}</p>
                <p className="mt-2 text-sm text-slate-500 dark:text-slate-400">Check console and FastAPI logs for details.</p>
            </div>
        );
    } else if (projects.length === 0) {
        content = (
            <div className="text-center py-20 text-slate-400 dark:text-slate-600">
                <p>No projects found. Click "New Scenario" to get started.</p>
            </div>
        );
    } else {
        content = (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {projects.map(project => (
                    // FIX: Ensure project.id is used for the key
                    <ProjectCard key={project.id} project={project} />
                ))}
            </div>
        );
    }

    return (
      <div 
        className={cn(
          "h-full w-full rounded-2xl bg-[var(--surface-bg)] shadow-lg p-6",
          "text-[var(--foreground)]" 
        )}
      >
        
        {/* Header Section */}
        <div className="flex justify-between items-center mb-6">
            <div className="space-y-1">
                <h1 className="text-xl font-semibold tracking-tight">Projects</h1>
                <p className="text-sm text-slate-500 dark:text-slate-400">
                    List of scenarios and road programmes will go here.
                </p>
            </div>

            {/* Create Project Button */}
            <button
                onClick={() => setIsFormOpen(true)}
                className="inline-flex items-center gap-2 rounded-xl bg-[var(--accent-color)] px-4 py-2 text-sm font-semibold text-white shadow-sm hover:brightness-110 transition"
            >
                <Plus className="h-4 w-4" />
                New Scenario
            </button>
        </div>

        {/* Project List/Content Area */}
        <div className="pt-4 border-t border-slate-200/50 dark:border-slate-800/50">
            {content}
        </div>

        {/* Project Creation Modal */}
        <Modal isOpen={isFormOpen} onClose={handleFormClose}>
            {/* Pass handleFormClose to the form so it can signal success */}
            <ProjectCreateForm onClose={handleFormClose} /> 
        </Modal>
      </div>
    );
}\n--- ./(app)/network/components/NetworkProjectSelector.tsx ---\n
// app/(app)/network/components/NetworkProjectSelector.tsx
"use client";

import React from "react";
import { AlertTriangle, RefreshCw } from "lucide-react";

type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
  discount_rate?: number | null;
};

type Props = {
  projects: Project[];
  projectsLoading: boolean;
  projectsError: string | null;
  selectedProjectId: string;
  onSelectedProjectChange: (id: string) => void;
  snapshotLoading: boolean;
  onRefreshSnapshot: () => void;
  selectedProject: Project | null;
};

export function NetworkProjectSelector({
  projects,
  projectsLoading,
  projectsError,
  selectedProjectId,
  onSelectedProjectChange,
  snapshotLoading,
  onRefreshSnapshot,
  selectedProject,
}: Props) {
  return (
    <section className="p-4 rounded-2xl bg-[var(--surface-bg)] shadow-sm border border-slate-200/10 dark:border-slate-800/40 space-y-3">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p className="text-xs uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Project
          </p>
          <p className="text-sm font-medium">
            {selectedProject ? selectedProject.project_name : "Select a project"}
          </p>
        </div>

        <div className="flex items-center gap-3">
          <select
            value={selectedProjectId}
            onChange={(e) => onSelectedProjectChange(e.target.value)}
            disabled={projectsLoading || projects.length === 0}
            className="min-w-[220px] rounded-lg border border-slate-300/60 dark:border-slate-700 bg-slate-50/60 dark:bg-slate-900/40 px-2.5 py-1.5 text-sm text-slate-800 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="" disabled>
              {projectsLoading
                ? "Loading projects‚Ä¶"
                : projects.length === 0
                ? "No projects found"
                : "Select project"}
            </option>
            {projects.map((p) => (
              <option key={p.id} value={p.id}>
                {p.project_name}
              </option>
            ))}
          </select>

          <button
            type="button"
            onClick={onRefreshSnapshot}
            disabled={!selectedProjectId || snapshotLoading}
            className="inline-flex items-center gap-1.5 rounded-lg border border-slate-200 dark:border-slate-700 px-2.5 py-1 text-[11px] font-medium text-slate-600 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800/60 disabled:opacity-60"
          >
            <RefreshCw className="h-3 w-3" />
            {snapshotLoading ? "Refreshing‚Ä¶" : "Refresh snapshot"}
          </button>
        </div>
      </div>

      {projectsError && (
        <p className="text-xs text-red-500 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          {projectsError}
        </p>
      )}

      {selectedProject && (
        <p className="text-[11px] text-slate-500 dark:text-slate-400">
          {selectedProject.description && (
            <>
              <span className="font-medium">Overview:</span>{" "}
              {selectedProject.description}{" "}
            </>
          )}
          {(selectedProject.start_year || selectedProject.forecast_duration) && (
            <>
              |
              {selectedProject.start_year && (
                <> Start year: {selectedProject.start_year}</>
              )}
              {selectedProject.forecast_duration && (
                <> ‚Ä¢ Horizon: {selectedProject.forecast_duration} years</>
              )}
            </>
          )}
        </p>
      )}
    </section>
  );
}\n--- ./(app)/network/components/NetworkBreakdowns.tsx ---\n
// app/(app)/network/components/NetworkBreakdowns.tsx
"use client";

import React from "react";
import { Map, Route, TrendingUp } from "lucide-react";
import type { NetworkSnapshotUi } from "../../projects/[projectId]/config/hooks/useNetworkSnapshot";

type Props = {
  snapshot: NetworkSnapshotUi | null;
  totalLengthForRatios: number;
};

export function NetworkBreakdowns({ snapshot, totalLengthForRatios }: Props) {
  if (!snapshot) return null;

  return (
    <>
      {/* Length by road class */}
      {snapshot.lengthByRoadClass?.length > 0 && (
        <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-3">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <Route className="h-4 w-4 text-sky-500" />
            Length by road class
          </h2>
          <div className="space-y-2 text-[11px]">
            {snapshot.lengthByRoadClass.map((row) => {
              const pct =
                totalLengthForRatios > 0
                  ? (row.lengthKm / totalLengthForRatios) * 100
                  : 0;

              return (
                <div key={row.label}>
                  <div className="flex justify-between mb-0.5">
                    <span className="text-slate-400">{row.label}</span>
                    <span className="font-mono">
                      {row.lengthKm.toFixed(1)} km
                    </span>
                  </div>
                  <div className="h-1.5 rounded-full bg-slate-800 overflow-hidden">
                    <div
                      className="h-full bg-sky-500"
                      style={{ width: `${pct}%` }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Length by network type (if present from workbook) */}
      {snapshot.lengthByNetworkType?.length > 0 && (
        <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-3">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <Map className="h-4 w-4 text-emerald-500" />
            Length by network type
          </h2>
          <div className="space-y-2 text-[11px]">
            {snapshot.lengthByNetworkType.map((row) => {
              const pct =
                totalLengthForRatios > 0
                  ? (row.lengthKm / totalLengthForRatios) * 100
                  : 0;

              return (
                <div key={row.label}>
                  <div className="flex justify-between mb-0.5">
                    <span className="text-slate-400">{row.label}</span>
                    <span className="font-mono">
                      {row.lengthKm.toFixed(1)} km
                    </span>
                  </div>
                  <div className="h-1.5 rounded-full bg-slate-800 overflow-hidden">
                    <div
                      className="h-full bg-emerald-500"
                      style={{ width: `${pct}%` }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      )}

      {/* Asset value breakdown */}
      {snapshot.assetValueByCategory?.length > 0 && (
        <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-3">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <TrendingUp className="h-4 w-4 text-emerald-500" />
            Asset value by category
          </h2>
          <div className="space-y-2 text-[11px]">
            {snapshot.assetValueByCategory.map((row) => (
              <div
                key={row.label}
                className="flex items-center justify-between gap-2"
              >
                <span className="text-slate-400">{row.label}</span>
                <span className="font-mono">
                  R {(row.value / 1_000_000).toFixed(1)} m
                </span>
              </div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}\n--- ./(app)/network/components/RealModel3D.tsx ---\n
"use client";

import React, { useRef, Suspense } from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls, Environment, Grid } from "@react-three/drei";
import * as THREE from "three";

// 1. Separate the Mesh Logic into a Sub-Component
function RoadSegment({ width, length, condition }: { width: number, length: number, condition: number }) {
  // Color logic: Green (Good) -> Red (Bad)
  // We calculate this outside the JSX to avoid re-instantiating objects too often
  const color = new THREE.Color().lerpColors(
    new THREE.Color("#10b981"), // Emerald
    new THREE.Color("#ef4444"), // Red
    Math.min(condition / 10, 1) // Normalized based on IRI max 10
  );

  return (
    <group>
      {/* Pavement Layer */}
      <mesh position={[0, 0.1, 0]} rotation={[-Math.PI / 2, 0, 0]} receiveShadow castShadow>
        <planeGeometry args={[width, length]} />
        <meshStandardMaterial 
            color="#334155" 
            roughness={0.9} 
            metalness={0.1}
        />
      </mesh>

      {/* Base Layer (Dirt) */}
      <mesh position={[0, -0.25, 0]}>
        <boxGeometry args={[width, 0.5, length]} />
        <meshStandardMaterial color="#78350f" /> 
      </mesh>

      {/* Lane Markings */}
      <mesh position={[0, 0.11, 0]} rotation={[-Math.PI / 2, 0, 0]}>
        <planeGeometry args={[0.15, length]} />
        <meshBasicMaterial color="#ffffff" side={THREE.DoubleSide} />
      </mesh>

      {/* Condition Sphere (Floating Indicator) */}
      <mesh position={[0, 2, 0]}>
        <sphereGeometry args={[0.5, 32, 32]} />
        <meshStandardMaterial color={color} emissive={color} emissiveIntensity={0.6} />
      </mesh>
    </group>
  );
}

// 2. Loading Fallback (While 3D assets load)
function Loader() {
  return (
    <mesh visible={false}>
      <boxGeometry />
      <meshBasicMaterial color="white" />
    </mesh>
  );
}

// 3. Main Export
export default function RealModel3D({ width = 8, length = 20, iri = 2.0 }) {
  return (
    // Container must have explicit height for Canvas to render
    <div className="h-[500px] w-full bg-slate-950 rounded-2xl overflow-hidden border border-slate-800 shadow-2xl relative">
        
        <Canvas 
            shadows 
            camera={{ position: [12, 8, 12], fov: 45 }}
            style={{ width: '100%', height: '100%' }} // Force size
        >
            {/* Background Color & Fog */}
            <color attach="background" args={["#0f172a"]} />
            <fog attach="fog" args={["#0f172a", 10, 40]} />
            
            {/* Lighting */}
            <ambientLight intensity={0.7} />
            <directionalLight position={[10, 10, 5]} intensity={1.5} castShadow />
            <spotLight position={[-10, 10, -5]} intensity={0.5} />

            {/* Suspense Wrapper handles the async Environment loading */}
            <Suspense fallback={<Loader />}>
                <RoadSegment width={width} length={length} condition={iri} />
                
                {/* Environment adds reflections/realism */}
                <Environment preset="city" />
            </Suspense>

            {/* Helper Grid */}
            <Grid 
                infiniteGrid 
                fadeDistance={30} 
                sectionColor="#4f46e5" 
                cellColor="#1e293b" 
                position={[0, -0.01, 0]}
            />
            
            {/* Controls */}
            <OrbitControls 
                minPolarAngle={0} 
                maxPolarAngle={Math.PI / 2.2} 
                enablePan={false}
                minDistance={5}
                maxDistance={30}
            />
        </Canvas>
        
        {/* HTML Overlay */}
        <div className="absolute top-4 left-4 bg-black/50 backdrop-blur-md px-4 py-2 rounded-lg text-white border border-white/10 pointer-events-none select-none z-10">
            <h3 className="text-[10px] font-bold uppercase tracking-widest text-white/50">3D Inspector</h3>
            <p className="text-xl font-mono">IRI {iri.toFixed(1)}</p>
        </div>
    </div>
  );
}\n--- ./(app)/network/components/NetworkSnapshotSummary.tsx ---\n
// app/(app)/network/components/NetworkSnapshotSummary.tsx
"use client";

import React from "react";
import { AlertTriangle, BarChart3, Map, TrendingUp } from "lucide-react";
import type { NetworkSnapshotUi } from "../../projects/[projectId]/config/hooks/useNetworkSnapshot";

type Props = {
  snapshot: NetworkSnapshotUi | null;
  loading: boolean;
  error: string | null;
};

export function NetworkSnapshotSummary({ snapshot, loading, error }: Props) {
  return (
    <>
      <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-4">
        <div className="flex items-center justify-between gap-3">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <Map className="h-5 w-5 text-sky-500" />
            Network snapshot
          </h2>
        </div>

        {loading && (
          <p className="text-xs text-slate-500 dark:text-slate-400">
            Loading snapshot‚Ä¶
          </p>
        )}

        {!loading && error && (
          <div className="flex items-start gap-2 text-xs text-red-500">
            <AlertTriangle className="h-4 w-4 mt-0.5" />
            <span>{error}</span>
          </div>
        )}

        {!loading && !error && !snapshot && (
          <p className="text-xs text-slate-500 dark:text-slate-400">
            No snapshot yet. Upload master data for this project on the
            configuration page to see network metrics here.
          </p>
        )}

        {!loading && snapshot && (
          <div className="space-y-4 text-sm">
            <div className="grid grid-cols-2 gap-4">
              <div className="rounded-xl bg-slate-50 dark:bg-slate-900/40 px-3 py-2.5">
                <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Total network length
                </p>
                <p className="mt-1 text-lg font-semibold">
                  {snapshot.totalLengthKm.toFixed(1)} km
                </p>
                <p className="mt-0.5 text-[11px] text-slate-500 dark:text-slate-400">
                  From latest master dataset
                </p>
              </div>

              <div className="rounded-xl bg-slate-50 dark:bg-slate-900/40 px-3 py-2.5">
                <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                  Surface mix
                </p>
                <p className="mt-1 text-sm">
                  <span className="font-semibold">
                    {snapshot.pavedLengthKm.toFixed(1)} km
                  </span>{" "}
                  paved
                </p>
                <p className="text-sm">
                  <span className="font-semibold">
                    {snapshot.gravelLengthKm.toFixed(1)} km
                  </span>{" "}
                  gravel
                </p>
              </div>
            </div>

            {/* Condition split */}
            <div>
              <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400 mb-1">
                Condition split
              </p>
              <div className="flex items-center gap-2 text-[11px]">
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-slate-200 dark:bg-slate-800">
                  <div
                    className="h-full bg-emerald-500"
                    style={{ width: `${snapshot.goodConditionPct}%` }}
                  />
                </div>
                <span className="font-semibold text-emerald-600 dark:text-emerald-400">
                  {snapshot.goodConditionPct.toFixed(0)}% good
                </span>
              </div>
              <div className="flex items-center gap-2 text-[11px] mt-1">
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-slate-200 dark:bg-slate-800">
                  <div
                    className="h-full bg-amber-500"
                    style={{ width: `${snapshot.fairConditionPct}%` }}
                  />
                </div>
                <span className="font-semibold text-amber-600 dark:text-amber-400">
                  {snapshot.fairConditionPct.toFixed(0)}% fair
                </span>
              </div>
              <div className="flex items-center gap-2 text-[11px] mt-1">
                <div className="flex-1 h-2 rounded-full overflow-hidden bg-slate-200 dark:bg-slate-800">
                  <div
                    className="h-full bg-rose-500"
                    style={{ width: `${snapshot.poorConditionPct}%` }}
                  />
                </div>
                <span className="font-semibold text-rose-600 dark:text-rose-400">
                  {snapshot.poorConditionPct.toFixed(0)}% poor
                </span>
              </div>
            </div>

            {snapshot.totalAssetValue != null && (
              <div className="rounded-xl bg-slate-50 dark:bg-slate-900/40 px-3 py-2.5 flex items-center justify-between gap-3">
                <div>
                  <p className="text-[11px] uppercase tracking-wide text-slate-500 dark:text-slate-400">
                    Network asset value
                  </p>
                  <p className="mt-1 text-lg font-semibold">
                    R {(snapshot.totalAssetValue / 1_000_000).toFixed(1)} m
                  </p>
                </div>
                <TrendingUp className="h-6 w-6 text-emerald-500" />
              </div>
            )}

            <p className="text-[10px] text-slate-500 dark:text-slate-500">
              Snapshot based on{" "}
              <span className="font-mono">
                {snapshot.calculatedAt
                  ? new Date(snapshot.calculatedAt).toLocaleString("en-ZA")
                  : "latest master data upload"}
              </span>
              .
            </p>
          </div>
        )}
      </div>

      {/* Unit costs card (if present) */}
      {snapshot && snapshot.unitCostsBySurface?.length > 0 && (
        <div className="p-6 bg-[var(--surface-bg)] rounded-2xl shadow-lg border border-slate-200/10 dark:border-slate-800/10 space-y-3">
          <h2 className="text-sm font-semibold flex items-center gap-2">
            <BarChart3 className="h-4 w-4 text-violet-500" />
            Typical unit costs (per km)
          </h2>
          <div className="space-y-1 text-[11px]">
            {snapshot.unitCostsBySurface.map((row) => (
              <div
                key={row.label}
                className="flex items-center justify-between gap-2"
              >
                <span className="text-slate-400">{row.label}</span>
                <span className="font-mono text-slate-100">
                  R {row.costPerKm.toFixed(0)}/km
                </span>
              </div>
            ))}
          </div>
        </div>
      )}
    </>
  );
}\n--- ./(app)/network/page.tsx ---\n
"use client";

import React, { useEffect, useMemo, useState } from "react";
import dynamic from "next/dynamic"; // üëà Import dynamic
import { supabase } from "@/lib/supabaseClient";
import { AlertTriangle, Cuboid } from "lucide-react";

import { useNetworkSnapshot } from "../projects/[projectId]/config/hooks/useNetworkSnapshot";
import type { NetworkSnapshotUi } from "../projects/[projectId]/config/hooks/useNetworkSnapshot";

import { NetworkProjectSelector } from "./components/NetworkProjectSelector";
import { NetworkSnapshotSummary } from "./components/NetworkSnapshotSummary";
import { NetworkBreakdowns } from "./components/NetworkBreakdowns";

// 1. Dynamic Import for the 3D Component (No SSR)
const RoadModel3D = dynamic(
  () => import("./components/RealModel3D"), 
  { 
    ssr: false, 
    loading: () => (
      <div className="h-[500px] w-full bg-slate-950 rounded-2xl flex items-center justify-center text-slate-500 border border-slate-800">
        Initializing 3D Engine...
      </div>
    ) 
  }
);

// const API_BASE = "http://127.0.0.1:8000";
const API_BASE = `${process.env.NEXT_PUBLIC_API_URL}`;

type Project = {
  id: string;
  project_name: string;
  description?: string | null;
  start_year?: number | null;
  forecast_duration?: number | null;
  discount_rate?: number | null;
};

export default function NetworkPage() {
  const [projects, setProjects] = useState<Project[]>([]);
  const [projectsLoading, setProjectsLoading] = useState(false);
  const [projectsError, setProjectsError] = useState<string | null>(null);
  const [selectedProjectId, setSelectedProjectId] = useState<string>("");

  // --- 3D State ---
  const [roadWidth, setRoadWidth] = useState(8);
  const [roadIRI, setRoadIRI] = useState(2.5);

  // --- Fetch projects -------------------------------------------------------
  useEffect(() => {
    const fetchProjects = async () => {
      setProjectsLoading(true);
      setProjectsError(null);

      try {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        const token = session?.access_token;

        if (!token) {
          setProjectsError("Please log in to view your projects.");
          setProjectsLoading(false);
          return;
        }

        const res = await fetch(`${API_BASE}/api/v1/projects`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });

        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          throw new Error(body.detail || `Failed to load projects (${res.status})`);
        }

        const data: Project[] = await res.json();
        setProjects(data);

        // Auto-select first project if none chosen
        if (data.length > 0 && !selectedProjectId) {
          setSelectedProjectId(data[0].id);
        }
      } catch (err: any) {
        console.error("[NetworkPage] fetchProjects error:", err);
        setProjectsError(err.message || "Could not load projects.");
      } finally {
        setProjectsLoading(false);
      }
    };

    fetchProjects();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // --- Network snapshot for selected project -------------------------------
  const {
    snapshot,
    loading: snapshotLoading,
    error: snapshotError,
    refetch,
  } = useNetworkSnapshot(selectedProjectId || "");

  const selectedProject = useMemo(
    () => projects.find((p) => p.id === selectedProjectId) || null,
    [projects, selectedProjectId]
  );

  const totalLengthForRatios: number =
    snapshot?.totalNetworkLengthKm ?? snapshot?.totalLengthKm ?? 0;

  return (
    <div className="space-y-6 pb-20">
      {/* Header -------------------------------------------------------------- */}
      <header className="space-y-1">
        <h1 className="text-2xl font-semibold tracking-tight">Network</h1>
        <p className="text-sm text-slate-500 dark:text-slate-400">
          Explore your road network across projects. Select a project to see
          aggregated length, surface mix, condition, asset value and unit costs
          from the latest master data upload.
        </p>
      </header>

      {/* Project selector ---------------------------------------------------- */}
      <NetworkProjectSelector
        projects={projects}
        projectsLoading={projectsLoading}
        projectsError={projectsError}
        selectedProjectId={selectedProjectId}
        onSelectedProjectChange={setSelectedProjectId}
        snapshotLoading={snapshotLoading}
        onRefreshSnapshot={refetch}
        selectedProject={selectedProject}
      />

      {/* Snapshot + breakdowns ---------------------------------------------- */}
      {selectedProjectId ? (
        <>
          <section className="grid gap-6 xl:grid-cols-[1.4fr,1.2fr]">
            {/* Left column */}
            <div className="space-y-4">
              <NetworkSnapshotSummary
                snapshot={snapshot as NetworkSnapshotUi | null}
                loading={snapshotLoading}
                error={snapshotError}
              />
            </div>

            {/* Right column */}
            <div className="space-y-4">
              <NetworkBreakdowns
                snapshot={snapshot as NetworkSnapshotUi | null}
                totalLengthForRatios={totalLengthForRatios}
              />
            </div>
          </section>

          {/* 3D Digital Twin Section ----------------------------------------- */}
          <section className="mt-8 border-t border-slate-200/50 dark:border-slate-800/50 pt-8">
            <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
              <Cuboid className="h-5 w-5 text-indigo-500" />
              Digital Twin Inspector
            </h2>
            <p className="text-sm text-slate-500 mb-6 max-w-3xl">
              Visualize road cross-sections and deterioration mechanics. 
              Adjust the parameters below to see how geometry and condition (IRI) 
              affect the physical model of the asset.
            </p>

            <div className="grid grid-cols-1 xl:grid-cols-[2fr,1fr] gap-6">
              
              {/* 1. The 3D Stage */}
              <RoadModel3D width={roadWidth} length={35} iri={roadIRI} />

              {/* 2. The Engineer's Console */}
              <div className="bg-[var(--surface-bg)] p-6 rounded-2xl border border-slate-200/60 dark:border-slate-800/60 shadow-sm space-y-8 h-fit">
                  <div className="flex items-center justify-between border-b border-slate-200 dark:border-slate-800 pb-4">
                    <h3 className="font-semibold text-sm uppercase tracking-wide text-slate-500">Parameters</h3>
                    <span className="text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded">Interactive</span>
                  </div>
                  
                  {/* Lane Width Control */}
                  <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <label className="text-sm font-medium">Carriageway Width</label>
                        <span className="font-mono text-sm bg-slate-100 dark:bg-slate-900 px-2 py-0.5 rounded">{roadWidth}m</span>
                      </div>
                      <input 
                          type="range" min={4} max={20} step={0.5} 
                          value={roadWidth} 
                          onChange={(e) => setRoadWidth(Number(e.target.value))}
                          className="w-full accent-indigo-500 cursor-pointer"
                      />
                      <p className="text-[10px] text-slate-400">
                        Adjusting width impacts volume calculations for resurfacing and base layers.
                      </p>
                  </div>

                  {/* Condition Control */}
                  <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <label className="text-sm font-medium">Roughness (IRI)</label>
                        <span className={`font-mono text-sm px-2 py-0.5 rounded ${
                          roadIRI < 3 ? 'bg-emerald-100 text-emerald-700' :
                          roadIRI < 6 ? 'bg-amber-100 text-amber-700' :
                          'bg-rose-100 text-rose-700'
                        }`}>
                          {roadIRI.toFixed(1)}
                        </span>
                      </div>
                      <input 
                          type="range" min={0} max={15} step={0.1} 
                          value={roadIRI} 
                          onChange={(e) => setRoadIRI(Number(e.target.value))}
                          className={`w-full cursor-pointer ${
                            roadIRI < 3 ? 'accent-emerald-500' : 
                            roadIRI < 6 ? 'accent-amber-500' : 'accent-rose-500'
                          }`}
                      />
                      <div className="flex justify-between text-[10px] text-slate-400">
                        <span>New (0)</span>
                        <span>Terminal (15)</span>
                      </div>
                      <p className="text-[10px] text-slate-400">
                        Drag to simulate deterioration. Visual cues (color, roughness) update in real-time.
                      </p>
                  </div>
              </div>
            </div>
          </section>
        </>
      ) : (
        <p className="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1">
          <AlertTriangle className="h-3 w-3" />
          Select a project above to see network metrics.
        </p>
      )}
    </div>
  );
}\n--- ./(app)/dashboard/page.tsx ---\n
"use client";

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { supabase } from "@/lib/supabaseClient";
import { LayoutDashboard, ArrowRight, BarChart3 } from 'lucide-react';
import { cn } from '@/lib/utils';

// const API_BASE = "http://127.0.0.1:8000";
const API_BASE = process.env.NEXT_PUBLIC_API_URL;

interface Project {
    id: string;
    project_name: string;
    description: string;
    created_at: string;
}

export default function DashboardHub() {
    const [projects, setProjects] = useState<Project[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        const fetchProjects = async () => {
            setLoading(true);
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return;

                const res = await fetch(`${API_BASE}/api/v1/projects`, {
                    headers: { 'Authorization': `Bearer ${session.access_token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    setProjects(data);
                } else {
                    setError("Could not load projects");
                }
            } catch (err) {
                console.error(err);
                setError("Connection failed");
            } finally {
                setLoading(false);
            }
        };
        fetchProjects();
    }, []);

    return (
      <div className="space-y-6">
        <div className="space-y-1">
            <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
                <LayoutDashboard className="h-6 w-6 text-sky-500" />
                Executive Dashboards
            </h1>
            <p className="text-sm text-slate-500 dark:text-slate-400">
                Select a project below to view its performance forecast and analytics.
            </p>
        </div>

        {loading && <div className="py-10 text-center text-slate-500">Loading projects...</div>}
        
        {error && <div className="py-10 text-center text-red-500">{error}</div>}

        {!loading && !error && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {projects.map((project) => (
                    <Link 
                        key={project.id} 
                        href={`/projects/${project.id}/dashboard`}
                        className="group relative block p-6 bg-[var(--surface-bg)] border border-slate-200/50 dark:border-slate-800/50 rounded-2xl hover:shadow-md transition-all hover:border-sky-500/30"
                    >
                        <div className="flex items-start justify-between mb-4">
                            <div className="p-2 bg-sky-50 dark:bg-sky-900/20 text-sky-600 rounded-lg group-hover:scale-110 transition-transform">
                                <BarChart3 className="h-5 w-5" />
                            </div>
                            <ArrowRight className="h-4 w-4 text-slate-300 group-hover:text-sky-500 transition-colors" />
                        </div>
                        
                        <h3 className="font-semibold text-lg text-[var(--foreground)] mb-1">
                            {project.project_name}
                        </h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 line-clamp-2">
                            {project.description || "No description provided."}
                        </p>
                        
                        <div className="mt-4 text-xs font-medium text-sky-600 opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                            View Dashboard
                        </div>
                    </Link>
                ))}
            </div>
        )}
        
        {!loading && projects.length === 0 && (
            <div className="text-center py-20 bg-[var(--surface-bg)] rounded-2xl border border-dashed border-slate-300 dark:border-slate-700">
                <p className="text-slate-500">No projects found.</p>
                <Link href="/projects" className="text-sky-500 hover:underline text-sm">Create one in Projects</Link>
            </div>
        )}
      </div>
    );
}\n--- ./(app)/profile/page.tsx ---\n
export default function ProfilePage() {
    return (
      <div className="space-y-4">
        <h1 className="text-xl font-semibold tracking-tight">Profile</h1>
        <p className="text-sm text-slate-500">
          User details, roles and org information will go here.
        </p>
      </div>
    );
  }\n--- ./(app)/layout.tsx ---\n
/* --- ./app/(app)/layout.tsx (UPDATED) --- */
"use client";

import { ReactNode, useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";
import { Sidebar } from "@/components/sidebar";
import { Topbar } from "@/components/topbar";

export default function AppLayout({ children }: { children: ReactNode }) {
  const router = useRouter();
  const [checking, setChecking] = useState(true);

  useEffect(() => {
    const checkSession = async () => {
      const { data, error } = await supabase.auth.getSession();
      if (error || !data.session) {
        router.replace("/login");
      } else {
        setChecking(false);
      }
    };

    checkSession();
  }, [router]);

  if (checking) {
    return (
      <div className="flex h-screen w-screen items-center justify-center bg-[var(--background)] text-[var(--foreground)]">
        Checking session...
      </div>
    );
  }

  return (
    // Outer container uses a gap for margin and sets the page background
    // Removed outer shadow for cleaner look based on the reference
    <div className="flex h-screen w-screen overflow-hidden bg-[var(--background)] text-[var(--foreground)] gap-6 p-6">
      <Sidebar />
      <div className="flex h-full flex-1 flex-col gap-6">
        <Topbar />
        {/* Removed bg-[var(--surface-bg)] from main to show page background */}
        {/* Added rounded-2xl to main for visual consistency with topbar/sidebar */}
        <main className="flex-1 overflow-y-auto rounded-2xl">
          {children}
        </main>
      </div>
    </div>
  );
}\n--- ./(app)/reports/page.tsx ---\n
export default function ReportsPage() {
    return (
      <div className="space-y-4">
        <h1 className="text-xl font-semibold tracking-tight">Reports</h1>
        <p className="text-sm text-slate-500">
          Board-ready investment reports and presentation views will live here.
        </p>
      </div>
    );
  }\n--- ./layout.tsx ---\n
import type { Metadata } from "next";
import "./globals.css";
import { ThemeProvider } from "@/components/theme-provider";

export const metadata: Metadata = {
  title: "Mosianedi",
  description: "Road investment modeling platform",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      {/* no bg/text classes here, they come from globals.css via vars */}
      <body>
        <ThemeProvider>{children}</ThemeProvider>
      </body>
    </html>
  );
}\n--- ./(auth)/register/page.tsx ---\n
/* --- ./app/(auth)/register/page.tsx (FULLY UPDATED - Input Fix) --- */
"use client";

import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";

const DEPARTMENTS = [
  "Planning",
  "Design",
  "Construction",
  "Maintenance",
  "Asset Management",
];

const JOB_TITLES = [
  "Roads Design Engineer",
  "Pavement Engineer",
  "Transportation Planner",
  "Project Manager",
  "Asset Management Specialist",
];

export default function RegisterPage() {
  const router = useRouter();

  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [username, setUsername] = useState("");
  const [department, setDepartment] = useState(DEPARTMENTS[0]);
  const [title, setTitle] = useState(JOB_TITLES[0]);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);

    if (password !== confirmPassword) {
      setError("Passwords do not match.");
      return;
    }

    setSubmitting(true);

    // 1) Create auth user
    const { data, error: signUpError } = await supabase.auth.signUp({
      email,
      password,
    });

    if (signUpError || !data.user) {
      setSubmitting(false);
      setError(signUpError?.message || "Unable to create account.");
      return;
    }

    const user = data.user;

    // 2) Insert profile row
    const { error: profileError } = await supabase.from("profiles").insert({
      user_id: user.id,
      first_name: firstName,
      last_name: lastName,
      username,
      email,
      department,
      title,
    });

    setSubmitting(false);

    if (profileError) {
      setError(profileError.message);
      return;
    }

    // 3) Redirect to projects (or login if you require email confirm)
    router.replace("/projects");
  };

  return (
    // Card Container: Use surface-bg variable
    <div className="w-full max-w-2xl rounded-2xl border border-slate-200/70 bg-[var(--surface-bg)]/95 p-8 shadow-lg dark:border-slate-800/70">
      <h1 className="text-xl font-semibold text-[var(--foreground)]">
        Create account
      </h1>
      <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">
        Start modeling road investment scenarios with Mosianedi.
      </p>

      <form onSubmit={handleSubmit} className="mt-6 space-y-4">
        {/* Name Row */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              First name
            </label>
            <input
              type="text"
              required
              value={firstName}
              onChange={(e) => setFirstName(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
              placeholder="" 
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Last name
            </label>
            <input
              type="text"
              required
              value={lastName}
              onChange={(e) => setLastName(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
              placeholder="" 
            />
          </div>
        </div>

        {/* Username */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Username
          </label>
          <input
            type="text"
            required
            value={username}
            onChange={(e) => setUsername(e.target.value)}
            className="
              w-full rounded-xl border border-slate-300 
              // FIX: Use explicit variable for background and text
              bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
              placeholder:text-slate-400 dark:placeholder:text-slate-500
              focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
              dark:border-slate-700 dark:focus:ring-sky-800/40
            "
            placeholder="jabu.mosianedi"
          />
          <p className="mt-1 text-xs text-slate-500 dark:text-slate-500">
            This will be used inside projects and collaboration features.
          </p>
        </div>

        {/* Department + Job title */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Department
            </label>
            <select
              value={department}
              onChange={(e) => setDepartment(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
            >
              {DEPARTMENTS.map((d) => (
                <option key={d} value={d}>
                  {d}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Job title
            </label>
            <select
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
            >
              {JOB_TITLES.map((t) => (
                <option key={t} value={t}>
                  {t}
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* Email */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Email
          </label>
          <input
            type="email"
            required
            autoComplete="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="
              w-full rounded-xl border border-slate-300 
              // FIX: Use explicit variable for background and text
              bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
              placeholder:text-slate-400 dark:placeholder:text-slate-500
              focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
              dark:border-slate-700 dark:focus:ring-sky-800/40
            "
            placeholder="you@example.com"
          />
        </div>

        {/* Passwords */}
        <div className="grid gap-4 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Password
            </label>
            <input
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
              Confirm password
            </label>
            <input
              type="password"
              required
              value={confirmPassword}
              onChange={(e) => setConfirmPassword(e.target.value)}
              className="
                w-full rounded-xl border border-slate-300 
                // FIX: Use explicit variable for background and text
                bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
                placeholder:text-slate-400 dark:placeholder:text-slate-500
                focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
                dark:border-slate-700 dark:focus:ring-sky-800/40
              "
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>
        </div>

        {error && (
          <p className="text-xs text-red-500">
            {error}
          </p>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="
            mt-2 inline-flex w-full items-center justify-center
            rounded-xl bg-[var(--accent-color)] px-4 py-2.5
            text-sm font-semibold text-white
            shadow-sm hover:brightness-110
            disabled:cursor-not-allowed disabled:opacity-70
            transition
          "
        >
          {submitting ? "Creating account‚Ä¶" : "Sign up"}
        </button>
      </form>

      <p className="mt-4 text-center text-xs text-slate-500 dark:text-slate-400">
        Already have an account?{" "}
        <button
          type="button"
          onClick={() => router.push("/login")}
          className="font-medium text-[var(--accent-color)] hover:underline"
        >
          Sign in
        </button>
      </p>
    </div>
  );
}\n--- ./(auth)/layout.tsx ---\n
/* --- ./app/(auth)/layout.tsx (NO CHANGES) --- */
import type { ReactNode } from "react";

export default function AuthLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen w-full bg-[var(--background)] text-[var(--foreground)]">
      <div className="mx-auto flex min-h-screen max-w-5xl items-center justify-center px-4">
        {children}
      </div>
    </div>
  );
}\n--- ./(auth)/login/page.tsx ---\n
/* --- ./app/(auth)/login/page.tsx (FULLY UPDATED - Input Fix) --- */
"use client";

import { FormEvent, useState } from "react";
import { useRouter } from "next/navigation";
import { supabase } from "@/lib/supabaseClient";

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    setError(null);
    setSubmitting(true);

    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    setSubmitting(false);

    if (error) {
      setError(error.message);
      return;
    }

    if (data.session) {
      router.replace("/projects");
    }
  };

  return (
    // Card Container: Use surface-bg variable
    <div className="w-full max-w-md rounded-2xl border border-slate-200/70 bg-[var(--surface-bg)]/95 p-8 shadow-lg dark:border-slate-800/70">
      <h1 className="text-xl font-semibold text-[var(--foreground)]">
        Sign in
      </h1>
      <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">
        Access the Mosianedi road investment studio.
      </p>

      <form onSubmit={handleSubmit} className="mt-6 space-y-4">
        {/* Email */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Email
          </label>
          <input
            type="email"
            autoComplete="email"
            required
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="
              w-full rounded-xl border border-slate-300
              // FIX: Use explicit variable for background and text
              bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
              placeholder:text-slate-400 dark:placeholder:text-slate-500
              focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
              dark:border-slate-700 dark:focus:ring-sky-800/40
            "
            placeholder="you@example.com"
          />
        </div>

        {/* Password */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">
            Password
          </label>
          <input
            type="password"
            autoComplete="current-password"
            required
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="
              w-full rounded-xl border border-slate-300 
              // FIX: Use explicit variable for background and text
              bg-[var(--input-bg)] px-3 py-2.5 text-sm text-[var(--input-text)]
              placeholder:text-slate-400 dark:placeholder:text-slate-500
              focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-100
              dark:border-slate-700 dark:focus:ring-sky-800/40
            "
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
          />
        </div>

        {error && (
          <p className="text-xs text-red-500">
            {error}
          </p>
        )}

        <button
          type="submit"
          disabled={submitting}
          className="
            mt-2 inline-flex w-full items-center justify-center
            rounded-xl bg-[var(--accent-color)] px-4 py-2.5
            text-sm font-semibold text-white
            shadow-sm hover:brightness-110
            disabled:cursor-not-allowed disabled:opacity-70
            transition
          "
        >
          {submitting ? "Signing in‚Ä¶" : "Sign in"}
        </button>
      </form>

      <p className="mt-4 text-center text-xs text-slate-500 dark:text-slate-400">
        Don&apos;t have an account?{" "}
        <button
          type="button"
          onClick={() => router.push("/register")}
          className="font-medium text-[var(--accent-color)] hover:underline"
        >
          Create one
        </button>
      </p>
    </div>
  );
}\n--- ./page.tsx ---\n
import { redirect } from "next/navigation";

export default function Home() {
  redirect("/projects");
}\n--- ./globals.css ---\n
/* --- ./app/globals.css (FINAL CORRECTED VERSION) --- */
@import "tailwindcss";
@import "leaflet/dist/leaflet.css";
/* Define Custom Color Variables */
:root {
  /* Light Theme */
  --background: #f4f6fb;   /* Main canvas background */
  --foreground: #1e293b;   /* Main text color (slate-800) */
  --surface-bg: #ffffff;   /* Elevated element background (cards, sidebar) */
  --sidebar-bg: var(--surface-bg);
  --accent-color: #4c51f0; /* Accent color (deep purple/blue for CTAs) */
  --input-bg: #ffffff;     /* Input background: White in light mode */
  --input-text: #1e293b;   /* Input text: Dark text in light mode */
}

/* Dark Theme */
.dark {
  --background: #09090b;   /* Deep near-black background (slate-950) */
  --foreground: #f1f5f9;   /* Light text color (slate-100) */
  --surface-bg: #111827;   /* Dark elevated surface (slate-900) */
  --sidebar-bg: var(--surface-bg);
  --accent-color: #5d62f3; 
  --input-bg: #1e293d;     /* Input background: Slate-800 for contrast */
  --input-text: #f1f5f9;   /* Input text: Light text in dark mode */
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}